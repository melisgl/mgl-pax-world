<!DOCTYPE html>
<html xmlns='http://www.w3.org/1999/xhtml' xml:lang='en' lang='en'>
<head>
<title>Journal manual</title>
<link type='text/css' href='style.css' rel='stylesheet'>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=device-width">
   <script src="jquery.min.js"></script>
<script src="toc.min.js"></script>
<script type="text/x-mathjax-config">
     MathJax.Hub.Config({
       tex2jax: {
         inlineMath: [['$','$']],
         processEscapes: true
       }
     });
   </script>
   <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML">
   </script>
   
</head>
<body>
<div id="content-container">
<div id="toc">
<div id="toc-header"><ul><li><a href="index.html">PAX World</a></li></ul></div>
<div id="page-toc">
</div>
<div id="toc-footer"><ul><li><a href="https://github.com/melisgl/mgl-pax">[generated by MGL-PAX]</a></li></ul></div>
</div>
<div id="content">
<p><a id="x-28JOURNAL-3A-40JOURNAL-MANUAL-20MGL-PAX-3ASECTION-29"></a>
<a id="JOURNAL:@JOURNAL-MANUAL%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#%22journal%22%20ASDF%2FSYSTEM:SYSTEM" title="&quot;journal&quot; ASDF/SYSTEM:SYSTEM">&#8594;</a> <a href="journal-manual.html" title="Journal manual">&#8634;</a> <a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L5">&#955;</a></span></span></p>

<h1><a href="journal-manual.html">Journal manual</a></h1>

<h2>Table of Contents</h2>

<ul>
<li><a href="#%22journal%22%20ASDF%2FSYSTEM:SYSTEM" title="&quot;journal&quot; ASDF/SYSTEM:SYSTEM">1 The <code>journal</code> ASDF System</a></li>
<li><a href="#JOURNAL:@JOURNAL-LINKS%20MGL-PAX:SECTION" title="Links">2 Links</a></li>
<li><a href="#JOURNAL:@JOURNAL-PORTABILITY%20MGL-PAX:SECTION" title="Portability">3 Portability</a></li>
<li><a href="#JOURNAL:@JOURNAL-BACKGROUND%20MGL-PAX:SECTION" title="Background">4 Background</a></li>
<li><a href="#JOURNAL:@JOURNAL-FEATURES%20MGL-PAX:SECTION" title="Distinguishing features">5 Distinguishing features</a></li>
<li><a href="#JOURNAL:@JOURNAL-BASICS%20MGL-PAX:SECTION" title="Basics">6 Basics</a>

<ul>
<li><a href="#JOURNAL:@IN-EVENTS%20MGL-PAX:SECTION" title="In-events">6.1 In-events</a></li>
<li><a href="#JOURNAL:@OUT-EVENTS%20MGL-PAX:SECTION" title="Out-events">6.2 Out-events</a></li>
<li><a href="#JOURNAL:@WORKING-WITH-UNREADABLE-VALUES%20MGL-PAX:SECTION" title="Working with unreadable values">6.3 Working with unreadable values</a></li>
<li><a href="#JOURNAL:@JOURNAL-UTILITIES%20MGL-PAX:SECTION" title="Utilities">6.4 Utilities</a></li>
<li><a href="#JOURNAL:@PRETTY-PRINTING%20MGL-PAX:SECTION" title="Pretty-printing">6.5 Pretty-printing</a></li>
<li><a href="#JOURNAL:@JOURNAL-ERROR-HANDLING%20MGL-PAX:SECTION" title="Error handling">6.6 Error handling</a></li>
</ul></li>
<li><a href="#JOURNAL:@LOGGING%20MGL-PAX:SECTION" title="Logging">7 Logging</a>

<ul>
<li><a href="#JOURNAL:@CUSTOMIZING-LOGS%20MGL-PAX:SECTION" title="Customizing logs">7.1 Customizing logs</a></li>
<li><a href="#JOURNAL:@LOG-RECORD%20MGL-PAX:SECTION" title="`:log-record`">7.2 <code>:log-record</code></a></li>
<li><a href="#JOURNAL:@LOGGING-WITH-LEAVES%20MGL-PAX:SECTION" title="Logging with `leaf-event`s">7.3 Logging with <code>leaf-event</code>s</a></li>
</ul></li>
<li><a href="#JOURNAL:@TRACING%20MGL-PAX:SECTION" title="Tracing">8 Tracing</a>

<ul>
<li><a href="#JOURNAL:@JOURNAL-SLIME-INTEGRATION%20MGL-PAX:SECTION" title="Slime integration">8.1 Slime integration</a></li>
</ul></li>
<li><a href="#JOURNAL:@REPLAY%20MGL-PAX:SECTION" title="Replay">9 Replay</a>

<ul>
<li><a href="#JOURNAL:@JOURNALED-FOR-REPLAY%20MGL-PAX:SECTION" title="Journaled for replay">9.1 Journaled for replay</a></li>
<li><a href="#JOURNAL:@BUNDLES%20MGL-PAX:SECTION" title="Bundles">9.2 Bundles</a></li>
<li><a href="#JOURNAL:@THE-REPLAY-STRATEGY%20MGL-PAX:SECTION" title="The replay strategy">9.3 The replay strategy</a></li>
<li><a href="#JOURNAL:@MATCHING-IN-EVENTS%20MGL-PAX:SECTION" title="Matching in-events">9.4 Matching in-events</a>

<ul>
<li><a href="#JOURNAL:@REPLAYING-THE-OUTCOME%20MGL-PAX:SECTION" title="Replaying the outcome">9.4.1 Replaying the outcome</a></li>
</ul></li>
<li><a href="#JOURNAL:@MATCHING-OUT-EVENTS%20MGL-PAX:SECTION" title="Matching out-events">9.5 Matching out-events</a></li>
<li><a href="#JOURNAL:@REPLAY-FAILURES%20MGL-PAX:SECTION" title="Replay failures">9.6 Replay failures</a></li>
<li><a href="#JOURNAL:@UPGRADES-AND-REPLAY%20MGL-PAX:SECTION" title="Upgrades and replay">9.7 Upgrades and replay</a></li>
</ul></li>
<li><a href="#JOURNAL:@TESTING%20MGL-PAX:SECTION" title="Testing">10 Testing</a>

<ul>
<li><a href="#JOURNAL:@TESTING-ON-MULTIPLE-LEVELS%20MGL-PAX:SECTION" title="Testing on multiple levels">10.1 Testing on multiple levels</a></li>
</ul></li>
<li><a href="#JOURNAL:@PERSISTENCE%20MGL-PAX:SECTION" title="Persistence">11 Persistence</a>

<ul>
<li><a href="#JOURNAL:@PERSISTENCE-TUTORIAL%20MGL-PAX:SECTION" title="Persistence tutorial">11.1 Persistence tutorial</a></li>
<li><a href="#JOURNAL:@SYNCHRONIZATION%20MGL-PAX:SECTION" title="Synchronization to storage">11.2 Synchronization to storage</a>

<ul>
<li><a href="#JOURNAL:@SYNCHRONIZATION-STRATEGIES%20MGL-PAX:SECTION" title="Synchronization strategies">11.2.1 Synchronization strategies</a></li>
<li><a href="#JOURNAL:@SYNCHRONIZATION-WITH-IN-MEMORY-JOURNALS%20MGL-PAX:SECTION" title="Synchronization with in-memory journals">11.2.2 Synchronization with in-memory journals</a></li>
<li><a href="#JOURNAL:@SYNCHRONIZATION-WITH-FILE-JOURNALS%20MGL-PAX:SECTION" title="Synchronization with file journals">11.2.3 Synchronization with file journals</a></li>
</ul></li>
</ul></li>
<li><a href="#JOURNAL:@SAFETY%20MGL-PAX:SECTION" title="Safety">12 Safety</a></li>
<li><a href="#JOURNAL:@EVENTS-REFERENCE%20MGL-PAX:SECTION" title="Events reference">13 Events reference</a>

<ul>
<li><a href="#JOURNAL:@EVENT-VERSIONS%20MGL-PAX:SECTION" title="Event versions">13.1 Event versions</a></li>
<li><a href="#JOURNAL:@IN-EVENTS-REFERENCE%20MGL-PAX:SECTION" title="In-events">13.2 In-events</a></li>
<li><a href="#JOURNAL:@OUT-EVENTS-REFERENCE%20MGL-PAX:SECTION" title="Out-events">13.3 Out-events</a></li>
<li><a href="#JOURNAL:@LEAF-EVENTS-REFERENCE%20MGL-PAX:SECTION" title="Leaf-events">13.4 Leaf-events</a></li>
</ul></li>
<li><a href="#JOURNAL:@JOURNALS-REFERENCE%20MGL-PAX:SECTION" title="Journals reference">14 Journals reference</a>

<ul>
<li><a href="#JOURNAL:@COMPARING-JOURNALS%20MGL-PAX:SECTION" title="Comparing journals">14.1 Comparing journals</a></li>
<li><a href="#JOURNAL:@IN-MEMORY-JOURNALS%20MGL-PAX:SECTION" title="In-memory journals">14.2 In-memory journals</a></li>
<li><a href="#JOURNAL:@FILE-JOURNALS%20MGL-PAX:SECTION" title="File journals">14.3 File journals</a></li>
<li><a href="#JOURNAL:@PPRINT-JOURNALS%20MGL-PAX:SECTION" title="Pretty-printing journals">14.4 Pretty-printing journals</a></li>
</ul></li>
<li><a href="#JOURNAL:@BUNDLES-REFERENCE%20MGL-PAX:SECTION" title="Bundles reference">15 Bundles reference</a>

<ul>
<li><a href="#JOURNAL:@IN-MEMORY-BUNDLES%20MGL-PAX:SECTION" title="In-memory bundles">15.1 In-memory bundles</a></li>
<li><a href="#JOURNAL:@FILE-BUNDLES%20MGL-PAX:SECTION" title="File bundles">15.2 File bundles</a></li>
</ul></li>
<li><a href="#JOURNAL:@STREAMLETS-REFERENCE%20MGL-PAX:SECTION" title="Streamlets reference">16 Streamlets reference</a>

<ul>
<li><a href="#JOURNAL:@OPENING-AND-CLOSING%20MGL-PAX:SECTION" title="Opening and closing">16.1 Opening and closing</a></li>
<li><a href="#JOURNAL:@READING-FROM-STREAMLETS%20MGL-PAX:SECTION" title="Reading from streamlets">16.2 Reading from streamlets</a></li>
<li><a href="#JOURNAL:@WRITING-TO-STREAMLETS%20MGL-PAX:SECTION" title="Writing to streamlets">16.3 Writing to streamlets</a></li>
</ul></li>
<li><a href="#JOURNAL:@JOURNAL%2FGLOSSARY%20MGL-PAX:SECTION" title="Glossary">17 Glossary</a></li>
</ul>

<h6>[in package JOURNAL with nicknames JRN]</h6>

<p><a id="x-28-22journal-22-20ASDF-2FSYSTEM-3ASYSTEM-29"></a>
<a id="%22journal%22%20ASDF%2FSYSTEM:SYSTEM"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="journal-manual.html" title="Journal manual">&#8592;</a> <a href="journal-manual.html" title="Journal manual">&#8593;</a> <a href="#JOURNAL:@JOURNAL-LINKS%20MGL-PAX:SECTION" title="Links">&#8594;</a> <a href="#%22journal%22%20ASDF%2FSYSTEM:SYSTEM" title="&quot;journal&quot; ASDF/SYSTEM:SYSTEM">&#8634;</a> <a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/journal.asd#L1">&#955;</a></span></span></p>

<h2><a href="#%22journal%22%20ASDF%2FSYSTEM:SYSTEM">1 The <code>journal</code> ASDF System</a></h2>

<ul>
<li>Version: 0.1.0</li>
<li>Description: A library built around explicit execution traces for
  logging, tracing, testing and persistence.</li>
<li>Licence: MIT, see COPYING.</li>
<li>Author: GÃ¡bor Melis <a href="m&#x61;&#105;l&#x74;&#111;:&#x6D;&#101;g&#x61;&#64;r&#x65;&#116;e&#x73;&#46;h&#x75;">m&#x61;&#105;l&#x74;&#111;:&#x6D;&#101;g&#x61;&#64;r&#x65;&#116;e&#x73;&#46;h&#x75;</a></li>
<li>Homepage: <a href="http://github.com/melisgl/journal" >http://github.com/melisgl/journal</a></li>
<li>Bug tracker: <a href="http://github.com/melisgl/journal/issues" >http://github.com/melisgl/journal/issues</a></li>
<li>Source control: <a href="https://github.com/melisgl/journal.git" >GIT</a></li>
</ul>

<p><a id="x-28JOURNAL-3A-40JOURNAL-LINKS-20MGL-PAX-3ASECTION-29"></a>
<a id="JOURNAL:@JOURNAL-LINKS%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#%22journal%22%20ASDF%2FSYSTEM:SYSTEM" title="&quot;journal&quot; ASDF/SYSTEM:SYSTEM">&#8592;</a> <a href="journal-manual.html" title="Journal manual">&#8593;</a> <a href="#JOURNAL:@JOURNAL-PORTABILITY%20MGL-PAX:SECTION" title="Portability">&#8594;</a> <a href="#JOURNAL:@JOURNAL-LINKS%20MGL-PAX:SECTION" title="Links">&#8634;</a> <a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L25">&#955;</a></span></span></p>

<h2><a href="#JOURNAL:@JOURNAL-LINKS%20MGL-PAX:SECTION">2 Links</a></h2>

<p>Here is the <a href="https://github.com/melisgl/journal" >official repository</a>
and the <a href="http://melisgl.github.io/mgl-pax-world/journal-manual.html" >HTML
documentation</a>
for the latest version.</p>

<p><a id="x-28JOURNAL-3A-40JOURNAL-PORTABILITY-20MGL-PAX-3ASECTION-29"></a>
<a id="JOURNAL:@JOURNAL-PORTABILITY%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#JOURNAL:@JOURNAL-LINKS%20MGL-PAX:SECTION" title="Links">&#8592;</a> <a href="journal-manual.html" title="Journal manual">&#8593;</a> <a href="#JOURNAL:@JOURNAL-BACKGROUND%20MGL-PAX:SECTION" title="Background">&#8594;</a> <a href="#JOURNAL:@JOURNAL-PORTABILITY%20MGL-PAX:SECTION" title="Portability">&#8634;</a> <a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L31">&#955;</a></span></span></p>

<h2><a href="#JOURNAL:@JOURNAL-PORTABILITY%20MGL-PAX:SECTION">3 Portability</a></h2>

<p>Tested on ABCL, CCL, CLISP, CMUCL, ECL, and SBCL. AllegroCL Express
edition runs out of heap while running the tests. On Lisps that seem
to lack support for disabling and enabling of interrupts, such as
ABCL and CLISP, durability is compromised, and any attempt to
<a href="#JOURNAL:SYNC-JOURNAL%20FUNCTION" title="JOURNAL:SYNC-JOURNAL FUNCTION"><code>sync-journal</code></a> (see <a href="#JOURNAL:@SYNCHRONIZATION-STRATEGIES%20MGL-PAX:SECTION" title="Synchronization strategies">Synchronization strategies</a> and <a href="#JOURNAL:@SAFETY%20MGL-PAX:SECTION" title="Safety">Safety</a>) will be a
runtime error.</p>

<p><a id="x-28JOURNAL-3A-40JOURNAL-BACKGROUND-20MGL-PAX-3ASECTION-29"></a>
<a id="JOURNAL:@JOURNAL-BACKGROUND%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#JOURNAL:@JOURNAL-PORTABILITY%20MGL-PAX:SECTION" title="Portability">&#8592;</a> <a href="journal-manual.html" title="Journal manual">&#8593;</a> <a href="#JOURNAL:@JOURNAL-FEATURES%20MGL-PAX:SECTION" title="Distinguishing features">&#8594;</a> <a href="#JOURNAL:@JOURNAL-BACKGROUND%20MGL-PAX:SECTION" title="Background">&#8634;</a> <a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L39">&#955;</a></span></span></p>

<h2><a href="#JOURNAL:@JOURNAL-BACKGROUND%20MGL-PAX:SECTION">4 Background</a></h2>

<p>Logging, tracing, testing, and persistence are about what happened
during code execution. Recording machine-readable logs and traces
can be repurposed for white-box testing. More, when the code is
rerun, selected frames may return their recorded values without
executing the code, which could serve as a <a href="https://en.wikipedia.org/wiki/Mock_object" >mock</a>
framework for writing tests. This ability to isolate external
interactions and to reexecute traces is sufficient to reconstruct
the state of a program, achieving simple persistence not unlike a
<a href="https://en.wikipedia.org/wiki/Journaling_file_system" >journaling filesystem</a> or <a href="https://martinfowler.com/eaaDev/EventSourcing.html" >Event
Sourcing</a>.</p>

<p>Journal is the library to log, trace, test and persist. It has a
single macro at its heart: <a href="#JOURNAL:JOURNALED%20MGL-PAX:MACRO" title="JOURNAL:JOURNALED MGL-PAX:MACRO"><code>journaled</code></a>, which does pretty much what
was described. It can be thought of as generating two events around
its body: one that records the name and an argument list (as in a
function call), and another that records the return values. In
Lisp-like pseudocode:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">defmacro</span></i> journaled <span class="paren2">(<span class="code">name args &amp;body body</span>)</span>
  `<span class="paren2">(<span class="code"><i><span class="symbol">progn</span></i>
     <span class="paren3">(<span class="code">record-event `<span class="paren4">(<span class="code"><span class="keyword">:in</span> ,name <span class="keyword">:args</span> ,args</span>)</span></span>)</span>
     <span class="paren3">(<span class="code"><i><span class="symbol">let</span></i> <span class="paren4">(<span class="code"><span class="paren5">(<span class="code">,return-values <span class="paren6">(<span class="code">multiple-value-list <span class="paren1">(<span class="code"><i><span class="symbol">progn</span></i> ,@body</span>)</span></span>)</span></span>)</span></span>)</span>
       <span class="paren4">(<span class="code">record-event `<span class="paren5">(<span class="code"><span class="keyword">:out</span> ,name <span class="keyword">:values</span> ,return-values</span>)</span></span>)</span>
       <span class="paren4">(<span class="code">values-list ,return-values</span>)</span></span>)</span></span>)</span></span>)</span></span></code></pre>

<p>This is basically how recording works. When replaying events from a
previous run, the return values of <code>body</code> can be checked against the
recorded ones, or we may return the recorded values without even
running <code>body</code>.</p>

<p>In summary, we can produce selective execution traces by wrapping
code in <code>journaled</code> and use those traces for various purposes. The
Journal library is this idea taken to its logical conclusion.</p>

<p><a id="x-28JOURNAL-3A-40JOURNAL-FEATURES-20MGL-PAX-3ASECTION-29"></a>
<a id="JOURNAL:@JOURNAL-FEATURES%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#JOURNAL:@JOURNAL-BACKGROUND%20MGL-PAX:SECTION" title="Background">&#8592;</a> <a href="journal-manual.html" title="Journal manual">&#8593;</a> <a href="#JOURNAL:@JOURNAL-BASICS%20MGL-PAX:SECTION" title="Basics">&#8594;</a> <a href="#JOURNAL:@JOURNAL-FEATURES%20MGL-PAX:SECTION" title="Distinguishing features">&#8634;</a> <a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L82">&#955;</a></span></span></p>

<h2><a href="#JOURNAL:@JOURNAL-FEATURES%20MGL-PAX:SECTION">5 Distinguishing features</a></h2>

<h5>As a logging facility</h5>

<ul>
<li><p>Nested contexts and single messages</p></li>
<li><p>Customizable content and format</p></li>
<li><p>Human- or machine-readable output</p></li>
</ul>

<pre><code><span class="code">#68200.234: <span class="paren1">(<span class="code"><span class="string">"some-context"</span></span>)</span>
#68200.234:   Informative log message
#68200.250: =&gt; NIL</span></code></pre>

<p>See <a href="#JOURNAL:@LOGGING%20MGL-PAX:SECTION" title="Logging">Logging</a> for a complete example.</p>

<h5>Compared to <a href="http://www.lispworks.com/documentation/HyperSpec/Body/m_tracec.htm" title="TRACE MGL-PAX:MACRO"><code>cl:trace</code></a></h5>

<ul>
<li><p>Ability to handle <a href="#JOURNAL:@NON-LOCAL-EXIT%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@NON-LOCAL-EXIT MGL-PAX:GLOSSARY-TERM">non-local exit</a>s</p></li>
<li><p>Customizable content and format</p></li>
<li><p>Optional timestamps, internal real- and run-time</p></li>
</ul>

<pre><code><span class="code"><span class="paren1">(<span class="code">FOO 2.1</span>)</span>
  <span class="paren1">(<span class="code">1+ 2.1</span>)</span>
  =&gt; 3.1
=E "SIMPLE-ERROR" "The assertion <span class="paren1">(<span class="code">INTEGERP 3.1</span>)</span> failed."</span></code></pre>

<p>See <a href="#JOURNAL:@TRACING%20MGL-PAX:SECTION" title="Tracing">Tracing</a> for a complete example.</p>

<h5>As a test framework</h5>

<ul>
<li><p>White-box testing based on execution traces</p></li>
<li><p>Isolation of external dependencies</p></li>
<li><p>Record-and-replay testing</p></li>
</ul>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">define-file-bundle-test</span></i> <span class="paren2">(<span class="code">test-user-registration <span class="keyword">:directory</span> <span class="string">"registration"</span></span>)</span>
  <span class="paren2">(<span class="code"><i><span class="symbol">let</span></i> <span class="paren3">(<span class="code"><span class="paren4">(<span class="code">username <span class="paren5">(<span class="code">replayed <span class="paren6">(<span class="code"><span class="string">"ask-username"</span></span>)</span>
                    <span class="paren6">(<span class="code">format t <span class="string">"Please type your username: "</span></span>)</span>
                    <span class="paren6">(<span class="code">read-line</span>)</span></span>)</span></span>)</span></span>)</span>
    <span class="paren3">(<span class="code">add-user username</span>)</span>
    <span class="paren3">(<span class="code">assert <span class="paren4">(<span class="code">user-exists-p username</span>)</span></span>)</span></span>)</span></span>)</span></span></code></pre>

<p>See <a href="#JOURNAL:@TESTING%20MGL-PAX:SECTION" title="Testing">Testing</a> for a complete example.</p>

<h5>As a solution for persistence</h5>

<ul>
<li><p>Event Sourcing: replay interactions with the external world</p></li>
<li><p>Unchanged control flow</p></li>
<li><p>Easy to implement history, undo</p></li>
</ul>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">defun</span></i> my-resumable-autosaving-game-with-history <span class="paren2">(<span class="code"></span>)</span>
  <span class="paren2">(<span class="code"><i><span class="symbol">with-bundle</span></i> <span class="paren3">(<span class="code">bundle</span>)</span>
    <span class="paren3">(<span class="code">play-guess-my-number</span>)</span></span>)</span></span>)</span></span></code></pre>

<p>See <a href="#JOURNAL:@PERSISTENCE%20MGL-PAX:SECTION" title="Persistence">Persistence</a> for a complete example.</p>

<p><a id="x-28JOURNAL-3A-40JOURNAL-BASICS-20MGL-PAX-3ASECTION-29"></a>
<a id="JOURNAL:@JOURNAL-BASICS%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#JOURNAL:@JOURNAL-FEATURES%20MGL-PAX:SECTION" title="Distinguishing features">&#8592;</a> <a href="journal-manual.html" title="Journal manual">&#8593;</a> <a href="#JOURNAL:@IN-EVENTS%20MGL-PAX:SECTION" title="In-events">&#8594;</a> <a href="#JOURNAL:@JOURNAL-BASICS%20MGL-PAX:SECTION" title="Basics">&#8634;</a> <a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L896">&#955;</a></span></span></p>

<h2><a href="#JOURNAL:@JOURNAL-BASICS%20MGL-PAX:SECTION">6 Basics</a></h2>

<p>The <a href="#JOURNAL:JOURNALED%20MGL-PAX:MACRO" title="JOURNAL:JOURNALED MGL-PAX:MACRO"><code>journaled</code></a> macro does both recording and replaying of events,
possibly at the same time. Recording is easy: events generated by
<code>journaled</code> are simply written to a journal, which is a sequence of
events much like a file. What events are generated is described in
<code>journaled</code>. <a href="#JOURNAL:@REPLAY%20MGL-PAX:SECTION" title="Replay">Replay</a> is much more involved, thus it gets its own
section. The journals used for recording and replaying are specified
by <a href="#JOURNAL:WITH-JOURNALING%20MGL-PAX:MACRO" title="JOURNAL:WITH-JOURNALING MGL-PAX:MACRO"><code>with-journaling</code></a> or by <a href="#JOURNAL:WITH-BUNDLE%20MGL-PAX:MACRO" title="JOURNAL:WITH-BUNDLE MGL-PAX:MACRO"><code>with-bundle</code></a>.</p>

<p>The <a href="#JOURNAL:@JOURNALS-REFERENCE%20MGL-PAX:SECTION" title="Journals reference">Journals reference</a> is presented later, but for most purposes,
creating them (e.g. with <a href="#JOURNAL:MAKE-IN-MEMORY-JOURNAL%20FUNCTION" title="JOURNAL:MAKE-IN-MEMORY-JOURNAL FUNCTION"><code>make-in-memory-journal</code></a>, <a href="#JOURNAL:MAKE-FILE-JOURNAL%20FUNCTION" title="JOURNAL:MAKE-FILE-JOURNAL FUNCTION"><code>make-file-journal</code></a>)
and maybe querying their contents with <a href="#JOURNAL:LIST-EVENTS%20FUNCTION" title="JOURNAL:LIST-EVENTS FUNCTION"><code>list-events</code></a> will suffice.
Some common cases of journal creation are handled by the convenience
function <a href="#JOURNAL:TO-JOURNAL%20GENERIC-FUNCTION" title="JOURNAL:TO-JOURNAL GENERIC-FUNCTION"><code>to-journal</code></a>.</p>

<p>Built on top of journals, <a href="#JOURNAL:@BUNDLES%20MGL-PAX:SECTION" title="Bundles">Bundles</a> juggle repeated replay-and-record
cycles focussing on persistence.</p>

<p><a id="x-28JOURNAL-3ATO-JOURNAL-20GENERIC-FUNCTION-29"></a>
<a id="JOURNAL:TO-JOURNAL%20GENERIC-FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L927">[generic-function]</a></span> <span class="reference-object"><a href="#JOURNAL:TO-JOURNAL%20GENERIC-FUNCTION" >to-journal</a></span></span> <span class="locative-args">designator</span></span></p>

<p>Return the journal designated by <code>designator</code> or
signal an error. The default implementation:</p>

<ul>
<li><p>returns <code>designator</code> itself if it is of type <a href="#JOURNAL:JOURNAL%20CLASS" title="JOURNAL:JOURNAL CLASS"><code>journal</code></a>,</p></li>
<li><p>returns a new <a href="#JOURNAL:IN-MEMORY-JOURNAL%20CLASS" title="JOURNAL:IN-MEMORY-JOURNAL CLASS"><code>in-memory-journal</code></a> if <code>designator</code> is <code>t</code>,</p></li>
<li><p>returns a new <a href="#JOURNAL:FILE-JOURNAL%20CLASS" title="JOURNAL:FILE-JOURNAL CLASS"><code>file-journal</code></a> if <code>designator</code> is a <code>pathname</code>(<a href="http://www.lispworks.com/documentation/HyperSpec/Body/t_pn.htm" title="PATHNAME CLASS"><code>0</code></a> <a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_pn.htm" title="PATHNAME FUNCTION"><code>1</code></a>).</p></li>
</ul></li>
</ul>

<p><a id="x-28JOURNAL-3AWITH-JOURNALING-20MGL-PAX-3AMACRO-29"></a>
<a id="JOURNAL:WITH-JOURNALING%20MGL-PAX:MACRO"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L943">[macro]</a></span> <span class="reference-object"><a href="#JOURNAL:WITH-JOURNALING%20MGL-PAX:MACRO" >with-journaling</a></span></span> <span class="locative-args">(&amp;key record replay replay-eoj-error-p) &amp;body body</span></span></p>

<p>Turn recording and/or replaying of events on or off for the
duration of <code>body</code>. Both <code>record</code> and <code>replay</code> should be a <a href="#JOURNAL:JOURNAL%20CLASS" title="JOURNAL:JOURNAL CLASS"><code>journal</code></a>
designator (in the sense of <a href="#JOURNAL:TO-JOURNAL%20GENERIC-FUNCTION" title="JOURNAL:TO-JOURNAL GENERIC-FUNCTION"><code>to-journal</code></a>) or <code>nil</code>.</p>

<p>If <code>record</code> designates a <code>journal</code>, then events generated by enclosed
<a href="#JOURNAL:JOURNALED%20MGL-PAX:MACRO" title="JOURNAL:JOURNALED MGL-PAX:MACRO"><code>journaled</code></a> <a href="#JOURNAL:@BLOCK%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@BLOCK MGL-PAX:GLOSSARY-TERM">block</a>s are written to that journal (with exceptions, see
the <code>log-record</code> argument of <code>journaled</code>). If <code>replay</code> designates a
<code>journal</code>, then the generated events are matched against events from
that journal according to the rules of <a href="#JOURNAL:@REPLAY%20MGL-PAX:SECTION" title="Replay">Replay</a>.</p>

<p>A <a href="#JOURNAL:JOURNAL-ERROR%20CONDITION" title="JOURNAL:JOURNAL-ERROR CONDITION"><code>journal-error</code></a> is signalled if <code>record</code> is a <code>journal</code> that has been
previously recorded to by another <code>with-journaling</code> (that is, if its
<a href="#JOURNAL:JOURNAL-STATE%20TYPE" title="JOURNAL:JOURNAL-STATE TYPE"><code>journal-state</code></a> is not <code>:new</code>) or if <code>replay</code> is a <code>journal</code> that is not a
complete recording of successful replay (i.e. its <code>journal-state</code> is
not <code>:completed</code>). These checks are intended to catch mistakes that
would render the new or existing records unusable for replay. When
<code>with-journaling</code> finishes, the <code>record</code> journal is marked <code>:completed</code> or
<code>:failed</code> in its <code>journal-state</code>.</p>

<p><code>replay-eoj-error-p</code> controls whether <a href="#JOURNAL:END-OF-JOURNAL%20CONDITION" title="JOURNAL:END-OF-JOURNAL CONDITION"><code>end-of-journal</code></a> is signalled when
a new event is being matched to the replay journal from which there
are no more events to read. If there was a <a href="#JOURNAL:JOURNALING-FAILURE%20CONDITION" title="JOURNAL:JOURNALING-FAILURE CONDITION"><code>journaling-failure</code></a> or a
<a href="#JOURNAL:REPLAY-FAILURE%20CONDITION" title="JOURNAL:REPLAY-FAILURE CONDITION"><code>replay-failure</code></a> during execution, then <code>end-of-journal</code> is not
signalled.</p>

<p>If <code>body</code> completes successfully, but <code>replay</code> has unprocessed events,
then <a href="#JOURNAL:REPLAY-INCOMPLETE%20CONDITION" title="JOURNAL:REPLAY-INCOMPLETE CONDITION"><code>replay-incomplete</code></a> is signalled.</p>

<p><code>with-journaling</code> for different <code>record</code> journals can be nested and run
independently.</p></li>
</ul>

<p><a id="x-28JOURNAL-3A-40BLOCK-20MGL-PAX-3AGLOSSARY-TERM-29"></a>
<a id="JOURNAL:@BLOCK%20MGL-PAX:GLOSSARY-TERM"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L982">[glossary-term]</a></span> <span class="reference-object"><a href="#JOURNAL:@BLOCK%20MGL-PAX:GLOSSARY-TERM" >block</a></span></span></span></p>

<p>A journaled block, or simply block, is a number of forms wrapped in
<a href="#JOURNAL:JOURNALED%20MGL-PAX:MACRO" title="JOURNAL:JOURNALED MGL-PAX:MACRO"><code>journaled</code></a>. When a block is executed, a <a href="#JOURNAL:@FRAME%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@FRAME MGL-PAX:GLOSSARY-TERM">frame</a> is created.</p></li>
</ul>

<p><a id="x-28JOURNAL-3A-40FRAME-20MGL-PAX-3AGLOSSARY-TERM-29"></a>
<a id="JOURNAL:@FRAME%20MGL-PAX:GLOSSARY-TERM"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L986">[glossary-term]</a></span> <span class="reference-object"><a href="#JOURNAL:@FRAME%20MGL-PAX:GLOSSARY-TERM" >frame</a></span></span></span></p>

<p>A frame is an <a href="#JOURNAL:IN-EVENT%20TYPE" title="JOURNAL:IN-EVENT TYPE"><code>in-event</code></a>, <a href="#JOURNAL:OUT-EVENT%20TYPE" title="JOURNAL:OUT-EVENT TYPE"><code>out-event</code></a> pair, which are created when a
<a href="#JOURNAL:@BLOCK%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@BLOCK MGL-PAX:GLOSSARY-TERM">block</a> is entered and left, respectively.</p></li>
</ul>

<p><a id="x-28JOURNAL-3ARECORD-JOURNAL-20FUNCTION-29"></a>
<a id="JOURNAL:RECORD-JOURNAL%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L1006">[function]</a></span> <span class="reference-object"><a href="#JOURNAL:RECORD-JOURNAL%20FUNCTION" >record-journal</a></span></span></span></p>

<p>Return the <a href="#JOURNAL:JOURNAL%20CLASS" title="JOURNAL:JOURNAL CLASS"><code>journal</code></a> in which events are currently being
recorded (see <a href="#JOURNAL:WITH-JOURNALING%20MGL-PAX:MACRO" title="JOURNAL:WITH-JOURNALING MGL-PAX:MACRO"><code>with-journaling</code></a> and <a href="#JOURNAL:WITH-BUNDLE%20MGL-PAX:MACRO" title="JOURNAL:WITH-BUNDLE MGL-PAX:MACRO"><code>with-bundle</code></a>) or <code>nil</code>.</p></li>
</ul>

<p><a id="x-28JOURNAL-3AREPLAY-JOURNAL-20FUNCTION-29"></a>
<a id="JOURNAL:REPLAY-JOURNAL%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L1000">[function]</a></span> <span class="reference-object"><a href="#JOURNAL:REPLAY-JOURNAL%20FUNCTION" >replay-journal</a></span></span></span></p>

<p>Return the <a href="#JOURNAL:JOURNAL%20CLASS" title="JOURNAL:JOURNAL CLASS"><code>journal</code></a> from which events are currently being
replayed (see <a href="#JOURNAL:WITH-JOURNALING%20MGL-PAX:MACRO" title="JOURNAL:WITH-JOURNALING MGL-PAX:MACRO"><code>with-journaling</code></a> and <a href="#JOURNAL:WITH-BUNDLE%20MGL-PAX:MACRO" title="JOURNAL:WITH-BUNDLE MGL-PAX:MACRO"><code>with-bundle</code></a>) or <code>nil</code>.</p></li>
</ul>

<p><a id="x-28JOURNAL-3AJOURNALED-20MGL-PAX-3AMACRO-29"></a>
<a id="JOURNAL:JOURNALED%20MGL-PAX:MACRO"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L1215">[macro]</a></span> <span class="reference-object"><a href="#JOURNAL:JOURNALED%20MGL-PAX:MACRO" >journaled</a></span></span> <span class="locative-args">(name &amp;key (log-record :record) version args values condition insertable replay-values replay-condition) &amp;body body</span></span></p>

<p><code>journaled</code> generates events upon entering and leaving the dynamic
extent of <code>body</code> (also known as the journaled <a href="#JOURNAL:@BLOCK%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@BLOCK MGL-PAX:GLOSSARY-TERM">block</a>), which we call
the <a href="#JOURNAL:@IN-EVENTS%20MGL-PAX:SECTION" title="In-events">In-events</a> and <a href="#JOURNAL:@OUT-EVENTS%20MGL-PAX:SECTION" title="Out-events">Out-events</a>. Between generating the two events,
<code>body</code> is typically executed normally (except for
<a href="#JOURNAL:@REPLAYING-THE-OUTCOME%20MGL-PAX:SECTION" title="Replaying the outcome">Replaying the outcome</a>).</p>

<p>Where the generated events are written is determined by the <code>:record</code>
argument of the enclosing <a href="#JOURNAL:WITH-JOURNALING%20MGL-PAX:MACRO" title="JOURNAL:WITH-JOURNALING MGL-PAX:MACRO"><code>with-journaling</code></a>. If there is no enclosing
<code>with-journaling</code> and <code>log-record</code> is <code>nil</code>, then event recording is
turned off and <code>journaled</code> imposes minimal overhead.</p>

<ul>
<li><p><code>name</code> can be of any type except <a href="http://www.lispworks.com/documentation/HyperSpec/Body/t_null.htm" title="NULL CLASS"><code>null</code></a>, not evaluated. For
  names, and for anything that gets written to a journal, a
  non-keyword symbol is a reasonable choice as it can be easily made
  unique. However, it also exposes the package structure, which
  might make reading stuff back more difficult. Keywords and strings
  do not have this problem.</p></li>
<li><p><code>args</code> can be of any type, but is typically a list.</p></li>
</ul>

<p>Also see <a href="#JOURNAL:@LOG-RECORD%20MGL-PAX:SECTION" title="`:log-record`"><code>:log-record</code></a> in the <a href="#JOURNAL:@LOGGING%20MGL-PAX:SECTION" title="Logging">Logging</a> section. For a description of
<code>version</code>, <code>insertable</code>, <code>replay-values</code> and <code>replay-condition</code>, see
<a href="#JOURNAL:@JOURNALED-FOR-REPLAY%20MGL-PAX:SECTION" title="Journaled for replay">Journaled for replay</a>.</p></li>
</ul>

<p><a id="x-28JOURNAL-3A-40IN-EVENTS-20MGL-PAX-3ASECTION-29"></a>
<a id="JOURNAL:@IN-EVENTS%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#JOURNAL:@JOURNAL-BASICS%20MGL-PAX:SECTION" title="Basics">&#8592;</a> <a href="#JOURNAL:@JOURNAL-BASICS%20MGL-PAX:SECTION" title="Basics">&#8593;</a> <a href="#JOURNAL:@OUT-EVENTS%20MGL-PAX:SECTION" title="Out-events">&#8594;</a> <a href="#JOURNAL:@IN-EVENTS%20MGL-PAX:SECTION" title="In-events">&#8634;</a> <a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L1261">&#955;</a></span></span></p>

<h3><a href="#JOURNAL:@IN-EVENTS%20MGL-PAX:SECTION">6.1 In-events</a></h3>

<p>Upon entering a <a href="#JOURNAL:@BLOCK%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@BLOCK MGL-PAX:GLOSSARY-TERM">block</a>, <a href="#JOURNAL:JOURNALED%20MGL-PAX:MACRO" title="JOURNAL:JOURNALED MGL-PAX:MACRO"><code>journaled</code></a> generates an <a href="#JOURNAL:IN-EVENT%20TYPE" title="JOURNAL:IN-EVENT TYPE"><code>in-event</code></a>,
which conceptually opens a new <a href="#JOURNAL:@FRAME%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@FRAME MGL-PAX:GLOSSARY-TERM">frame</a>. These in-events are created
from the <code>name</code>, <code>version</code> and <code>args</code> arguments of <code>journaled</code>. For example,</p>

<pre><code><span class="code"><span class="paren1">(<span class="code">journaled <span class="paren2">(<span class="code">name <span class="keyword">:version</span> version <span class="keyword">:args</span> args</span>)</span> ...</span>)</span></span></code></pre>

<p>creates an event like this:</p>

<pre><code><span class="code">`<span class="paren1">(<span class="code"><span class="keyword">:in</span> ,name <span class="keyword">:version</span> ,version <span class="keyword">:args</span> ,args</span>)</span></span></code></pre>

<p>where <code>:version</code> and <code>:args</code> may be omitted if they are <code>nil</code>. Versions
are used for <a href="#JOURNAL:@REPLAY%20MGL-PAX:SECTION" title="Replay">Replay</a>.</p>

<p><a id="x-28JOURNAL-3A-40OUT-EVENTS-20MGL-PAX-3ASECTION-29"></a>
<a id="JOURNAL:@OUT-EVENTS%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#JOURNAL:@IN-EVENTS%20MGL-PAX:SECTION" title="In-events">&#8592;</a> <a href="#JOURNAL:@JOURNAL-BASICS%20MGL-PAX:SECTION" title="Basics">&#8593;</a> <a href="#JOURNAL:@WORKING-WITH-UNREADABLE-VALUES%20MGL-PAX:SECTION" title="Working with unreadable values">&#8594;</a> <a href="#JOURNAL:@OUT-EVENTS%20MGL-PAX:SECTION" title="Out-events">&#8634;</a> <a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L1281">&#955;</a></span></span></p>

<h3><a href="#JOURNAL:@OUT-EVENTS%20MGL-PAX:SECTION">6.2 Out-events</a></h3>

<p>Upon leaving a <a href="#JOURNAL:@BLOCK%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@BLOCK MGL-PAX:GLOSSARY-TERM">block</a>, <a href="#JOURNAL:JOURNALED%20MGL-PAX:MACRO" title="JOURNAL:JOURNALED MGL-PAX:MACRO"><code>journaled</code></a> generates an <a href="#JOURNAL:OUT-EVENT%20TYPE" title="JOURNAL:OUT-EVENT TYPE"><code>out-event</code></a>, closing
the <a href="#JOURNAL:@FRAME%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@FRAME MGL-PAX:GLOSSARY-TERM">frame</a> opened by the corresponding <a href="#JOURNAL:IN-EVENT%20TYPE" title="JOURNAL:IN-EVENT TYPE"><code>in-event</code></a>. These out-events
are property lists like this:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><span class="keyword">:out</span> foo <span class="keyword">:version</span> 1 <span class="keyword">:values</span> <span class="paren2">(<span class="code">42</span>)</span></span>)</span></span></code></pre>

<p>Their <code>name</code> and <code>version</code> (<code>foo</code> and <code>1</code> in the example) are the same
as in the in-event: they come from the corresponding arguments of
<code>journaled</code>. <code>exit</code> and <code>outcome</code> are filled in differently depending on
how the block finished its execution.</p>

<p><a id="x-28JOURNAL-3AEVENT-EXIT-20TYPE-29"></a>
<a id="JOURNAL:EVENT-EXIT%20TYPE"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L1304">[type]</a></span> <span class="reference-object"><a href="#JOURNAL:EVENT-EXIT%20TYPE" >event-exit</a></span></span></span></p>

<p>One of <code>:values</code>, <code>:condition</code>, <code>:error</code> and <code>:nlx</code>. Indicates whether a
journaled <a href="#JOURNAL:@BLOCK%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@BLOCK MGL-PAX:GLOSSARY-TERM">block</a></p>

<ul>
<li><p>returned normally (<code>:values</code>, see <a href="#JOURNAL:@VALUES-OUTCOME%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@VALUES-OUTCOME MGL-PAX:GLOSSARY-TERM">values outcome</a>),</p></li>
<li><p>unwound on an expected condition (<code>:condition</code>, see <a href="#JOURNAL:@CONDITION-OUTCOME%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@CONDITION-OUTCOME MGL-PAX:GLOSSARY-TERM">condition outcome</a>),</p></li>
<li><p>unwound on an unexpected condition (<code>:error</code>, see <a href="#JOURNAL:@ERROR-OUTCOME%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@ERROR-OUTCOME MGL-PAX:GLOSSARY-TERM">error outcome</a>),</p></li>
<li><p>unwound by performing a <a href="#JOURNAL:@NON-LOCAL-EXIT%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@NON-LOCAL-EXIT MGL-PAX:GLOSSARY-TERM">non-local exit</a> of some other kind such as
  a throw (<code>:nlx</code>, see <a href="#JOURNAL:@NLX-OUTCOME%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@NLX-OUTCOME MGL-PAX:GLOSSARY-TERM">nlx outcome</a>).</p></li>
</ul>

<p>The first two are <a href="#JOURNAL:@EXPECTED-OUTCOME%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@EXPECTED-OUTCOME MGL-PAX:GLOSSARY-TERM">expected outcome</a>s, while the latter two are
<a href="#JOURNAL:@UNEXPECTED-OUTCOME%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@UNEXPECTED-OUTCOME MGL-PAX:GLOSSARY-TERM">unexpected outcome</a>s.</p></li>
</ul>

<p><a id="x-28JOURNAL-3A-40VALUES-OUTCOME-20MGL-PAX-3AGLOSSARY-TERM-29"></a>
<a id="JOURNAL:@VALUES-OUTCOME%20MGL-PAX:GLOSSARY-TERM"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L1321">[glossary-term]</a></span> <span class="reference-object"><a href="#JOURNAL:@VALUES-OUTCOME%20MGL-PAX:GLOSSARY-TERM" >values outcome</a></span></span></span></p>

<p>If the <a href="#JOURNAL:JOURNALED%20MGL-PAX:MACRO" title="JOURNAL:JOURNALED MGL-PAX:MACRO"><code>journaled</code></a> <a href="#JOURNAL:@BLOCK%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@BLOCK MGL-PAX:GLOSSARY-TERM">block</a> returns normally, <a href="#JOURNAL:EVENT-EXIT%20TYPE" title="JOURNAL:EVENT-EXIT TYPE"><code>event-exit</code></a> is
<code>:values</code>, and the outcome is the list of values returned:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code">journaled <span class="paren2">(<span class="code">foo</span>)</span> <span class="paren2">(<span class="code">values 7 t</span>)</span></span>)</span>
<span class="comment">;; generates the out-event
</span><span class="paren1">(<span class="code"><span class="keyword">:out</span> foo <span class="keyword">:values</span> <span class="paren2">(<span class="code">7 t</span>)</span></span>)</span></span></code></pre>

<p>The list of return values of the block is transformed by the <code>values</code>
argument of <code>journaled</code>, whose default is <code>#'identity</code>. Also see
<a href="#JOURNAL:@WORKING-WITH-UNREADABLE-VALUES%20MGL-PAX:SECTION" title="Working with unreadable values">Working with unreadable values</a>).</p></li>
</ul>

<p><a id="x-28JOURNAL-3A-40CONDITION-OUTCOME-20MGL-PAX-3AGLOSSARY-TERM-29"></a>
<a id="JOURNAL:@CONDITION-OUTCOME%20MGL-PAX:GLOSSARY-TERM"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L1336">[glossary-term]</a></span> <span class="reference-object"><a href="#JOURNAL:@CONDITION-OUTCOME%20MGL-PAX:GLOSSARY-TERM" >condition outcome</a></span></span></span></p>

<p>If the <a href="#JOURNAL:@BLOCK%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@BLOCK MGL-PAX:GLOSSARY-TERM">block</a> unwound due to a condition, and <a href="#JOURNAL:JOURNALED%20MGL-PAX:MACRO" title="JOURNAL:JOURNALED MGL-PAX:MACRO"><code>journaled</code></a>'s
<code>condition</code> argument (a function whose default is <code>(constantly nil)</code>)
returns non-NIL when invoked on it, then <a href="#JOURNAL:EVENT-EXIT%20TYPE" title="JOURNAL:EVENT-EXIT TYPE"><code>event-exit</code></a> is
<code>:condition</code>, and the outcome is this return value:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code">journaled <span class="paren2">(<span class="code">foo <span class="keyword">:condition</span> <span class="paren3">(<span class="code"><i><span class="symbol">lambda</span></i> <span class="paren4">(<span class="code">c</span>)</span> <span class="paren4">(<span class="code">prin1-to-string c</span>)</span></span>)</span></span>)</span>
  <span class="paren2">(<span class="code">error <span class="string">"xxx"</span></span>)</span></span>)</span>
<span class="comment">;; generates the out-event
</span><span class="paren1">(<span class="code"><span class="keyword">:out</span> foo <span class="keyword">:condition</span> <span class="string">"xxx"</span></span>)</span></span></code></pre>

<p>Conditions thus recognized are those that can be considered part of
normal execution. Just like return values, these expected conditions
may be required to match what's in the replay journal. Furthermore,
given a suitable <code>replay-condition</code> in <code>journaled</code>, they may be replayed
without running the <a href="#JOURNAL:@BLOCK%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@BLOCK MGL-PAX:GLOSSARY-TERM">block</a>.</p></li>
</ul>

<p><a id="x-28JOURNAL-3A-40ERROR-OUTCOME-20MGL-PAX-3AGLOSSARY-TERM-29"></a>
<a id="JOURNAL:@ERROR-OUTCOME%20MGL-PAX:GLOSSARY-TERM"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L1355">[glossary-term]</a></span> <span class="reference-object"><a href="#JOURNAL:@ERROR-OUTCOME%20MGL-PAX:GLOSSARY-TERM" >error outcome</a></span></span></span></p>

<p>If the <a href="#JOURNAL:JOURNALED%20MGL-PAX:MACRO" title="JOURNAL:JOURNALED MGL-PAX:MACRO"><code>journaled</code></a> <a href="#JOURNAL:@BLOCK%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@BLOCK MGL-PAX:GLOSSARY-TERM">block</a> unwound due to a condition, but
<code>journaled</code>'s <code>condition</code> argument returns <code>nil</code> when invoked on it, then
<a href="#JOURNAL:EVENT-EXIT%20TYPE" title="JOURNAL:EVENT-EXIT TYPE"><code>event-exit</code></a> is <code>:error</code> and the outcome the string
representations of the type of the condition and the condition
itself.</p>

<pre><code><span class="code"><span class="paren1">(<span class="code">journaled <span class="paren2">(<span class="code">foo</span>)</span>
  <span class="paren2">(<span class="code">error <span class="string">"xxx"</span></span>)</span></span>)</span>
<span class="comment">;; generates this out-event:
</span><span class="comment">;; (:out foo :error ("simple-error" "xxx"))</span></span></code></pre>

<p>The conversion to string is performed with <a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_wr_pr.htm" title="PRINC FUNCTION"><code>princ</code></a> in
<a href="http://www.lispworks.com/documentation/HyperSpec/Body/m_w_std_.htm" title="WITH-STANDARD-IO-SYNTAX MGL-PAX:MACRO"><code>with-standard-io-syntax</code></a>. This scheme is intended to avoid leaking
random implementation details into the journal, which would make
<a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_rd_rd.htm" title="READ FUNCTION"><code>read</code></a>ing it back difficult.</p>

<p>In contrast with <a href="#JOURNAL:@CONDITION-OUTCOME%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@CONDITION-OUTCOME MGL-PAX:GLOSSARY-TERM">condition outcome</a>s, error outcomes are what the
code is not prepared to handle or replay in a meaningful way.</p></li>
</ul>

<p><a id="x-28JOURNAL-3A-40NLX-OUTCOME-20MGL-PAX-3AGLOSSARY-TERM-29"></a>
<a id="JOURNAL:@NLX-OUTCOME%20MGL-PAX:GLOSSARY-TERM"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L1377">[glossary-term]</a></span> <span class="reference-object"><a href="#JOURNAL:@NLX-OUTCOME%20MGL-PAX:GLOSSARY-TERM" >nlx outcome</a></span></span></span></p>

<p>If the <a href="#JOURNAL:JOURNALED%20MGL-PAX:MACRO" title="JOURNAL:JOURNALED MGL-PAX:MACRO"><code>journaled</code></a> <a href="#JOURNAL:@BLOCK%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@BLOCK MGL-PAX:GLOSSARY-TERM">block</a> performed a <a href="#JOURNAL:@NON-LOCAL-EXIT%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@NON-LOCAL-EXIT MGL-PAX:GLOSSARY-TERM">non-local exit</a> that was not
due to a condition, then <a href="#JOURNAL:EVENT-EXIT%20TYPE" title="JOURNAL:EVENT-EXIT TYPE"><code>event-exit</code></a> is <code>:nlx</code> and the outcome
is <code>nil</code>.</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">catch</span></i> 'xxx
  <span class="paren2">(<span class="code">journaled <span class="paren3">(<span class="code">foo</span>)</span>
    <span class="paren3">(<span class="code"><i><span class="symbol">throw</span></i> 'xxx nil</span>)</span></span>)</span></span>)</span>
<span class="comment">;; generates the out-event
</span><span class="paren1">(<span class="code"><span class="keyword">:out</span> foo <span class="keyword">:nlx</span> nil</span>)</span></span></code></pre>

<p>Note that <a href="#JOURNAL:@CONDITION-OUTCOME%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@CONDITION-OUTCOME MGL-PAX:GLOSSARY-TERM">condition outcome</a>s and <a href="#JOURNAL:@ERROR-OUTCOME%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@ERROR-OUTCOME MGL-PAX:GLOSSARY-TERM">error outcome</a>s are also due to
<a href="#JOURNAL:@NON-LOCAL-EXIT%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@NON-LOCAL-EXIT MGL-PAX:GLOSSARY-TERM">non-local exit</a>s but are distinct from nlx outcomes.</p>

<p>Currently, nlx outcomes are detected rather heuristically as there
is no portable way to detect what really caused the unwinding of the
stack.</p></li>
</ul>

<p>There is a further grouping of outcomes into expected and unexpected.</p>

<p><a id="x-28JOURNAL-3A-40EXPECTED-OUTCOME-20MGL-PAX-3AGLOSSARY-TERM-29"></a>
<a id="JOURNAL:@EXPECTED-OUTCOME%20MGL-PAX:GLOSSARY-TERM"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L1397">[glossary-term]</a></span> <span class="reference-object"><a href="#JOURNAL:@EXPECTED-OUTCOME%20MGL-PAX:GLOSSARY-TERM" >expected outcome</a></span></span></span></p>

<p>An <a href="#JOURNAL:OUT-EVENT%20TYPE" title="JOURNAL:OUT-EVENT TYPE"><code>out-event</code></a> is said to have an expected outcome if it had a
<a href="#JOURNAL:@VALUES-OUTCOME%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@VALUES-OUTCOME MGL-PAX:GLOSSARY-TERM">values outcome</a> or a <a href="#JOURNAL:@CONDITION-OUTCOME%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@CONDITION-OUTCOME MGL-PAX:GLOSSARY-TERM">condition outcome</a>, or equivalently, when its
<a href="#JOURNAL:EVENT-EXIT%20TYPE" title="JOURNAL:EVENT-EXIT TYPE"><code>event-exit</code></a> is <code>:values</code> or <code>:condition</code>.</p></li>
</ul>

<p><a id="x-28JOURNAL-3A-40UNEXPECTED-OUTCOME-20MGL-PAX-3AGLOSSARY-TERM-29"></a>
<a id="JOURNAL:@UNEXPECTED-OUTCOME%20MGL-PAX:GLOSSARY-TERM"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L1402">[glossary-term]</a></span> <span class="reference-object"><a href="#JOURNAL:@UNEXPECTED-OUTCOME%20MGL-PAX:GLOSSARY-TERM" >unexpected outcome</a></span></span></span></p>

<p>An <a href="#JOURNAL:OUT-EVENT%20TYPE" title="JOURNAL:OUT-EVENT TYPE"><code>out-event</code></a> is said to have an unexpected outcome if it had an
<a href="#JOURNAL:@ERROR-OUTCOME%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@ERROR-OUTCOME MGL-PAX:GLOSSARY-TERM">error outcome</a> or an <a href="#JOURNAL:@NLX-OUTCOME%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@NLX-OUTCOME MGL-PAX:GLOSSARY-TERM">nlx outcome</a>, or equivalently, when its
<a href="#JOURNAL:EVENT-EXIT%20TYPE" title="JOURNAL:EVENT-EXIT TYPE"><code>event-exit</code></a> is <code>:error</code> or <code>:nlx</code>.</p></li>
</ul>

<p><a id="x-28JOURNAL-3A-40WORKING-WITH-UNREADABLE-VALUES-20MGL-PAX-3ASECTION-29"></a>
<a id="JOURNAL:@WORKING-WITH-UNREADABLE-VALUES%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#JOURNAL:@OUT-EVENTS%20MGL-PAX:SECTION" title="Out-events">&#8592;</a> <a href="#JOURNAL:@JOURNAL-BASICS%20MGL-PAX:SECTION" title="Basics">&#8593;</a> <a href="#JOURNAL:@JOURNAL-UTILITIES%20MGL-PAX:SECTION" title="Utilities">&#8594;</a> <a href="#JOURNAL:@WORKING-WITH-UNREADABLE-VALUES%20MGL-PAX:SECTION" title="Working with unreadable values">&#8634;</a> <a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L1408">&#955;</a></span></span></p>

<h3><a href="#JOURNAL:@WORKING-WITH-UNREADABLE-VALUES%20MGL-PAX:SECTION">6.3 Working with unreadable values</a></h3>

<p>The events recorded often need to be <a href="#JOURNAL:@READABLE%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@READABLE MGL-PAX:GLOSSARY-TERM">readable</a>. This is always
required with <a href="#JOURNAL:FILE-JOURNAL%20CLASS" title="JOURNAL:FILE-JOURNAL CLASS"><code>file-journal</code></a>s, often with <a href="#JOURNAL:IN-MEMORY-JOURNAL%20CLASS" title="JOURNAL:IN-MEMORY-JOURNAL CLASS"><code>in-memory-journal</code></a>s, but
never with <a href="#JOURNAL:PPRINT-JOURNAL%20CLASS" title="JOURNAL:PPRINT-JOURNAL CLASS"><code>pprint-journal</code></a>s. By choosing an appropriate identifier or
string representation of the unreadable object to journal, this is
not a problem in practice. <a href="#JOURNAL:JOURNALED%20MGL-PAX:MACRO" title="JOURNAL:JOURNALED MGL-PAX:MACRO"><code>journaled</code></a> provides the <code>values</code>
hook for this purpose.</p>

<p>With <a href="#JOURNAL:EXTERNAL-EVENT%20TYPE" title="JOURNAL:EXTERNAL-EVENT TYPE"><code>external-event</code></a>s, whose outcome is replayed (see
<a href="#JOURNAL:@REPLAYING-THE-OUTCOME%20MGL-PAX:SECTION" title="Replaying the outcome">Replaying the outcome</a>), we also need to be able to reverse the
transformation of <code>values</code>, and this is what the
<code>replay-values</code> argument of <code>journaled</code> is for.</p>

<p>Let's see a complete example.</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">defclass</span></i> user <span class="paren2">(<span class="code"></span>)</span>
  <span class="paren2">(<span class="code"><span class="paren3">(<span class="code">id <span class="keyword">:initarg</span> <span class="keyword">:id</span> <span class="keyword">:reader</span> user-id</span>)</span></span>)</span></span>)</span>

<span class="paren1">(<span class="code"><i><span class="symbol">defmethod</span></i> print-object <span class="paren2">(<span class="code"><span class="paren3">(<span class="code">user user</span>)</span> stream</span>)</span>
  <span class="paren2">(<span class="code">print-unreadable-object <span class="paren3">(<span class="code">user stream <span class="keyword">:type</span> t</span>)</span>
    <span class="paren3">(<span class="code">format stream <span class="string">"~S"</span> <span class="paren4">(<span class="code">slot-value user 'id</span>)</span></span>)</span></span>)</span></span>)</span>

<span class="paren1">(<span class="code"><i><span class="symbol">defvar</span></i> <span class="special">*users*</span> <span class="paren2">(<span class="code">make-hash-table</span>)</span></span>)</span>

<span class="paren1">(<span class="code"><i><span class="symbol">defun</span></i> find-user <span class="paren2">(<span class="code">id</span>)</span>
  <span class="paren2">(<span class="code">gethash id <span class="special">*users*</span></span>)</span></span>)</span>

<span class="paren1">(<span class="code"><i><span class="symbol">defun</span></i> add-user <span class="paren2">(<span class="code">id</span>)</span>
  <span class="paren2">(<span class="code">setf <span class="paren3">(<span class="code">gethash id <span class="special">*users*</span></span>)</span> <span class="paren3">(<span class="code">make-instance 'user <span class="keyword">:id</span> id</span>)</span></span>)</span></span>)</span>

<span class="paren1">(<span class="code"><i><span class="symbol">defvar</span></i> <span class="special">*user7*</span> <span class="paren2">(<span class="code">add-user 7</span>)</span></span>)</span>

<span class="paren1">(<span class="code"><i><span class="symbol">defun</span></i> get-message <span class="paren2">(<span class="code"></span>)</span>
  <span class="paren2">(<span class="code">replayed <span class="paren3">(<span class="code">listen <span class="keyword">:values</span> <span class="paren4">(<span class="code">values-&gt; #'user-id</span>)</span>
                    <span class="keyword">:replay-values</span> <span class="paren4">(<span class="code">values&lt;- #'find-user</span>)</span></span>)</span>
    <span class="paren3">(<span class="code">values <span class="special">*user7*</span> <span class="string">"hello"</span></span>)</span></span>)</span></span>)</span>

<span class="paren1">(<span class="code">jtrace user-id find-user get-message</span>)</span>

<span class="paren1">(<span class="code"><i><span class="symbol">let</span></i> <span class="paren2">(<span class="code"><span class="paren3">(<span class="code">bundle <span class="paren4">(<span class="code">make-file-bundle <span class="string">"/tmp/user-example/"</span></span>)</span></span>)</span></span>)</span>
  <span class="paren2">(<span class="code">format t <span class="string">"Recording"</span></span>)</span>
  <span class="paren2">(<span class="code"><i><span class="symbol">with-bundle</span></i> <span class="paren3">(<span class="code">bundle</span>)</span>
    <span class="paren3">(<span class="code">get-message</span>)</span></span>)</span>
  <span class="paren2">(<span class="code">format t <span class="string">"~%Replaying"</span></span>)</span>
  <span class="paren2">(<span class="code"><i><span class="symbol">with-bundle</span></i> <span class="paren3">(<span class="code">bundle</span>)</span>
    <span class="paren3">(<span class="code">get-message</span>)</span></span>)</span></span>)</span>
.. Recording
.. <span class="paren1">(<span class="code">GET-MESSAGE</span>)</span>
..   <span class="paren1">(<span class="code">USER-ID #&lt;USER 7&gt;</span>)</span>
..   =&gt; 7
.. =&gt; #&lt;USER 7&gt;, "hello"
.. Replaying
.. <span class="paren1">(<span class="code">GET-MESSAGE</span>)</span>
..   <span class="paren1">(<span class="code">FIND-USER 7</span>)</span>
..   =&gt; #&lt;USER 7&gt;, T
.. =&gt; #&lt;USER 7&gt;, "hello"
==&gt; #&lt;USER 7&gt;
=&gt; "hello"</span></code></pre>

<p>To be able to journal the return values of <code>get-message</code>, the <code>user</code>
object must be transformed to something <a href="#JOURNAL:@READABLE%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@READABLE MGL-PAX:GLOSSARY-TERM">readable</a>. On the
<code>Recording</code> run, <code>(values-&gt; #'user-id)</code> replaces the user object
with its id in the <a href="#JOURNAL:EVENT-OUTCOME%20FUNCTION" title="JOURNAL:EVENT-OUTCOME FUNCTION"><code>event-outcome</code></a> recorded, but the original user
object is returned.</p>

<p>When <code>Replaying</code>, the journaled <a href="#JOURNAL:OUT-EVENT%20TYPE" title="JOURNAL:OUT-EVENT TYPE"><code>out-event</code></a> is replayed (see
<a href="#JOURNAL:@REPLAYING-THE-OUTCOME%20MGL-PAX:SECTION" title="Replaying the outcome">Replaying the outcome</a>):</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><span class="keyword">:OUT</span> GET-MESSAGE <span class="keyword">:VERSION</span> <span class="keyword">:INFINITY</span> <span class="keyword">:VALUES</span> <span class="paren2">(<span class="code">7 <span class="string">"hello"</span></span>)</span></span>)</span></span></code></pre>

<p>The user object is looked up according to <code>:replay-values</code> and is
returned along with <code>&quot;hello&quot;</code>.</p>

<p><a id="x-28JOURNAL-3AVALUES--3E-20FUNCTION-29"></a>
<a id="JOURNAL:VALUES-%3E%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L1489">[function]</a></span> <span class="reference-object"><a href="#JOURNAL:VALUES-%3E%20FUNCTION" >values-&gt;</a></span></span> <span class="locative-args">&amp;rest fns</span></span></p>

<p>A utility to create a function suitable as the <code>values</code>
argument of <a href="#JOURNAL:JOURNALED%20MGL-PAX:MACRO" title="JOURNAL:JOURNALED MGL-PAX:MACRO"><code>journaled</code></a>. The <a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_values.htm" title="VALUES FUNCTION"><code>values</code></a> function is called with the list
of values returned by the <a href="#JOURNAL:@BLOCK%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@BLOCK MGL-PAX:GLOSSARY-TERM">block</a> and returns a transformed set of
values that may be recorded in a journal. While arbitrary
transformations are allowed, <code>values-&gt;</code> handles the common case of
transforming individual elements of the list independently by
calling the functions in FN with the values of the list of the same
position.</p>

<pre><code><span class="code"><span class="paren1">(<span class="code">funcall <span class="paren2">(<span class="code">values-&gt; #'1+</span>)</span> '<span class="paren2">(<span class="code">7 <span class="keyword">:something</span></span>)</span></span>)</span>
=&gt; <span class="paren1">(<span class="code">8 <span class="keyword">:SOMETHING</span></span>)</span></span></code></pre>

<p>Note how <code>#'1+</code> is applied only to the first element of the values
list. The list of functions is shorter than the values list, so
<code>:something</code> is not transformed. A value can be left explicitly
untransformed by specifying #'<a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_identi.htm" title="IDENTITY FUNCTION"><code>identity</code></a> or <code>nil</code> as the function:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code">funcall <span class="paren2">(<span class="code">values-&gt; #'1+ nil #'symbol-name</span>)</span>
         '<span class="paren2">(<span class="code">7 <span class="keyword">:something</span> <span class="keyword">:another</span></span>)</span></span>)</span>
=&gt; <span class="paren1">(<span class="code">8 <span class="keyword">:SOMETHING</span> <span class="string">"ANOTHER"</span></span>)</span></span></code></pre></li>
</ul>

<p><a id="x-28JOURNAL-3AVALUES-3C--20FUNCTION-29"></a>
<a id="JOURNAL:VALUES%3C-%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L1520">[function]</a></span> <span class="reference-object"><a href="#JOURNAL:VALUES%3C-%20FUNCTION" >values&lt;-</a></span></span> <span class="locative-args">&amp;rest fns</span></span></p>

<p>The inverse of <a href="#JOURNAL:VALUES-%3E%20FUNCTION" title="JOURNAL:VALUES-&gt; FUNCTION"><code>values-&gt;</code></a>, this returns a function suitable as
the <code>replay-values</code> argument of <a href="#JOURNAL:JOURNALED%20MGL-PAX:MACRO" title="JOURNAL:JOURNALED MGL-PAX:MACRO"><code>journaled</code></a>. It does pretty much what
<code>values-&gt;</code> does, but the function returned returns the transformed
list as multiple values instead of as a list.</p>

<pre><code><span class="code"><span class="paren1">(<span class="code">funcall <span class="paren2">(<span class="code">values&lt;- #'1-</span>)</span> '<span class="paren2">(<span class="code">8 <span class="keyword">:something</span></span>)</span></span>)</span>
=&gt; 7
=&gt; :SOMETHING</span></code></pre></li>
</ul>

<p><a id="x-28JOURNAL-3A-40JOURNAL-UTILITIES-20MGL-PAX-3ASECTION-29"></a>
<a id="JOURNAL:@JOURNAL-UTILITIES%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#JOURNAL:@WORKING-WITH-UNREADABLE-VALUES%20MGL-PAX:SECTION" title="Working with unreadable values">&#8592;</a> <a href="#JOURNAL:@JOURNAL-BASICS%20MGL-PAX:SECTION" title="Basics">&#8593;</a> <a href="#JOURNAL:@PRETTY-PRINTING%20MGL-PAX:SECTION" title="Pretty-printing">&#8594;</a> <a href="#JOURNAL:@JOURNAL-UTILITIES%20MGL-PAX:SECTION" title="Utilities">&#8634;</a> <a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L1536">&#955;</a></span></span></p>

<h3><a href="#JOURNAL:@JOURNAL-UTILITIES%20MGL-PAX:SECTION">6.4 Utilities</a></h3>

<p><a id="x-28JOURNAL-3ALIST-EVENTS-20FUNCTION-29"></a>
<a id="JOURNAL:LIST-EVENTS%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L1541">[function]</a></span> <span class="reference-object"><a href="#JOURNAL:LIST-EVENTS%20FUNCTION" >list-events</a></span></span> <span class="locative-args">&amp;optional (journal (record-journal))</span></span></p>

<p>Return a list of all the events in the journal designated by
<code>journal</code>. Calls <a href="#JOURNAL:SYNC-JOURNAL%20FUNCTION" title="JOURNAL:SYNC-JOURNAL FUNCTION"><code>sync-journal</code></a> first to make sure that all writes are
taken into account.</p></li>
</ul>

<p><a id="x-28JOURNAL-3AEVENTS-TO-FRAMES-20FUNCTION-29"></a>
<a id="JOURNAL:EVENTS-TO-FRAMES%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L1552">[function]</a></span> <span class="reference-object"><a href="#JOURNAL:EVENTS-TO-FRAMES%20FUNCTION" >events-to-frames</a></span></span> <span class="locative-args">events</span></span></p>

<p>Convert a flat list of events, such as those returned by <a href="#JOURNAL:LIST-EVENTS%20FUNCTION" title="JOURNAL:LIST-EVENTS FUNCTION"><code>list-events</code></a>,
to a nested list representing the <a href="#JOURNAL:@FRAME%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@FRAME MGL-PAX:GLOSSARY-TERM">frame</a>s. Each frame is a list of
the form <code>(&lt;in-event&gt; &lt;nested-frames&gt;* &lt;out-event&gt;?)</code>. Like in
<a href="#JOURNAL:PRINT-EVENTS%20FUNCTION" title="JOURNAL:PRINT-EVENTS FUNCTION"><code>print-events</code></a>, <code>events</code> may be a <a href="#JOURNAL:JOURNAL%20CLASS" title="JOURNAL:JOURNAL CLASS"><code>journal</code></a>.</p>

<pre><code><span class="code"><span class="paren1">(<span class="code">events-to-frames '<span class="paren2">(<span class="code"><span class="paren3">(<span class="code"><span class="keyword">:in</span> foo <span class="keyword">:args</span> <span class="paren4">(<span class="code">1 2</span>)</span></span>)</span>
                    <span class="paren3">(<span class="code"><span class="keyword">:in</span> bar <span class="keyword">:args</span> <span class="paren4">(<span class="code">7</span>)</span></span>)</span>
                    <span class="paren3">(<span class="code"><span class="keyword">:leaf</span> <span class="string">"leaf"</span></span>)</span>
                    <span class="paren3">(<span class="code"><span class="keyword">:out</span> bar <span class="keyword">:values</span> <span class="paren4">(<span class="code">8</span>)</span></span>)</span>
                    <span class="paren3">(<span class="code"><span class="keyword">:out</span> foo <span class="keyword">:values</span> <span class="paren4">(<span class="code">2</span>)</span></span>)</span>
                    <span class="paren3">(<span class="code"><span class="keyword">:in</span> foo <span class="keyword">:args</span> <span class="paren4">(<span class="code">3 4</span>)</span></span>)</span>
                    <span class="paren3">(<span class="code"><span class="keyword">:in</span> bar <span class="keyword">:args</span> <span class="paren4">(<span class="code">8</span>)</span></span>)</span></span>)</span></span>)</span>
=&gt; <span class="paren1">(<span class="code"><span class="paren2">(<span class="code"><span class="paren3">(<span class="code"><span class="keyword">:IN</span> FOO <span class="keyword">:ARGS</span> <span class="paren4">(<span class="code">1 2</span>)</span></span>)</span>
     <span class="paren3">(<span class="code"><span class="paren4">(<span class="code"><span class="keyword">:IN</span> BAR <span class="keyword">:ARGS</span> <span class="paren5">(<span class="code">7</span>)</span></span>)</span>
      <span class="paren4">(<span class="code"><span class="keyword">:LEAF</span> <span class="string">"leaf"</span></span>)</span>
      <span class="paren4">(<span class="code"><span class="keyword">:OUT</span> BAR <span class="keyword">:VALUES</span> <span class="paren5">(<span class="code">8</span>)</span></span>)</span></span>)</span>
     <span class="paren3">(<span class="code"><span class="keyword">:OUT</span> FOO <span class="keyword">:VALUES</span> <span class="paren4">(<span class="code">2</span>)</span></span>)</span></span>)</span>
    <span class="paren2">(<span class="code"><span class="paren3">(<span class="code"><span class="keyword">:IN</span> FOO <span class="keyword">:ARGS</span> <span class="paren4">(<span class="code">3 4</span>)</span></span>)</span> <span class="paren3">(<span class="code"><span class="paren4">(<span class="code"><span class="keyword">:IN</span> BAR <span class="keyword">:ARGS</span> <span class="paren5">(<span class="code">8</span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span></code></pre>

<p>Note that, as in the above example, incomplete frames (those without
an <a href="#JOURNAL:OUT-EVENT%20TYPE" title="JOURNAL:OUT-EVENT TYPE"><code>out-event</code></a>) are included in the output.</p></li>
</ul>

<p><a id="x-28JOURNAL-3AEXPECTED-TYPE-20FUNCTION-29"></a>
<a id="JOURNAL:EXPECTED-TYPE%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L1603">[function]</a></span> <span class="reference-object"><a href="#JOURNAL:EXPECTED-TYPE%20FUNCTION" >expected-type</a></span></span> <span class="locative-args">type</span></span></p>

<p>Return a function suitable as the <code>condition</code> argument of <a href="#JOURNAL:JOURNALED%20MGL-PAX:MACRO" title="JOURNAL:JOURNALED MGL-PAX:MACRO"><code>journaled</code></a>,
which returns the type of its single argument as a string if it is
of <code>type</code>, else <code>nil</code>.</p></li>
</ul>

<p><a id="x-28JOURNAL-3A-40PRETTY-PRINTING-20MGL-PAX-3ASECTION-29"></a>
<a id="JOURNAL:@PRETTY-PRINTING%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#JOURNAL:@JOURNAL-UTILITIES%20MGL-PAX:SECTION" title="Utilities">&#8592;</a> <a href="#JOURNAL:@JOURNAL-BASICS%20MGL-PAX:SECTION" title="Basics">&#8593;</a> <a href="#JOURNAL:@JOURNAL-ERROR-HANDLING%20MGL-PAX:SECTION" title="Error handling">&#8594;</a> <a href="#JOURNAL:@PRETTY-PRINTING%20MGL-PAX:SECTION" title="Pretty-printing">&#8634;</a> <a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L1865">&#955;</a></span></span></p>

<h3><a href="#JOURNAL:@PRETTY-PRINTING%20MGL-PAX:SECTION">6.5 Pretty-printing</a></h3>

<p><a id="x-28JOURNAL-3APRINT-EVENTS-20FUNCTION-29"></a>
<a id="JOURNAL:PRINT-EVENTS%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L1886">[function]</a></span> <span class="reference-object"><a href="#JOURNAL:PRINT-EVENTS%20FUNCTION" >print-events</a></span></span> <span class="locative-args">events &amp;key stream</span></span></p>

<p>Print <code>events</code> to <code>stream</code> as lists, starting a new line for each
event and indenting them according to their nesting structure.
<code>events</code> may be a sequence or a <a href="#JOURNAL:JOURNAL%20CLASS" title="JOURNAL:JOURNAL CLASS"><code>journal</code></a>, in which case <a href="#JOURNAL:LIST-EVENTS%20FUNCTION" title="JOURNAL:LIST-EVENTS FUNCTION"><code>list-events</code></a> is
called on it first.</p>

<pre><code><span class="code"><span class="paren1">(<span class="code">print-events '<span class="paren2">(<span class="code"><span class="paren3">(<span class="code"><span class="keyword">:in</span> log <span class="keyword">:args</span> <span class="paren4">(<span class="code"><span class="string">"first arg"</span> 2</span>)</span></span>)</span>
                <span class="paren3">(<span class="code"><span class="keyword">:in</span> versioned <span class="keyword">:version</span> 1 <span class="keyword">:args</span> <span class="paren4">(<span class="code">3</span>)</span></span>)</span>
                <span class="paren3">(<span class="code"><span class="keyword">:out</span> versioned <span class="keyword">:version</span> 1 <span class="keyword">:values</span> <span class="paren4">(<span class="code">42 t</span>)</span></span>)</span>
                <span class="paren3">(<span class="code"><span class="keyword">:out</span> log <span class="keyword">:condition</span> <span class="string">"a :CONDITION outcome"</span></span>)</span>
                <span class="paren3">(<span class="code"><span class="keyword">:in</span> log-2</span>)</span>
                <span class="paren3">(<span class="code"><span class="keyword">:out</span> log-2 <span class="keyword">:nlx</span> nil</span>)</span>
                <span class="paren3">(<span class="code"><span class="keyword">:in</span> external <span class="keyword">:version</span> <span class="keyword">:infinity</span></span>)</span>
                <span class="paren3">(<span class="code"><span class="keyword">:out</span> external <span class="keyword">:version</span> <span class="keyword">:infinity</span>
                 <span class="keyword">:error</span> <span class="paren4">(<span class="code"><span class="string">"ERROR"</span> <span class="string">"an :ERROR outcome"</span></span>)</span></span>)</span></span>)</span></span>)</span>
..
.. <span class="paren1">(<span class="code"><span class="keyword">:IN</span> LOG <span class="keyword">:ARGS</span> <span class="paren2">(<span class="code"><span class="string">"first arg"</span> 2</span>)</span></span>)</span>
..   <span class="paren1">(<span class="code"><span class="keyword">:IN</span> VERSIONED <span class="keyword">:VERSION</span> 1 <span class="keyword">:ARGS</span> <span class="paren2">(<span class="code">3</span>)</span></span>)</span>
..   <span class="paren1">(<span class="code"><span class="keyword">:OUT</span> VERSIONED <span class="keyword">:VERSION</span> 1 <span class="keyword">:VALUES</span> <span class="paren2">(<span class="code">42 T</span>)</span></span>)</span>
.. <span class="paren1">(<span class="code"><span class="keyword">:OUT</span> LOG <span class="keyword">:CONDITION</span> <span class="string">"a :CONDITION outcome"</span></span>)</span>
.. <span class="paren1">(<span class="code"><span class="keyword">:IN</span> LOG-2</span>)</span>
.. <span class="paren1">(<span class="code"><span class="keyword">:OUT</span> LOG-2 <span class="keyword">:NLX</span> NIL</span>)</span>
.. <span class="paren1">(<span class="code"><span class="keyword">:IN</span> EXTERNAL <span class="keyword">:VERSION</span> <span class="keyword">:INFINITY</span></span>)</span>
.. <span class="paren1">(<span class="code"><span class="keyword">:OUT</span> EXTERNAL <span class="keyword">:VERSION</span> <span class="keyword">:INFINITY</span> <span class="keyword">:ERROR</span> <span class="paren2">(<span class="code"><span class="string">"ERROR"</span> <span class="string">"an :ERROR outcome"</span></span>)</span></span>)</span>
=&gt; <span class="comment">; No value</span></span></code></pre></li>
</ul>

<p><a id="x-28JOURNAL-3APPRINT-EVENTS-20FUNCTION-29"></a>
<a id="JOURNAL:PPRINT-EVENTS%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L1916">[function]</a></span> <span class="reference-object"><a href="#JOURNAL:PPRINT-EVENTS%20FUNCTION" >pprint-events</a></span></span> <span class="locative-args">events &amp;key stream (prettifier 'prettify-event)</span></span></p>

<p>Like <a href="#JOURNAL:PRINT-EVENTS%20FUNCTION" title="JOURNAL:PRINT-EVENTS FUNCTION"><code>print-events</code></a>, but produces terser, more human readable
output.</p>

<pre><code><span class="code"><span class="paren1">(<span class="code">pprint-events '<span class="paren2">(<span class="code"><span class="paren3">(<span class="code"><span class="keyword">:in</span> log <span class="keyword">:args</span> <span class="paren4">(<span class="code"><span class="string">"first arg"</span> 2</span>)</span></span>)</span>
                 <span class="paren3">(<span class="code"><span class="keyword">:in</span> versioned <span class="keyword">:version</span> 1 <span class="keyword">:args</span> <span class="paren4">(<span class="code">3</span>)</span></span>)</span>
                 <span class="paren3">(<span class="code"><span class="keyword">:leaf</span> <span class="string">"This is a leaf, not a frame."</span></span>)</span>
                 <span class="paren3">(<span class="code"><span class="keyword">:out</span> versioned <span class="keyword">:version</span> 1 <span class="keyword">:values</span> <span class="paren4">(<span class="code">42 t</span>)</span></span>)</span>
                 <span class="paren3">(<span class="code"><span class="keyword">:out</span> log <span class="keyword">:condition</span> <span class="string">"a :CONDITION outcome"</span></span>)</span>
                 <span class="paren3">(<span class="code"><span class="keyword">:in</span> log-2</span>)</span>
                 <span class="paren3">(<span class="code"><span class="keyword">:out</span> log-2 <span class="keyword">:nlx</span> nil</span>)</span>
                 <span class="paren3">(<span class="code"><span class="keyword">:in</span> external <span class="keyword">:version</span> <span class="keyword">:infinity</span></span>)</span>
                 <span class="paren3">(<span class="code"><span class="keyword">:out</span> external <span class="keyword">:version</span> <span class="keyword">:infinity</span>
                  <span class="keyword">:error</span> <span class="paren4">(<span class="code"><span class="string">"ERROR"</span> <span class="string">"an :ERROR outcome"</span></span>)</span></span>)</span></span>)</span></span>)</span>
..
.. <span class="paren1">(<span class="code">LOG <span class="string">"first arg"</span> 2</span>)</span>
..   <span class="paren1">(<span class="code">VERSIONED 3</span>)</span> v1
..     This is a leaf, not a frame.
..   =&gt; 42, T
.. =C "a :CONDITION outcome"
.. <span class="paren1">(<span class="code">LOG-2</span>)</span>
.. =X
.. <span class="paren1">(<span class="code">EXTERNAL</span>)</span> ext
.. =E "ERROR" "an :ERROR outcome"
=&gt; <span class="comment">; No value</span></span></code></pre>

<p>The function given as the <code>prettifier</code> argument formats individual
events. The above output was produced with <a href="#JOURNAL:PRETTIFY-EVENT%20FUNCTION" title="JOURNAL:PRETTIFY-EVENT FUNCTION"><code>prettify-event</code></a>. For a
description of <code>prettifier</code>'s arguments see <code>prettify-event</code>.</p></li>
</ul>

<p><a id="x-28JOURNAL-3APRETTIFY-EVENT-20FUNCTION-29"></a>
<a id="JOURNAL:PRETTIFY-EVENT%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L1965">[function]</a></span> <span class="reference-object"><a href="#JOURNAL:PRETTIFY-EVENT%20FUNCTION" >prettify-event</a></span></span> <span class="locative-args">event depth stream</span></span></p>

<p>Write <code>event</code> to <code>stream</code> in a somewhat human-friendly format.
This is the function <a href="#JOURNAL:PPRINT-JOURNAL%20CLASS" title="JOURNAL:PPRINT-JOURNAL CLASS"><code>pprint-journal</code></a>, <a href="#JOURNAL:PPRINT-EVENTS%20FUNCTION" title="JOURNAL:PPRINT-EVENTS FUNCTION"><code>pprint-events</code></a>, and <a href="#JOURNAL:@TRACING%20MGL-PAX:SECTION" title="Tracing">Tracing</a> use
by default. In addition to the basic example in <code>pprint-events</code>,
<a href="#JOURNAL:@DECORATION%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@DECORATION MGL-PAX:GLOSSARY-TERM">decoration</a> on events is printed before normal, indented output like
this:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code">pprint-events '<span class="paren2">(<span class="code"><span class="paren3">(<span class="code"><span class="keyword">:leaf</span> <span class="string">"About to sleep"</span> <span class="keyword">:time</span> <span class="string">"19:57:00"</span> <span class="keyword">:function</span> <span class="string">"FOO"</span></span>)</span></span>)</span></span>)</span>
..
.. 19:57:00 FOO: About to sleep</span></code></pre>

<p><code>depth</code> is the nesting level of the <code>event</code>. Top-level events have depth
0. <code>prettify-event</code> prints indents the output after printing the
decorations by 2 spaces per depth.</p></li>
</ul>

<p>Instead of collecting events and then printing them, events can
be pretty-printed to a stream as they generated. This is
accomplished with <a href="#JOURNAL:@PPRINT-JOURNALS%20MGL-PAX:SECTION" title="Pretty-printing journals">Pretty-printing journals</a>, discussed in detail later, in
the following way:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">let</span></i> <span class="paren2">(<span class="code"><span class="paren3">(<span class="code">journal <span class="paren4">(<span class="code">make-pprint-journal</span>)</span></span>)</span></span>)</span>
  <span class="paren2">(<span class="code"><i><span class="symbol">with-journaling</span></i> <span class="paren3">(<span class="code"><span class="keyword">:record</span> journal</span>)</span>
    <span class="paren3">(<span class="code">journaled <span class="paren4">(<span class="code">foo</span>)</span> <span class="string">"Hello"</span></span>)</span></span>)</span></span>)</span>
..
.. <span class="paren1">(<span class="code">FOO</span>)</span>
.. =&gt; "Hello"</span></code></pre>

<p>Note that <a href="#JOURNAL:@PPRINT-JOURNALS%20MGL-PAX:SECTION" title="Pretty-printing journals">Pretty-printing journals</a> are not tied to <a href="#JOURNAL:WITH-JOURNALING%20MGL-PAX:MACRO" title="JOURNAL:WITH-JOURNALING MGL-PAX:MACRO"><code>with-journaling</code></a> and are
most often used for <a href="#JOURNAL:@LOGGING%20MGL-PAX:SECTION" title="Logging">Logging</a> and <a href="#JOURNAL:@TRACING%20MGL-PAX:SECTION" title="Tracing">Tracing</a>.</p>

<p><a id="x-28JOURNAL-3A-40JOURNAL-ERROR-HANDLING-20MGL-PAX-3ASECTION-29"></a>
<a id="JOURNAL:@JOURNAL-ERROR-HANDLING%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#JOURNAL:@PRETTY-PRINTING%20MGL-PAX:SECTION" title="Pretty-printing">&#8592;</a> <a href="#JOURNAL:@JOURNAL-BASICS%20MGL-PAX:SECTION" title="Basics">&#8593;</a> <a href="#JOURNAL:@LOGGING%20MGL-PAX:SECTION" title="Logging">&#8594;</a> <a href="#JOURNAL:@JOURNAL-ERROR-HANDLING%20MGL-PAX:SECTION" title="Error handling">&#8634;</a> <a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L1614">&#955;</a></span></span></p>

<h3><a href="#JOURNAL:@JOURNAL-ERROR-HANDLING%20MGL-PAX:SECTION">6.6 Error handling</a></h3>

<p><a id="x-28JOURNAL-3AJOURNALING-FAILURE-20CONDITION-29"></a>
<a id="JOURNAL:JOURNALING-FAILURE%20CONDITION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L1622">[condition]</a></span> <span class="reference-object"><a href="#JOURNAL:JOURNALING-FAILURE%20CONDITION" >journaling-failure</a></span></span> <span class="locative-args"><a href="http://www.lispworks.com/documentation/HyperSpec/Body/e_seriou.htm" title="SERIOUS-CONDITION CONDITION">serious-condition</a></span></span></p>

<p>Signalled during the dynamic extent of
<a href="#JOURNAL:WITH-JOURNALING%20MGL-PAX:MACRO" title="JOURNAL:WITH-JOURNALING MGL-PAX:MACRO"><code>with-journaling</code></a> when an error threatens to leave the journaling
mechanism in an inconsistent state. These include I/O errors
encountered reading or writing journals by <code>with-journaling</code>,
<a href="#JOURNAL:JOURNALED%20MGL-PAX:MACRO" title="JOURNAL:JOURNALED MGL-PAX:MACRO"><code>journaled</code></a>, <a href="#JOURNAL:LOGGED%20MGL-PAX:MACRO" title="JOURNAL:LOGGED MGL-PAX:MACRO"><code>logged</code></a>, <a href="#JOURNAL:WITH-REPLAY-FILTER%20MGL-PAX:MACRO" title="JOURNAL:WITH-REPLAY-FILTER MGL-PAX:MACRO"><code>with-replay-filter</code></a>, <a href="#JOURNAL:SYNC-JOURNAL%20FUNCTION" title="JOURNAL:SYNC-JOURNAL FUNCTION"><code>sync-journal</code></a>, and also
<a href="http://www.lispworks.com/documentation/HyperSpec/Body/e_storag.htm" title="STORAGE-CONDITION CONDITION"><code>storage-condition</code></a>s, assertion failures, errors calling <code>journaled</code>'s
<code>values</code> and <code>condition</code> function arguments.
Crucially, this does not apply to <a href="#JOURNAL:@NON-LOCAL-EXIT%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@NON-LOCAL-EXIT MGL-PAX:GLOSSARY-TERM">non-local exit</a>s from other code,
such as <code>journaled</code> <a href="#JOURNAL:@BLOCK%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@BLOCK MGL-PAX:GLOSSARY-TERM">block</a>s, whose error handling is largely
unaltered (see <a href="#JOURNAL:@OUT-EVENTS%20MGL-PAX:SECTION" title="Out-events">Out-events</a> and <a href="#JOURNAL:@REPLAY-FAILURES%20MGL-PAX:SECTION" title="Replay failures">Replay failures</a>).</p>

<p>In general, any <a href="#JOURNAL:@NON-LOCAL-EXIT%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@NON-LOCAL-EXIT MGL-PAX:GLOSSARY-TERM">non-local exit</a> from critical parts of the code is
turned into a <code>journaling-failure</code> to protect the integrity of the
<a href="#JOURNAL:RECORD-JOURNAL%20FUNCTION" title="JOURNAL:RECORD-JOURNAL FUNCTION"><code>record-journal</code></a>. The condition that caused the unwinding is in
<a href="#JOURNAL:JOURNALING-FAILURE-EMBEDDED-CONDITION%20%28MGL-PAX:READER%20JOURNAL:JOURNALING-FAILURE%29" title="JOURNAL:JOURNALING-FAILURE-EMBEDDED-CONDITION (MGL-PAX:READER JOURNAL:JOURNALING-FAILURE)"><code>journaling-failure-embedded-condition</code></a>, or <code>nil</code> if it was a pure
<a href="#JOURNAL:@NON-LOCAL-EXIT%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@NON-LOCAL-EXIT MGL-PAX:GLOSSARY-TERM">non-local exit</a> like <a href="http://www.lispworks.com/documentation/HyperSpec/Body/s_throw.htm" title="THROW MGL-PAX:MACRO"><code>throw</code></a>. This is a <a href="http://www.lispworks.com/documentation/HyperSpec/Body/e_seriou.htm" title="SERIOUS-CONDITION CONDITION"><code>serious-condition</code></a>, not to be
handled within <code>with-journaling</code>.</p>

<p>After a <code>journaling-failure</code>, the journaling mechanism cannot be
trusted anymore. The <a href="#JOURNAL:REPLAY-JOURNAL%20FUNCTION" title="JOURNAL:REPLAY-JOURNAL FUNCTION"><code>replay-journal</code></a> might have failed a read and be
out-of-sync. The <code>record-journal</code> may have missing events (or even
half-written events with <a href="#JOURNAL:FILE-JOURNAL%20CLASS" title="JOURNAL:FILE-JOURNAL CLASS"><code>file-journal</code></a>s without <code>sync</code>, see
<a href="#JOURNAL:@SYNCHRONIZATION-STRATEGIES%20MGL-PAX:SECTION" title="Synchronization strategies">Synchronization strategies</a>), and further writes to it would risk
replayability, which is equivalent to database corruption. Thus,
upon signalling <code>journaling-failure</code>, <a href="#JOURNAL:JOURNAL-STATE%20TYPE" title="JOURNAL:JOURNAL-STATE TYPE"><code>journal-state</code></a> is set to</p>

<ul>
<li><p><code>:completed</code> if the journal is in state <code>:recording</code> or <code>:logging</code> and
  the transition to <code>:recording</code> was reflected in storage,</p></li>
<li><p>else it is set to <code>:failed</code>.</p></li>
</ul>

<p>After a <code>journaling-failure</code>, any further attempt within the affected
<code>with-journaling</code> to use the critical machinery mentioned
above (<code>journaled</code>, <code>logged</code>, etc) resignals the same journal failure
condition. As a consequence, the record journal cannot be changed,
and the only way to recover is to leave <code>with-journaling</code>. This does
not affect processing in other threads, which by design cannot write
to the record journal.</p>

<p>Note that in contrast with <code>journaling-failure</code> and <a href="#JOURNAL:REPLAY-FAILURE%20CONDITION" title="JOURNAL:REPLAY-FAILURE CONDITION"><code>replay-failure</code></a>,
which necessitate leaving <code>with-journaling</code> to recover from, the other
conditions â <a href="#JOURNAL:JOURNAL-ERROR%20CONDITION" title="JOURNAL:JOURNAL-ERROR CONDITION"><code>journal-error</code></a>, and <a href="#JOURNAL:STREAMLET-ERROR%20CONDITION" title="JOURNAL:STREAMLET-ERROR CONDITION"><code>streamlet-error</code></a> â are subclasses of
<a href="http://www.lispworks.com/documentation/HyperSpec/Body/e_error.htm" title="ERROR CONDITION"><code>error</code></a> as the their handling need not be so
heavy-handed.</p></li>
</ul>

<p><a id="x-28JOURNAL-3AJOURNALING-FAILURE-EMBEDDED-CONDITION-20-28MGL-PAX-3AREADER-20JOURNAL-3AJOURNALING-FAILURE-29-29"></a>
<a id="JOURNAL:JOURNALING-FAILURE-EMBEDDED-CONDITION%20%28MGL-PAX:READER%20JOURNAL:JOURNALING-FAILURE%29"></a></p>

<ul>
<li><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L1622">[reader]</a></span> <span class="reference-object"><a href="#JOURNAL:JOURNALING-FAILURE-EMBEDDED-CONDITION%20%28MGL-PAX:READER%20JOURNAL:JOURNALING-FAILURE%29" >journaling-failure-embedded-condition</a></span></span> <span class="locative-args">journaling-failure (:embedded-condition)</span></span></li>
</ul>

<p><a id="x-28JOURNAL-3ARECORD-UNEXPECTED-OUTCOME-20CONDITION-29"></a>
<a id="JOURNAL:RECORD-UNEXPECTED-OUTCOME%20CONDITION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L1806">[condition]</a></span> <span class="reference-object"><a href="#JOURNAL:RECORD-UNEXPECTED-OUTCOME%20CONDITION" >record-unexpected-outcome</a></span></span></span></p>

<p>Signalled (with <a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_signal.htm" title="SIGNAL FUNCTION"><code>signal</code></a>: this is not an
<a href="http://www.lispworks.com/documentation/HyperSpec/Body/e_error.htm" title="ERROR CONDITION"><code>error</code></a>) by <a href="#JOURNAL:JOURNALED%20MGL-PAX:MACRO" title="JOURNAL:JOURNALED MGL-PAX:MACRO"><code>journaled</code></a> when a <a href="#JOURNAL:VERSIONED-EVENT%20TYPE" title="JOURNAL:VERSIONED-EVENT TYPE"><code>versioned-event</code></a> or an
<a href="#JOURNAL:EXTERNAL-EVENT%20TYPE" title="JOURNAL:EXTERNAL-EVENT TYPE"><code>external-event</code></a> had an UNEXPECTED-OUTCOME while in <a href="#JOURNAL:JOURNAL-STATE%20TYPE" title="JOURNAL:JOURNAL-STATE TYPE"><code>journal-state</code></a>
<code>:recording</code>. Upon signalling this condition, <code>journal-state</code> is set to
<code>:logging</code>, thus no more events can be recorded that will affect
replay of the journal being recorded. The event that triggered this
condition is recorded in state <code>:logging</code>, with its version
downgraded. Since <a href="#JOURNAL:@REPLAY%20MGL-PAX:SECTION" title="Replay">Replay</a> (except <a href="#JOURNAL:@INVOKED%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@INVOKED MGL-PAX:GLOSSARY-TERM">invoked</a>) is built on the
assumption that control flow is deterministic, an unexpected outcome
is significant because it makes this assumption to hold unlikely.</p>

<p>Also see <a href="#JOURNAL:REPLAY-UNEXPECTED-OUTCOME%20CONDITION" title="JOURNAL:REPLAY-UNEXPECTED-OUTCOME CONDITION"><code>replay-unexpected-outcome</code></a>.</p></li>
</ul>

<p><a id="x-28JOURNAL-3ADATA-EVENT-LOSSAGE-20CONDITION-29"></a>
<a id="JOURNAL:DATA-EVENT-LOSSAGE%20CONDITION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L1829">[condition]</a></span> <span class="reference-object"><a href="#JOURNAL:DATA-EVENT-LOSSAGE%20CONDITION" >data-event-lossage</a></span></span> <span class="locative-args"><a href="#JOURNAL:JOURNALING-FAILURE%20CONDITION" title="JOURNAL:JOURNALING-FAILURE CONDITION">journaling-failure</a></span></span></p>

<p>Signalled when a <a href="#JOURNAL:@DATA-EVENT%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@DATA-EVENT MGL-PAX:GLOSSARY-TERM">data event</a> is about to be recorded
in <a href="#JOURNAL:JOURNAL-STATE%20TYPE" title="JOURNAL:JOURNAL-STATE TYPE"><code>journal-state</code></a> <code>:mismatched</code> or <code>:logging</code>. Since the data event will
not be replayed that constitutes data loss.</p></li>
</ul>

<p><a id="x-28JOURNAL-3AJOURNAL-ERROR-20CONDITION-29"></a>
<a id="JOURNAL:JOURNAL-ERROR%20CONDITION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L1840">[condition]</a></span> <span class="reference-object"><a href="#JOURNAL:JOURNAL-ERROR%20CONDITION" >journal-error</a></span></span> <span class="locative-args"><a href="http://www.lispworks.com/documentation/HyperSpec/Body/e_error.htm" title="ERROR CONDITION">error</a></span></span></p>

<p>Signalled by <a href="#JOURNAL:WITH-JOURNALING%20MGL-PAX:MACRO" title="JOURNAL:WITH-JOURNALING MGL-PAX:MACRO"><code>with-journaling</code></a>, <a href="#JOURNAL:WITH-BUNDLE%20MGL-PAX:MACRO" title="JOURNAL:WITH-BUNDLE MGL-PAX:MACRO"><code>with-bundle</code></a> and by
<a href="#JOURNAL:@LOG-RECORD%20MGL-PAX:SECTION" title="`:log-record`"><code>:log-record</code></a>. It is also signalled by the low-level streamlet
interface (see <a href="#JOURNAL:@STREAMLETS-REFERENCE%20MGL-PAX:SECTION" title="Streamlets reference">Streamlets reference</a>).</p></li>
</ul>

<p><a id="x-28JOURNAL-3AEND-OF-JOURNAL-20CONDITION-29"></a>
<a id="JOURNAL:END-OF-JOURNAL%20CONDITION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L1853">[condition]</a></span> <span class="reference-object"><a href="#JOURNAL:END-OF-JOURNAL%20CONDITION" >end-of-journal</a></span></span> <span class="locative-args"><a href="#JOURNAL:JOURNAL-ERROR%20CONDITION" title="JOURNAL:JOURNAL-ERROR CONDITION">journal-error</a></span></span></p>

<p>This might be signalled by the replay mechanism if
<a href="#JOURNAL:WITH-JOURNALING%20MGL-PAX:MACRO" title="JOURNAL:WITH-JOURNALING MGL-PAX:MACRO"><code>with-journaling</code></a>'s <code>replay-eoj-error-p</code> is true. Unlike
<a href="#JOURNAL:REPLAY-FAILURE%20CONDITION" title="JOURNAL:REPLAY-FAILURE CONDITION"><code>replay-failure</code></a>s, this does not affect <a href="#JOURNAL:JOURNAL-STATE%20TYPE" title="JOURNAL:JOURNAL-STATE TYPE"><code>journal-state</code></a> of
<a href="#JOURNAL:RECORD-JOURNAL%20FUNCTION" title="JOURNAL:RECORD-JOURNAL FUNCTION"><code>record-journal</code></a>. At a lower level, it is signalled by <a href="#JOURNAL:READ-EVENT%20GENERIC-FUNCTION" title="JOURNAL:READ-EVENT GENERIC-FUNCTION"><code>read-event</code></a> upon
reading past the end of the <a href="#JOURNAL:JOURNAL%20CLASS" title="JOURNAL:JOURNAL CLASS"><code>journal</code></a> if <code>eoj-error-p</code>.</p></li>
</ul>

<p><a id="x-28JOURNAL-3A-40LOGGING-20MGL-PAX-3ASECTION-29"></a>
<a id="JOURNAL:@LOGGING%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#JOURNAL:@JOURNAL-ERROR-HANDLING%20MGL-PAX:SECTION" title="Error handling">&#8592;</a> <a href="journal-manual.html" title="Journal manual">&#8593;</a> <a href="#JOURNAL:@CUSTOMIZING-LOGS%20MGL-PAX:SECTION" title="Customizing logs">&#8594;</a> <a href="#JOURNAL:@LOGGING%20MGL-PAX:SECTION" title="Logging">&#8634;</a> <a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L2096">&#955;</a></span></span></p>

<h2><a href="#JOURNAL:@LOGGING%20MGL-PAX:SECTION">7 Logging</a></h2>

<p>Before we get into the details, here is a self-contained example
that demonstrates typical use.</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">defvar</span></i> <span class="special">*communication-log*</span> nil</span>)</span>
<span class="paren1">(<span class="code"><i><span class="symbol">defvar</span></i> <span class="special">*logic-log*</span> nil</span>)</span>
<span class="paren1">(<span class="code"><i><span class="symbol">defvar</span></i> <span class="special">*logic-log-level*</span> 0</span>)</span>

<span class="paren1">(<span class="code"><i><span class="symbol">defun</span></i> call-with-connection <span class="paren2">(<span class="code">port fn</span>)</span>
  <span class="paren2">(<span class="code">framed <span class="paren3">(<span class="code">call-with-connection <span class="keyword">:log-record</span> <span class="special">*communication-log*</span>
                                <span class="keyword">:args</span> `<span class="paren4">(<span class="code">,port</span>)</span></span>)</span>
    <span class="paren3">(<span class="code">funcall fn</span>)</span></span>)</span></span>)</span>

<span class="paren1">(<span class="code"><i><span class="symbol">defun</span></i> fetch-data <span class="paren2">(<span class="code">key</span>)</span>
  <span class="paren2">(<span class="code"><i><span class="symbol">let</span></i> <span class="paren3">(<span class="code"><span class="paren4">(<span class="code">value 42</span>)</span></span>)</span>
    <span class="paren3">(<span class="code">logged <span class="paren4">(<span class="code"><span class="paren5">(<span class="code">and <span class="paren6">(<span class="code">&lt;= 1 <span class="special">*logic-log-level*</span></span>)</span> <span class="special">*logic-log*</span></span>)</span></span>)</span>
      <span class="string">"The value of ~S is ~S."</span> key value</span>)</span>
    value</span>)</span></span>)</span>

<span class="paren1">(<span class="code"><i><span class="symbol">defun</span></i> init-logging <span class="paren2">(<span class="code">&amp;key <span class="paren3">(<span class="code">logic-log-level 1</span>)</span></span>)</span>
  <span class="paren2">(<span class="code"><i><span class="symbol">let*</span></i> <span class="paren3">(<span class="code"><span class="paren4">(<span class="code">stream <span class="paren5">(<span class="code">open <span class="string">"/tmp/xxx.log"</span>
                       <span class="keyword">:direction</span> <span class="keyword">:output</span>
                       <span class="keyword">:if-does-not-exist</span> <span class="keyword">:create</span>
                       <span class="keyword">:if-exists</span> <span class="keyword">:append</span></span>)</span></span>)</span>
         <span class="paren4">(<span class="code">journal <span class="paren5">(<span class="code">make-pprint-journal
                   <span class="keyword">:stream</span> <span class="paren6">(<span class="code">make-broadcast-stream
                            <span class="paren1">(<span class="code">make-synonym-stream '<span class="special">*standard-output*</span></span>)</span>
                            stream</span>)</span></span>)</span></span>)</span></span>)</span>
    <span class="paren3">(<span class="code"><i><span class="symbol">setq</span></i> <span class="special">*communication-log*</span> journal</span>)</span>
    <span class="paren3">(<span class="code"><i><span class="symbol">setq</span></i> <span class="special">*logic-log*</span> journal</span>)</span>
    <span class="paren3">(<span class="code"><i><span class="symbol">setq</span></i> <span class="special">*logic-log-level*</span> logic-log-level</span>)</span></span>)</span></span>)</span>

<span class="paren1">(<span class="code">init-logging</span>)</span>

<span class="paren1">(<span class="code">call-with-connection 8080 <span class="paren2">(<span class="code"><i><span class="symbol">lambda</span></i> <span class="paren3">(<span class="code"></span>)</span> <span class="paren3">(<span class="code">fetch-data <span class="keyword">:foo</span></span>)</span></span>)</span></span>)</span>
..
.. <span class="paren1">(<span class="code">CALL-WITH-CONNECTION 8080</span>)</span>
..   The value of :FOO is 42.
.. =&gt; 42
=&gt; 42

<span class="paren1">(<span class="code"><i><span class="symbol">setq</span></i> <span class="special">*logic-log-level*</span> 0</span>)</span>
<span class="paren1">(<span class="code">call-with-connection 8080 <span class="paren2">(<span class="code"><i><span class="symbol">lambda</span></i> <span class="paren3">(<span class="code"></span>)</span> <span class="paren3">(<span class="code">fetch-data <span class="keyword">:foo</span></span>)</span></span>)</span></span>)</span>
..
.. <span class="paren1">(<span class="code">CALL-WITH-CONNECTION 8080</span>)</span>
.. =&gt; 42
=&gt; 42

<span class="paren1">(<span class="code">ignore-errors
  <span class="paren2">(<span class="code">call-with-connection 8080 <span class="paren3">(<span class="code"><i><span class="symbol">lambda</span></i> <span class="paren4">(<span class="code"></span>)</span> <span class="paren4">(<span class="code">error <span class="string">"Something unexpected."</span></span>)</span></span>)</span></span>)</span></span>)</span>
..
.. <span class="paren1">(<span class="code">CALL-WITH-CONNECTION 8080</span>)</span>
.. =E "SIMPLE-ERROR" "Something unexpected."</span></code></pre>

<h5>Default to muffling</h5>

<p>Imagine a utility library called glib.</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">defvar</span></i> <span class="special">*glib-log*</span> nil</span>)</span>
<span class="paren1">(<span class="code"><i><span class="symbol">defvar</span></i> <span class="special">*patience*</span> 1</span>)</span>

<span class="paren1">(<span class="code"><i><span class="symbol">defun</span></i> sl33p <span class="paren2">(<span class="code">seconds</span>)</span>
  <span class="paren2">(<span class="code">logged <span class="paren3">(<span class="code"><span class="special">*glib-log*</span></span>)</span> <span class="string">"Sleeping for ~As."</span> seconds</span>)</span>
  <span class="paren2">(<span class="code">sleep <span class="paren3">(<span class="code">* <span class="special">*patience*</span> seconds</span>)</span></span>)</span></span>)</span></span></code></pre>

<p>Glib follows the recommendation to have a special variable globally
bound to <code>nil</code> by default. The value of <code>*glib-log*</code> is the journal to
which glib log messages will be routed. Since it's <code>nil</code>, the log
messages are muffled, and to record any log message, we need to
change its value.</p>

<h5>Routing logs to a journal</h5>

<p>Let's send the logs to a <a href="#JOURNAL:PPRINT-JOURNAL%20CLASS" title="JOURNAL:PPRINT-JOURNAL CLASS"><code>pprint-journal</code></a>:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">setq</span></i> <span class="special">*glib-log*</span> <span class="paren2">(<span class="code">make-pprint-journal
                  <span class="keyword">:log-decorator</span> <span class="paren3">(<span class="code">make-log-decorator <span class="keyword">:time</span> t</span>)</span></span>)</span></span>)</span>
<span class="paren1">(<span class="code">sl33p 0.01</span>)</span>
..
.. 2020-08-31T12:45:23.827172+02:00: Sleeping for 0.01s.</span></code></pre>

<p>That's a bit too wordy. For this tutorial, let's stick to less
verbose output:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">setq</span></i> <span class="special">*glib-log*</span> <span class="paren2">(<span class="code">make-pprint-journal</span>)</span></span>)</span>
<span class="paren1">(<span class="code">sl33p 0.01</span>)</span>
..
.. Sleeping for 0.01s.</span></code></pre>

<p>To log to a file:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">setq</span></i> <span class="special">*glib-log*</span> <span class="paren2">(<span class="code">make-pprint-journal
                  <span class="keyword">:stream</span> <span class="paren3">(<span class="code">open <span class="string">"/tmp/glib.log"</span>
                                <span class="keyword">:direction</span> <span class="keyword">:output</span>
                                <span class="keyword">:if-does-not-exist</span> <span class="keyword">:create</span>
                                <span class="keyword">:if-exists</span> <span class="keyword">:append</span></span>)</span></span>)</span></span>)</span></span></code></pre>

<h5>Capturing logs in <a href="#JOURNAL:WITH-JOURNALING%20MGL-PAX:MACRO" title="JOURNAL:WITH-JOURNALING MGL-PAX:MACRO"><code>with-journaling</code></a>'s <a href="#JOURNAL:RECORD-JOURNAL%20FUNCTION" title="JOURNAL:RECORD-JOURNAL FUNCTION"><code>record-journal</code></a></h5>

<p>If we were recording a journal for replay and wanted to include glib
logs in the journal, we would do something like this:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">with-journaling</span></i> <span class="paren2">(<span class="code"><span class="keyword">:record</span> t</span>)</span>
  <span class="paren2">(<span class="code"><i><span class="symbol">let</span></i> <span class="paren3">(<span class="code"><span class="paren4">(<span class="code"><span class="special">*glib-log*</span> <span class="keyword">:record</span></span>)</span></span>)</span>
    <span class="paren3">(<span class="code">sl33p 0.01</span>)</span>
    <span class="paren3">(<span class="code">journaled <span class="paren4">(<span class="code">non-glib-stuff <span class="keyword">:version</span> 1</span>)</span></span>)</span></span>)</span>
  <span class="paren2">(<span class="code">list-events</span>)</span></span>)</span>
=&gt; <span class="paren1">(<span class="code"><span class="paren2">(<span class="code"><span class="keyword">:LEAF</span> <span class="string">"Sleeping for 0.01s."</span></span>)</span>
    <span class="paren2">(<span class="code"><span class="keyword">:IN</span> NON-GLIB-STUFF <span class="keyword">:VERSION</span> 1</span>)</span>
    <span class="paren2">(<span class="code"><span class="keyword">:OUT</span> NON-GLIB-STUFF <span class="keyword">:VERSION</span> 1 <span class="keyword">:VALUES</span> <span class="paren3">(<span class="code">NIL</span>)</span></span>)</span></span>)</span></span></code></pre>

<p>We could even <code>(setq *glib-log* :record)</code> to make it so that glib
messages are included by default in the <code>record-journal</code>. In this
example, the special <code>*glib-log*</code> acts like a log category for all
the log messages of the glib library (currently one).</p>

<h5>Rerouting a category</h5>

<p>Next, we route <code>*glib-log*</code> to wherever <code>*app-log*</code> is pointing by
binding <code>*glib-log*</code> <em>to the symbol</em> <code>*app-log*</code> (see <a href="#JOURNAL:@LOG-RECORD%20MGL-PAX:SECTION" title="`:log-record`"><code>:log-record</code></a>).</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">defvar</span></i> <span class="special">*app-log*</span> nil</span>)</span>

<span class="paren1">(<span class="code"><i><span class="symbol">let</span></i> <span class="paren2">(<span class="code"><span class="paren3">(<span class="code"><span class="special">*glib-log*</span> '<span class="special">*app-log*</span></span>)</span></span>)</span>
  <span class="paren2">(<span class="code"><i><span class="symbol">setq</span></i> <span class="special">*app-log*</span> nil</span>)</span>
  <span class="paren2">(<span class="code">logged <span class="paren3">(<span class="code"><span class="special">*glib-log*</span></span>)</span> <span class="string">"This is not written anywhere."</span></span>)</span>
  <span class="paren2">(<span class="code"><i><span class="symbol">setq</span></i> <span class="special">*app-log*</span> <span class="paren3">(<span class="code">make-pprint-journal <span class="keyword">:pretty</span> nil</span>)</span></span>)</span>
  <span class="paren2">(<span class="code">sl33p 0.01</span>)</span></span>)</span>
..
.. <span class="paren1">(<span class="code"><span class="keyword">:LEAF</span> <span class="string">"Sleeping for 0.01s."</span></span>)</span></span></code></pre>

<p>Note how pretty-printing was turned off, and we see the <a href="#JOURNAL:LEAF-EVENT%20TYPE" title="JOURNAL:LEAF-EVENT TYPE"><code>leaf-event</code></a>
generated by <a href="#JOURNAL:LOGGED%20MGL-PAX:MACRO" title="JOURNAL:LOGGED MGL-PAX:MACRO"><code>logged</code></a> in its raw plist form.</p>

<h5>Conditional routing</h5>

<p>Finally, to make routing decisions conditional we need to change
<code>sl33p</code>:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">defvar</span></i> <span class="special">*glib-log-level*</span> 1</span>)</span>

<span class="paren1">(<span class="code"><i><span class="symbol">defun</span></i> sl33p <span class="paren2">(<span class="code">seconds</span>)</span>
  <span class="paren2">(<span class="code">logged <span class="paren3">(<span class="code"><span class="paren4">(<span class="code">and <span class="paren5">(<span class="code">&lt;= 2 <span class="special">*glib-log-level*</span></span>)</span> <span class="special">*glib-log*</span></span>)</span></span>)</span>
          <span class="string">"Sleeping for ~As."</span> <span class="paren3">(<span class="code">* <span class="special">*patience*</span> seconds</span>)</span></span>)</span>
  <span class="paren2">(<span class="code">sleep seconds</span>)</span></span>)</span>

<span class="comment">;;; Check that it all works:
</span><span class="paren1">(<span class="code"><i><span class="symbol">let</span></i> <span class="paren2">(<span class="code"><span class="paren3">(<span class="code"><span class="special">*glib-log-level*</span> 1</span>)</span>
      <span class="paren3">(<span class="code"><span class="special">*glib-log*</span> <span class="paren4">(<span class="code">make-pprint-journal</span>)</span></span>)</span></span>)</span>
  <span class="paren2">(<span class="code">format t <span class="string">"~%With log-level ~A"</span> <span class="special">*glib-log-level*</span></span>)</span>
  <span class="paren2">(<span class="code">sl33p 0.01</span>)</span>
  <span class="paren2">(<span class="code"><i><span class="symbol">setq</span></i> <span class="special">*glib-log-level*</span> 2</span>)</span>
  <span class="paren2">(<span class="code">format t <span class="string">"~%With log-level ~A"</span> <span class="special">*glib-log-level*</span></span>)</span>
  <span class="paren2">(<span class="code">sl33p 0.01</span>)</span></span>)</span>
..
.. With log-level 1
.. With log-level 2
.. Sleeping for 0.01s.</span></code></pre>

<h5>Nested log contexts</h5>

<p><code>logged</code> is for single messages. <a href="#JOURNAL:JOURNALED%20MGL-PAX:MACRO" title="JOURNAL:JOURNALED MGL-PAX:MACRO"><code>journaled</code></a>, or in this example <a href="#JOURNAL:FRAMED%20MGL-PAX:MACRO" title="JOURNAL:FRAMED MGL-PAX:MACRO"><code>framed</code></a>,
can provide nested context:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">defun</span></i> callv <span class="paren2">(<span class="code">var value symbol &amp;rest args</span>)</span>
  <span class="string">"Call SYMBOL-FUNCTION of SYMBOL with VAR dynamically bound to VALUE."</span>
  <span class="paren2">(<span class="code">framed <span class="paren3">(<span class="code"><span class="string">"glib:callv"</span> <span class="keyword">:log-record</span> <span class="special">*glib-log*</span>
                        <span class="keyword">:args</span> `<span class="paren4">(<span class="code">,var ,value ,symbol ,@args</span>)</span></span>)</span>
    <span class="paren3">(<span class="code"><i><span class="symbol">progv</span></i> <span class="paren4">(<span class="code">list var</span>)</span> <span class="paren4">(<span class="code">list value</span>)</span>
      <span class="paren4">(<span class="code">apply <span class="paren5">(<span class="code">symbol-function symbol</span>)</span> args</span>)</span></span>)</span></span>)</span></span>)</span>

<span class="paren1">(<span class="code">callv '<span class="special">*print-base*</span> 2 'print 10</span>)</span>
..
.. <span class="paren1">(<span class="code"><span class="string">"glib:callv"</span> <span class="special">*PRINT-BASE*</span> 2 PRINT 10</span>)</span>
.. 1010 
.. =&gt; 10
=&gt; 10

<span class="paren1">(<span class="code"><i><span class="symbol">let</span></i> <span class="paren2">(<span class="code"><span class="paren3">(<span class="code"><span class="special">*glib-log-level*</span> 2</span>)</span></span>)</span>
  <span class="paren2">(<span class="code">callv '<span class="special">*patience*</span> 7 'sl33p 0.01</span>)</span></span>)</span>
..
.. <span class="paren1">(<span class="code"><span class="string">"glib:callv"</span> <span class="special">*PATIENCE*</span> 7 SL33P 0.01</span>)</span>
..   Sleeping for 0.07s.
.. =&gt; NIL</span></code></pre>

<p><a id="x-28JOURNAL-3A-40CUSTOMIZING-LOGS-20MGL-PAX-3ASECTION-29"></a>
<a id="JOURNAL:@CUSTOMIZING-LOGS%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#JOURNAL:@LOGGING%20MGL-PAX:SECTION" title="Logging">&#8592;</a> <a href="#JOURNAL:@LOGGING%20MGL-PAX:SECTION" title="Logging">&#8593;</a> <a href="#JOURNAL:@LOG-RECORD%20MGL-PAX:SECTION" title="`:log-record`">&#8594;</a> <a href="#JOURNAL:@CUSTOMIZING-LOGS%20MGL-PAX:SECTION" title="Customizing logs">&#8634;</a> <a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L2304">&#955;</a></span></span></p>

<h3><a href="#JOURNAL:@CUSTOMIZING-LOGS%20MGL-PAX:SECTION">7.1 Customizing logs</a></h3>

<p>Customizing the output format is possible if we don't necessarily
expect to be able to read the logs back programmatically. There is
an example in <a href="#JOURNAL:@TRACING%20MGL-PAX:SECTION" title="Tracing">Tracing</a>, which is built on <a href="#JOURNAL:@PPRINT-JOURNALS%20MGL-PAX:SECTION" title="Pretty-printing journals">Pretty-printing journals</a>.</p>

<p>Here, we discuss how to make logs more informative.</p>

<p><a id="x-28JOURNAL-3A-40DECORATION-20MGL-PAX-3AGLOSSARY-TERM-29"></a>
<a id="JOURNAL:@DECORATION%20MGL-PAX:GLOSSARY-TERM"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L2315">[glossary-term]</a></span> <span class="reference-object"><a href="#JOURNAL:@DECORATION%20MGL-PAX:GLOSSARY-TERM" >decoration</a></span></span></span></p>

<p><a href="#JOURNAL:JOURNAL-LOG-DECORATOR%20%28MGL-PAX:ACCESSOR%20JOURNAL:JOURNAL%29" title="JOURNAL:JOURNAL-LOG-DECORATOR (MGL-PAX:ACCESSOR JOURNAL:JOURNAL)"><code>journal-log-decorator</code></a> adds additional data to <a href="#JOURNAL:LOG-EVENT%20TYPE" title="JOURNAL:LOG-EVENT TYPE"><code>log-event</code></a>s as they
are written to the journal. This data is called decoration, and it is
to capture the context in which the event was triggered. See
<a href="#JOURNAL:MAKE-LOG-DECORATOR%20FUNCTION" title="JOURNAL:MAKE-LOG-DECORATOR FUNCTION"><code>make-log-decorator</code></a> for a typical example. Decorations, since they
can be on <code>log-event</code>s only, do not affect <a href="#JOURNAL:@REPLAY%20MGL-PAX:SECTION" title="Replay">Replay</a>. Decorations are
most often used with <a href="#JOURNAL:@PRETTY-PRINTING%20MGL-PAX:SECTION" title="Pretty-printing">Pretty-printing</a>.</p></li>
</ul>

<p><a id="x-28JOURNAL-3AJOURNAL-LOG-DECORATOR-20-28MGL-PAX-3AACCESSOR-20JOURNAL-3AJOURNAL-29-29"></a>
<a id="JOURNAL:JOURNAL-LOG-DECORATOR%20%28MGL-PAX:ACCESSOR%20JOURNAL:JOURNAL%29"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L463">[accessor]</a></span> <span class="reference-object"><a href="#JOURNAL:JOURNAL-LOG-DECORATOR%20%28MGL-PAX:ACCESSOR%20JOURNAL:JOURNAL%29" >journal-log-decorator</a></span></span> <span class="locative-args">journal (:log-decorator = nil)</span></span></p>

<p>If non-NIL, this is a function to add <a href="#JOURNAL:@DECORATION%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@DECORATION MGL-PAX:GLOSSARY-TERM">decoration</a>
to <a href="#JOURNAL:LOG-EVENT%20TYPE" title="JOURNAL:LOG-EVENT TYPE"><code>log-event</code></a>s before they are written to a journal. The only
allowed transformation is to <em>append</em> a plist to the event, which
is a plist itself. The keys can be anything.</p></li>
</ul>

<p><a id="x-28JOURNAL-3AMAKE-LOG-DECORATOR-20FUNCTION-29"></a>
<a id="JOURNAL:MAKE-LOG-DECORATOR%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L2323">[function]</a></span> <span class="reference-object"><a href="#JOURNAL:MAKE-LOG-DECORATOR%20FUNCTION" >make-log-decorator</a></span></span> <span class="locative-args">&amp;key thread time real-time run-time</span></span></p>

<p>Return a function suitable as <a href="#JOURNAL:JOURNAL-LOG-DECORATOR%20%28MGL-PAX:ACCESSOR%20JOURNAL:JOURNAL%29" title="JOURNAL:JOURNAL-LOG-DECORATOR (MGL-PAX:ACCESSOR JOURNAL:JOURNAL)"><code>journal-log-decorator</code></a> that may add
the name of the thread, a timestamp, the internal real-time or
run-time (both in seconds) to events. <code>thread</code>, <code>time</code>, <code>real-time</code> and
<code>run-time</code> are <a href="#JOURNAL:@BOOLEAN-VALUED-SYMBOL%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@BOOLEAN-VALUED-SYMBOL MGL-PAX:GLOSSARY-TERM">boolean-valued symbol</a>s.</p>

<pre><code><span class="code"><span class="paren1">(<span class="code">funcall <span class="paren2">(<span class="code">make-log-decorator <span class="keyword">:thread</span> t <span class="keyword">:time</span> t <span class="keyword">:real-time</span> t <span class="keyword">:run-time</span> t</span>)</span>
         <span class="paren2">(<span class="code">make-leaf-event <span class="keyword">:foo</span></span>)</span></span>)</span>
=&gt; <span class="paren1">(<span class="code"><span class="keyword">:LEAF</span> <span class="keyword">:FOO</span> <span class="keyword">:TIME</span> <span class="string">"2020-08-31T13:38:58.129178+02:00"</span>
    <span class="keyword">:REAL-TIME</span> 66328.82 <span class="keyword">:RUN-TIME</span> 98.663 <span class="keyword">:THREAD</span> <span class="string">"worker"</span></span>)</span></span></code></pre></li>
</ul>

<p><a id="x-28JOURNAL-3A-40LOG-RECORD-20MGL-PAX-3ASECTION-29"></a>
<a id="JOURNAL:@LOG-RECORD%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#JOURNAL:@CUSTOMIZING-LOGS%20MGL-PAX:SECTION" title="Customizing logs">&#8592;</a> <a href="#JOURNAL:@LOGGING%20MGL-PAX:SECTION" title="Logging">&#8593;</a> <a href="#JOURNAL:@LOGGING-WITH-LEAVES%20MGL-PAX:SECTION" title="Logging with `leaf-event`s">&#8594;</a> <a href="#JOURNAL:@LOG-RECORD%20MGL-PAX:SECTION" title="`:log-record`">&#8634;</a> <a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L2354">&#955;</a></span></span></p>

<h3><a href="#JOURNAL:@LOG-RECORD%20MGL-PAX:SECTION">7.2 <code>:log-record</code></a></h3>

<p><a href="#JOURNAL:WITH-JOURNALING%20MGL-PAX:MACRO" title="JOURNAL:WITH-JOURNALING MGL-PAX:MACRO"><code>with-journaling</code></a> and <a href="#JOURNAL:WITH-BUNDLE%20MGL-PAX:MACRO" title="JOURNAL:WITH-BUNDLE MGL-PAX:MACRO"><code>with-bundle</code></a> control replaying and recording
within their dynamic extent, which is rather a necessity because
<a href="#JOURNAL:@REPLAY%20MGL-PAX:SECTION" title="Replay">Replay</a> needs to read the events in the same order as the <a href="#JOURNAL:JOURNALED%20MGL-PAX:MACRO" title="JOURNAL:JOURNALED MGL-PAX:MACRO"><code>journaled</code></a>
<a href="#JOURNAL:@BLOCK%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@BLOCK MGL-PAX:GLOSSARY-TERM">block</a>s are being executed. However, <a href="#JOURNAL:LOG-EVENT%20TYPE" title="JOURNAL:LOG-EVENT TYPE"><code>log-event</code></a>s do not affect
replay, so we can allow more flexibility in routing them.</p>

<p>The <code>log-record</code> argument of <code>journaled</code> and <a href="#JOURNAL:LOGGED%20MGL-PAX:MACRO" title="JOURNAL:LOGGED MGL-PAX:MACRO"><code>logged</code></a> controls where
<code>log-event</code>s are written both within <code>with-journaling</code> and without. The
algorithm to determine the target journal is this:</p>

<ol>
<li><p>If <code>log-record</code> is <code>:record</code>, then the <a href="#JOURNAL:RECORD-JOURNAL%20FUNCTION" title="JOURNAL:RECORD-JOURNAL FUNCTION"><code>record-journal</code></a> is returned.</p></li>
<li><p>If <code>log-record</code> is <code>nil</code>, then it is returned.</p></li>
<li><p>If <code>log-record</code> is a <a href="#JOURNAL:JOURNAL%20CLASS" title="JOURNAL:JOURNAL CLASS"><code>journal</code></a>, then it is returned.</p></li>
<li><p>If <code>log-record</code> is a symbol (other than <code>nil</code>), then the <a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_symb_5.htm" title="SYMBOL-VALUE FUNCTION"><code>symbol-value</code></a>
   of that symbol is assigned to <code>log-record</code>, and we go to step 1.</p></li>
</ol>

<p>If the return value is <code>nil</code>, then the event will not be written
anywhere, else it is written to the journal returned.</p>

<p>This is reminiscent of <a href="http://www.lispworks.com/documentation/HyperSpec/Body/t_syn_st.htm" title="SYNONYM-STREAM CLASS"><code>synonym-stream</code></a>s, also in that it is possible
end up in cycles in the resolution. For this reason, the algorithm
stop with a <a href="#JOURNAL:JOURNAL-ERROR%20CONDITION" title="JOURNAL:JOURNAL-ERROR CONDITION"><code>journal-error</code></a> after 100 iterations.</p>

<h5>Interactions</h5>

<p>Events may be written to <code>log-record</code> even without an enclosing
<code>with-journaling</code>, and it does not affect the <a href="#JOURNAL:JOURNAL-STATE%20TYPE" title="JOURNAL:JOURNAL-STATE TYPE"><code>journal-state</code></a>. However,
it is a <code>journal-error</code> to write to a <code>:completed</code> journal (see
<code>journal-state</code>).</p>

<p>When multiple threads log to the same journal, it is guaranteed that
individual events are written atomically, but frames from different
threads do not necessarily nest. To keep the log informative, the
name of thread may be added to the events as <a href="#JOURNAL:@DECORATION%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@DECORATION MGL-PAX:GLOSSARY-TERM">decoration</a>.</p>

<p>Also, see notes on thread <a href="#JOURNAL:@SAFETY%20MGL-PAX:SECTION" title="Safety">Safety</a>.</p>

<p><a id="x-28JOURNAL-3A-40LOGGING-WITH-LEAVES-20MGL-PAX-3ASECTION-29"></a>
<a id="JOURNAL:@LOGGING-WITH-LEAVES%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#JOURNAL:@LOG-RECORD%20MGL-PAX:SECTION" title="`:log-record`">&#8592;</a> <a href="#JOURNAL:@LOGGING%20MGL-PAX:SECTION" title="Logging">&#8593;</a> <a href="#JOURNAL:@TRACING%20MGL-PAX:SECTION" title="Tracing">&#8594;</a> <a href="#JOURNAL:@LOGGING-WITH-LEAVES%20MGL-PAX:SECTION" title="Logging with `leaf-event`s">&#8634;</a> <a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L2410">&#955;</a></span></span></p>

<h3><a href="#JOURNAL:@LOGGING-WITH-LEAVES%20MGL-PAX:SECTION">7.3 Logging with <code>leaf-event</code>s</a></h3>

<p><a id="x-28JOURNAL-3ALOGGED-20MGL-PAX-3AMACRO-29"></a>
<a id="JOURNAL:LOGGED%20MGL-PAX:MACRO"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L2413">[macro]</a></span> <span class="reference-object"><a href="#JOURNAL:LOGGED%20MGL-PAX:MACRO" >logged</a></span></span> <span class="locative-args">(&amp;optional (log-record :record)) format-control &amp;rest format-args</span></span></p>

<p><code>logged</code> creates a single <a href="#JOURNAL:LEAF-EVENT%20TYPE" title="JOURNAL:LEAF-EVENT TYPE"><code>leaf-event</code></a>, whose name is the string
constructed by <a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_format.htm" title="FORMAT FUNCTION"><code>format</code></a>. For example:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">with-journaling</span></i> <span class="paren2">(<span class="code"><span class="keyword">:record</span> t</span>)</span>
  <span class="paren2">(<span class="code">logged <span class="paren3">(<span class="code"></span>)</span> <span class="string">"Hello, ~A."</span> <span class="string">"world"</span></span>)</span>
  <span class="paren2">(<span class="code">list-events</span>)</span></span>)</span>
=&gt; <span class="paren1">(<span class="code"><span class="paren2">(<span class="code"><span class="keyword">:LEAF</span> <span class="string">"Hello, world."</span></span>)</span></span>)</span></span></code></pre>

<p><code>leaf-event</code>s are <a href="#JOURNAL:LOG-EVENT%20TYPE" title="JOURNAL:LOG-EVENT TYPE"><code>log-event</code></a>s with no separate in- and out-events. They
have an <a href="#JOURNAL:EVENT-NAME%20FUNCTION" title="JOURNAL:EVENT-NAME FUNCTION"><code>event-name</code></a> and no other properties. Use <code>logged</code> for
point-in-time textual log messages, and <a href="#JOURNAL:JOURNALED%20MGL-PAX:MACRO" title="JOURNAL:JOURNALED MGL-PAX:MACRO"><code>journaled</code></a> with <code>version</code>
<code>nil</code> (i.e. <a href="#JOURNAL:FRAMED%20MGL-PAX:MACRO" title="JOURNAL:FRAMED MGL-PAX:MACRO"><code>framed</code></a>) to provide context.</p>

<p>Also, see <a href="#JOURNAL:@LOG-RECORD%20MGL-PAX:SECTION" title="`:log-record`"><code>:log-record</code></a>.</p></li>
</ul>

<p><a id="x-28JOURNAL-3A-40TRACING-20MGL-PAX-3ASECTION-29"></a>
<a id="JOURNAL:@TRACING%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#JOURNAL:@LOGGING-WITH-LEAVES%20MGL-PAX:SECTION" title="Logging with `leaf-event`s">&#8592;</a> <a href="journal-manual.html" title="Journal manual">&#8593;</a> <a href="#JOURNAL:@JOURNAL-SLIME-INTEGRATION%20MGL-PAX:SECTION" title="Slime integration">&#8594;</a> <a href="#JOURNAL:@TRACING%20MGL-PAX:SECTION" title="Tracing">&#8634;</a> <a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L2448">&#955;</a></span></span></p>

<h2><a href="#JOURNAL:@TRACING%20MGL-PAX:SECTION">8 Tracing</a></h2>

<p><a href="#JOURNAL:JTRACE%20MGL-PAX:MACRO" title="JOURNAL:JTRACE MGL-PAX:MACRO"><code>jtrace</code></a> behaves similarly to <a href="http://www.lispworks.com/documentation/HyperSpec/Body/m_tracec.htm" title="TRACE MGL-PAX:MACRO"><code>cl:trace</code></a> but deals <a href="#JOURNAL:@NON-LOCAL-EXIT%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@NON-LOCAL-EXIT MGL-PAX:GLOSSARY-TERM">non-local exit</a>s
gracefully.</p>

<h5>Basic tracing</h5>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">defun</span></i> foo <span class="paren2">(<span class="code">x</span>)</span>
  <span class="paren2">(<span class="code">sleep 0.12</span>)</span>
  <span class="paren2">(<span class="code">1+ x</span>)</span></span>)</span>

<span class="paren1">(<span class="code"><i><span class="symbol">defun</span></i> bar <span class="paren2">(<span class="code">x</span>)</span>
  <span class="paren2">(<span class="code">foo <span class="paren3">(<span class="code">+ x 2</span>)</span></span>)</span>
  <span class="paren2">(<span class="code">error <span class="string">"xxx"</span></span>)</span></span>)</span>

<span class="paren1">(<span class="code">jtrace foo bar</span>)</span>

<span class="paren1">(<span class="code">ignore-errors <span class="paren2">(<span class="code">bar 1</span>)</span></span>)</span>
..
.. <span class="paren1">(<span class="code">BAR 1</span>)</span>
..   <span class="paren1">(<span class="code">FOO 3</span>)</span>
..   =&gt; 4
.. =E "SIMPLE-ERROR" "xxx"</span></code></pre>

<h5>Log-like output</h5>

<p>It can also include the name of the originating thread and
timestamps in the output:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">let</span></i> <span class="paren2">(<span class="code"><span class="paren3">(<span class="code"><span class="special">*trace-thread*</span> t</span>)</span>
      <span class="paren3">(<span class="code"><span class="special">*trace-time*</span> t</span>)</span></span>)</span>
  <span class="paren2">(<span class="code">ignore-errors <span class="paren3">(<span class="code">bar 1</span>)</span></span>)</span></span>)</span>
..
.. 2020-09-02T19:58:19.415204+02:00 worker: <span class="paren1">(<span class="code">BAR 1</span>)</span>
.. 2020-09-02T19:58:19.415547+02:00 worker:   <span class="paren1">(<span class="code">FOO 3</span>)</span>
.. 2020-09-02T19:58:19.535766+02:00 worker:   =&gt; 4
.. 2020-09-02T19:58:19.535908+02:00 worker: =E "SIMPLE-ERROR" "xxx"</span></code></pre>

<h5>Profiler-like output</h5>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">let</span></i> <span class="paren2">(<span class="code"><span class="paren3">(<span class="code"><span class="special">*trace-real-time*</span> t</span>)</span>
      <span class="paren3">(<span class="code"><span class="special">*trace-run-time*</span> t</span>)</span></span>)</span>
  <span class="paren2">(<span class="code">ignore-errors <span class="paren3">(<span class="code">bar 1</span>)</span></span>)</span></span>)</span>
..
.. #16735.736 !68.368: <span class="paren1">(<span class="code">BAR 1</span>)</span>
.. #16735.736 !68.369:   <span class="paren1">(<span class="code">FOO 3</span>)</span>
.. #16735.857 !68.369:   =&gt; 4
.. #16735.857 !68.369: =E "SIMPLE-ERROR" "xxx"</span></code></pre>

<h5>Customizing the content and the format</h5>

<p>If these options are insufficient, the content and the format of the
trace can be customized:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">let</span></i> <span class="paren2">(<span class="code"><span class="paren3">(<span class="code"><span class="special">*trace-journal*</span>
       <span class="paren4">(<span class="code">make-pprint-journal <span class="keyword">:pretty</span> '<span class="special">*trace-pretty*</span>
                     <span class="keyword">:prettifier</span> <span class="paren5">(<span class="code"><i><span class="symbol">lambda</span></i> <span class="paren6">(<span class="code">event depth stream</span>)</span>
                                   <span class="paren6">(<span class="code">format stream <span class="string">"~%Depth: ~A, event: ~S"</span>
                                           depth event</span>)</span></span>)</span>
                     <span class="keyword">:stream</span> <span class="paren5">(<span class="code">make-synonym-stream '<span class="special">*error-output*</span></span>)</span>
                     <span class="keyword">:log-decorator</span> <span class="paren5">(<span class="code"><i><span class="symbol">lambda</span></i> <span class="paren6">(<span class="code">event</span>)</span>
                                      <span class="paren6">(<span class="code">append event '<span class="paren1">(<span class="code"><span class="keyword">:custom</span> 7</span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span>
  <span class="paren2">(<span class="code">ignore-errors <span class="paren3">(<span class="code">bar 1</span>)</span></span>)</span></span>)</span>
..
.. Depth: 0, event: <span class="paren1">(<span class="code"><span class="keyword">:IN</span> BAR <span class="keyword">:ARGS</span> <span class="paren2">(<span class="code">1</span>)</span> <span class="keyword">:CUSTOM</span> 7</span>)</span>
.. Depth: 1, event: <span class="paren1">(<span class="code"><span class="keyword">:IN</span> FOO <span class="keyword">:ARGS</span> <span class="paren2">(<span class="code">3</span>)</span> <span class="keyword">:CUSTOM</span> 7</span>)</span>
.. Depth: 1, event: <span class="paren1">(<span class="code"><span class="keyword">:OUT</span> FOO <span class="keyword">:VALUES</span> <span class="paren2">(<span class="code">4</span>)</span> <span class="keyword">:CUSTOM</span> 7</span>)</span>
.. Depth: 0, event: <span class="paren1">(<span class="code"><span class="keyword">:OUT</span> BAR <span class="keyword">:ERROR</span> <span class="paren2">(<span class="code"><span class="string">"SIMPLE-ERROR"</span> <span class="string">"xxx"</span></span>)</span> <span class="keyword">:CUSTOM</span> 7</span>)</span></span></code></pre>

<p>In the above, <a href="#JOURNAL:*TRACE-JOURNAL*%20VARIABLE" title="JOURNAL:*TRACE-JOURNAL* VARIABLE"><code>*trace-journal*</code></a> was bound locally to keep the example
from wrecking the global default, but the same effect could be
achieved by <a href="http://www.lispworks.com/documentation/HyperSpec/Body/m_setf.htm" title="SETF MGL-PAX:MACRO"><code>setf</code></a>ing <a href="#JOURNAL:PPRINT-JOURNAL-PRETTIFIER%20%28MGL-PAX:ACCESSOR%20JOURNAL:PPRINT-JOURNAL%29" title="JOURNAL:PPRINT-JOURNAL-PRETTIFIER (MGL-PAX:ACCESSOR JOURNAL:PPRINT-JOURNAL)"><code>pprint-journal-prettifier</code></a>,
<a href="#JOURNAL:PPRINT-JOURNAL-STREAM%20%28MGL-PAX:ACCESSOR%20JOURNAL:PPRINT-JOURNAL%29" title="JOURNAL:PPRINT-JOURNAL-STREAM (MGL-PAX:ACCESSOR JOURNAL:PPRINT-JOURNAL)"><code>pprint-journal-stream</code></a> and <a href="#JOURNAL:JOURNAL-LOG-DECORATOR%20%28MGL-PAX:ACCESSOR%20JOURNAL:JOURNAL%29" title="JOURNAL:JOURNAL-LOG-DECORATOR (MGL-PAX:ACCESSOR JOURNAL:JOURNAL)"><code>journal-log-decorator</code></a>.</p>

<p><a id="x-28JOURNAL-3AJTRACE-20MGL-PAX-3AMACRO-29"></a>
<a id="JOURNAL:JTRACE%20MGL-PAX:MACRO"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L2573">[macro]</a></span> <span class="reference-object"><a href="#JOURNAL:JTRACE%20MGL-PAX:MACRO" >jtrace</a></span></span> <span class="locative-args">&amp;rest names</span></span></p>

<p>Like <a href="http://www.lispworks.com/documentation/HyperSpec/Body/m_tracec.htm" title="TRACE MGL-PAX:MACRO"><code>cl:trace</code></a>, <code>jtrace</code> takes a list of symbols. When functions
denoted by those <code>names</code> are invoked, their names, arguments and
outcomes are printed in human readable form to <a href="http://www.lispworks.com/documentation/HyperSpec/Body/v_debug_.htm" title="*TRACE-OUTPUT* VARIABLE"><code>*trace-output*</code></a>. These
values may not be <a href="#JOURNAL:@READABLE%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@READABLE MGL-PAX:GLOSSARY-TERM">readable</a>, <code>jtrace</code> does not care.</p>

<p>The format of the output is the same as that of <a href="#JOURNAL:PPRINT-EVENTS%20FUNCTION" title="JOURNAL:PPRINT-EVENTS FUNCTION"><code>pprint-events</code></a>.
Behind the scenes, <code>jtrace</code> encapsulates the global functions with
<code>names</code> in wrapper that behaves as if <code>foo</code> in the example above was
defined like this:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">defun</span></i> foo <span class="paren2">(<span class="code">x</span>)</span>
  <span class="paren2">(<span class="code">framed <span class="paren3">(<span class="code">foo <span class="keyword">:args</span> `<span class="paren4">(<span class="code">,x</span>)</span> <span class="keyword">:log-record</span> <span class="special">*trace-journal*</span></span>)</span>
    <span class="paren3">(<span class="code">1+ x</span>)</span></span>)</span></span>)</span></span></code></pre>

<p>If <code>jtrace</code> is invoked with no arguments, it returns the list of
symbols currently traced.</p>

<p>On Lisps other than SBCL, where a function encapsulation facility is
not available or it is not used by Journal, <code>jtrace</code> simply sets
<a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_symb_1.htm" title="SYMBOL-FUNCTION FUNCTION"><code>symbol-function</code></a>. This solution loses the tracing encapsulation when
the function is recompiled. On these platforms, <code>(jtrace)</code> also
retraces all functions that should be traced but aren't.</p>

<p>The main advantage of <code>jtrace</code> over <code>cl:trace</code> is the ability to trace
errors, not just normal return values. As it is built on <a href="#JOURNAL:JOURNALED%20MGL-PAX:MACRO" title="JOURNAL:JOURNALED MGL-PAX:MACRO"><code>journaled</code></a>,
it can also detect â somewhat heuristically â <a href="http://www.lispworks.com/documentation/HyperSpec/Body/s_throw.htm" title="THROW MGL-PAX:MACRO"><code>throw</code></a>s and similar.</p></li>
</ul>

<p><a id="x-28JOURNAL-3AJUNTRACE-20MGL-PAX-3AMACRO-29"></a>
<a id="JOURNAL:JUNTRACE%20MGL-PAX:MACRO"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L2663">[macro]</a></span> <span class="reference-object"><a href="#JOURNAL:JUNTRACE%20MGL-PAX:MACRO" >juntrace</a></span></span> <span class="locative-args">&amp;rest names</span></span></p>

<p>Like <a href="http://www.lispworks.com/documentation/HyperSpec/Body/m_tracec.htm" title="UNTRACE MGL-PAX:MACRO"><code>cl:untrace</code></a>, <code>juntrace</code> makes it so that the global functions
denoted by the symbols <code>names</code> are no longer traced by <a href="#JOURNAL:JTRACE%20MGL-PAX:MACRO" title="JOURNAL:JTRACE MGL-PAX:MACRO"><code>jtrace</code></a>. When
invoked with no arguments, it untraces all traced functions.</p></li>
</ul>

<p><a id="x-28JOURNAL-3A-2ATRACE-PRETTY-2A-20VARIABLE-29"></a>
<a id="JOURNAL:*TRACE-PRETTY*%20VARIABLE"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L2539">[variable]</a></span> <span class="reference-object"><a href="#JOURNAL:*TRACE-PRETTY*%20VARIABLE" >*trace-pretty*</a></span></span> <span class="locative-args">t</span></span></p>

<p>If <code>*trace-pretty*</code> is true, then <a href="#JOURNAL:JTRACE%20MGL-PAX:MACRO" title="JOURNAL:JTRACE MGL-PAX:MACRO"><code>jtrace</code></a> produces output like
<a href="#JOURNAL:PPRINT-EVENTS%20FUNCTION" title="JOURNAL:PPRINT-EVENTS FUNCTION"><code>pprint-events</code></a>, else it's like <a href="#JOURNAL:PRINT-EVENTS%20FUNCTION" title="JOURNAL:PRINT-EVENTS FUNCTION"><code>print-events</code></a>.</p></li>
</ul>

<p><a id="x-28JOURNAL-3A-2ATRACE-THREAD-2A-20VARIABLE-29"></a>
<a id="JOURNAL:*TRACE-THREAD*%20VARIABLE"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L2543">[variable]</a></span> <span class="reference-object"><a href="#JOURNAL:*TRACE-THREAD*%20VARIABLE" >*trace-thread*</a></span></span> <span class="locative-args">nil</span></span></p>

<p>Controls whether to decorate the trace with the name of the
originating thread. See <a href="#JOURNAL:MAKE-LOG-DECORATOR%20FUNCTION" title="JOURNAL:MAKE-LOG-DECORATOR FUNCTION"><code>make-log-decorator</code></a>.</p></li>
</ul>

<p><a id="x-28JOURNAL-3A-2ATRACE-TIME-2A-20VARIABLE-29"></a>
<a id="JOURNAL:*TRACE-TIME*%20VARIABLE"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L2547">[variable]</a></span> <span class="reference-object"><a href="#JOURNAL:*TRACE-TIME*%20VARIABLE" >*trace-time*</a></span></span> <span class="locative-args">nil</span></span></p>

<p>Controls whether to decorate the trace with a timestamp. See
<a href="#JOURNAL:MAKE-LOG-DECORATOR%20FUNCTION" title="JOURNAL:MAKE-LOG-DECORATOR FUNCTION"><code>make-log-decorator</code></a>.</p></li>
</ul>

<p><a id="x-28JOURNAL-3A-2ATRACE-REAL-TIME-2A-20VARIABLE-29"></a>
<a id="JOURNAL:*TRACE-REAL-TIME*%20VARIABLE"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L2551">[variable]</a></span> <span class="reference-object"><a href="#JOURNAL:*TRACE-REAL-TIME*%20VARIABLE" >*trace-real-time*</a></span></span> <span class="locative-args">nil</span></span></p>

<p>Controls whether to decorate the trace with the internal real-time.
See <a href="#JOURNAL:MAKE-LOG-DECORATOR%20FUNCTION" title="JOURNAL:MAKE-LOG-DECORATOR FUNCTION"><code>make-log-decorator</code></a>.</p></li>
</ul>

<p><a id="x-28JOURNAL-3A-2ATRACE-RUN-TIME-2A-20VARIABLE-29"></a>
<a id="JOURNAL:*TRACE-RUN-TIME*%20VARIABLE"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L2555">[variable]</a></span> <span class="reference-object"><a href="#JOURNAL:*TRACE-RUN-TIME*%20VARIABLE" >*trace-run-time*</a></span></span> <span class="locative-args">nil</span></span></p>

<p>Controls whether to decorate the trace with the internal run-time.
See <a href="#JOURNAL:MAKE-LOG-DECORATOR%20FUNCTION" title="JOURNAL:MAKE-LOG-DECORATOR FUNCTION"><code>make-log-decorator</code></a>.</p></li>
</ul>

<p><a id="x-28JOURNAL-3A-2ATRACE-JOURNAL-2A-20VARIABLE-29"></a>
<a id="JOURNAL:*TRACE-JOURNAL*%20VARIABLE"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L2798">[variable]</a></span> <span class="reference-object"><a href="#JOURNAL:*TRACE-JOURNAL*%20VARIABLE" >*trace-journal*</a></span></span> <span class="locative-args">#&lt;pprint-journal :new&gt;</span></span></p>

<p>The <a href="#JOURNAL:JOURNAL%20CLASS" title="JOURNAL:JOURNAL CLASS"><code>journal</code></a> where <a href="#JOURNAL:JTRACE%20MGL-PAX:MACRO" title="JOURNAL:JTRACE MGL-PAX:MACRO"><code>jtrace</code></a> writes <a href="#JOURNAL:LOG-EVENT%20TYPE" title="JOURNAL:LOG-EVENT TYPE"><code>log-event</code></a>s. By default, it is a
<a href="#JOURNAL:PPRINT-JOURNAL%20CLASS" title="JOURNAL:PPRINT-JOURNAL CLASS"><code>pprint-journal</code></a> that sets up a <a href="http://www.lispworks.com/documentation/HyperSpec/Body/t_syn_st.htm" title="SYNONYM-STREAM CLASS"><code>synonym-stream</code></a> to <a href="http://www.lispworks.com/documentation/HyperSpec/Body/v_debug_.htm" title="*TRACE-OUTPUT* VARIABLE"><code>*trace-output*</code></a> and
sends its output there. It pays attention to <a href="#JOURNAL:*TRACE-PRETTY*%20VARIABLE" title="JOURNAL:*TRACE-PRETTY* VARIABLE"><code>*trace-pretty*</code></a>, and its
log decorator is affected by <a href="#JOURNAL:*TRACE-TIME*%20VARIABLE" title="JOURNAL:*TRACE-TIME* VARIABLE"><code>*trace-time*</code></a> and <a href="#JOURNAL:*TRACE-THREAD*%20VARIABLE" title="JOURNAL:*TRACE-THREAD* VARIABLE"><code>*trace-thread*</code></a>.
However, by changing <a href="#JOURNAL:JOURNAL-LOG-DECORATOR%20%28MGL-PAX:ACCESSOR%20JOURNAL:JOURNAL%29" title="JOURNAL:JOURNAL-LOG-DECORATOR (MGL-PAX:ACCESSOR JOURNAL:JOURNAL)"><code>journal-log-decorator</code></a> and
<a href="#JOURNAL:PPRINT-JOURNAL-PRETTIFIER%20%28MGL-PAX:ACCESSOR%20JOURNAL:PPRINT-JOURNAL%29" title="JOURNAL:PPRINT-JOURNAL-PRETTIFIER (MGL-PAX:ACCESSOR JOURNAL:PPRINT-JOURNAL)"><code>pprint-journal-prettifier</code></a>, content and output can be customized.</p></li>
</ul>

<p><a id="x-28JOURNAL-3A-40JOURNAL-SLIME-INTEGRATION-20MGL-PAX-3ASECTION-29"></a>
<a id="JOURNAL:@JOURNAL-SLIME-INTEGRATION%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#JOURNAL:@TRACING%20MGL-PAX:SECTION" title="Tracing">&#8592;</a> <a href="#JOURNAL:@TRACING%20MGL-PAX:SECTION" title="Tracing">&#8593;</a> <a href="#JOURNAL:@REPLAY%20MGL-PAX:SECTION" title="Replay">&#8594;</a> <a href="#JOURNAL:@JOURNAL-SLIME-INTEGRATION%20MGL-PAX:SECTION" title="Slime integration">&#8634;</a> <a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L2690">&#955;</a></span></span></p>

<h3><a href="#JOURNAL:@JOURNAL-SLIME-INTEGRATION%20MGL-PAX:SECTION">8.1 Slime integration</a></h3>

<p><a href="https://common-lisp.net/project/slime/" >Slime</a>, by default, binds
<code>C-c C-t</code> to toggling <a href="http://www.lispworks.com/documentation/HyperSpec/Body/m_tracec.htm" title="TRACE MGL-PAX:MACRO"><code>cl:trace</code></a>. To integrate <a href="#JOURNAL:JTRACE%20MGL-PAX:MACRO" title="JOURNAL:JTRACE MGL-PAX:MACRO"><code>jtrace</code></a> into Slime, add
the following ELisp snippet to your Emacs initialization file or
load <code>src/journal.el</code>:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_167.html#IDX483" class="symbol"><i><span class="symbol">defun</span></i></a> slime-toggle-jtrace-fdefinition <span class="paren2">(<span class="code">spec</span>)</span>
  <span class="string">"Toggle JTRACE."</span>
  <span class="paren2">(<span class="code"><a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_290.html#SEC290" class="symbol">interactive</a> <span class="paren3">(<span class="code"><a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_83.html#IDX225" class="symbol">list</a> <span class="paren4">(<span class="code">slime-read-from-minibuffer
                      <span class="string">"j(un)trace: "</span> <span class="paren5">(<span class="code">slime-symbol-at-point</span>)</span></span>)</span></span>)</span></span>)</span>
  <span class="paren2">(<span class="code"><a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_621.html#IDX2298" class="symbol">message</a> <span class="string">"%s"</span> <span class="paren3">(<span class="code">slime-eval
                 <span class="comment">;; Silently fail if Journal is not loaded.
</span>                 `<span class="paren4">(<span class="code">cl:when <span class="paren5">(<span class="code">cl:find-package <span class="keyword">:journal</span></span>)</span>
                           <span class="paren5">(<span class="code">cl:funcall
                            <span class="paren6">(<span class="code">cl:find-symbol
                             <span class="paren1">(<span class="code">cl:symbol-name <span class="keyword">:swank-toggle-jtrace</span></span>)</span> <span class="keyword">:journal</span></span>)</span>
                            ,spec</span>)</span></span>)</span></span>)</span></span>)</span></span>)</span>

<span class="paren1">(<span class="code"><a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_332.html#IDX1020" class="symbol"><i><span class="symbol">define-key</span></i></a> slime-mode-map <span class="paren2">(<span class="code">kbd <span class="string">"C-c C-j"</span></span>)</span>
  'slime-toggle-jtrace-fdefinition</span>)</span>

<span class="paren1">(<span class="code"><a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_332.html#IDX1020" class="symbol"><i><span class="symbol">define-key</span></i></a> slime-repl-mode-map <span class="paren2">(<span class="code">kbd <span class="string">"C-c C-j"</span></span>)</span>
  'slime-toggle-jtrace-fdefinition</span>)</span></span></code></pre>

<p>Since <a href="#JOURNAL:JTRACE%20MGL-PAX:MACRO" title="JOURNAL:JTRACE MGL-PAX:MACRO"><code>jtrace</code></a> lacks some features of <a href="http://www.lispworks.com/documentation/HyperSpec/Body/m_tracec.htm" title="TRACE MGL-PAX:MACRO"><code>cl:trace</code></a>, most notably that of
tracing non-global functions, it is assigned a separate binding,
<code>C-c C-j</code>.</p>

<p><a id="x-28JOURNAL-3A-40REPLAY-20MGL-PAX-3ASECTION-29"></a>
<a id="JOURNAL:@REPLAY%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#JOURNAL:@JOURNAL-SLIME-INTEGRATION%20MGL-PAX:SECTION" title="Slime integration">&#8592;</a> <a href="journal-manual.html" title="Journal manual">&#8593;</a> <a href="#JOURNAL:@JOURNALED-FOR-REPLAY%20MGL-PAX:SECTION" title="Journaled for replay">&#8594;</a> <a href="#JOURNAL:@REPLAY%20MGL-PAX:SECTION" title="Replay">&#8634;</a> <a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L2713">&#955;</a></span></span></p>

<h2><a href="#JOURNAL:@REPLAY%20MGL-PAX:SECTION">9 Replay</a></h2>

<p>During replay, code is executed normally with special rules for
<a href="#JOURNAL:@BLOCK%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@BLOCK MGL-PAX:GLOSSARY-TERM">block</a>s. There are two modes for dealing with blocks: replaying the
code and replaying the outcome. When code is replayed, upon entering
and leaving a block, the events generated are matched to events read
from the journal being replayed. If the events don't match,
<a href="#JOURNAL:REPLAY-FAILURE%20CONDITION" title="JOURNAL:REPLAY-FAILURE CONDITION"><code>replay-failure</code></a> is signalled, which marks the record journal as having
failed the replay. This is intended to make sure that the state of
the program during the replay matches the state at the time of
recording. In the other mode, when the outcome is replayed, a block
may not be executed at all, but its recorded outcome is
reproduced (i.e. the recorded return values are simply returned).</p>

<p>Replay can be only be initiated with <a href="#JOURNAL:WITH-JOURNALING%20MGL-PAX:MACRO" title="JOURNAL:WITH-JOURNALING MGL-PAX:MACRO"><code>with-journaling</code></a> (or its close
kin <a href="#JOURNAL:WITH-BUNDLE%20MGL-PAX:MACRO" title="JOURNAL:WITH-BUNDLE MGL-PAX:MACRO"><code>with-bundle</code></a>). After the per-event processing described below,
when <code>with-journaling</code> finishes, it might signal <a href="#JOURNAL:REPLAY-INCOMPLETE%20CONDITION" title="JOURNAL:REPLAY-INCOMPLETE CONDITION"><code>replay-incomplete</code></a> if
there are unprocessed non-log events left in the replay journal.</p>

<p>Replay is deemed successful or failed depending on whether all
events are replayed from the replay journal without a
<code>replay-failure</code>. A journal that records events from a successful
replay can be used in place of the journal that was replayed, and so
on. The logic of replacing journals with their successful replays is
automated by <a href="#JOURNAL:@BUNDLES%20MGL-PAX:SECTION" title="Bundles">Bundles</a>. <code>with-journaling</code> does not allow replay from
journals that were failed replays themselves. The mechanism, in
terms of which tracking success and failure of replays is
implemented, revolves around <a href="#JOURNAL:JOURNAL-STATE%20TYPE" title="JOURNAL:JOURNAL-STATE TYPE"><code>journal-state</code></a> and
<a href="#JOURNAL:EVENT-VERSION%20TYPE" title="JOURNAL:EVENT-VERSION TYPE"><code>event-version</code></a>s, which we discuss next.</p>

<p><a id="x-28JOURNAL-3AJOURNAL-STATE-20TYPE-29"></a>
<a id="JOURNAL:JOURNAL-STATE%20TYPE"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L2750">[type]</a></span> <span class="reference-object"><a href="#JOURNAL:JOURNAL-STATE%20TYPE" >journal-state</a></span></span></span></p>

<p><a href="#JOURNAL:JOURNAL%20CLASS" title="JOURNAL:JOURNAL CLASS"><code>journal</code></a>'s state with respect to replay is updated during
<a href="#JOURNAL:WITH-JOURNALING%20MGL-PAX:MACRO" title="JOURNAL:WITH-JOURNALING MGL-PAX:MACRO"><code>with-journaling</code></a>. The possible states are:</p>

<ul>
<li><p><strong><code>:new</code></strong>: This journal was just created but never recorded to.</p></li>
<li><p><strong><code>:replaying</code></strong>: Replaying events has started, some events may have
  been replayed successfully, but there are more non-log events to
  replay.</p></li>
<li><p><strong><code>:mismatched</code></strong>: There was a <a href="#JOURNAL:REPLAY-FAILURE%20CONDITION" title="JOURNAL:REPLAY-FAILURE CONDITION"><code>replay-failure</code></a>. In this state,
  <a href="#JOURNAL:VERSIONED-EVENT%20TYPE" title="JOURNAL:VERSIONED-EVENT TYPE"><code>versioned-event</code></a>s generated are downgraded to <a href="#JOURNAL:LOG-EVENT%20TYPE" title="JOURNAL:LOG-EVENT TYPE"><code>log-event</code></a>s,
  <a href="#JOURNAL:EXTERNAL-EVENT%20TYPE" title="JOURNAL:EXTERNAL-EVENT TYPE"><code>external-event</code></a>s and <a href="#JOURNAL:@INVOKED%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@INVOKED MGL-PAX:GLOSSARY-TERM">invoked</a> trigger <a href="#JOURNAL:DATA-EVENT-LOSSAGE%20CONDITION" title="JOURNAL:DATA-EVENT-LOSSAGE CONDITION"><code>data-event-lossage</code></a>.</p></li>
<li><p><strong><code>:recording</code></strong>: All events from the replay journal were
  successfully replayed, and now new events are being recorded
  without being matched to the replay journal.</p></li>
<li><p><strong><code>:logging</code></strong>: There was a <a href="#JOURNAL:RECORD-UNEXPECTED-OUTCOME%20CONDITION" title="JOURNAL:RECORD-UNEXPECTED-OUTCOME CONDITION"><code>record-unexpected-outcome</code></a>. In this
  state, <code>versioned-event</code>s generated are downgraded to <code>log-event</code>s,
  <code>external-event</code>s and <a href="#JOURNAL:@INVOKED%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@INVOKED MGL-PAX:GLOSSARY-TERM">invoked</a> trigger <code>data-event-lossage</code>.</p></li>
<li><p><strong><code>:failed</code></strong>: The journal is to be discarded. It encountered a
  <a href="#JOURNAL:JOURNALING-FAILURE%20CONDITION" title="JOURNAL:JOURNALING-FAILURE CONDITION"><code>journaling-failure</code></a> or a <code>replay-failure</code> without completing the
  replay and reaching <code>:recording</code>.</p></li>
<li><p><strong><code>:completed</code></strong>: All events were successfully replayed and
  <code>with-journaling</code> finished or a <code>journaling-failure</code> occurred while
  <code>:recording</code> or <code>:logging</code>.</p></li>
</ul>

<p>The state transitions are:</p>

<pre><code>:NEW                -&gt; :REPLAYING  (on entering WITH-JOURNALING)
:REPLAYING          -&gt; :MISMATCHED (on REPLAY-FAILURE)
:REPLAYING          -&gt; :FAILED     (on REPLAY-INCOMPLETE)
:REPLAYING          -&gt; :FAILED     (on JOURNALING-FAILURE)
:REPLAYING          -&gt; :RECORDING  (on successfully replaying all events)
:MISMATCHED         -&gt; :FAILED     (on leaving WITH-JOURNALING)
:RECORDING          -&gt; :LOGGING    (on RECORD-UNEXPECTED-OUTCOME)
:RECORDING/:LOGGING -&gt; :COMPLETED  (on leaving WITH-JOURNALING)
:RECORDING/:LOGGING -&gt; :COMPLETED  (on JOURNALING-FAILURE)
</code></pre>

<p><code>:new</code> is the starting state. It is a <a href="#JOURNAL:JOURNAL-ERROR%20CONDITION" title="JOURNAL:JOURNAL-ERROR CONDITION"><code>journal-error</code></a> to attempt to
write to journals in <code>:completed</code>. Note that once in <code>:recording</code>, the
only possible terminal state is <code>:completed</code>.</p></li>
</ul>

<p><a id="x-28JOURNAL-3A-40JOURNALED-FOR-REPLAY-20MGL-PAX-3ASECTION-29"></a>
<a id="JOURNAL:@JOURNALED-FOR-REPLAY%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#JOURNAL:@REPLAY%20MGL-PAX:SECTION" title="Replay">&#8592;</a> <a href="#JOURNAL:@REPLAY%20MGL-PAX:SECTION" title="Replay">&#8593;</a> <a href="#JOURNAL:@BUNDLES%20MGL-PAX:SECTION" title="Bundles">&#8594;</a> <a href="#JOURNAL:@JOURNALED-FOR-REPLAY%20MGL-PAX:SECTION" title="Journaled for replay">&#8634;</a> <a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L2813">&#955;</a></span></span></p>

<h3><a href="#JOURNAL:@JOURNALED-FOR-REPLAY%20MGL-PAX:SECTION">9.1 Journaled for replay</a></h3>

<p>The following arguments of <a href="#JOURNAL:JOURNALED%20MGL-PAX:MACRO" title="JOURNAL:JOURNALED MGL-PAX:MACRO"><code>journaled</code></a> control behaviour under replay.</p>

<ul>
<li><p><code>version</code>: see <a href="#JOURNAL:EVENT-VERSION%20TYPE" title="JOURNAL:EVENT-VERSION TYPE"><code>event-version</code></a> below.</p></li>
<li><p><code>insertable</code> controls whether <a href="#JOURNAL:VERSIONED-EVENT%20TYPE" title="JOURNAL:VERSIONED-EVENT TYPE"><code>versioned-event</code></a>s and <a href="#JOURNAL:EXTERNAL-EVENT%20TYPE" title="JOURNAL:EXTERNAL-EVENT TYPE"><code>external-event</code></a>s
  may be replayed with the <em>insert</em> replay strategy (see
  <a href="#JOURNAL:@THE-REPLAY-STRATEGY%20MGL-PAX:SECTION" title="The replay strategy">The replay strategy</a>). Does not affect <a href="#JOURNAL:LOG-EVENT%20TYPE" title="JOURNAL:LOG-EVENT TYPE"><code>log-event</code></a>s, which are
  always _insert_ed. Note that inserting <code>external-event</code>s while
  <code>:replaying</code> is often not meaningful (e.g. asking the user for input
  may lead to a <a href="#JOURNAL:REPLAY-FAILURE%20CONDITION" title="JOURNAL:REPLAY-FAILURE CONDITION"><code>replay-failure</code></a>). See <a href="#JOURNAL:PEEK-REPLAY-EVENT%20FUNCTION" title="JOURNAL:PEEK-REPLAY-EVENT FUNCTION"><code>peek-replay-event</code></a> for an
  example on how to properly insert these kinds of <code>external-event</code>s.</p></li>
<li><p><code>replay-values</code>, a function or <code>nil</code>, may be called with <a href="#JOURNAL:EVENT-OUTCOME%20FUNCTION" title="JOURNAL:EVENT-OUTCOME FUNCTION"><code>event-outcome</code></a>
  when replaying and <code>:version</code> <code>:infinity</code>. <code>nil</code> is equivalent to
  <a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_vals_l.htm" title="VALUES-LIST FUNCTION"><code>values-list</code></a>. See <a href="#JOURNAL:VALUES%3C-%20FUNCTION" title="JOURNAL:VALUES&lt;- FUNCTION"><code>values&lt;-</code></a> for an example.</p></li>
<li><p><code>replay-condition</code>, a function or <code>nil</code>, may be called with
  <code>event-outcome</code> (the return value of the function provided as
  <code>:condition</code>) when replaying and <code>:version</code> is <code>:infinity</code>. <code>nil</code> is
  equivalent to the <a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_error.htm" title="ERROR FUNCTION"><code>error</code></a> function. Replaying conditions is
  cumbersome and best avoided.</p></li>
</ul>

<p><a id="x-28JOURNAL-3A-2AFORCE-INSERTABLE-2A-20VARIABLE-29"></a>
<a id="JOURNAL:*FORCE-INSERTABLE*%20VARIABLE"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L2864">[variable]</a></span> <span class="reference-object"><a href="#JOURNAL:*FORCE-INSERTABLE*%20VARIABLE" >*force-insertable*</a></span></span> <span class="locative-args">nil</span></span></p>

<p>The default value of the <code>insertable</code> argument of <a href="#JOURNAL:JOURNALED%20MGL-PAX:MACRO" title="JOURNAL:JOURNALED MGL-PAX:MACRO"><code>journaled</code></a> for
<a href="#JOURNAL:VERSIONED-EVENT%20TYPE" title="JOURNAL:VERSIONED-EVENT TYPE"><code>versioned-event</code></a>s. Binding this to <code>t</code> allows en-masse structural
upgrades in combination with <a href="#JOURNAL:WITH-REPLAY-FILTER%20MGL-PAX:MACRO" title="JOURNAL:WITH-REPLAY-FILTER MGL-PAX:MACRO"><code>with-replay-filter</code></a>. Does not affect
<a href="#JOURNAL:EXTERNAL-EVENT%20TYPE" title="JOURNAL:EXTERNAL-EVENT TYPE"><code>external-event</code></a>s. See <a href="#JOURNAL:@UPGRADES-AND-REPLAY%20MGL-PAX:SECTION" title="Upgrades and replay">Upgrades and replay</a>.</p></li>
</ul>

<p><a id="x-28JOURNAL-3AEVENT-VERSION-20TYPE-29"></a>
<a id="JOURNAL:EVENT-VERSION%20TYPE"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L238">[type]</a></span> <span class="reference-object"><a href="#JOURNAL:EVENT-VERSION%20TYPE" >event-version</a></span></span></span></p>

<p>An event's version is either <code>nil</code>, a positive <a href="http://www.lispworks.com/documentation/HyperSpec/Body/t_fixnum.htm" title="FIXNUM CLASS"><code>fixnum</code></a>, or <code>:infinity</code>,
which correspond to <a href="#JOURNAL:LOG-EVENT%20TYPE" title="JOURNAL:LOG-EVENT TYPE"><code>log-event</code></a>s, <a href="#JOURNAL:VERSIONED-EVENT%20TYPE" title="JOURNAL:VERSIONED-EVENT TYPE"><code>versioned-event</code></a>s, and
<a href="#JOURNAL:EXTERNAL-EVENT%20TYPE" title="JOURNAL:EXTERNAL-EVENT TYPE"><code>external-event</code></a>s, respectively, and have an increasingly strict
behaviour with regards to <a href="#JOURNAL:@REPLAY%20MGL-PAX:SECTION" title="Replay">Replay</a>. All <a href="#JOURNAL:EVENT%20TYPE" title="JOURNAL:EVENT TYPE"><code>event</code></a>s have versions. The
versions of the in- and out-events belonging to the same <a href="#JOURNAL:@FRAME%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@FRAME MGL-PAX:GLOSSARY-TERM">frame</a> are
the same.</p></li>
</ul>

<p><a id="x-28JOURNAL-3ALOG-EVENT-20TYPE-29"></a>
<a id="JOURNAL:LOG-EVENT%20TYPE"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L2870">[type]</a></span> <span class="reference-object"><a href="#JOURNAL:LOG-EVENT%20TYPE" >log-event</a></span></span></span></p>

<p>Events with <a href="#JOURNAL:EVENT-VERSION%20TYPE" title="JOURNAL:EVENT-VERSION TYPE"><code>event-version</code></a> <code>nil</code> called log events. During <a href="#JOURNAL:@REPLAY%20MGL-PAX:SECTION" title="Replay">Replay</a>,
they are never matched to events from the replay journal, and log
events in the replay do not affect events being recorded either.
These properties allow log events to be recorded in arbitrary
journals with <a href="#JOURNAL:JOURNALED%20MGL-PAX:MACRO" title="JOURNAL:JOURNALED MGL-PAX:MACRO"><code>journaled</code></a>'s <code>log-record</code> argument. The convenience macro
<a href="#JOURNAL:FRAMED%20MGL-PAX:MACRO" title="JOURNAL:FRAMED MGL-PAX:MACRO"><code>framed</code></a> is creating frames of log-events, while the <a href="#JOURNAL:LOGGED%20MGL-PAX:MACRO" title="JOURNAL:LOGGED MGL-PAX:MACRO"><code>logged</code></a> generates
a log-event that's a <a href="#JOURNAL:LEAF-EVENT%20TYPE" title="JOURNAL:LEAF-EVENT TYPE"><code>leaf-event</code></a>.</p></li>
</ul>

<p><a id="x-28JOURNAL-3AVERSIONED-EVENT-20TYPE-29"></a>
<a id="JOURNAL:VERSIONED-EVENT%20TYPE"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L2880">[type]</a></span> <span class="reference-object"><a href="#JOURNAL:VERSIONED-EVENT%20TYPE" >versioned-event</a></span></span></span></p>

<p>Events with a positive integer <a href="#JOURNAL:EVENT-VERSION%20TYPE" title="JOURNAL:EVENT-VERSION TYPE"><code>event-version</code></a> are called
versioned events. In <a href="#JOURNAL:@REPLAY%20MGL-PAX:SECTION" title="Replay">Replay</a>, they undergo consistency checks unlike
<a href="#JOURNAL:LOG-EVENT%20TYPE" title="JOURNAL:LOG-EVENT TYPE"><code>log-event</code></a>s, but the rules for them are less strict than for
<a href="#JOURNAL:EXTERNAL-EVENT%20TYPE" title="JOURNAL:EXTERNAL-EVENT TYPE"><code>external-event</code></a>s. In particular, higher versions are always
considered compatible with lower versions, they become an <em>upgrade</em>
in terms of the <a href="#JOURNAL:@THE-REPLAY-STRATEGY%20MGL-PAX:SECTION" title="The replay strategy">The replay strategy</a>, and versioned events can be
inserted into the record without a corresponding <a href="#JOURNAL:@REPLAY-EVENT%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@REPLAY-EVENT MGL-PAX:GLOSSARY-TERM">replay event</a> with
<a href="#JOURNAL:JOURNALED%20MGL-PAX:MACRO" title="JOURNAL:JOURNALED MGL-PAX:MACRO"><code>journaled</code></a>'s <code>insertable</code>.</p>

<p>If a <code>versioned-event</code> has an <a href="#JOURNAL:@UNEXPECTED-OUTCOME%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@UNEXPECTED-OUTCOME MGL-PAX:GLOSSARY-TERM">unexpected outcome</a>,
<a href="#JOURNAL:RECORD-UNEXPECTED-OUTCOME%20CONDITION" title="JOURNAL:RECORD-UNEXPECTED-OUTCOME CONDITION"><code>record-unexpected-outcome</code></a> is signalled.</p></li>
</ul>

<p><a id="x-28JOURNAL-3AEXTERNAL-EVENT-20TYPE-29"></a>
<a id="JOURNAL:EXTERNAL-EVENT%20TYPE"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L2894">[type]</a></span> <span class="reference-object"><a href="#JOURNAL:EXTERNAL-EVENT%20TYPE" >external-event</a></span></span></span></p>

<p>Events with <a href="#JOURNAL:EVENT-VERSION%20TYPE" title="JOURNAL:EVENT-VERSION TYPE"><code>event-version</code></a> <code>:infinity</code> are called external events.
They are like <a href="#JOURNAL:VERSIONED-EVENT%20TYPE" title="JOURNAL:VERSIONED-EVENT TYPE"><code>versioned-event</code></a>s whose version was bumped all the way
to infinity, which rules out easy, non-matching upgrades. Also, they
are never inserted to the record without a matching replay
event (see <a href="#JOURNAL:@THE-REPLAY-STRATEGY%20MGL-PAX:SECTION" title="The replay strategy">The replay strategy</a>).</p>

<p>In return for these restrictions, external events can be replayed
without running the corresponding <a href="#JOURNAL:@BLOCK%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@BLOCK MGL-PAX:GLOSSARY-TERM">block</a> (see
<a href="#JOURNAL:@REPLAYING-THE-OUTCOME%20MGL-PAX:SECTION" title="Replaying the outcome">Replaying the outcome</a>). This allows their out-event variety, called
<a href="#JOURNAL:@DATA-EVENT%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@DATA-EVENT MGL-PAX:GLOSSARY-TERM">data event</a>s, to be non-deterministic. Data events play a crucial
role in <a href="#JOURNAL:@PERSISTENCE%20MGL-PAX:SECTION" title="Persistence">Persistence</a>.</p>

<p>If an <code>external-event</code> has an <a href="#JOURNAL:@UNEXPECTED-OUTCOME%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@UNEXPECTED-OUTCOME MGL-PAX:GLOSSARY-TERM">unexpected outcome</a>,
<a href="#JOURNAL:RECORD-UNEXPECTED-OUTCOME%20CONDITION" title="JOURNAL:RECORD-UNEXPECTED-OUTCOME CONDITION"><code>record-unexpected-outcome</code></a> is signalled.</p></li>
</ul>

<p>Built on top of <a href="#JOURNAL:JOURNALED%20MGL-PAX:MACRO" title="JOURNAL:JOURNALED MGL-PAX:MACRO"><code>journaled</code></a>, the macros below record a pair of
<a href="#JOURNAL:@IN-EVENTS%20MGL-PAX:SECTION" title="In-events">In-events</a> and <a href="#JOURNAL:@OUT-EVENTS%20MGL-PAX:SECTION" title="Out-events">Out-events</a> but differ in how they are replayed and
the requirements on their <a href="#JOURNAL:@BLOCK%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@BLOCK MGL-PAX:GLOSSARY-TERM">block</a>s. The following table names the
type of <a href="#JOURNAL:EVENT%20TYPE" title="JOURNAL:EVENT TYPE"><code>event</code></a> produced (<code>Event</code>), how <a href="#JOURNAL:@IN-EVENTS%20MGL-PAX:SECTION" title="In-events">In-events</a> are
replayed (<code>In-e.</code>), whether the block is always run (<code>Run</code>), how
<a href="#JOURNAL:@OUT-EVENTS%20MGL-PAX:SECTION" title="Out-events">Out-events</a> are replayed (<code>Out-e.</code>), whether the block must be
deterministic (<code>Det</code>) or side-effect free (<code>sef</code>).</p>

<pre><code>|          | Event     | In-e.  | Run | Out-e. | Det | SEF |
|----------+-----------+--------+-----+--------+-----+-----|
| FRAMED   | log       | skip   | y   | skip   | n   | n   |
| CHECKED  | versioned | match  | y   | match  | y   | n   |
| REPLAYED | external  | match  | n   | replay | n   | y   |
| INVOKED  | versioned | replay | y   | match  | y   | n   |
</code></pre>

<p>Note that the replay-replay combination is not implemented because
there is nowhere to return values from replay-triggered functions.</p>

<p><a id="x-28JOURNAL-3AFRAMED-20MGL-PAX-3AMACRO-29"></a>
<a id="JOURNAL:FRAMED%20MGL-PAX:MACRO"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L2911">[macro]</a></span> <span class="reference-object"><a href="#JOURNAL:FRAMED%20MGL-PAX:MACRO" >framed</a></span></span> <span class="locative-args">(name &amp;key log-record args values condition) &amp;body body</span></span></p>

<p>A wrapper around <a href="#JOURNAL:JOURNALED%20MGL-PAX:MACRO" title="JOURNAL:JOURNALED MGL-PAX:MACRO"><code>journaled</code></a> to produce <a href="#JOURNAL:@FRAME%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@FRAME MGL-PAX:GLOSSARY-TERM">frame</a>s of <a href="#JOURNAL:LOG-EVENT%20TYPE" title="JOURNAL:LOG-EVENT TYPE"><code>log-event</code></a>s. That
is, <code>version</code> is always <code>nil</code>, and some irrelevant arguments are
omitted. The related <a href="#JOURNAL:LOGGED%20MGL-PAX:MACRO" title="JOURNAL:LOGGED MGL-PAX:MACRO"><code>logged</code></a> creates a single <a href="#JOURNAL:LEAF-EVENT%20TYPE" title="JOURNAL:LEAF-EVENT TYPE"><code>leaf-event</code></a>.</p>

<p>With <code>framed</code>, <code>body</code> is always run and no <a href="#JOURNAL:REPLAY-FAILURE%20CONDITION" title="JOURNAL:REPLAY-FAILURE CONDITION"><code>replay-failure</code></a>s are
triggered. <code>body</code> is not required to be deterministic, and it may have
side-effects.</p></li>
</ul>

<p><a id="x-28JOURNAL-3ACHECKED-20MGL-PAX-3AMACRO-29"></a>
<a id="JOURNAL:CHECKED%20MGL-PAX:MACRO"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L2923">[macro]</a></span> <span class="reference-object"><a href="#JOURNAL:CHECKED%20MGL-PAX:MACRO" >checked</a></span></span> <span class="locative-args">(name &amp;key (version 1) args values condition insertable) &amp;body body</span></span></p>

<p>A wrapper around <a href="#JOURNAL:JOURNALED%20MGL-PAX:MACRO" title="JOURNAL:JOURNALED MGL-PAX:MACRO"><code>journaled</code></a> to produce <a href="#JOURNAL:@FRAME%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@FRAME MGL-PAX:GLOSSARY-TERM">frame</a>s of <a href="#JOURNAL:VERSIONED-EVENT%20TYPE" title="JOURNAL:VERSIONED-EVENT TYPE"><code>versioned-event</code></a>s.
<code>version</code> defaults to 1. <code>checked</code> is for ensuring that supposedly
deterministic processing does not veer off the replay.</p>

<p>With <code>checked</code>, <code>body</code> â which must be deterministic â is always run and
<a href="#JOURNAL:REPLAY-FAILURE%20CONDITION" title="JOURNAL:REPLAY-FAILURE CONDITION"><code>replay-failure</code></a>s are triggered when the events generated do not match
the events in the replay journal. <code>body</code> may have side-effects.</p>

<p>For further discussion of determinism, see <a href="#JOURNAL:REPLAYED%20MGL-PAX:MACRO" title="JOURNAL:REPLAYED MGL-PAX:MACRO"><code>replayed</code></a>.</p></li>
</ul>

<p><a id="x-28JOURNAL-3AREPLAYED-20MGL-PAX-3AMACRO-29"></a>
<a id="JOURNAL:REPLAYED%20MGL-PAX:MACRO"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L2939">[macro]</a></span> <span class="reference-object"><a href="#JOURNAL:REPLAYED%20MGL-PAX:MACRO" >replayed</a></span></span> <span class="locative-args">(name &amp;key args values condition insertable replay-values replay-condition) &amp;body body</span></span></p>

<p>A wrapper around <a href="#JOURNAL:JOURNALED%20MGL-PAX:MACRO" title="JOURNAL:JOURNALED MGL-PAX:MACRO"><code>journaled</code></a> to produce <a href="#JOURNAL:@FRAME%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@FRAME MGL-PAX:GLOSSARY-TERM">frame</a>s of <a href="#JOURNAL:EXTERNAL-EVENT%20TYPE" title="JOURNAL:EXTERNAL-EVENT TYPE"><code>external-event</code></a>s.
<code>version</code> is <code>:infinity</code>. <code>replayed</code> is for primarily for marking and
isolating non-deterministic processing.</p>

<p>With <code>replayed</code>, the <a href="#JOURNAL:IN-EVENT%20TYPE" title="JOURNAL:IN-EVENT TYPE"><code>in-event</code></a> is checked for consistency with the
replay (as with <a href="#JOURNAL:CHECKED%20MGL-PAX:MACRO" title="JOURNAL:CHECKED MGL-PAX:MACRO"><code>checked</code></a>), but <code>body</code> is not run (assuming it has a
recorded <a href="#JOURNAL:@EXPECTED-OUTCOME%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@EXPECTED-OUTCOME MGL-PAX:GLOSSARY-TERM">expected outcome</a>), and the outcome in the <a href="#JOURNAL:OUT-EVENT%20TYPE" title="JOURNAL:OUT-EVENT TYPE"><code>out-event</code></a> is
reproduced (see <a href="#JOURNAL:@REPLAYING-THE-OUTCOME%20MGL-PAX:SECTION" title="Replaying the outcome">Replaying the outcome</a>). For this scheme to work,
<code>replayed</code> requires its <code>body</code> to be side-effect free, but it may be
non-deterministic.</p></li>
</ul>

<p><a id="x-28JOURNAL-3A-40INVOKED-20MGL-PAX-3AGLOSSARY-TERM-29"></a>
<a id="JOURNAL:@INVOKED%20MGL-PAX:GLOSSARY-TERM"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L2959">[glossary-term]</a></span> <span class="reference-object"><a href="#JOURNAL:@INVOKED%20MGL-PAX:GLOSSARY-TERM" >invoked</a></span></span></span></p>

<p>Invoked refers to functions and blocks defined by <a href="#JOURNAL:DEFINE-INVOKED%20MGL-PAX:MACRO" title="JOURNAL:DEFINE-INVOKED MGL-PAX:MACRO"><code>define-invoked</code></a> or
<a href="#JOURNAL:FLET-INVOKED%20MGL-PAX:MACRO" title="JOURNAL:FLET-INVOKED MGL-PAX:MACRO"><code>flet-invoked</code></a>. Invoked frames may be recorded in response to
asynchronous events, and at replay the presence of its in-event
triggers the execution of the function associated with the name of
the event.</p>

<p>On the one hand, <a href="#JOURNAL:FRAMED%20MGL-PAX:MACRO" title="JOURNAL:FRAMED MGL-PAX:MACRO"><code>framed</code></a>, <a href="#JOURNAL:CHECKED%20MGL-PAX:MACRO" title="JOURNAL:CHECKED MGL-PAX:MACRO"><code>checked</code></a>, <a href="#JOURNAL:REPLAYED%20MGL-PAX:MACRO" title="JOURNAL:REPLAYED MGL-PAX:MACRO"><code>replayed</code></a> or plain <a href="#JOURNAL:JOURNALED%20MGL-PAX:MACRO" title="JOURNAL:JOURNALED MGL-PAX:MACRO"><code>journaled</code></a> have
<a href="#JOURNAL:@IN-EVENTS%20MGL-PAX:SECTION" title="In-events">In-events</a> that are always predictable from the code and the
preceding events. The control flow â on the level of recorded frames
â is deterministic in this sense. On the other hand, Invoked encodes
in its <a href="#JOURNAL:IN-EVENT%20TYPE" title="JOURNAL:IN-EVENT TYPE"><code>in-event</code></a> what function to call next, introducing
non-deterministic control flow.</p>

<p>By letting events choose the code to run, Invoked resembles typical
<a href="https://martinfowler.com/eaaDev/EventSourcing.html" >Event Sourcing</a> frameworks. When Invoked is used
exclusively, the journal becomes a sequence of events. In contrast,
<code>journaled</code> and its wrappers put code first, and the journal will be a
projection of the call tree.</p></li>
</ul>

<p><a id="x-28JOURNAL-3ADEFINE-INVOKED-20MGL-PAX-3AMACRO-29"></a>
<a id="JOURNAL:DEFINE-INVOKED%20MGL-PAX:MACRO"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L2986">[macro]</a></span> <span class="reference-object"><a href="#JOURNAL:DEFINE-INVOKED%20MGL-PAX:MACRO" >define-invoked</a></span></span> <span class="locative-args">function-name args (name &amp;key (version 1) insertable) &amp;body body</span></span></p>

<p><code>define-invoked</code> is intended for recording asynchronous function
invocations like event or signal handlers. It defines a function
that records <a href="#JOURNAL:VERSIONED-EVENT%20TYPE" title="JOURNAL:VERSIONED-EVENT TYPE"><code>versioned-event</code></a>s with <code>args</code> set to the actual arguments.
At replay, it is invoked whenever the recorded <a href="#JOURNAL:IN-EVENT%20TYPE" title="JOURNAL:IN-EVENT TYPE"><code>in-event</code></a> becomes the
<a href="#JOURNAL:@REPLAY-EVENT%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@REPLAY-EVENT MGL-PAX:GLOSSARY-TERM">replay event</a>.</p>

<p><a href="http://www.lispworks.com/documentation/HyperSpec/Body/m_defun.htm" title="DEFUN MGL-PAX:MACRO"><code>defun</code></a> and <a href="#JOURNAL:CHECKED%20MGL-PAX:MACRO" title="JOURNAL:CHECKED MGL-PAX:MACRO"><code>checked</code></a> rolled into one, <code>define-invoked</code> defines a
top-level function with <code>function-name</code> and <code>args</code> (only simple
positional arguments are allowed) and wraps <code>checked</code> with <code>name</code>, the
same <code>args</code> and <code>insertable</code> around <code>body</code>. Whenever an <code>in-event</code> becomes
the <a href="#JOURNAL:@REPLAY-EVENT%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@REPLAY-EVENT MGL-PAX:GLOSSARY-TERM">replay event</a>, and it has a <code>define-invoked</code> defined with the name
of the event, <code>function-name</code> is invoked with <a href="#JOURNAL:EVENT-ARGS%20FUNCTION" title="JOURNAL:EVENT-ARGS FUNCTION"><code>event-args</code></a>.</p>

<p>While <code>body</code>'s return values are recorded as usual, the defined
function returns no values to make it less likely to affect control
flow in a way that's not possible to reproduce when the function is
called by the replay mechanism.</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">defvar</span></i> <span class="special">*state*</span></span>)</span>

<span class="paren1">(<span class="code"><i><span class="symbol">define-invoked</span></i> foo <span class="paren2">(<span class="code">x</span>)</span> <span class="paren2">(<span class="code"><span class="string">"foo"</span></span>)</span>
  <span class="paren2">(<span class="code"><i><span class="symbol">setq</span></i> <span class="special">*state*</span> <span class="paren3">(<span class="code">1+ x</span>)</span></span>)</span></span>)</span>

<span class="paren1">(<span class="code"><i><span class="symbol">define-invoked</span></i> bar <span class="paren2">(<span class="code">x</span>)</span> <span class="paren2">(<span class="code"><span class="string">"bar"</span></span>)</span>
  <span class="paren2">(<span class="code"><i><span class="symbol">setq</span></i> <span class="special">*state*</span> <span class="paren3">(<span class="code">+ 2 x</span>)</span></span>)</span></span>)</span>

<span class="paren1">(<span class="code"><i><span class="symbol">if</span></i> <span class="paren2">(<span class="code">zerop <span class="paren3">(<span class="code">random 2</span>)</span></span>)</span>
    <span class="paren2">(<span class="code">foo 0</span>)</span>
    <span class="paren2">(<span class="code">bar 1</span>)</span></span>)</span></span></code></pre>

<p>The above can be alternatively implemented with <a href="#JOURNAL:REPLAYED%20MGL-PAX:MACRO" title="JOURNAL:REPLAYED MGL-PAX:MACRO"><code>replayed</code></a> explicitly
encapsulating the non-determinism:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">let</span></i> <span class="paren2">(<span class="code"><span class="paren3">(<span class="code">x <span class="paren4">(<span class="code">replayed <span class="paren5">(<span class="code">choose</span>)</span> <span class="paren5">(<span class="code">random 2</span>)</span></span>)</span></span>)</span></span>)</span>
  <span class="paren2">(<span class="code"><i><span class="symbol">if</span></i> <span class="paren3">(<span class="code">zerop x</span>)</span>
      <span class="paren3">(<span class="code">checked <span class="paren4">(<span class="code">foo <span class="keyword">:args</span> `<span class="paren5">(<span class="code">,x</span>)</span></span>)</span>
        <span class="paren4">(<span class="code"><i><span class="symbol">setq</span></i> <span class="special">*state*</span> <span class="paren5">(<span class="code">1+ x</span>)</span></span>)</span></span>)</span>
      <span class="paren3">(<span class="code">checked <span class="paren4">(<span class="code">bar <span class="keyword">:args</span> `<span class="paren5">(<span class="code">,x</span>)</span></span>)</span>
        <span class="paren4">(<span class="code"><i><span class="symbol">setq</span></i> <span class="special">*state*</span> <span class="paren5">(<span class="code">+ 2 x</span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span></code></pre></li>
</ul>

<p><a id="x-28JOURNAL-3AFLET-INVOKED-20MGL-PAX-3AMACRO-29"></a>
<a id="JOURNAL:FLET-INVOKED%20MGL-PAX:MACRO"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L3051">[macro]</a></span> <span class="reference-object"><a href="#JOURNAL:FLET-INVOKED%20MGL-PAX:MACRO" >flet-invoked</a></span></span> <span class="locative-args">definitions &amp;body body</span></span></p>

<p>Like <a href="#JOURNAL:DEFINE-INVOKED%20MGL-PAX:MACRO" title="JOURNAL:DEFINE-INVOKED MGL-PAX:MACRO"><code>define-invoked</code></a>, but with <a href="http://www.lispworks.com/documentation/HyperSpec/Body/s_flet_.htm" title="FLET MGL-PAX:MACRO"><code>flet</code></a> instead of <a href="http://www.lispworks.com/documentation/HyperSpec/Body/m_defun.htm" title="DEFUN MGL-PAX:MACRO"><code>defun</code></a>. The event
name and the function are associated in the dynamic extent of <code>body</code>.
<a href="#JOURNAL:WITH-JOURNALING%20MGL-PAX:MACRO" title="JOURNAL:WITH-JOURNALING MGL-PAX:MACRO"><code>with-journaling</code></a> does not change the bindings. The example in
<code>define-invoked</code> can be rewritten as:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">let</span></i> <span class="paren2">(<span class="code"><span class="paren3">(<span class="code">state nil</span>)</span></span>)</span>
  <span class="paren2">(<span class="code">flet-invoked <span class="paren3">(<span class="code"><span class="paren4">(<span class="code">foo <span class="paren5">(<span class="code">x</span>)</span> <span class="paren5">(<span class="code"><span class="string">"foo"</span></span>)</span>
                   <span class="paren5">(<span class="code"><i><span class="symbol">setq</span></i> state <span class="paren6">(<span class="code">1+ x</span>)</span></span>)</span></span>)</span>
                 <span class="paren4">(<span class="code">bar <span class="paren5">(<span class="code">x</span>)</span> <span class="paren5">(<span class="code"><span class="string">"bar"</span></span>)</span>
                   <span class="paren5">(<span class="code"><i><span class="symbol">setq</span></i> state <span class="paren6">(<span class="code">+ 2 x</span>)</span></span>)</span></span>)</span></span>)</span>
    <span class="paren3">(<span class="code"><i><span class="symbol">if</span></i> <span class="paren4">(<span class="code">zerop <span class="paren5">(<span class="code">random 2</span>)</span></span>)</span>
      <span class="paren4">(<span class="code">foo 0</span>)</span>
      <span class="paren4">(<span class="code">bar 1</span>)</span></span>)</span></span>)</span></span>)</span></span></code></pre></li>
</ul>

<p><a id="x-28JOURNAL-3A-40BUNDLES-20MGL-PAX-3ASECTION-29"></a>
<a id="JOURNAL:@BUNDLES%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#JOURNAL:@JOURNALED-FOR-REPLAY%20MGL-PAX:SECTION" title="Journaled for replay">&#8592;</a> <a href="#JOURNAL:@REPLAY%20MGL-PAX:SECTION" title="Replay">&#8593;</a> <a href="#JOURNAL:@THE-REPLAY-STRATEGY%20MGL-PAX:SECTION" title="The replay strategy">&#8594;</a> <a href="#JOURNAL:@BUNDLES%20MGL-PAX:SECTION" title="Bundles">&#8634;</a> <a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L3108">&#955;</a></span></span></p>

<h3><a href="#JOURNAL:@BUNDLES%20MGL-PAX:SECTION">9.2 Bundles</a></h3>

<p>Consider replaying the same code repeatedly, hoping to make
progress in the processing. Maybe based on the availability of
external input, the code may error out. After each run, one has to
decide whether to keep the journal just recorded or stick with the
replay journal. A typical solution to this would look like this:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">let</span></i> <span class="paren2">(<span class="code"><span class="paren3">(<span class="code">record nil</span>)</span></span>)</span>
  <span class="paren2">(<span class="code"><i><span class="symbol">loop</span></i>
    <span class="paren3">(<span class="code"><i><span class="symbol">setq</span></i> record <span class="paren4">(<span class="code">make-in-memory-journal</span>)</span></span>)</span>
    <span class="paren3">(<span class="code"><i><span class="symbol">with-journaling</span></i> <span class="paren4">(<span class="code"><span class="keyword">:record</span> record <span class="keyword">:replay</span> replay</span>)</span>
      ...</span>)</span>
    <span class="paren3">(<span class="code">when <span class="paren4">(<span class="code">and
           <span class="comment">;; RECORD is a valid replay of REPLAY ...
</span>           <span class="paren5">(<span class="code">eq <span class="paren6">(<span class="code">journal-state record</span>)</span> <span class="keyword">:completed</span></span>)</span>
           <span class="comment">;; ... and is also significantly different from it ...
</span>           <span class="paren5">(<span class="code">journal-diverged-p record</span>)</span></span>)</span>
      <span class="comment">;; so use it for future replays.
</span>      <span class="paren4">(<span class="code"><i><span class="symbol">setq</span></i> replay record</span>)</span></span>)</span></span>)</span></span>)</span></span></code></pre>

<p>This is pretty much what bundles automate. The above becomes:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">let</span></i> <span class="paren2">(<span class="code"><span class="paren3">(<span class="code">bundle <span class="paren4">(<span class="code">make-in-memory-bundle</span>)</span></span>)</span></span>)</span>
  <span class="paren2">(<span class="code"><i><span class="symbol">loop</span></i>
    <span class="paren3">(<span class="code"><i><span class="symbol">with-bundle</span></i> <span class="paren4">(<span class="code">bundle</span>)</span>
      ...</span>)</span></span>)</span></span>)</span></span></code></pre>

<p>With <a href="#JOURNAL:FILE-JOURNAL%20CLASS" title="JOURNAL:FILE-JOURNAL CLASS"><code>file-journal</code></a>s, the motivating example above would be even more
complicated, but <a href="#JOURNAL:FILE-BUNDLE%20CLASS" title="JOURNAL:FILE-BUNDLE CLASS"><code>file-bundle</code></a>s work the same way as
<a href="#JOURNAL:IN-MEMORY-BUNDLE%20CLASS" title="JOURNAL:IN-MEMORY-BUNDLE CLASS"><code>in-memory-bundle</code></a>s.</p>

<p><a id="x-28JOURNAL-3AWITH-BUNDLE-20MGL-PAX-3AMACRO-29"></a>
<a id="JOURNAL:WITH-BUNDLE%20MGL-PAX:MACRO"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L3145">[macro]</a></span> <span class="reference-object"><a href="#JOURNAL:WITH-BUNDLE%20MGL-PAX:MACRO" >with-bundle</a></span></span> <span class="locative-args">(bundle) &amp;body body</span></span></p>

<p>This is like <a href="#JOURNAL:WITH-JOURNALING%20MGL-PAX:MACRO" title="JOURNAL:WITH-JOURNALING MGL-PAX:MACRO"><code>with-journaling</code></a> where the <a href="#JOURNAL:REPLAY-JOURNAL%20FUNCTION" title="JOURNAL:REPLAY-JOURNAL FUNCTION"><code>replay-journal</code></a> is the last
successfully completed one in <code>bundle</code>, and the <a href="#JOURNAL:RECORD-JOURNAL%20FUNCTION" title="JOURNAL:RECORD-JOURNAL FUNCTION"><code>record-journal</code></a> is a
new one created in <code>bundle</code>. When <code>with-bundle</code> finishes, the record
journal is in <a href="#JOURNAL:JOURNAL-STATE%20TYPE" title="JOURNAL:JOURNAL-STATE TYPE"><code>journal-state</code></a> <code>:failed</code> or <code>:completed</code>.</p>

<p>To avoid accumulating useless data, the new record is immediately
deleted when <code>with-bundle</code> finishes if it has not diverged from the
replay journal (see <a href="#JOURNAL:JOURNAL-DIVERGENT-P%20FUNCTION" title="JOURNAL:JOURNAL-DIVERGENT-P FUNCTION"><code>journal-divergent-p</code></a>). Because <code>:failed</code> journals
are always divergent in this sense, they are deleted instead based
on whether there is already a previous failed journal in the bundle
and the new record is identical to that journal (see
<a href="#JOURNAL:IDENTICAL-JOURNALS-P%20GENERIC-FUNCTION" title="JOURNAL:IDENTICAL-JOURNALS-P GENERIC-FUNCTION"><code>identical-journals-p</code></a>).</p>

<p>It is a <a href="#JOURNAL:JOURNAL-ERROR%20CONDITION" title="JOURNAL:JOURNAL-ERROR CONDITION"><code>journal-error</code></a> to have concurrent or nested <code>with-bundle</code>s on
the same bundle.</p></li>
</ul>

<p><a id="x-28JOURNAL-3A-40THE-REPLAY-STRATEGY-20MGL-PAX-3ASECTION-29"></a>
<a id="JOURNAL:@THE-REPLAY-STRATEGY%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#JOURNAL:@BUNDLES%20MGL-PAX:SECTION" title="Bundles">&#8592;</a> <a href="#JOURNAL:@REPLAY%20MGL-PAX:SECTION" title="Replay">&#8593;</a> <a href="#JOURNAL:@MATCHING-IN-EVENTS%20MGL-PAX:SECTION" title="Matching in-events">&#8594;</a> <a href="#JOURNAL:@THE-REPLAY-STRATEGY%20MGL-PAX:SECTION" title="The replay strategy">&#8634;</a> <a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L3180">&#955;</a></span></span></p>

<h3><a href="#JOURNAL:@THE-REPLAY-STRATEGY%20MGL-PAX:SECTION">9.3 The replay strategy</a></h3>

<p>The replay process for both <a href="#JOURNAL:@IN-EVENTS%20MGL-PAX:SECTION" title="In-events">In-events</a> and <a href="#JOURNAL:@OUT-EVENTS%20MGL-PAX:SECTION" title="Out-events">Out-events</a> starts by
determining how the generated event (the <em>new</em> event from now on)
shall be replayed. Roughly, the decision is based on the <code>name</code> and
<code>version</code> of the new event and the <a href="#JOURNAL:@REPLAY-EVENT%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@REPLAY-EVENT MGL-PAX:GLOSSARY-TERM">replay event</a> (the next event to be
read from the replay). There are four possible strategies:</p>

<ul>
<li><p><strong>match</strong>: A new in-event must match the replay event in its <code>args</code>.
  See <a href="#JOURNAL:@MATCHING-IN-EVENTS%20MGL-PAX:SECTION" title="Matching in-events">Matching in-events</a> for details. A new out-event must match
  the replay event's <code>exit</code> and <code>outcome</code>, see <a href="#JOURNAL:@MATCHING-OUT-EVENTS%20MGL-PAX:SECTION" title="Matching out-events">Matching out-events</a>.</p></li>
<li><p><strong>upgrade</strong>: The new event is not matched to any replay event, but
  an event is consumed from the replay journal. This happens if the
  next new event has the same name as the replay event, but its
  version is higher.</p></li>
<li><p><strong>insert</strong>: The new event is not matched to any replay event, and
  no events are consumed from the replay journal, which may be
  empty. This is always the case for new <a href="#JOURNAL:LOG-EVENT%20TYPE" title="JOURNAL:LOG-EVENT TYPE"><code>log-event</code></a>s and when there
  are no more events to read from the replay journal (unless
  <code>replay-eoj-error-p</code>). For <a href="#JOURNAL:VERSIONED-EVENT%20TYPE" title="JOURNAL:VERSIONED-EVENT TYPE"><code>versioned-event</code></a>s, it is affected by
  setting <a href="#JOURNAL:JOURNALED%20MGL-PAX:MACRO" title="JOURNAL:JOURNALED MGL-PAX:MACRO"><code>journaled</code></a>'s <code>insertable</code> to true (see
  <a href="#JOURNAL:@JOURNALED-FOR-REPLAY%20MGL-PAX:SECTION" title="Journaled for replay">Journaled for replay</a>).</p>

<p>The out-event's strategy is always <em>insert</em> if the strategy for
the corresponding in-event was <em>insert</em>.</p></li>
<li><p>Also, <a href="#JOURNAL:END-OF-JOURNAL%20CONDITION" title="JOURNAL:END-OF-JOURNAL CONDITION"><code>end-of-journal</code></a>, <a href="#JOURNAL:REPLAY-NAME-MISMATCH%20CONDITION" title="JOURNAL:REPLAY-NAME-MISMATCH CONDITION"><code>replay-name-mismatch</code></a> and
  <a href="#JOURNAL:REPLAY-VERSION-DOWNGRADE%20CONDITION" title="JOURNAL:REPLAY-VERSION-DOWNGRADE CONDITION"><code>replay-version-downgrade</code></a> may be signalled. See the algorithm below
  details.</p></li>
</ul>

<p>The strategy is determined by the following algorithm, invoked
whenever an event is generated by a journaled <a href="#JOURNAL:@BLOCK%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@BLOCK MGL-PAX:GLOSSARY-TERM">block</a>:</p>

<ol>
<li><p>Log events are not matched to the replay. If the new event is a
   log event or a <a href="#JOURNAL:REPLAY-FAILURE%20CONDITION" title="JOURNAL:REPLAY-FAILURE CONDITION"><code>replay-failure</code></a> has been signalled before (i.e. the
   record journal's <a href="#JOURNAL:JOURNAL-STATE%20TYPE" title="JOURNAL:JOURNAL-STATE TYPE"><code>journal-state</code></a> is <code>:mismatched</code>), then <strong>insert</strong>
   is returned.</p></li>
<li><p>Else, log events to be read in the replay journal are skipped,
   and the next unread, non-log event is peeked at (without
   advancing the replay journal).</p>

<ul>
<li><p><strong>end of replay</strong>: If there are no replay events left, then:</p>

<ul>
<li><p>If <code>replay-eoj-error-p</code> is <code>nil</code> in <a href="#JOURNAL:WITH-JOURNALING%20MGL-PAX:MACRO" title="JOURNAL:WITH-JOURNALING MGL-PAX:MACRO"><code>with-journaling</code></a> (the
  default), <strong>insert</strong> is returned.</p></li>
<li><p>If <code>replay-eoj-error-p</code> is true, then <strong><code>end-of-journal</code></strong>
  is signalled.</p></li>
</ul></li>
<li><p><strong>mismatched name</strong>: Else, if the next unread replay event's
  name is not <a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_equal.htm" title="EQUAL FUNCTION"><code>equal</code></a> to the name of the new event, then:</p>

<ul>
<li><p>For <code>versioned-event</code>s, <strong><code>replay-name-mismatch</code></strong> is
  signalled if <code>insertable</code> is <code>nil</code>, else <strong>insert</strong> is
  returned.</p></li>
<li><p>For <a href="#JOURNAL:EXTERNAL-EVENT%20TYPE" title="JOURNAL:EXTERNAL-EVENT TYPE"><code>external-event</code></a>s, <strong><code>replay-name-mismatch</code></strong> is
  signalled.</p></li>
</ul></li>
<li><p><strong>matching name</strong>: Else, if the name of the next unread event
  in the replay journal is <code>equal</code> to the name of new event, then
  it is chosen as the <em>replay</em> event.</p>

<ul>
<li><p>If the replay event's version is higher than the new
  event's version, then <strong><code>replay-version-downgrade</code></strong> is
  signalled.</p></li>
<li><p>If the two versions are equal, then <strong>match</strong> is returned.</p></li>
<li><p>If the new event's version is higher, then <strong>upgrade</strong> is
  returned.</p></li>
</ul>

<p>Where <code>:infinity</code> is considered higher than any integer and
equal to itself.</p></li>
</ul></li>
</ol>

<p>In summary:</p>

<pre><code> | new event | end-of-replay     | mismatched name   | matching name |
 |-----------+-------------------+-------------------+---------------|
 | Log       | insert            | insert            | insert        |
 | Versioned | insert/eoj-error  | insert/name-error | match-version |
 | External  | insert/eoj-error  | insert/name-error | match-version |
</code></pre>

<p>Version matching (<code>match-version</code> above) is based on which event has
a higher version:</p>

<pre><code> | replay event    | =     | new event |
 |-----------------+-------+-----------|
 | downgrade-error | match | upgrade   |
</code></pre>

<p><a id="x-28JOURNAL-3A-40REPLAY-EVENT-20MGL-PAX-3AGLOSSARY-TERM-29"></a>
<a id="JOURNAL:@REPLAY-EVENT%20MGL-PAX:GLOSSARY-TERM"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L3273">[glossary-term]</a></span> <span class="reference-object"><a href="#JOURNAL:@REPLAY-EVENT%20MGL-PAX:GLOSSARY-TERM" >replay event</a></span></span></span></p>

<p>The replay event is the next event to be read from <a href="#JOURNAL:REPLAY-JOURNAL%20FUNCTION" title="JOURNAL:REPLAY-JOURNAL FUNCTION"><code>replay-journal</code></a>
which is not to be skipped. There may be no replay event if there
are no more unread events in the replay journal.</p>

<p>An event in the replay journal is skipped if it is a <a href="#JOURNAL:LOG-EVENT%20TYPE" title="JOURNAL:LOG-EVENT TYPE"><code>log-event</code></a> or
there is a <a href="#JOURNAL:WITH-REPLAY-FILTER%20MGL-PAX:MACRO" title="JOURNAL:WITH-REPLAY-FILTER MGL-PAX:MACRO"><code>with-replay-filter</code></a> with a matching <code>:skip</code>. If <code>:skip</code> is in
effect, the replay event may be indeterminate.</p>

<p>Events from the replay journal are read when they are <code>:match</code>ed or
<code>:upgrade</code>d (see <a href="#JOURNAL:@THE-REPLAY-STRATEGY%20MGL-PAX:SECTION" title="The replay strategy">The replay strategy</a>), when nested events are
echoed while <a href="#JOURNAL:@REPLAYING-THE-OUTCOME%20MGL-PAX:SECTION" title="Replaying the outcome">Replaying the outcome</a>, or when there is an <a href="#JOURNAL:@INVOKED%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@INVOKED MGL-PAX:GLOSSARY-TERM">invoked</a>
defined with the same name as the replay event.</p>

<p>The replay event is available via <a href="#JOURNAL:PEEK-REPLAY-EVENT%20FUNCTION" title="JOURNAL:PEEK-REPLAY-EVENT FUNCTION"><code>peek-replay-event</code></a>.</p></li>
</ul>

<p><a id="x-28JOURNAL-3A-40MATCHING-IN-EVENTS-20MGL-PAX-3ASECTION-29"></a>
<a id="JOURNAL:@MATCHING-IN-EVENTS%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#JOURNAL:@THE-REPLAY-STRATEGY%20MGL-PAX:SECTION" title="The replay strategy">&#8592;</a> <a href="#JOURNAL:@REPLAY%20MGL-PAX:SECTION" title="Replay">&#8593;</a> <a href="#JOURNAL:@REPLAYING-THE-OUTCOME%20MGL-PAX:SECTION" title="Replaying the outcome">&#8594;</a> <a href="#JOURNAL:@MATCHING-IN-EVENTS%20MGL-PAX:SECTION" title="Matching in-events">&#8634;</a> <a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L3326">&#955;</a></span></span></p>

<h3><a href="#JOURNAL:@MATCHING-IN-EVENTS%20MGL-PAX:SECTION">9.4 Matching in-events</a></h3>

<p>If the replay strategy is <em>match</em>, then, for in-events, the
matching process continues like this:</p>

<ul>
<li><p>If the <a href="#JOURNAL:EVENT-ARGS%20FUNCTION" title="JOURNAL:EVENT-ARGS FUNCTION"><code>event-args</code></a> are not <a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_equal.htm" title="EQUAL FUNCTION"><code>equal</code></a>, then <strong><a href="#JOURNAL:REPLAY-ARGS-MISMATCH%20CONDITION" title="JOURNAL:REPLAY-ARGS-MISMATCH CONDITION"><code>replay-args-mismatch</code></a></strong>
  signalled.</p></li>
<li><p>At this point, two things might happen:</p>

<ul>
<li><p>For <a href="#JOURNAL:VERSIONED-EVENT%20TYPE" title="JOURNAL:VERSIONED-EVENT TYPE"><code>versioned-event</code></a>s, the <a href="#JOURNAL:@BLOCK%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@BLOCK MGL-PAX:GLOSSARY-TERM">block</a> will be executed as normal
  and its outcome will be matched to the <a href="#JOURNAL:@REPLAY-EVENT%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@REPLAY-EVENT MGL-PAX:GLOSSARY-TERM">replay event</a> (see
  <a href="#JOURNAL:@MATCHING-OUT-EVENTS%20MGL-PAX:SECTION" title="Matching out-events">Matching out-events</a>).</p></li>
<li><p>For <a href="#JOURNAL:EXTERNAL-EVENT%20TYPE" title="JOURNAL:EXTERNAL-EVENT TYPE"><code>external-event</code></a>s, the corresponding replay <a href="#JOURNAL:OUT-EVENT%20TYPE" title="JOURNAL:OUT-EVENT TYPE"><code>out-event</code></a> is
  looked at. If there is one, meaning that the frame finished
  with an <a href="#JOURNAL:@EXPECTED-OUTCOME%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@EXPECTED-OUTCOME MGL-PAX:GLOSSARY-TERM">expected outcome</a>, then its outcome will be
  replayed (see <a href="#JOURNAL:@REPLAYING-THE-OUTCOME%20MGL-PAX:SECTION" title="Replaying the outcome">Replaying the outcome</a>). If the <code>out-event</code> is
  missing, then <code>external-event</code>s behave like <code>versioned-event</code>s,
  and the <a href="#JOURNAL:@BLOCK%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@BLOCK MGL-PAX:GLOSSARY-TERM">block</a> is executed.</p></li>
</ul></li>
</ul>

<p><a id="x-28JOURNAL-3A-40REPLAYING-THE-OUTCOME-20MGL-PAX-3ASECTION-29"></a>
<a id="JOURNAL:@REPLAYING-THE-OUTCOME%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#JOURNAL:@MATCHING-IN-EVENTS%20MGL-PAX:SECTION" title="Matching in-events">&#8592;</a> <a href="#JOURNAL:@MATCHING-IN-EVENTS%20MGL-PAX:SECTION" title="Matching in-events">&#8593;</a> <a href="#JOURNAL:@MATCHING-OUT-EVENTS%20MGL-PAX:SECTION" title="Matching out-events">&#8594;</a> <a href="#JOURNAL:@REPLAYING-THE-OUTCOME%20MGL-PAX:SECTION" title="Replaying the outcome">&#8634;</a> <a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L3535">&#955;</a></span></span></p>

<h4><a href="#JOURNAL:@REPLAYING-THE-OUTCOME%20MGL-PAX:SECTION">9.4.1 Replaying the outcome</a></h4>

<p>So, if an in-event is triggered that matches the replay,
<code>event-version</code>(<a href="#JOURNAL:EVENT-VERSION%20FUNCTION" title="JOURNAL:EVENT-VERSION FUNCTION"><code>0</code></a> <a href="#JOURNAL:EVENT-VERSION%20TYPE" title="JOURNAL:EVENT-VERSION TYPE"><code>1</code></a>) is <code>:infinity</code>, then normal execution is altered in the
following manner:</p>

<ul>
<li><p>The journaled <a href="#JOURNAL:@BLOCK%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@BLOCK MGL-PAX:GLOSSARY-TERM">block</a> is not executed.</p></li>
<li><p>To keep execution and the replay journal in sync, events of frames
  nested in the current one are skipped over in the replay journal.</p></li>
<li><p>All events (including <a href="#JOURNAL:LOG-EVENT%20TYPE" title="JOURNAL:LOG-EVENT TYPE"><code>log-event</code></a>s) skipped over are echoed to the
  record journal. This serves to keep a trail of what happened
  during the original recording. Note that functions corresponding
  to <a href="#JOURNAL:@INVOKED%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@INVOKED MGL-PAX:GLOSSARY-TERM">invoked</a> frames are called when their <a href="#JOURNAL:IN-EVENT%20TYPE" title="JOURNAL:IN-EVENT TYPE"><code>in-event</code></a> is skipped over.</p></li>
<li><p>The out-event corresponding to the in-event being processed is
  then read from the replay journal and is recorded again (to allow
  recording to function properly).</p></li>
</ul>

<p>To be able to reproduce the outcome in the replay journal, some
assistance may be required from <code>replay-values</code> and <code>replay-condition</code>:</p>

<ul>
<li><p>If the <a href="#JOURNAL:@REPLAY-EVENT%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@REPLAY-EVENT MGL-PAX:GLOSSARY-TERM">replay event</a> has a normal return (i.e. <code>event-exit</code>(<a href="#JOURNAL:EVENT-EXIT%20FUNCTION" title="JOURNAL:EVENT-EXIT FUNCTION"><code>0</code></a> <a href="#JOURNAL:EVENT-EXIT%20TYPE" title="JOURNAL:EVENT-EXIT TYPE"><code>1</code></a>) <code>:values</code>),
  then the recorded return values (in <a href="#JOURNAL:EVENT-OUTCOME%20FUNCTION" title="JOURNAL:EVENT-OUTCOME FUNCTION"><code>event-outcome</code></a>) are returned
  immediately as in <code>(values-list (event-outcome replay-event))</code>. If
  <code>replay-values</code> is specified, it is called instead of <a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_vals_l.htm" title="VALUES-LIST FUNCTION"><code>values-list</code></a>.
  See <a href="#JOURNAL:@WORKING-WITH-UNREADABLE-VALUES%20MGL-PAX:SECTION" title="Working with unreadable values">Working with unreadable values</a> for an example.</p></li>
<li><p>Similarly, if the replay event has unwound with an expected
  condition (has <code>event-exit</code> <code>:condition</code>), then the recorded
  condition (in <code>event-outcome</code>) is signalled as
  IN <code>(error (event-outcome replay-event))</code>. If <code>replay-condition</code> is
  specified, it is called instead of <code>error</code>(<a href="http://www.lispworks.com/documentation/HyperSpec/Body/e_error.htm" title="ERROR CONDITION"><code>0</code></a> <a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_error.htm" title="ERROR FUNCTION"><code>1</code></a>). <code>replay-condition</code> must
  not return normally, and it's a <a href="#JOURNAL:JOURNAL-ERROR%20CONDITION" title="JOURNAL:JOURNAL-ERROR CONDITION"><code>journal-error</code></a> if it does.</p></li>
</ul>

<p><a href="#JOURNAL:WITH-REPLAY-FILTER%20MGL-PAX:MACRO" title="JOURNAL:WITH-REPLAY-FILTER MGL-PAX:MACRO"><code>with-replay-filter</code></a>'s <code>no-replay-outcome</code> can selectively turn off
replaying the outcome. See <a href="#JOURNAL:@TESTING-ON-MULTIPLE-LEVELS%20MGL-PAX:SECTION" title="Testing on multiple levels">Testing on multiple levels</a>, for an
example.</p>

<p><a id="x-28JOURNAL-3A-40MATCHING-OUT-EVENTS-20MGL-PAX-3ASECTION-29"></a>
<a id="JOURNAL:@MATCHING-OUT-EVENTS%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#JOURNAL:@REPLAYING-THE-OUTCOME%20MGL-PAX:SECTION" title="Replaying the outcome">&#8592;</a> <a href="#JOURNAL:@REPLAY%20MGL-PAX:SECTION" title="Replay">&#8593;</a> <a href="#JOURNAL:@REPLAY-FAILURES%20MGL-PAX:SECTION" title="Replay failures">&#8594;</a> <a href="#JOURNAL:@MATCHING-OUT-EVENTS%20MGL-PAX:SECTION" title="Matching out-events">&#8634;</a> <a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L3623">&#955;</a></span></span></p>

<h3><a href="#JOURNAL:@MATCHING-OUT-EVENTS%20MGL-PAX:SECTION">9.5 Matching out-events</a></h3>

<p>If there were no <a href="#JOURNAL:@REPLAY-FAILURES%20MGL-PAX:SECTION" title="Replay failures">Replay failures</a> during the matching of the
<a href="#JOURNAL:IN-EVENT%20TYPE" title="JOURNAL:IN-EVENT TYPE"><code>in-event</code></a>, and the conditions for <a href="#JOURNAL:@REPLAYING-THE-OUTCOME%20MGL-PAX:SECTION" title="Replaying the outcome">Replaying the outcome</a> were not
met, then the <a href="#JOURNAL:@BLOCK%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@BLOCK MGL-PAX:GLOSSARY-TERM">block</a> is executed. When the outcome of the block is
determined, an <a href="#JOURNAL:OUT-EVENT%20TYPE" title="JOURNAL:OUT-EVENT TYPE"><code>out-event</code></a> is triggered and is matched to the replay
journal. The matching of out-events starts out as in
<a href="#JOURNAL:@THE-REPLAY-STRATEGY%20MGL-PAX:SECTION" title="The replay strategy">The replay strategy</a> with checks for <a href="#JOURNAL:EVENT-NAME%20FUNCTION" title="JOURNAL:EVENT-NAME FUNCTION"><code>event-name</code></a> and
<a href="#JOURNAL:EVENT-VERSION%20FUNCTION" title="JOURNAL:EVENT-VERSION FUNCTION"><code>event-version</code></a>.</p>

<p>If the replay strategy is <em>insert</em> or <em>upgrade</em>, then the out-event
is written to <a href="#JOURNAL:RECORD-JOURNAL%20FUNCTION" title="JOURNAL:RECORD-JOURNAL FUNCTION"><code>record-journal</code></a>, consuming an event with a matching
name from the <a href="#JOURNAL:REPLAY-JOURNAL%20FUNCTION" title="JOURNAL:REPLAY-JOURNAL FUNCTION"><code>replay-journal</code></a> in the latter case. If the strategy is
<em>match</em>, then:</p>

<ul>
<li><p>If the new event has an <a href="#JOURNAL:@UNEXPECTED-OUTCOME%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@UNEXPECTED-OUTCOME MGL-PAX:GLOSSARY-TERM">unexpected outcome</a>, then
  <strong><a href="#JOURNAL:REPLAY-UNEXPECTED-OUTCOME%20CONDITION" title="JOURNAL:REPLAY-UNEXPECTED-OUTCOME CONDITION"><code>replay-unexpected-outcome</code></a></strong> is signalled. Note that the replay
  event always has an <a href="#JOURNAL:@EXPECTED-OUTCOME%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@EXPECTED-OUTCOME MGL-PAX:GLOSSARY-TERM">expected outcome</a> due to the handling of
  <a href="#JOURNAL:RECORD-UNEXPECTED-OUTCOME%20CONDITION" title="JOURNAL:RECORD-UNEXPECTED-OUTCOME CONDITION"><code>record-unexpected-outcome</code></a>.</p></li>
<li><p>If the new event has an <a href="#JOURNAL:@EXPECTED-OUTCOME%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@EXPECTED-OUTCOME MGL-PAX:GLOSSARY-TERM">expected outcome</a>, then unless the new and
  <a href="#JOURNAL:@REPLAY-EVENT%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@REPLAY-EVENT MGL-PAX:GLOSSARY-TERM">replay event</a>'s <code>event-exit</code>(<a href="#JOURNAL:EVENT-EXIT%20FUNCTION" title="JOURNAL:EVENT-EXIT FUNCTION"><code>0</code></a> <a href="#JOURNAL:EVENT-EXIT%20TYPE" title="JOURNAL:EVENT-EXIT TYPE"><code>1</code></a>)s are <a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_eq.htm" title="EQ FUNCTION"><code>eq</code></a> and their <a href="#JOURNAL:EVENT-OUTCOME%20FUNCTION" title="JOURNAL:EVENT-OUTCOME FUNCTION"><code>event-outcome</code></a>s are
  <a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_equal.htm" title="EQUAL FUNCTION"><code>equal</code></a>, <strong><a href="#JOURNAL:REPLAY-OUTCOME-MISMATCH%20CONDITION" title="JOURNAL:REPLAY-OUTCOME-MISMATCH CONDITION"><code>replay-outcome-mismatch</code></a></strong> is signalled.</p></li>
<li><p>Else, the replay event is consumed and the new event is written
  the <code>record-journal</code>.</p></li>
</ul>

<p>Note that <a href="#JOURNAL:@THE-REPLAY-STRATEGY%20MGL-PAX:SECTION" title="The replay strategy">The replay strategy</a> for the in-event and the out-event of
the same <a href="#JOURNAL:@FRAME%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@FRAME MGL-PAX:GLOSSARY-TERM">frame</a> may differ if the corresponding out-event is not
present in <code>replay-journal</code>, which may be the case when the recording
process failed hard without unwinding properly, or when an
<a href="#JOURNAL:@UNEXPECTED-OUTCOME%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@UNEXPECTED-OUTCOME MGL-PAX:GLOSSARY-TERM">unexpected outcome</a> triggered the transition to <a href="#JOURNAL:JOURNAL-STATE%20TYPE" title="JOURNAL:JOURNAL-STATE TYPE"><code>journal-state</code></a>
<code>:logging</code>.</p>

<p><a id="x-28JOURNAL-3A-40REPLAY-FAILURES-20MGL-PAX-3ASECTION-29"></a>
<a id="JOURNAL:@REPLAY-FAILURES%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#JOURNAL:@MATCHING-OUT-EVENTS%20MGL-PAX:SECTION" title="Matching out-events">&#8592;</a> <a href="#JOURNAL:@REPLAY%20MGL-PAX:SECTION" title="Replay">&#8593;</a> <a href="#JOURNAL:@UPGRADES-AND-REPLAY%20MGL-PAX:SECTION" title="Upgrades and replay">&#8594;</a> <a href="#JOURNAL:@REPLAY-FAILURES%20MGL-PAX:SECTION" title="Replay failures">&#8634;</a> <a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L3835">&#955;</a></span></span></p>

<h3><a href="#JOURNAL:@REPLAY-FAILURES%20MGL-PAX:SECTION">9.6 Replay failures</a></h3>

<p><a id="x-28JOURNAL-3AREPLAY-FAILURE-20CONDITION-29"></a>
<a id="JOURNAL:REPLAY-FAILURE%20CONDITION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L3849">[condition]</a></span> <span class="reference-object"><a href="#JOURNAL:REPLAY-FAILURE%20CONDITION" >replay-failure</a></span></span> <span class="locative-args"><a href="http://www.lispworks.com/documentation/HyperSpec/Body/e_seriou.htm" title="SERIOUS-CONDITION CONDITION">serious-condition</a></span></span></p>

<p>A abstract superclass (never itself signalled) for
all kinds of mismatches between the events produced and the replay
journal. Signalled only in <a href="#JOURNAL:JOURNAL-STATE%20TYPE" title="JOURNAL:JOURNAL-STATE TYPE"><code>journal-state</code></a> <code>:replaying</code> and only once
per <a href="#JOURNAL:WITH-JOURNALING%20MGL-PAX:MACRO" title="JOURNAL:WITH-JOURNALING MGL-PAX:MACRO"><code>with-journaling</code></a>. If a <code>replay-failure</code> is signalled for an <a href="#JOURNAL:EVENT%20TYPE" title="JOURNAL:EVENT TYPE"><code>event</code></a>,
then the event will be recorded, but <a href="#JOURNAL:RECORD-JOURNAL%20FUNCTION" title="JOURNAL:RECORD-JOURNAL FUNCTION"><code>record-journal</code></a> will transition
to <code>journal-state</code> <code>:mismatched</code>. Like <a href="#JOURNAL:JOURNALING-FAILURE%20CONDITION" title="JOURNAL:JOURNALING-FAILURE CONDITION"><code>journaling-failure</code></a>, this is a
serious condition because it is to be handled outside the enclosing
<code>with-journaling</code>. If a <code>replay-failure</code> were to be handled inside the
<code>with-journaling</code>, keep in mind that in <code>:mismatched</code>, replay always
uses the <em>insert</em> replay strategy (see <a href="#JOURNAL:@THE-REPLAY-STRATEGY%20MGL-PAX:SECTION" title="The replay strategy">The replay strategy</a>).</p></li>
</ul>

<p><a id="x-28JOURNAL-3AREPLAY-FAILURE-NEW-EVENT-20-28MGL-PAX-3AREADER-20JOURNAL-3AREPLAY-FAILURE-29-29"></a>
<a id="JOURNAL:REPLAY-FAILURE-NEW-EVENT%20%28MGL-PAX:READER%20JOURNAL:REPLAY-FAILURE%29"></a></p>

<ul>
<li><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L3849">[reader]</a></span> <span class="reference-object"><a href="#JOURNAL:REPLAY-FAILURE-NEW-EVENT%20%28MGL-PAX:READER%20JOURNAL:REPLAY-FAILURE%29" >replay-failure-new-event</a></span></span> <span class="locative-args">replay-failure (:new-event)</span></span></li>
</ul>

<p><a id="x-28JOURNAL-3AREPLAY-FAILURE-REPLAY-EVENT-20-28MGL-PAX-3AREADER-20JOURNAL-3AREPLAY-FAILURE-29-29"></a>
<a id="JOURNAL:REPLAY-FAILURE-REPLAY-EVENT%20%28MGL-PAX:READER%20JOURNAL:REPLAY-FAILURE%29"></a></p>

<ul>
<li><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L3849">[reader]</a></span> <span class="reference-object"><a href="#JOURNAL:REPLAY-FAILURE-REPLAY-EVENT%20%28MGL-PAX:READER%20JOURNAL:REPLAY-FAILURE%29" >replay-failure-replay-event</a></span></span> <span class="locative-args">replay-failure (:replay-event)</span></span></li>
</ul>

<p><a id="x-28JOURNAL-3AREPLAY-FAILURE-REPLAY-JOURNAL-20-28MGL-PAX-3AREADER-20JOURNAL-3AREPLAY-FAILURE-29-29"></a>
<a id="JOURNAL:REPLAY-FAILURE-REPLAY-JOURNAL%20%28MGL-PAX:READER%20JOURNAL:REPLAY-FAILURE%29"></a></p>

<ul>
<li><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L3849">[reader]</a></span> <span class="reference-object"><a href="#JOURNAL:REPLAY-FAILURE-REPLAY-JOURNAL%20%28MGL-PAX:READER%20JOURNAL:REPLAY-FAILURE%29" >replay-failure-replay-journal</a></span></span> <span class="locative-args">replay-failure (= '(replay-journal))</span></span></li>
</ul>

<p><a id="x-28JOURNAL-3AREPLAY-NAME-MISMATCH-20CONDITION-29"></a>
<a id="JOURNAL:REPLAY-NAME-MISMATCH%20CONDITION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L3932">[condition]</a></span> <span class="reference-object"><a href="#JOURNAL:REPLAY-NAME-MISMATCH%20CONDITION" >replay-name-mismatch</a></span></span> <span class="locative-args"><a href="#JOURNAL:REPLAY-FAILURE%20CONDITION" title="JOURNAL:REPLAY-FAILURE CONDITION">replay-failure</a></span></span></p>

<p>Signalled when the new event's and <a href="#JOURNAL:@REPLAY-EVENT%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@REPLAY-EVENT MGL-PAX:GLOSSARY-TERM">replay event</a>'s
<a href="#JOURNAL:EVENT-NAME%20FUNCTION" title="JOURNAL:EVENT-NAME FUNCTION"><code>event-name</code></a> are not <a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_equal.htm" title="EQUAL FUNCTION"><code>equal</code></a>. The <a href="#JOURNAL:REPLAY-FORCE-INSERT%20RESTART" title="JOURNAL:REPLAY-FORCE-INSERT RESTART"><code>replay-force-insert</code></a>,
<a href="#JOURNAL:REPLAY-FORCE-UPGRADE%20RESTART" title="JOURNAL:REPLAY-FORCE-UPGRADE RESTART"><code>replay-force-upgrade</code></a> restarts are provided.</p></li>
</ul>

<p><a id="x-28JOURNAL-3AREPLAY-VERSION-DOWNGRADE-20CONDITION-29"></a>
<a id="JOURNAL:REPLAY-VERSION-DOWNGRADE%20CONDITION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L3946">[condition]</a></span> <span class="reference-object"><a href="#JOURNAL:REPLAY-VERSION-DOWNGRADE%20CONDITION" >replay-version-downgrade</a></span></span> <span class="locative-args"><a href="#JOURNAL:REPLAY-FAILURE%20CONDITION" title="JOURNAL:REPLAY-FAILURE CONDITION">replay-failure</a></span></span></p>

<p>Signalled when the new event and the <a href="#JOURNAL:@REPLAY-EVENT%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@REPLAY-EVENT MGL-PAX:GLOSSARY-TERM">replay event</a>
have the same <a href="#JOURNAL:EVENT-NAME%20FUNCTION" title="JOURNAL:EVENT-NAME FUNCTION"><code>event-name</code></a>, but the new event has a lower version. The
<a href="#JOURNAL:REPLAY-FORCE-UPGRADE%20RESTART" title="JOURNAL:REPLAY-FORCE-UPGRADE RESTART"><code>replay-force-upgrade</code></a> restart is provided.</p></li>
</ul>

<p><a id="x-28JOURNAL-3AREPLAY-ARGS-MISMATCH-20CONDITION-29"></a>
<a id="JOURNAL:REPLAY-ARGS-MISMATCH%20CONDITION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L3960">[condition]</a></span> <span class="reference-object"><a href="#JOURNAL:REPLAY-ARGS-MISMATCH%20CONDITION" >replay-args-mismatch</a></span></span> <span class="locative-args"><a href="#JOURNAL:REPLAY-FAILURE%20CONDITION" title="JOURNAL:REPLAY-FAILURE CONDITION">replay-failure</a></span></span></p>

<p>Signalled when the new event's and <a href="#JOURNAL:@REPLAY-EVENT%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@REPLAY-EVENT MGL-PAX:GLOSSARY-TERM">replay event</a>'s
<a href="#JOURNAL:EVENT-ARGS%20FUNCTION" title="JOURNAL:EVENT-ARGS FUNCTION"><code>event-args</code></a> are not <a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_equal.htm" title="EQUAL FUNCTION"><code>equal</code></a>. The <a href="#JOURNAL:REPLAY-FORCE-UPGRADE%20RESTART" title="JOURNAL:REPLAY-FORCE-UPGRADE RESTART"><code>replay-force-upgrade</code></a> restart is
provided.</p></li>
</ul>

<p><a id="x-28JOURNAL-3AREPLAY-OUTCOME-MISMATCH-20CONDITION-29"></a>
<a id="JOURNAL:REPLAY-OUTCOME-MISMATCH%20CONDITION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L3974">[condition]</a></span> <span class="reference-object"><a href="#JOURNAL:REPLAY-OUTCOME-MISMATCH%20CONDITION" >replay-outcome-mismatch</a></span></span> <span class="locative-args"><a href="#JOURNAL:REPLAY-FAILURE%20CONDITION" title="JOURNAL:REPLAY-FAILURE CONDITION">replay-failure</a></span></span></p>

<p>Signalled when the new event's and <a href="#JOURNAL:@REPLAY-EVENT%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@REPLAY-EVENT MGL-PAX:GLOSSARY-TERM">replay event</a>'s
<code>event-exit</code>(<a href="#JOURNAL:EVENT-EXIT%20FUNCTION" title="JOURNAL:EVENT-EXIT FUNCTION"><code>0</code></a> <a href="#JOURNAL:EVENT-EXIT%20TYPE" title="JOURNAL:EVENT-EXIT TYPE"><code>1</code></a>) and/or <a href="#JOURNAL:EVENT-OUTCOME%20FUNCTION" title="JOURNAL:EVENT-OUTCOME FUNCTION"><code>event-outcome</code></a> are not <a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_equal.htm" title="EQUAL FUNCTION"><code>equal</code></a>. The
<a href="#JOURNAL:REPLAY-FORCE-UPGRADE%20RESTART" title="JOURNAL:REPLAY-FORCE-UPGRADE RESTART"><code>replay-force-upgrade</code></a> restart is provided.</p></li>
</ul>

<p><a id="x-28JOURNAL-3AREPLAY-UNEXPECTED-OUTCOME-20CONDITION-29"></a>
<a id="JOURNAL:REPLAY-UNEXPECTED-OUTCOME%20CONDITION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L3988">[condition]</a></span> <span class="reference-object"><a href="#JOURNAL:REPLAY-UNEXPECTED-OUTCOME%20CONDITION" >replay-unexpected-outcome</a></span></span> <span class="locative-args"><a href="#JOURNAL:REPLAY-FAILURE%20CONDITION" title="JOURNAL:REPLAY-FAILURE CONDITION">replay-failure</a></span></span></p>

<p>Signalled when the new event has an
<a href="#JOURNAL:@UNEXPECTED-OUTCOME%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@UNEXPECTED-OUTCOME MGL-PAX:GLOSSARY-TERM">unexpected outcome</a>. Note that the <a href="#JOURNAL:@REPLAY-EVENT%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@REPLAY-EVENT MGL-PAX:GLOSSARY-TERM">replay event</a> always has an
<a href="#JOURNAL:@EXPECTED-OUTCOME%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@EXPECTED-OUTCOME MGL-PAX:GLOSSARY-TERM">expected outcome</a> due to the logic of <a href="#JOURNAL:RECORD-UNEXPECTED-OUTCOME%20CONDITION" title="JOURNAL:RECORD-UNEXPECTED-OUTCOME CONDITION"><code>record-unexpected-outcome</code></a>. No
restarts are provided.</p></li>
</ul>

<p><a id="x-28JOURNAL-3AREPLAY-INCOMPLETE-20CONDITION-29"></a>
<a id="JOURNAL:REPLAY-INCOMPLETE%20CONDITION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L4003">[condition]</a></span> <span class="reference-object"><a href="#JOURNAL:REPLAY-INCOMPLETE%20CONDITION" >replay-incomplete</a></span></span> <span class="locative-args"><a href="#JOURNAL:REPLAY-FAILURE%20CONDITION" title="JOURNAL:REPLAY-FAILURE CONDITION">replay-failure</a></span></span></p>

<p>Signalled if there are unprocessed non-log events in
<a href="#JOURNAL:REPLAY-JOURNAL%20FUNCTION" title="JOURNAL:REPLAY-JOURNAL FUNCTION"><code>replay-journal</code></a> when <a href="#JOURNAL:WITH-JOURNALING%20MGL-PAX:MACRO" title="JOURNAL:WITH-JOURNALING MGL-PAX:MACRO"><code>with-journaling</code></a> finishes and the body of
<code>with-journaling</code> returned normally, which is to prevent this
condition to cancel an ongoing unwinding. No restarts are provided.</p></li>
</ul>

<p><a id="x-28JOURNAL-3AREPLAY-FORCE-INSERT-20RESTART-29"></a>
<a id="JOURNAL:REPLAY-FORCE-INSERT%20RESTART"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L4017">[restart]</a></span> <span class="reference-object"><a href="#JOURNAL:REPLAY-FORCE-INSERT%20RESTART" >replay-force-insert</a></span></span></span></p>

<p>This restart forces <a href="#JOURNAL:@THE-REPLAY-STRATEGY%20MGL-PAX:SECTION" title="The replay strategy">The replay strategy</a> to be <code>:insert</code>, overriding
<a href="#JOURNAL:REPLAY-NAME-MISMATCH%20CONDITION" title="JOURNAL:REPLAY-NAME-MISMATCH CONDITION"><code>replay-name-mismatch</code></a>. This is intended for upgrades, and extreme
care must be taken not to lose data.</p></li>
</ul>

<p><a id="x-28JOURNAL-3AREPLAY-FORCE-UPGRADE-20RESTART-29"></a>
<a id="JOURNAL:REPLAY-FORCE-UPGRADE%20RESTART"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L4022">[restart]</a></span> <span class="reference-object"><a href="#JOURNAL:REPLAY-FORCE-UPGRADE%20RESTART" >replay-force-upgrade</a></span></span></span></p>

<p>This restart forces <a href="#JOURNAL:@THE-REPLAY-STRATEGY%20MGL-PAX:SECTION" title="The replay strategy">The replay strategy</a> to be <code>:upgrade</code>, overriding
<a href="#JOURNAL:REPLAY-NAME-MISMATCH%20CONDITION" title="JOURNAL:REPLAY-NAME-MISMATCH CONDITION"><code>replay-name-mismatch</code></a>, <a href="#JOURNAL:REPLAY-VERSION-DOWNGRADE%20CONDITION" title="JOURNAL:REPLAY-VERSION-DOWNGRADE CONDITION"><code>replay-version-downgrade</code></a>,
<a href="#JOURNAL:REPLAY-ARGS-MISMATCH%20CONDITION" title="JOURNAL:REPLAY-ARGS-MISMATCH CONDITION"><code>replay-args-mismatch</code></a>, <a href="#JOURNAL:REPLAY-OUTCOME-MISMATCH%20CONDITION" title="JOURNAL:REPLAY-OUTCOME-MISMATCH CONDITION"><code>replay-outcome-mismatch</code></a>. This is intended for
upgrades, and extreme care must be taken not to lose data.</p></li>
</ul>

<p><a id="x-28JOURNAL-3A-40UPGRADES-AND-REPLAY-20MGL-PAX-3ASECTION-29"></a>
<a id="JOURNAL:@UPGRADES-AND-REPLAY%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#JOURNAL:@REPLAY-FAILURES%20MGL-PAX:SECTION" title="Replay failures">&#8592;</a> <a href="#JOURNAL:@REPLAY%20MGL-PAX:SECTION" title="Replay">&#8593;</a> <a href="#JOURNAL:@TESTING%20MGL-PAX:SECTION" title="Testing">&#8594;</a> <a href="#JOURNAL:@UPGRADES-AND-REPLAY%20MGL-PAX:SECTION" title="Upgrades and replay">&#8634;</a> <a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L4029">&#955;</a></span></span></p>

<h3><a href="#JOURNAL:@UPGRADES-AND-REPLAY%20MGL-PAX:SECTION">9.7 Upgrades and replay</a></h3>

<p>The replay mechanism is built on the assumption that the tree of
<a href="#JOURNAL:@FRAME%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@FRAME MGL-PAX:GLOSSARY-TERM">frame</a>s is the same when the code is replayed as it was when the
replay journal was originally recorded. Thus, non-deterministic
control flow poses a challenge, but non-determinism can be isolated
with <a href="#JOURNAL:EXTERNAL-EVENT%20TYPE" title="JOURNAL:EXTERNAL-EVENT TYPE"><code>external-event</code></a>s. However, when the code changes, we might find
the structure of frames in previous recordings hard to accommodate.
In this case, we might decide to alter the structure, giving up some
of the safety provided by the replay mechanism. There are various
tools at our disposal to control this tradeoff between safety and
flexibility:</p>

<ul>
<li><p>We can insert individual frames with <a href="#JOURNAL:JOURNALED%20MGL-PAX:MACRO" title="JOURNAL:JOURNALED MGL-PAX:MACRO"><code>journaled</code></a>'s <code>insertable</code>,
  upgrade frames by bumping <code>journaled</code>'s <code>version</code>, and filter frames
  with <a href="#JOURNAL:WITH-REPLAY-FILTER%20MGL-PAX:MACRO" title="JOURNAL:WITH-REPLAY-FILTER MGL-PAX:MACRO"><code>with-replay-filter</code></a>. This option allows for the most
  consistency checks.</p></li>
<li><p>The <a href="#JOURNAL:REPLAY-FORCE-UPGRADE%20RESTART" title="JOURNAL:REPLAY-FORCE-UPGRADE RESTART"><code>replay-force-upgrade</code></a> and <a href="#JOURNAL:REPLAY-FORCE-INSERT%20RESTART" title="JOURNAL:REPLAY-FORCE-INSERT RESTART"><code>replay-force-insert</code></a> restarts allow
  overriding <a href="#JOURNAL:@THE-REPLAY-STRATEGY%20MGL-PAX:SECTION" title="The replay strategy">The replay strategy</a>, but their use requires great care
  to be taken.</p></li>
<li><p>Or we may decide to keep the bare minimum of the replay journal
  around and discard everything except for <code>external-event</code>s. This
  option is equivalent to</p>

<pre><code>(let ((*force-insertable* t))
  (with-replay-filter (:skip '((:name nil)))
    42))
</code></pre></li>
<li><p>Rerecording the journal without replay might be another option if
  there are no <code>external-event</code>s to worry about.</p></li>
<li><p>Finally, we can rewrite the replay journal using the low-level
  interface (see <a href="#JOURNAL:@STREAMLETS-REFERENCE%20MGL-PAX:SECTION" title="Streamlets reference">Streamlets reference</a>). In this case, extreme care
  must be taken not to corrupt the journal (and lose data) as there
  are no consistency checks to save us.</p></li>
</ul>

<p>With that, let's see how <code>with-replay-filter</code> works.</p>

<p><a id="x-28JOURNAL-3AWITH-REPLAY-STREAMLET-20MGL-PAX-3AMACRO-29"></a>
<a id="JOURNAL:WITH-REPLAY-STREAMLET%20MGL-PAX:MACRO"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L4071">[macro]</a></span> <span class="reference-object"><a href="#JOURNAL:WITH-REPLAY-STREAMLET%20MGL-PAX:MACRO" >with-replay-streamlet</a></span></span> <span class="locative-args">(var) &amp;body body</span></span></p>

<p>Open <a href="#JOURNAL:REPLAY-JOURNAL%20FUNCTION" title="JOURNAL:REPLAY-JOURNAL FUNCTION"><code>replay-journal</code></a> for reading with <a href="#JOURNAL:WITH-OPEN-JOURNAL%20MGL-PAX:MACRO" title="JOURNAL:WITH-OPEN-JOURNAL MGL-PAX:MACRO"><code>with-open-journal</code></a>, set the
<a href="#JOURNAL:READ-POSITION%20GENERIC-FUNCTION" title="JOURNAL:READ-POSITION GENERIC-FUNCTION"><code>read-position</code></a> on it to the event next read by the <a href="#JOURNAL:@REPLAY%20MGL-PAX:SECTION" title="Replay">Replay</a>
mechanism (which is never a <a href="#JOURNAL:LOG-EVENT%20TYPE" title="JOURNAL:LOG-EVENT TYPE"><code>log-event</code></a>). The low-level
<a href="#JOURNAL:@READING-FROM-STREAMLETS%20MGL-PAX:SECTION" title="Reading from streamlets">Reading from streamlets</a> api is then available to inspect the
contents of the replay. It is an error if <code>replay-journal</code> is <code>nil</code>.</p></li>
</ul>

<p><a id="x-28JOURNAL-3APEEK-REPLAY-EVENT-20FUNCTION-29"></a>
<a id="JOURNAL:PEEK-REPLAY-EVENT%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L4081">[function]</a></span> <span class="reference-object"><a href="#JOURNAL:PEEK-REPLAY-EVENT%20FUNCTION" >peek-replay-event</a></span></span></span></p>

<p>Return the <a href="#JOURNAL:@REPLAY-EVENT%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@REPLAY-EVENT MGL-PAX:GLOSSARY-TERM">replay event</a> to be read from <a href="#JOURNAL:REPLAY-JOURNAL%20FUNCTION" title="JOURNAL:REPLAY-JOURNAL FUNCTION"><code>replay-journal</code></a>. This is
roughly equivalent to</p>

<pre><code><span class="code"><span class="paren1">(<span class="code">when <span class="paren2">(<span class="code">replay-journal</span>)</span>
  <span class="paren2">(<span class="code"><i><span class="symbol">with-replay-streamlet</span></i> <span class="paren3">(<span class="code">streamlet</span>)</span>
    <span class="paren3">(<span class="code">peek-event streamlet</span>)</span></span>)</span></span></span></span></code></pre>

<p>except <code>peek-replay-event</code> takes into account <a href="#JOURNAL:WITH-REPLAY-FILTER%20MGL-PAX:MACRO" title="JOURNAL:WITH-REPLAY-FILTER MGL-PAX:MACRO"><code>with-replay-filter</code></a>
<code>:map</code>, and it may return <code>(:indeterminate)</code> if <code>with-replay-filter</code>
<code>:skip</code> is in effect and what events are to be skipped cannot be
decided until the next in-event generated by the code.</p>

<p>Imagine a business process for paying an invoice. In the first
version of this process, we just pay the invoice:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code">replayed <span class="paren2">(<span class="code">pay</span>)</span></span>)</span></span></code></pre>

<p>We have left the implementation of PAY blank. In the second version,
we need to get an approval first:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code">when <span class="paren2">(<span class="code">replayed <span class="paren3">(<span class="code">get-approval</span>)</span>
        <span class="paren3">(<span class="code">= <span class="paren4">(<span class="code">random 2</span>)</span> 0</span>)</span></span>)</span>
  <span class="paren2">(<span class="code">replayed <span class="paren3">(<span class="code">pay</span>)</span></span>)</span></span>)</span></span></code></pre>

<p>Replaying a journal produced by the first version of the code with
the second version would run into difficulties because inserting
<a href="#JOURNAL:EXTERNAL-EVENT%20TYPE" title="JOURNAL:EXTERNAL-EVENT TYPE"><code>external-event</code></a>s is tricky.</p>

<p>We have to first decide how to handle the lack of approval in the
first version. Here, we just assume the processes started by the
first version get approval automatically. The implementation is
based on a dummy <code>process</code> block whose version is bumped when the
payment process changes and is inspected at the start of journaling.</p>

<p>When v1 is replayed with v2, we introduce an <code>insertable</code>, versioned
<code>get-approval</code> block that just returns <code>t</code>. When replaying the code
again, still with v2, the <code>get-approval</code> block will be upgraded to
<code>:infinity</code>.</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">let</span></i> <span class="paren2">(<span class="code"><span class="paren3">(<span class="code">bundle <span class="paren4">(<span class="code">make-in-memory-bundle</span>)</span></span>)</span></span>)</span>
  <span class="comment">;; First version of the payment process. Just pay.
</span>  <span class="paren2">(<span class="code"><i><span class="symbol">with-bundle</span></i> <span class="paren3">(<span class="code">bundle</span>)</span>
    <span class="paren3">(<span class="code">checked <span class="paren4">(<span class="code">process <span class="keyword">:version</span> 1</span>)</span></span>)</span>
    <span class="paren3">(<span class="code">replayed <span class="paren4">(<span class="code">pay</span>)</span></span>)</span></span>)</span>
  <span class="comment">;; Second version of the payment process. Only pay if approved.
</span>  <span class="paren2">(<span class="code"><i><span class="symbol">loop</span></i> repeat 2 do
    <span class="paren3">(<span class="code"><i><span class="symbol">with-bundle</span></i> <span class="paren4">(<span class="code">bundle</span>)</span>
      <span class="paren4">(<span class="code"><i><span class="symbol">let</span></i> <span class="paren5">(<span class="code"><span class="paren6">(<span class="code">replay-process-event <span class="paren1">(<span class="code">peek-replay-event</span>)</span></span>)</span></span>)</span>
        <span class="paren5">(<span class="code">checked <span class="paren6">(<span class="code">process <span class="keyword">:version</span> 2</span>)</span></span>)</span>
        <span class="paren5">(<span class="code">when <span class="paren6">(<span class="code"><i><span class="symbol">if</span></i> <span class="paren1">(<span class="code">and replay-process-event
                       <span class="paren2">(<span class="code">&lt; <span class="paren3">(<span class="code">event-version replay-process-event</span>)</span> 2</span>)</span></span>)</span>
                  <span class="comment">;; This will be upgraded to :INFINITY the second
</span>                  <span class="comment">;; time around the LOOP.
</span>                  <span class="paren1">(<span class="code">checked <span class="paren2">(<span class="code">get-approval <span class="keyword">:insertable</span> t</span>)</span>
                    t</span>)</span>
                  <span class="paren1">(<span class="code">replayed <span class="paren2">(<span class="code">get-approval</span>)</span>
                    <span class="paren2">(<span class="code">= <span class="paren3">(<span class="code">random 2</span>)</span> 0</span>)</span></span>)</span></span>)</span>
          <span class="paren6">(<span class="code">replayed <span class="paren1">(<span class="code">pay</span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span></code></pre></li>
</ul>

<p><a id="x-28JOURNAL-3AWITH-REPLAY-FILTER-20MGL-PAX-3AMACRO-29"></a>
<a id="JOURNAL:WITH-REPLAY-FILTER%20MGL-PAX:MACRO"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L4152">[macro]</a></span> <span class="reference-object"><a href="#JOURNAL:WITH-REPLAY-FILTER%20MGL-PAX:MACRO" >with-replay-filter</a></span></span> <span class="locative-args">(&amp;key map skip no-replay-outcome) &amp;body body</span></span></p>

<p><code>with-replay-filter</code> performs journal upgrade during replay by
allowing events to be transformed as they are read from the replay
journal or skipped if they match some patterns. For how to add new
blocks in a code upgrade, see <a href="#JOURNAL:JOURNALED%20MGL-PAX:MACRO" title="JOURNAL:JOURNALED MGL-PAX:MACRO"><code>journaled</code></a>'s <code>:insertable</code> argument. In
addition, it also allows some control over <a href="#JOURNAL:@REPLAYING-THE-OUTCOME%20MGL-PAX:SECTION" title="Replaying the outcome">Replaying the outcome</a>.</p>

<ul>
<li><p><code>map</code>: A function called with an event read from the replay journal
  which returns a transformed event. See <a href="#JOURNAL:@EVENTS-REFERENCE%20MGL-PAX:SECTION" title="Events reference">Events reference</a>. <code>map</code>
  takes effect before before <code>skip</code>.</p></li>
<li><p><code>skip</code>: In addition to filtering out <a href="#JOURNAL:LOG-EVENT%20TYPE" title="JOURNAL:LOG-EVENT TYPE"><code>log-event</code></a>s (which always
  happens during replay), filter out all events that belong to
  frames that match any of its <code>skip</code> patterns. Filtered out events
  are never seen by <code>journaled</code> as it replays events. <code>skip</code> patterns
  are of the format <code>(&amp;key name version&lt;)</code>, where <code>version&lt;</code> is a
  valid <a href="#JOURNAL:EVENT-VERSION%20TYPE" title="JOURNAL:EVENT-VERSION TYPE"><code>event-version</code></a>, and <code>name</code> may be <code>nil</code>, which acts as a
  wildcard.</p>

<p><code>skip</code> is for when <code>journaled</code> <a href="#JOURNAL:@BLOCK%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@BLOCK MGL-PAX:GLOSSARY-TERM">block</a>s are removed from the code,
which would render replaying previously recorded journals
impossible. Note that, for reasons of safety, it is not possible
to filter <a href="#JOURNAL:EXTERNAL-EVENT%20TYPE" title="JOURNAL:EXTERNAL-EVENT TYPE"><code>external-event</code></a>s.</p></li>
<li><p><code>no-replay-outcome</code> is a list of <a href="#JOURNAL:EVENT-NAME%20FUNCTION" title="JOURNAL:EVENT-NAME FUNCTION"><code>event-name</code></a>s. <a href="#JOURNAL:@REPLAYING-THE-OUTCOME%20MGL-PAX:SECTION" title="Replaying the outcome">Replaying the outcome</a>
  is prevented for frames with <a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_equal.htm" title="EQUAL FUNCTION"><code>equal</code></a> names. See
  <a href="#JOURNAL:@TESTING-ON-MULTIPLE-LEVELS%20MGL-PAX:SECTION" title="Testing on multiple levels">Testing on multiple levels</a> for an example.</p></li>
</ul>

<p><code>with-replay-filter</code> affects only the immediately enclosing
<a href="#JOURNAL:WITH-JOURNALING%20MGL-PAX:MACRO" title="JOURNAL:WITH-JOURNALING MGL-PAX:MACRO"><code>with-journaling</code></a>. A <code>with-replay-filter</code> nested within another in the
same <code>with-journaling</code> inherits the <code>skip</code> patterns of its parent, to
which it adds its own. The <a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_map.htm" title="MAP FUNCTION"><code>map</code></a> function is applied to before the
parent's <code>map</code>.</p>

<p>Examples of <code>skip</code> patterns:</p>

<pre><code><span class="code"><span class="comment">;; Match events with name FOO and version 1, 2, 3 or 4
</span><span class="paren1">(<span class="code"><span class="keyword">:name</span> foo <span class="keyword">:version&lt;</span> 5</span>)</span>
<span class="comment">;; Match events with name BAR and any version
</span><span class="paren1">(<span class="code"><span class="keyword">:name</span> bar <span class="keyword">:version&lt;</span> <span class="keyword">:infinity</span></span>)</span>
<span class="comment">;; Same as the previous
</span><span class="paren1">(<span class="code"><span class="keyword">:name</span> bar</span>)</span>
<span class="comment">;; Match all names
</span><span class="paren1">(<span class="code"><span class="keyword">:name</span> nil</span>)</span>
<span class="comment">;; Same as the previous
</span><span class="paren1">(<span class="code"></span>)</span></span></code></pre>

<p>Skipping can be thought of as removing nodes of the tree of frames,
connecting its children to its parent. The following example removes
frames <code>j1</code> and <code>j2</code> from around <code>j3</code>, the <code>j1</code> frame from within
<code>j3</code>, and the third <code>j1</code> frame.</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">let</span></i> <span class="paren2">(<span class="code"><span class="paren3">(<span class="code">journal <span class="paren4">(<span class="code">make-in-memory-journal</span>)</span></span>)</span></span>)</span>
  <span class="comment">;; Record trees J1 -&gt; J2 -&gt; J3 -&gt; J1, and J1.
</span>  <span class="paren2">(<span class="code"><i><span class="symbol">with-journaling</span></i> <span class="paren3">(<span class="code"><span class="keyword">:record</span> journal</span>)</span>
    <span class="paren3">(<span class="code">checked <span class="paren4">(<span class="code">j1</span>)</span>
      <span class="paren4">(<span class="code">checked <span class="paren5">(<span class="code">j2</span>)</span>
        <span class="paren5">(<span class="code">checked <span class="paren6">(<span class="code">j3</span>)</span>
          <span class="paren6">(<span class="code">checked <span class="paren1">(<span class="code">j1</span>)</span>
            42</span>)</span></span>)</span></span>)</span></span>)</span>
    <span class="paren3">(<span class="code">checked <span class="paren4">(<span class="code">j1</span>)</span>
      7</span>)</span></span>)</span>
  <span class="comment">;; Filter out all occurrences of VERSIONED-EVENTs named J1 and
</span>  <span class="comment">;; J2 from the replay, leaving only J3 to match.
</span>  <span class="paren2">(<span class="code"><i><span class="symbol">with-journaling</span></i> <span class="paren3">(<span class="code"><span class="keyword">:replay</span> journal <span class="keyword">:record</span> t <span class="keyword">:replay-eoj-error-p</span> t</span>)</span>
    <span class="paren3">(<span class="code"><i><span class="symbol">with-replay-filter</span></i> <span class="paren4">(<span class="code"><span class="keyword">:skip</span> '<span class="paren5">(<span class="code"><span class="paren6">(<span class="code"><span class="keyword">:name</span> j1</span>)</span> <span class="paren6">(<span class="code"><span class="keyword">:name</span> j2</span>)</span></span>)</span></span>)</span>
      <span class="paren4">(<span class="code">checked <span class="paren5">(<span class="code">j3</span>)</span>
        42</span>)</span></span>)</span></span>)</span></span>)</span></span></code></pre></li>
</ul>

<p><a id="x-28JOURNAL-3A-40TESTING-20MGL-PAX-3ASECTION-29"></a>
<a id="JOURNAL:@TESTING%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#JOURNAL:@UPGRADES-AND-REPLAY%20MGL-PAX:SECTION" title="Upgrades and replay">&#8592;</a> <a href="journal-manual.html" title="Journal manual">&#8593;</a> <a href="#JOURNAL:@TESTING-ON-MULTIPLE-LEVELS%20MGL-PAX:SECTION" title="Testing on multiple levels">&#8594;</a> <a href="#JOURNAL:@TESTING%20MGL-PAX:SECTION" title="Testing">&#8634;</a> <a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L4359">&#955;</a></span></span></p>

<h2><a href="#JOURNAL:@TESTING%20MGL-PAX:SECTION">10 Testing</a></h2>

<p>Having discussed the <a href="#JOURNAL:@REPLAY%20MGL-PAX:SECTION" title="Replay">Replay</a> mechanism, next are <a href="#JOURNAL:@TESTING%20MGL-PAX:SECTION" title="Testing">Testing</a> and
<a href="#JOURNAL:@PERSISTENCE%20MGL-PAX:SECTION" title="Persistence">Persistence</a>, which rely heavily on replay. Suppose we want to unit
test user registration. Unfortunately, the code communicates with a
database service and also takes input from the user. A natural
solution is to create <a href="https://en.wikipedia.org/wiki/Mock_object" >mocks</a> for these external
systems to unshackle the test from the cumbersome database
dependency and to allow it to run without user interaction.</p>

<p>We do this below by wrapping external interaction in <a href="#JOURNAL:JOURNALED%20MGL-PAX:MACRO" title="JOURNAL:JOURNALED MGL-PAX:MACRO"><code>journaled</code></a> with
<code>:version</code> <code>:infinity</code> (see <a href="#JOURNAL:@REPLAYING-THE-OUTCOME%20MGL-PAX:SECTION" title="Replaying the outcome">Replaying the outcome</a>).</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">defparameter</span></i> <span class="special">*db*</span> <span class="paren2">(<span class="code">make-hash-table</span>)</span></span>)</span>

<span class="paren1">(<span class="code"><i><span class="symbol">defun</span></i> set-key <span class="paren2">(<span class="code">key value</span>)</span>
  <span class="paren2">(<span class="code">replayed <span class="paren3">(<span class="code"><span class="string">"set-key"</span> <span class="keyword">:args</span> `<span class="paren4">(<span class="code">,key ,value</span>)</span></span>)</span>
    <span class="paren3">(<span class="code">format t <span class="string">"Updating db~%"</span></span>)</span>
    <span class="paren3">(<span class="code">setf <span class="paren4">(<span class="code">gethash key <span class="special">*db*</span></span>)</span> value</span>)</span>
    nil</span>)</span></span>)</span>

<span class="paren1">(<span class="code"><i><span class="symbol">defun</span></i> get-key <span class="paren2">(<span class="code">key</span>)</span>
  <span class="paren2">(<span class="code">replayed <span class="paren3">(<span class="code"><span class="string">"get-key"</span> <span class="keyword">:args</span> `<span class="paren4">(<span class="code">,key</span>)</span></span>)</span>
    <span class="paren3">(<span class="code">format t <span class="string">"Query db~%"</span></span>)</span>
    <span class="paren3">(<span class="code">gethash key <span class="special">*db*</span></span>)</span></span>)</span></span>)</span>

<span class="paren1">(<span class="code"><i><span class="symbol">defun</span></i> ask-username <span class="paren2">(<span class="code"></span>)</span>
  <span class="paren2">(<span class="code">replayed <span class="paren3">(<span class="code"><span class="string">"ask-username"</span></span>)</span>
    <span class="paren3">(<span class="code">format t <span class="string">"Please type your username: "</span></span>)</span>
    <span class="paren3">(<span class="code">read-line</span>)</span></span>)</span></span>)</span>

<span class="paren1">(<span class="code"><i><span class="symbol">defun</span></i> maybe-win-the-grand-prize <span class="paren2">(<span class="code"></span>)</span>
  <span class="paren2">(<span class="code">checked <span class="paren3">(<span class="code"><span class="string">"maybe-win-the-grand-prize"</span></span>)</span>
    <span class="paren3">(<span class="code">when <span class="paren4">(<span class="code">= 1000000 <span class="paren5">(<span class="code">hash-table-count <span class="special">*db*</span></span>)</span></span>)</span>
      <span class="paren4">(<span class="code">format t <span class="string">"You are the lucky one!"</span></span>)</span></span>)</span></span>)</span></span>)</span>

<span class="paren1">(<span class="code"><i><span class="symbol">defun</span></i> register-user <span class="paren2">(<span class="code">username</span>)</span>
  <span class="paren2">(<span class="code">unless <span class="paren3">(<span class="code">get-key username</span>)</span>
    <span class="paren3">(<span class="code">set-key username `<span class="paren4">(<span class="code"><span class="keyword">:user-object</span> <span class="keyword">:username</span> ,username</span>)</span></span>)</span>
    <span class="paren3">(<span class="code">maybe-win-the-grand-prize</span>)</span></span>)</span></span>)</span></span></code></pre>

<p>Now, we write a test that records these interactions in a file when
it's run for the first time.</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">define-file-bundle-test</span></i> <span class="paren2">(<span class="code">test-user-registration
                          <span class="keyword">:directory</span> <span class="paren3">(<span class="code">asdf:system-relative-pathname
                                      <span class="keyword">:journal</span> <span class="string">"test/registration/"</span></span>)</span></span>)</span>
  <span class="paren2">(<span class="code"><i><span class="symbol">let</span></i> <span class="paren3">(<span class="code"><span class="paren4">(<span class="code">username <span class="paren5">(<span class="code">ask-username</span>)</span></span>)</span></span>)</span>
    <span class="paren3">(<span class="code">register-user username</span>)</span>
    <span class="paren3">(<span class="code">assert <span class="paren4">(<span class="code">get-key username</span>)</span></span>)</span>
    <span class="paren3">(<span class="code">register-user username</span>)</span>
    <span class="paren3">(<span class="code">assert <span class="paren4">(<span class="code">get-key username</span>)</span></span>)</span></span>)</span></span>)</span>

<span class="comment">;; Original recording: everything is executed
</span>JRN&gt; <span class="paren1">(<span class="code">test-user-registration</span>)</span>
Please type your username: joe
Query db
Updating db
Query db
Query db
Query db
=&gt; NIL</span></code></pre>

<p>On reruns, none of the external stuff is executed. The return values
of the external <code>journaled</code> blocks are replayed from the journal:</p>

<pre><code><span class="code"><span class="comment">;; Replay: all external interactions are mocked.
</span>JRN&gt; <span class="paren1">(<span class="code">test-user-registration</span>)</span>
=&gt; NIL</span></code></pre>

<p>Should the code change, we might want to upgrade carefully (see
<a href="#JOURNAL:@UPGRADES-AND-REPLAY%20MGL-PAX:SECTION" title="Upgrades and replay">Upgrades and replay</a>) or just rerecord from scratch:</p>

<pre><code><span class="code">JRN&gt; <span class="paren1">(<span class="code">test-user-registration <span class="keyword">:rerecord</span> t</span>)</span>
Please type your username: joe
Query db
Updating db
Query db
Query db
Query db
=&gt; NIL</span></code></pre>

<p>Thus satisfied that our test runs, we can commit the journal file in
the bundle into version control. Its contents are:</p>

<pre><code><span class="code">
<span class="paren1">(<span class="code"><span class="keyword">:IN</span> <span class="string">"ask-username"</span> <span class="keyword">:VERSION</span> <span class="keyword">:INFINITY</span></span>)</span>
<span class="paren1">(<span class="code"><span class="keyword">:OUT</span> <span class="string">"ask-username"</span> <span class="keyword">:VERSION</span> <span class="keyword">:INFINITY</span> <span class="keyword">:VALUES</span> <span class="paren2">(<span class="code"><span class="string">"joe"</span> NIL</span>)</span></span>)</span>
<span class="paren1">(<span class="code"><span class="keyword">:IN</span> <span class="string">"get-key"</span> <span class="keyword">:VERSION</span> <span class="keyword">:INFINITY</span> <span class="keyword">:ARGS</span> <span class="paren2">(<span class="code"><span class="string">"joe"</span></span>)</span></span>)</span>
<span class="paren1">(<span class="code"><span class="keyword">:OUT</span> <span class="string">"get-key"</span> <span class="keyword">:VERSION</span> <span class="keyword">:INFINITY</span> <span class="keyword">:VALUES</span> <span class="paren2">(<span class="code">NIL NIL</span>)</span></span>)</span>
<span class="paren1">(<span class="code"><span class="keyword">:IN</span> <span class="string">"set-key"</span> <span class="keyword">:VERSION</span> <span class="keyword">:INFINITY</span> <span class="keyword">:ARGS</span> <span class="paren2">(<span class="code"><span class="string">"joe"</span> <span class="paren3">(<span class="code"><span class="keyword">:USER-OBJECT</span> <span class="keyword">:USERNAME</span> <span class="string">"joe"</span></span>)</span></span>)</span></span>)</span>
<span class="paren1">(<span class="code"><span class="keyword">:OUT</span> <span class="string">"set-key"</span> <span class="keyword">:VERSION</span> <span class="keyword">:INFINITY</span> <span class="keyword">:VALUES</span> <span class="paren2">(<span class="code">NIL</span>)</span></span>)</span>
<span class="paren1">(<span class="code"><span class="keyword">:IN</span> <span class="string">"maybe-win-the-grand-prize"</span> <span class="keyword">:VERSION</span> 1</span>)</span>
<span class="paren1">(<span class="code"><span class="keyword">:OUT</span> <span class="string">"maybe-win-the-grand-prize"</span> <span class="keyword">:VERSION</span> 1 <span class="keyword">:VALUES</span> <span class="paren2">(<span class="code">NIL</span>)</span></span>)</span>
<span class="paren1">(<span class="code"><span class="keyword">:IN</span> <span class="string">"get-key"</span> <span class="keyword">:VERSION</span> <span class="keyword">:INFINITY</span> <span class="keyword">:ARGS</span> <span class="paren2">(<span class="code"><span class="string">"joe"</span></span>)</span></span>)</span>
<span class="paren1">(<span class="code"><span class="keyword">:OUT</span> <span class="string">"get-key"</span> <span class="keyword">:VERSION</span> <span class="keyword">:INFINITY</span> <span class="keyword">:VALUES</span> <span class="paren2">(<span class="code"><span class="paren3">(<span class="code"><span class="keyword">:USER-OBJECT</span> <span class="keyword">:USERNAME</span> <span class="string">"joe"</span></span>)</span> T</span>)</span></span>)</span>
<span class="paren1">(<span class="code"><span class="keyword">:IN</span> <span class="string">"get-key"</span> <span class="keyword">:VERSION</span> <span class="keyword">:INFINITY</span> <span class="keyword">:ARGS</span> <span class="paren2">(<span class="code"><span class="string">"joe"</span></span>)</span></span>)</span>
<span class="paren1">(<span class="code"><span class="keyword">:OUT</span> <span class="string">"get-key"</span> <span class="keyword">:VERSION</span> <span class="keyword">:INFINITY</span> <span class="keyword">:VALUES</span> <span class="paren2">(<span class="code"><span class="paren3">(<span class="code"><span class="keyword">:USER-OBJECT</span> <span class="keyword">:USERNAME</span> <span class="string">"joe"</span></span>)</span> T</span>)</span></span>)</span>
<span class="paren1">(<span class="code"><span class="keyword">:IN</span> <span class="string">"get-key"</span> <span class="keyword">:VERSION</span> <span class="keyword">:INFINITY</span> <span class="keyword">:ARGS</span> <span class="paren2">(<span class="code"><span class="string">"joe"</span></span>)</span></span>)</span>
<span class="paren1">(<span class="code"><span class="keyword">:OUT</span> <span class="string">"get-key"</span> <span class="keyword">:VERSION</span> <span class="keyword">:INFINITY</span> <span class="keyword">:VALUES</span> <span class="paren2">(<span class="code"><span class="paren3">(<span class="code"><span class="keyword">:USER-OBJECT</span> <span class="keyword">:USERNAME</span> <span class="string">"joe"</span></span>)</span> T</span>)</span></span>)</span></span></code></pre>

<p>Note that when this journal is replayed, new <a href="#JOURNAL:VERSIONED-EVENT%20TYPE" title="JOURNAL:VERSIONED-EVENT TYPE"><code>versioned-event</code></a>s are
required to match the replay. So, after the original recording, we
can check by eyeballing that the record represents a correct
execution. Then on subsequent replays, even though
<code>maybe-win-the-grand-prize</code> sits behind <code>register-user</code> and is hard
to test with <a href="http://www.lispworks.com/documentation/HyperSpec/Body/m_assert.htm" title="ASSERT MGL-PAX:MACRO"><code>assert</code></a>s, the replay mechanism verifies that it is
called only for new users.</p>

<p>This record-and-replay style of testing is not the only possibility:
direct inspection of a journal with the low-level events api (see
<a href="#JOURNAL:@EVENTS-REFERENCE%20MGL-PAX:SECTION" title="Events reference">Events reference</a>) can facilitate checking non-local invariants.</p>

<p><a id="x-28JOURNAL-3ADEFINE-FILE-BUNDLE-TEST-20MGL-PAX-3AMACRO-29"></a>
<a id="JOURNAL:DEFINE-FILE-BUNDLE-TEST%20MGL-PAX:MACRO"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L4484">[macro]</a></span> <span class="reference-object"><a href="#JOURNAL:DEFINE-FILE-BUNDLE-TEST%20MGL-PAX:MACRO" >define-file-bundle-test</a></span></span> <span class="locative-args">(name &amp;key directory (equivalentp t)) &amp;body body</span></span></p>

<p>Define a function with <code>name</code> for record-and-replay testing. The
function's <code>body</code> is executed in a <a href="#JOURNAL:WITH-BUNDLE%20MGL-PAX:MACRO" title="JOURNAL:WITH-BUNDLE MGL-PAX:MACRO"><code>with-bundle</code></a> to guarantee
replayability. The bundle in question is a <a href="#JOURNAL:FILE-BUNDLE%20CLASS" title="JOURNAL:FILE-BUNDLE CLASS"><code>file-bundle</code></a> created in
<code>directory</code>. The function has a single keyword argument, <code>rerecord</code>. If
<code>rerecord</code> is true, the bundle is deleted with <a href="#JOURNAL:DELETE-FILE-BUNDLE%20FUNCTION" title="JOURNAL:DELETE-FILE-BUNDLE FUNCTION"><code>delete-file-bundle</code></a> to
start afresh.</p>

<p>Furthermore, if <code>body</code> returns normally, and it is a replay of a
previous run, and <code>equivalentp</code>, then it is ASSERTed that the record
and replay journals are <a href="#JOURNAL:EQUIVALENT-REPLAY-JOURNALS-P%20GENERIC-FUNCTION" title="JOURNAL:EQUIVALENT-REPLAY-JOURNALS-P GENERIC-FUNCTION"><code>equivalent-replay-journals-p</code></a>. If this check
fails, <a href="#JOURNAL:RECORD-JOURNAL%20FUNCTION" title="JOURNAL:RECORD-JOURNAL FUNCTION"><code>record-journal</code></a> is discarded when the function returns. In
addition to the replay consistency, this checks that no inserts or
upgrades were performed (see <a href="#JOURNAL:@THE-REPLAY-STRATEGY%20MGL-PAX:SECTION" title="The replay strategy">The replay strategy</a>).</p></li>
</ul>

<p><a id="x-28JOURNAL-3A-40TESTING-ON-MULTIPLE-LEVELS-20MGL-PAX-3ASECTION-29"></a>
<a id="JOURNAL:@TESTING-ON-MULTIPLE-LEVELS%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#JOURNAL:@TESTING%20MGL-PAX:SECTION" title="Testing">&#8592;</a> <a href="#JOURNAL:@TESTING%20MGL-PAX:SECTION" title="Testing">&#8593;</a> <a href="#JOURNAL:@PERSISTENCE%20MGL-PAX:SECTION" title="Persistence">&#8594;</a> <a href="#JOURNAL:@TESTING-ON-MULTIPLE-LEVELS%20MGL-PAX:SECTION" title="Testing on multiple levels">&#8634;</a> <a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L4523">&#955;</a></span></span></p>

<h3><a href="#JOURNAL:@TESTING-ON-MULTIPLE-LEVELS%20MGL-PAX:SECTION">10.1 Testing on multiple levels</a></h3>

<p>Nesting <a href="#JOURNAL:REPLAYED%20MGL-PAX:MACRO" title="JOURNAL:REPLAYED MGL-PAX:MACRO"><code>replayed</code></a>s (that is, <a href="#JOURNAL:@FRAME%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@FRAME MGL-PAX:GLOSSARY-TERM">frame</a>s of <a href="#JOURNAL:EXTERNAL-EVENT%20TYPE" title="JOURNAL:EXTERNAL-EVENT TYPE"><code>external-event</code></a>s) is not
obviously useful since the outer <code>replayed</code> will be replayed by
outcome, and the inner one will be just echoed to the record
journal. However, if we turn off <a href="#JOURNAL:@REPLAYING-THE-OUTCOME%20MGL-PAX:SECTION" title="Replaying the outcome">Replaying the outcome</a> for the
outer, the inner will be replayed.</p>

<p>This is useful for testing layered communication. For example, we
might have written code that takes input from an external
system (<a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_rd_lin.htm" title="READ-LINE FUNCTION"><code>read-line</code></a>) and does some complicated
processing (<a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_rd_fro.htm" title="READ-FROM-STRING FUNCTION"><code>read-from-string</code></a>) before returning the input in a form
suitable for further processing. Suppose we wrap <code>replayed</code> around
<code>read-from-string</code> for <a href="#JOURNAL:@PERSISTENCE%20MGL-PAX:SECTION" title="Persistence">Persistence</a> because putting it around
<code>read-line</code> would expose low-level protocol details in the journal,
making protocol changes difficult.</p>

<p>However, upon realizing that <code>read-from-string</code> was not the best tool
for the job and switching to <a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_parse_.htm" title="PARSE-INTEGER FUNCTION"><code>parse-integer</code></a>, we want to test by
replaying all previously recorded journals. For this, we prevent the
outer <code>replayed</code> from being replayed by outcome with
<a href="#JOURNAL:WITH-REPLAY-FILTER%20MGL-PAX:MACRO" title="JOURNAL:WITH-REPLAY-FILTER MGL-PAX:MACRO"><code>with-replay-filter</code></a>:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">let</span></i> <span class="paren2">(<span class="code"><span class="paren3">(<span class="code">bundle <span class="paren4">(<span class="code">make-in-memory-bundle</span>)</span></span>)</span></span>)</span>
  <span class="comment">;; Original with READ-FROM-STRING
</span>  <span class="paren2">(<span class="code"><i><span class="symbol">with-bundle</span></i> <span class="paren3">(<span class="code">bundle</span>)</span>
    <span class="paren3">(<span class="code">replayed <span class="paren4">(<span class="code"><span class="string">"accept-number"</span></span>)</span>
      <span class="paren4">(<span class="code">values <span class="paren5">(<span class="code">read-from-string <span class="paren6">(<span class="code">replayed <span class="paren1">(<span class="code"><span class="string">"input-number"</span></span>)</span>
                                  <span class="paren1">(<span class="code">read-line</span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span>
  <span class="comment">;; Switch to PARSE-INTEGER and test by replay.
</span>  <span class="paren2">(<span class="code"><i><span class="symbol">with-bundle</span></i> <span class="paren3">(<span class="code">bundle</span>)</span>
    <span class="paren3">(<span class="code"><i><span class="symbol">with-replay-filter</span></i> <span class="paren4">(<span class="code"><span class="keyword">:no-replay-outcome</span> '<span class="paren5">(<span class="code"><span class="string">"accept-number"</span></span>)</span></span>)</span>
      <span class="paren4">(<span class="code">replayed <span class="paren5">(<span class="code"><span class="string">"accept-number"</span></span>)</span>
        <span class="comment">;; 1+ is our bug.
</span>        <span class="paren5">(<span class="code">values <span class="paren6">(<span class="code">1+ <span class="paren1">(<span class="code">parse-integer <span class="paren2">(<span class="code">replayed <span class="paren3">(<span class="code"><span class="string">"input-number"</span></span>)</span>
                                     <span class="paren3">(<span class="code">read-line</span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span></code></pre>

<p>The inner <code>input-number</code> block is replayed by outcome, and
<code>parse-integer</code> is called with the string <code>read-line</code> returned in the
original invocation. The outcome of the outer <code>accept-number</code> block
checked as if it was a <a href="#JOURNAL:VERSIONED-EVENT%20TYPE" title="JOURNAL:VERSIONED-EVENT TYPE"><code>versioned-event</code></a> and we get a
<a href="#JOURNAL:REPLAY-OUTCOME-MISMATCH%20CONDITION" title="JOURNAL:REPLAY-OUTCOME-MISMATCH CONDITION"><code>replay-outcome-mismatch</code></a> due to the bug.</p>

<p><a id="x-28JOURNAL-3A-40PERSISTENCE-20MGL-PAX-3ASECTION-29"></a>
<a id="JOURNAL:@PERSISTENCE%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#JOURNAL:@TESTING-ON-MULTIPLE-LEVELS%20MGL-PAX:SECTION" title="Testing on multiple levels">&#8592;</a> <a href="journal-manual.html" title="Journal manual">&#8593;</a> <a href="#JOURNAL:@PERSISTENCE-TUTORIAL%20MGL-PAX:SECTION" title="Persistence tutorial">&#8594;</a> <a href="#JOURNAL:@PERSISTENCE%20MGL-PAX:SECTION" title="Persistence">&#8634;</a> <a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L4569">&#955;</a></span></span></p>

<h2><a href="#JOURNAL:@PERSISTENCE%20MGL-PAX:SECTION">11 Persistence</a></h2>

<p><a id="x-28JOURNAL-3A-40PERSISTENCE-TUTORIAL-20MGL-PAX-3ASECTION-29"></a>
<a id="JOURNAL:@PERSISTENCE-TUTORIAL%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#JOURNAL:@PERSISTENCE%20MGL-PAX:SECTION" title="Persistence">&#8592;</a> <a href="#JOURNAL:@PERSISTENCE%20MGL-PAX:SECTION" title="Persistence">&#8593;</a> <a href="#JOURNAL:@SYNCHRONIZATION%20MGL-PAX:SECTION" title="Synchronization to storage">&#8594;</a> <a href="#JOURNAL:@PERSISTENCE-TUTORIAL%20MGL-PAX:SECTION" title="Persistence tutorial">&#8634;</a> <a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L4573">&#955;</a></span></span></p>

<h3><a href="#JOURNAL:@PERSISTENCE-TUTORIAL%20MGL-PAX:SECTION">11.1 Persistence tutorial</a></h3>

<p>Let's write a simple game.</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">defun</span></i> play-guess-my-number <span class="paren2">(<span class="code"></span>)</span>
  <span class="paren2">(<span class="code"><i><span class="symbol">let</span></i> <span class="paren3">(<span class="code"><span class="paren4">(<span class="code">my-number <span class="paren5">(<span class="code">replayed <span class="paren6">(<span class="code">think-of-a-number</span>)</span>
                     <span class="paren6">(<span class="code">random 10</span>)</span></span>)</span></span>)</span></span>)</span>
    <span class="paren3">(<span class="code">format t <span class="string">"~%I thought of a number.~%"</span></span>)</span>
    <span class="paren3">(<span class="code"><i><span class="symbol">loop</span></i> for i upfrom 0 do
      <span class="paren4">(<span class="code">write-line <span class="string">"Guess my number:"</span></span>)</span>
      <span class="paren4">(<span class="code"><i><span class="symbol">let</span></i> <span class="paren5">(<span class="code"><span class="paren6">(<span class="code">guess <span class="paren1">(<span class="code">replayed <span class="paren2">(<span class="code">read-guess</span>)</span>
                     <span class="paren2">(<span class="code">values <span class="paren3">(<span class="code">parse-integer <span class="paren4">(<span class="code">read-line</span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span>
        <span class="paren5">(<span class="code">format t <span class="string">"You guessed ~D.~%"</span> guess</span>)</span>
        <span class="paren5">(<span class="code">when <span class="paren6">(<span class="code">= guess my-number</span>)</span>
          <span class="paren6">(<span class="code">checked <span class="paren1">(<span class="code">game-won <span class="keyword">:args</span> `<span class="paren2">(<span class="code">,<span class="paren3">(<span class="code">1+ i</span>)</span></span>)</span></span>)</span></span>)</span>
          <span class="paren6">(<span class="code">format t <span class="string">"You guessed it in ~D tries!"</span> <span class="paren1">(<span class="code">1+ i</span>)</span></span>)</span>
          <span class="paren6">(<span class="code">return</span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span>

<span class="paren1">(<span class="code"><i><span class="symbol">defparameter</span></i> <span class="special">*the-evergreen-game*</span> <span class="paren2">(<span class="code">make-in-memory-bundle</span>)</span></span>)</span></span></code></pre>

<h5>Original recording</h5>

<p>Unfortunately, the implementation is lacking in the input validation
department. In the transcript below, <a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_parse_.htm" title="PARSE-INTEGER FUNCTION"><code>parse-integer</code></a> fails with <code>junk
in string</code> when the user enters <code>not a number</code>:</p>

<pre><code><span class="code">CL-USER&gt; <span class="paren1">(<span class="code">handler-case
             <span class="paren2">(<span class="code"><i><span class="symbol">with-bundle</span></i> <span class="paren3">(<span class="code"><span class="special">*the-evergreen-game*</span></span>)</span>
               <span class="paren3">(<span class="code">play-guess-my-number</span>)</span></span>)</span>
           <span class="paren2">(<span class="code">error <span class="paren3">(<span class="code">e</span>)</span>
             <span class="paren3">(<span class="code">format t <span class="string">"Oops. ~A~%"</span> e</span>)</span></span>)</span></span>)</span>
I thought of a number.
Guess my number:
7 <span class="comment">; real user input
</span>You guessed 7.
Guess my number:
not a number <span class="comment">; real user input
</span>Oops. junk in string "not a number"</span></code></pre>

<h5>Replay and extension</h5>

<p>Instead of fixing this bug, we just restart the game from the
beginning, <a href="#JOURNAL:@REPLAYING-THE-OUTCOME%20MGL-PAX:SECTION" title="Replaying the outcome">Replaying the outcome</a> of external interactions marked
with <a href="#JOURNAL:REPLAYED%20MGL-PAX:MACRO" title="JOURNAL:REPLAYED MGL-PAX:MACRO"><code>replayed</code></a>:</p>

<pre><code><span class="code">CL-USER&gt; <span class="paren1">(<span class="code"><i><span class="symbol">with-bundle</span></i> <span class="paren2">(<span class="code"><span class="special">*the-evergreen-game*</span></span>)</span>
           <span class="paren2">(<span class="code">play-guess-my-number</span>)</span></span>)</span>
I thought of a number.
Guess my number:
You guessed 7.
Guess my number: <span class="comment">; New recording starts here
</span>5 <span class="comment">; real user input
</span>You guessed 5.
Guess my number:
4 <span class="comment">; real user input
</span>You guessed 4.
Guess my number:
2 <span class="comment">; real user input
</span>You guessed 2.
You guessed it in 4 tries!</span></code></pre>

<h5>It's evergreen</h5>

<p>We can now replay this game many times without any user interaction:</p>

<pre><code><span class="code">CL-USER&gt; <span class="paren1">(<span class="code"><i><span class="symbol">with-bundle</span></i> <span class="paren2">(<span class="code"><span class="special">*the-evergreen-game*</span></span>)</span>
           <span class="paren2">(<span class="code">play-guess-my-number</span>)</span></span>)</span>
I thought of a number.
Guess my number:
You guessed 7.
Guess my number:
You guessed 5.
Guess my number:
You guessed 4.
Guess my number:
You guessed 2.
You guessed it in 4 tries!</span></code></pre>

<h5>The generated events</h5>

<p>This simple mechanism allows us to isolate external interactions and
write tests in record-and-replay style based on the events produced:</p>

<pre><code><span class="code">CL-USER&gt; <span class="paren1">(<span class="code">list-events <span class="special">*the-evergreen-game*</span></span>)</span>
<span class="paren1">(<span class="code"><span class="paren2">(<span class="code"><span class="keyword">:IN</span> THINK-OF-A-NUMBER <span class="keyword">:VERSION</span> <span class="keyword">:INFINITY</span></span>)</span>
 <span class="paren2">(<span class="code"><span class="keyword">:OUT</span> THINK-OF-A-NUMBER <span class="keyword">:VERSION</span> <span class="keyword">:INFINITY</span> <span class="keyword">:VALUES</span> <span class="paren3">(<span class="code">2</span>)</span></span>)</span>
 <span class="paren2">(<span class="code"><span class="keyword">:IN</span> READ-GUESS <span class="keyword">:VERSION</span> <span class="keyword">:INFINITY</span></span>)</span>
 <span class="paren2">(<span class="code"><span class="keyword">:OUT</span> READ-GUESS <span class="keyword">:VERSION</span> <span class="keyword">:INFINITY</span> <span class="keyword">:VALUES</span> <span class="paren3">(<span class="code">7</span>)</span></span>)</span>
 <span class="paren2">(<span class="code"><span class="keyword">:IN</span> READ-GUESS <span class="keyword">:VERSION</span> <span class="keyword">:INFINITY</span> <span class="keyword">:ARGS</span> NIL</span>)</span>
 <span class="paren2">(<span class="code"><span class="keyword">:OUT</span> READ-GUESS <span class="keyword">:VERSION</span> <span class="keyword">:INFINITY</span> <span class="keyword">:VALUES</span> <span class="paren3">(<span class="code">5</span>)</span></span>)</span>
 <span class="paren2">(<span class="code"><span class="keyword">:IN</span> READ-GUESS <span class="keyword">:VERSION</span> <span class="keyword">:INFINITY</span> <span class="keyword">:ARGS</span> NIL</span>)</span>
 <span class="paren2">(<span class="code"><span class="keyword">:OUT</span> READ-GUESS <span class="keyword">:VERSION</span> <span class="keyword">:INFINITY</span> <span class="keyword">:VALUES</span> <span class="paren3">(<span class="code">4</span>)</span></span>)</span>
 <span class="paren2">(<span class="code"><span class="keyword">:IN</span> READ-GUESS <span class="keyword">:VERSION</span> <span class="keyword">:INFINITY</span> <span class="keyword">:ARGS</span> NIL</span>)</span>
 <span class="paren2">(<span class="code"><span class="keyword">:OUT</span> READ-GUESS <span class="keyword">:VERSION</span> <span class="keyword">:INFINITY</span> <span class="keyword">:VALUES</span> <span class="paren3">(<span class="code">2</span>)</span></span>)</span>
 <span class="paren2">(<span class="code"><span class="keyword">:IN</span> GAME-WON <span class="keyword">:VERSION</span> 1 <span class="keyword">:ARGS</span> <span class="paren3">(<span class="code">4</span>)</span></span>)</span>
 <span class="paren2">(<span class="code"><span class="keyword">:OUT</span> GAME-WON <span class="keyword">:VERSION</span> 1 <span class="keyword">:VALUES</span> <span class="paren3">(<span class="code">NIL</span>)</span></span>)</span></span>)</span></span></code></pre>

<p>In fact, being able to replay this game at all already checks it
through the <code>game-won</code> event that the number of tries calculation is
correct.</p>

<p>In addition, thus being able to reconstruct the internal state of
the program gives us persistence by replay. If instead of a
<a href="#JOURNAL:IN-MEMORY-BUNDLE%20CLASS" title="JOURNAL:IN-MEMORY-BUNDLE CLASS"><code>in-memory-bundle</code></a>, we used a <a href="#JOURNAL:FILE-BUNDLE%20CLASS" title="JOURNAL:FILE-BUNDLE CLASS"><code>file-bundle</code></a>, the game would have been
saved on disk without having to write any code for saving and
loading the game state.</p>

<h5>Discussion</h5>

<p>Persistence by replay, also known as <a href="https://martinfowler.com/eaaDev/EventSourcing.html" >Event
Sourcing</a>, is appropriate when the external
interactions are well-defined and stable. Storing events shines in
comparison to persisting state when the control flow is too
complicated to be interrupted and resumed easily. Resuming execution
in deeply nested function calls is fraught with such peril that it
is often easier to flatten the program into a state machine, which
is as pleasant as manually managing <a href="https://en.wikipedia.org/wiki/Continuation" >continuations</a>.</p>

<p>In contrast, the Journal library does not favour certain styles of
control flow and only requires that non-determinism is packaged up
in <code>replayed</code>, which allows it to reconstruct the state of the program
from the recorded events at any point during its execution and
resume from there.</p>

<p><a id="x-28JOURNAL-3A-40SYNCHRONIZATION-20MGL-PAX-3ASECTION-29"></a>
<a id="JOURNAL:@SYNCHRONIZATION%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#JOURNAL:@PERSISTENCE-TUTORIAL%20MGL-PAX:SECTION" title="Persistence tutorial">&#8592;</a> <a href="#JOURNAL:@PERSISTENCE%20MGL-PAX:SECTION" title="Persistence">&#8593;</a> <a href="#JOURNAL:@SYNCHRONIZATION-STRATEGIES%20MGL-PAX:SECTION" title="Synchronization strategies">&#8594;</a> <a href="#JOURNAL:@SYNCHRONIZATION%20MGL-PAX:SECTION" title="Synchronization to storage">&#8634;</a> <a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L4709">&#955;</a></span></span></p>

<h3><a href="#JOURNAL:@SYNCHRONIZATION%20MGL-PAX:SECTION">11.2 Synchronization to storage</a></h3>

<p>In the following, we explore how journals can serve as a
persistence mechanism and the guarantees they offer. The high-level
summary is that journals with <code>sync</code> can serve as a durable and
consistent storage medium. The other two
<a href="https://en.wikipedia.org/wiki/ACID" >ACID</a> properties, atomicity and
isolation, do not apply because Journal is single-client and does
not need transactions.</p>

<p><a id="x-28JOURNAL-3A-40ABORTED-EXECUTION-20MGL-PAX-3AGLOSSARY-TERM-29"></a>
<a id="JOURNAL:@ABORTED-EXECUTION%20MGL-PAX:GLOSSARY-TERM"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L4723">[glossary-term]</a></span> <span class="reference-object"><a href="#JOURNAL:@ABORTED-EXECUTION%20MGL-PAX:GLOSSARY-TERM" >aborted execution</a></span></span></span></p>

<p>Aborted execution is when the operating system or the application
crashes, calls <code>abort()</code>, is killed by a <code>sigkill</code> signal or there
is a power outage. Synchronization guarantees are defined in the
face of aborted execution and do not apply to hardware errors, Lisp
or OS bugs.</p></li>
</ul>

<p><a id="x-28JOURNAL-3A-40DATA-EVENT-20MGL-PAX-3AGLOSSARY-TERM-29"></a>
<a id="JOURNAL:@DATA-EVENT%20MGL-PAX:GLOSSARY-TERM"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L4730">[glossary-term]</a></span> <span class="reference-object"><a href="#JOURNAL:@DATA-EVENT%20MGL-PAX:GLOSSARY-TERM" >data event</a></span></span></span></p>

<p>Data events are the only events that may be non-deterministic. They
record information that could change if the same code were run
multiple times. Data events typically correspond to interactions
with the user, servers or even the random number generator. Due to
their non-determinism, they are the only parts of the journal not
reproducible by rerunning the code. In this sense, only the data
events are not redundant with the code, and whether other events are
persisted does not affect durability. There are two kinds of data
events:</p>

<ul>
<li><p>An <a href="#JOURNAL:EXTERNAL-EVENT%20TYPE" title="JOURNAL:EXTERNAL-EVENT TYPE"><code>external-event</code></a> that is also an <a href="#JOURNAL:OUT-EVENT%20TYPE" title="JOURNAL:OUT-EVENT TYPE"><code>out-event</code></a>.</p></li>
<li><p>The <a href="#JOURNAL:IN-EVENT%20TYPE" title="JOURNAL:IN-EVENT TYPE"><code>in-event</code></a> of an <a href="#JOURNAL:@INVOKED%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@INVOKED MGL-PAX:GLOSSARY-TERM">invoked</a> function, which lies outside the
  normal, deterministic control flow.</p></li>
</ul></li>
</ul>

<p><a id="x-28JOURNAL-3A-40SYNCHRONIZATION-STRATEGIES-20MGL-PAX-3ASECTION-29"></a>
<a id="JOURNAL:@SYNCHRONIZATION-STRATEGIES%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#JOURNAL:@SYNCHRONIZATION%20MGL-PAX:SECTION" title="Synchronization to storage">&#8592;</a> <a href="#JOURNAL:@SYNCHRONIZATION%20MGL-PAX:SECTION" title="Synchronization to storage">&#8593;</a> <a href="#JOURNAL:@SYNCHRONIZATION-WITH-IN-MEMORY-JOURNALS%20MGL-PAX:SECTION" title="Synchronization with in-memory journals">&#8594;</a> <a href="#JOURNAL:@SYNCHRONIZATION-STRATEGIES%20MGL-PAX:SECTION" title="Synchronization strategies">&#8634;</a> <a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L4763">&#955;</a></span></span></p>

<h4><a href="#JOURNAL:@SYNCHRONIZATION-STRATEGIES%20MGL-PAX:SECTION">11.2.1 Synchronization strategies</a></h4>

<p>When a journal or bundle is created (see <a href="#JOURNAL:MAKE-IN-MEMORY-JOURNAL%20FUNCTION" title="JOURNAL:MAKE-IN-MEMORY-JOURNAL FUNCTION"><code>make-in-memory-journal</code></a>,
<a href="#JOURNAL:MAKE-FILE-JOURNAL%20FUNCTION" title="JOURNAL:MAKE-FILE-JOURNAL FUNCTION"><code>make-file-journal</code></a>, <a href="#JOURNAL:MAKE-IN-MEMORY-BUNDLE%20FUNCTION" title="JOURNAL:MAKE-IN-MEMORY-BUNDLE FUNCTION"><code>make-in-memory-bundle</code></a>, <a href="#JOURNAL:MAKE-FILE-BUNDLE%20FUNCTION" title="JOURNAL:MAKE-FILE-BUNDLE FUNCTION"><code>make-file-bundle</code></a>), the
<code>sync</code> option determines when â as a <a href="#JOURNAL:RECORD-JOURNAL%20FUNCTION" title="JOURNAL:RECORD-JOURNAL FUNCTION"><code>record-journal</code></a> â the recorded
events and <a href="#JOURNAL:JOURNAL-STATE%20TYPE" title="JOURNAL:JOURNAL-STATE TYPE"><code>journal-state</code></a> changes are persisted durably. For
<a href="#JOURNAL:FILE-JOURNAL%20CLASS" title="JOURNAL:FILE-JOURNAL CLASS"><code>file-journal</code></a>s, persisting means calling something like <code>fsync</code>,
while for <a href="#JOURNAL:IN-MEMORY-JOURNAL%20CLASS" title="JOURNAL:IN-MEMORY-JOURNAL CLASS"><code>in-memory-journal</code></a>s, a user defined function is called to
persist the data.</p>

<ul>
<li><p><code>nil</code>: Never synchronize. A <code>file-journal</code>'s file may be corrupted on
  <a href="#JOURNAL:@ABORTED-EXECUTION%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@ABORTED-EXECUTION MGL-PAX:GLOSSARY-TERM">aborted execution</a>. In <code>in-memory-journal</code>s, <code>sync-fn</code> is never
  called.</p></li>
<li><p><code>t</code>: This is the <em>no data loss</em> setting with minimal
  synchronization. It guarantees <em>consistency</em> (i.e. no corruption)
  and <em>durability</em> up to the most recent <a href="#JOURNAL:@DATA-EVENT%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@DATA-EVENT MGL-PAX:GLOSSARY-TERM">data event</a> written in
  <code>journal-state</code> <code>:recording</code> or for the entire record journal in
  states <code>:failed</code> and <code>:completed</code>. <code>:failed</code> or <code>:completed</code> is guaranteed
  when leaving <a href="#JOURNAL:WITH-JOURNALING%20MGL-PAX:MACRO" title="JOURNAL:WITH-JOURNALING MGL-PAX:MACRO"><code>with-journaling</code></a> at the latest.</p></li>
<li><p>Values other than <code>nil</code> and <code>t</code> are reserved for future extensions.
  Using them triggers a <a href="#JOURNAL:JOURNAL-ERROR%20CONDITION" title="JOURNAL:JOURNAL-ERROR CONDITION"><code>journal-error</code></a>.</p></li>
</ul>

<p><a id="x-28JOURNAL-3A-40SYNCHRONIZATION-WITH-IN-MEMORY-JOURNALS-20MGL-PAX-3ASECTION-29"></a>
<a id="JOURNAL:@SYNCHRONIZATION-WITH-IN-MEMORY-JOURNALS%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#JOURNAL:@SYNCHRONIZATION-STRATEGIES%20MGL-PAX:SECTION" title="Synchronization strategies">&#8592;</a> <a href="#JOURNAL:@SYNCHRONIZATION%20MGL-PAX:SECTION" title="Synchronization to storage">&#8593;</a> <a href="#JOURNAL:@SYNCHRONIZATION-WITH-FILE-JOURNALS%20MGL-PAX:SECTION" title="Synchronization with file journals">&#8594;</a> <a href="#JOURNAL:@SYNCHRONIZATION-WITH-IN-MEMORY-JOURNALS%20MGL-PAX:SECTION" title="Synchronization with in-memory journals">&#8634;</a> <a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L4827">&#955;</a></span></span></p>

<h4><a href="#JOURNAL:@SYNCHRONIZATION-WITH-IN-MEMORY-JOURNALS%20MGL-PAX:SECTION">11.2.2 Synchronization with in-memory journals</a></h4>

<p>Unlike <a href="#JOURNAL:FILE-JOURNAL%20CLASS" title="JOURNAL:FILE-JOURNAL CLASS"><code>file-journal</code></a>s, <a href="#JOURNAL:IN-MEMORY-JOURNAL%20CLASS" title="JOURNAL:IN-MEMORY-JOURNAL CLASS"><code>in-memory-journal</code></a>s do not have any built-in
persistent storage backing them, but with <code>sync-fn</code>, persistence can
be tacked on. If non-NIL, <code>sync-fn</code> must be a function of a single
argument, an <code>in-memory-journal</code>. <code>sync-fn</code> is called according to
<a href="#JOURNAL:@SYNCHRONIZATION-STRATEGIES%20MGL-PAX:SECTION" title="Synchronization strategies">Synchronization strategies</a>, and upon normal return the journal must
be stored durably.</p>

<p>The following example saves the entire journal history when a new
<a href="#JOURNAL:@DATA-EVENT%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@DATA-EVENT MGL-PAX:GLOSSARY-TERM">data event</a> is recorded. Note how <code>sync-to-db</code> is careful to
overwrite <code>*db*</code> only if it is called with a journal that has not
failed the replay (as in <a href="#JOURNAL:@REPLAY-FAILURES%20MGL-PAX:SECTION" title="Replay failures">Replay failures</a>) and is sufficiently
different from the replay journal as determined by
<a href="#JOURNAL:JOURNAL-DIVERGENT-P%20FUNCTION" title="JOURNAL:JOURNAL-DIVERGENT-P FUNCTION"><code>journal-divergent-p</code></a>.</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">defparameter</span></i> <span class="special">*db*</span> <span class="paren2">(<span class="code"></span>)</span></span>)</span>

<span class="paren1">(<span class="code"><i><span class="symbol">defun</span></i> sync-to-db <span class="paren2">(<span class="code">journal</span>)</span>
  <span class="paren2">(<span class="code">when <span class="paren3">(<span class="code">and <span class="paren4">(<span class="code">member <span class="paren5">(<span class="code">journal-state journal</span>)</span>
                     '<span class="paren5">(<span class="code"><span class="keyword">:recording</span> <span class="keyword">:logging</span> <span class="keyword">:completed</span></span>)</span></span>)</span>
             <span class="paren4">(<span class="code">journal-divergent-p journal</span>)</span></span>)</span>
    <span class="paren3">(<span class="code"><i><span class="symbol">setq</span></i> <span class="special">*db*</span> <span class="paren4">(<span class="code">journal-events journal</span>)</span></span>)</span>
    <span class="paren3">(<span class="code">format t <span class="string">"Saved ~S~%New events from position ~S~%"</span> <span class="special">*db*</span>
            <span class="paren4">(<span class="code">journal-previous-sync-position journal</span>)</span></span>)</span></span>)</span></span>)</span>

<span class="paren1">(<span class="code"><i><span class="symbol">defun</span></i> make-db-backed-record-journal <span class="paren2">(<span class="code"></span>)</span>
  <span class="paren2">(<span class="code">make-in-memory-journal <span class="keyword">:sync-fn</span> 'sync-to-db</span>)</span></span>)</span>

<span class="paren1">(<span class="code"><i><span class="symbol">defun</span></i> make-db-backed-replay-journal <span class="paren2">(<span class="code"></span>)</span>
  <span class="paren2">(<span class="code">make-in-memory-journal <span class="keyword">:events</span> <span class="special">*db*</span></span>)</span></span>)</span>

<span class="paren1">(<span class="code"><i><span class="symbol">with-journaling</span></i> <span class="paren2">(<span class="code"><span class="keyword">:record</span> <span class="paren3">(<span class="code">make-db-backed-record-journal</span>)</span>
                  <span class="keyword">:replay</span> <span class="paren3">(<span class="code">make-db-backed-replay-journal</span>)</span></span>)</span>
  <span class="paren2">(<span class="code">replayed <span class="paren3">(<span class="code">a</span>)</span>
    2</span>)</span>
  <span class="paren2">(<span class="code">ignore-errors
    <span class="paren3">(<span class="code">replayed <span class="paren4">(<span class="code">b</span>)</span>
      <span class="paren4">(<span class="code">error <span class="string">"Whoops"</span></span>)</span></span>)</span></span>)</span></span>)</span>
.. Saved #<span class="paren1">(<span class="code"><span class="paren2">(<span class="code"><span class="keyword">:IN</span> A <span class="keyword">:VERSION</span> <span class="keyword">:INFINITY</span></span>)</span>
..         <span class="paren2">(<span class="code"><span class="keyword">:OUT</span> A <span class="keyword">:VERSION</span> <span class="keyword">:INFINITY</span> <span class="keyword">:VALUES</span> <span class="paren3">(<span class="code">2</span>)</span></span>)</span></span>)</span>
.. New events from position 0
.. Saved #<span class="paren1">(<span class="code"><span class="paren2">(<span class="code"><span class="keyword">:IN</span> A <span class="keyword">:VERSION</span> <span class="keyword">:INFINITY</span></span>)</span>
..         <span class="paren2">(<span class="code"><span class="keyword">:OUT</span> A <span class="keyword">:VERSION</span> <span class="keyword">:INFINITY</span> <span class="keyword">:VALUES</span> <span class="paren3">(<span class="code">2</span>)</span></span>)</span>
..         <span class="paren2">(<span class="code"><span class="keyword">:IN</span> B <span class="keyword">:VERSION</span> <span class="keyword">:INFINITY</span></span>)</span>
..         <span class="paren2">(<span class="code"><span class="keyword">:OUT</span> B <span class="keyword">:ERROR</span> <span class="paren3">(<span class="code"><span class="string">"SIMPLE-ERROR"</span> <span class="string">"Whoops"</span></span>)</span></span>)</span></span>)</span>
.. New events from position 2
..</span></code></pre>

<p>In a real application, external events often involve unreliable or
high-latency communication. In the above example, block <code>b</code> signals
an error, say, to simulate some kind of network condition. Now, a
new journal <em>for replay</em> is created and initialized with the saved
events, and the whole process is restarted.</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">defun</span></i> run-with-db <span class="paren2">(<span class="code"></span>)</span>
  <span class="paren2">(<span class="code"><i><span class="symbol">with-journaling</span></i> <span class="paren3">(<span class="code"><span class="keyword">:record</span> <span class="paren4">(<span class="code">make-db-backed-record-journal</span>)</span>
                    <span class="keyword">:replay</span> <span class="paren4">(<span class="code">make-db-backed-replay-journal</span>)</span></span>)</span>
    <span class="paren3">(<span class="code">replayed <span class="paren4">(<span class="code">a</span>)</span>
      <span class="paren4">(<span class="code">format t <span class="string">"A~%"</span></span>)</span>
      2</span>)</span>
    <span class="paren3">(<span class="code">replayed <span class="paren4">(<span class="code">b</span>)</span>
      <span class="paren4">(<span class="code">format t <span class="string">"B~%"</span></span>)</span>
      3</span>)</span></span>)</span></span>)</span>

<span class="paren1">(<span class="code">run-with-db</span>)</span>
.. B
.. Saved #<span class="paren1">(<span class="code"><span class="paren2">(<span class="code"><span class="keyword">:IN</span> A <span class="keyword">:VERSION</span> <span class="keyword">:INFINITY</span></span>)</span>
..         <span class="paren2">(<span class="code"><span class="keyword">:OUT</span> A <span class="keyword">:VERSION</span> <span class="keyword">:INFINITY</span> <span class="keyword">:VALUES</span> <span class="paren3">(<span class="code">2</span>)</span></span>)</span>
..         <span class="paren2">(<span class="code"><span class="keyword">:IN</span> B <span class="keyword">:VERSION</span> <span class="keyword">:INFINITY</span></span>)</span>
..         <span class="paren2">(<span class="code"><span class="keyword">:OUT</span> B <span class="keyword">:VERSION</span> <span class="keyword">:INFINITY</span> <span class="keyword">:VALUES</span> <span class="paren3">(<span class="code">3</span>)</span></span>)</span></span>)</span>
.. New events from position 0
..
=&gt; 3</span></code></pre>

<p>Note that on the rerun, block <code>a</code> is not executed because external
events are replayed simply by reproducing their outcome, in this
case returning 2. See <a href="#JOURNAL:@REPLAYING-THE-OUTCOME%20MGL-PAX:SECTION" title="Replaying the outcome">Replaying the outcome</a>. Block <code>b</code>, on the
other hand, was rerun because it had an <a href="#JOURNAL:@UNEXPECTED-OUTCOME%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@UNEXPECTED-OUTCOME MGL-PAX:GLOSSARY-TERM">unexpected outcome</a> the
first time around. This time it ran without error, a <a href="#JOURNAL:@DATA-EVENT%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@DATA-EVENT MGL-PAX:GLOSSARY-TERM">data event</a> was
triggered, and <code>sync-fn</code> was invoked.</p>

<p>If we were to invoke the now completed <code>run-with-db</code> again, it would
simply return 3 without ever invoking <code>sync-fn</code>:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code">run-with-db</span>)</span>
=&gt; 3</span></code></pre>

<p>With <a href="#JOURNAL:JOURNAL-REPLAY-MISMATCH%20%28MGL-PAX:READER%20JOURNAL:JOURNAL%29" title="JOURNAL:JOURNAL-REPLAY-MISMATCH (MGL-PAX:READER JOURNAL:JOURNAL)"><code>journal-replay-mismatch</code></a>, <code>sync-fn</code> can be optimized to to reuse
the sequence of events in the replay journal up until the point of
divergence.</p>

<p><a id="x-28JOURNAL-3A-40SYNCHRONIZATION-WITH-FILE-JOURNALS-20MGL-PAX-3ASECTION-29"></a>
<a id="JOURNAL:@SYNCHRONIZATION-WITH-FILE-JOURNALS%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#JOURNAL:@SYNCHRONIZATION-WITH-IN-MEMORY-JOURNALS%20MGL-PAX:SECTION" title="Synchronization with in-memory journals">&#8592;</a> <a href="#JOURNAL:@SYNCHRONIZATION%20MGL-PAX:SECTION" title="Synchronization to storage">&#8593;</a> <a href="#JOURNAL:@SAFETY%20MGL-PAX:SECTION" title="Safety">&#8594;</a> <a href="#JOURNAL:@SYNCHRONIZATION-WITH-FILE-JOURNALS%20MGL-PAX:SECTION" title="Synchronization with file journals">&#8634;</a> <a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L5311">&#955;</a></span></span></p>

<h4><a href="#JOURNAL:@SYNCHRONIZATION-WITH-FILE-JOURNALS%20MGL-PAX:SECTION">11.2.3 Synchronization with file journals</a></h4>

<p>For <a href="#JOURNAL:FILE-JOURNAL%20CLASS" title="JOURNAL:FILE-JOURNAL CLASS"><code>file-journal</code></a>s, <code>sync</code> determines when the events written to the
<a href="#JOURNAL:RECORD-JOURNAL%20FUNCTION" title="JOURNAL:RECORD-JOURNAL FUNCTION"><code>record-journal</code></a> and its <a href="#JOURNAL:JOURNAL-STATE%20TYPE" title="JOURNAL:JOURNAL-STATE TYPE"><code>journal-state</code></a> will be persisted durably in
the file. Syncing to the file involves two calls to <code>fsync</code> and is
not cheap.</p>

<p>Syncing events to files is implemented as follows.</p>

<ul>
<li><p>When the journal file is created, its parent directory is
  immediately fsynced to make sure that the file will not be lost on
  <a href="#JOURNAL:@ABORTED-EXECUTION%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@ABORTED-EXECUTION MGL-PAX:GLOSSARY-TERM">aborted execution</a>.</p></li>
<li><p>When an event is about to be written the first time after file
  creation or after a sync, a transaction start marker is written to
  the file.</p></li>
<li><p>Any number of events may be subsequently written until syncing is
  deemed necessary (see <a href="#JOURNAL:@SYNCHRONIZATION-STRATEGIES%20MGL-PAX:SECTION" title="Synchronization strategies">Synchronization strategies</a>).</p></li>
<li><p>At this point, <code>fsync</code> is called to flush all event data and state
  changes to the file, and the transaction start marker is
  <em>overwritten</em> with a transaction completed marker and another
  <code>fsync</code> is performed.</p></li>
<li><p>When reading back this file (e.g. for replay), an open transaction
  marker is treated as the end of file.</p></li>
</ul>

<p>Note that this implementation assumes that after writing the start
transaction marker, a crash cannot leave any kind of garbage bytes
around: it must leave zeros. This is not true for all filesytems.
For example, ext3/ext4 with <code>data=writeback</code> <a href="https://ext4.wiki.kernel.org/index.php/Ext3_Data=Ordered_vs_Data=Writeback_mode" >can leave garbage
around</a>.</p>

<p><a id="x-28JOURNAL-3A-40SAFETY-20MGL-PAX-3ASECTION-29"></a>
<a id="JOURNAL:@SAFETY%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#JOURNAL:@SYNCHRONIZATION-WITH-FILE-JOURNALS%20MGL-PAX:SECTION" title="Synchronization with file journals">&#8592;</a> <a href="journal-manual.html" title="Journal manual">&#8593;</a> <a href="#JOURNAL:@EVENTS-REFERENCE%20MGL-PAX:SECTION" title="Events reference">&#8594;</a> <a href="#JOURNAL:@SAFETY%20MGL-PAX:SECTION" title="Safety">&#8634;</a> <a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L5500">&#955;</a></span></span></p>

<h2><a href="#JOURNAL:@SAFETY%20MGL-PAX:SECTION">12 Safety</a></h2>

<h5>Thread safety</h5>

<p>Changes to journals come in two varieties: adding an event and
changing the <a href="#JOURNAL:JOURNAL-STATE%20TYPE" title="JOURNAL:JOURNAL-STATE TYPE"><code>journal-state</code></a>. Both are performed by <a href="#JOURNAL:JOURNALED%20MGL-PAX:MACRO" title="JOURNAL:JOURNALED MGL-PAX:MACRO"><code>journaled</code></a> only
unless the low-level streamlet interface is used (see
<a href="#JOURNAL:@STREAMLETS-REFERENCE%20MGL-PAX:SECTION" title="Streamlets reference">Streamlets reference</a>). Using <code>journaled</code> wrapped in a
<a href="#JOURNAL:WITH-JOURNALING%20MGL-PAX:MACRO" title="JOURNAL:WITH-JOURNALING MGL-PAX:MACRO"><code>with-journaling</code></a>, <a href="#JOURNAL:WITH-BUNDLE%20MGL-PAX:MACRO" title="JOURNAL:WITH-BUNDLE MGL-PAX:MACRO"><code>with-bundle</code></a>, or <a href="#JOURNAL:@LOG-RECORD%20MGL-PAX:SECTION" title="`:log-record`"><code>:log-record</code></a> without <code>with-journaling</code>
is thread-safe.</p>

<ul>
<li><p>Every journal is guaranteed to have at most a single writer active
  at any time. Writers are mainly <code>with-journaling</code> and <code>with-bundle</code>,
  but any journals directly logged to have a log writer stored in
  the journal object. See <a href="#JOURNAL:@LOGGING%20MGL-PAX:SECTION" title="Logging">Logging</a>.</p></li>
<li><p><code>with-journaling</code> and <code>with-bundle</code> have dynamic extent as writers,
  but log writers of journals have indefinite extent: once a journal
  is used as a <code>log-record</code>, there remains a writer.</p></li>
<li><p>Attempting to create a second writer triggers a <a href="#JOURNAL:JOURNAL-ERROR%20CONDITION" title="JOURNAL:JOURNAL-ERROR CONDITION"><code>journal-error</code></a>.</p></li>
<li><p>Writing to the same journal via <a href="#JOURNAL:@LOG-RECORD%20MGL-PAX:SECTION" title="`:log-record`"><code>:log-record</code></a> from multiple threads
  concurrently is possible since this doesn't create multiple
  writers. It is ensured with locking that events are written
  atomically. Frames can be interleaved, but these are <a href="#JOURNAL:LOG-EVENT%20TYPE" title="JOURNAL:LOG-EVENT TYPE"><code>log-event</code></a>s,
  so this does not affect replay.</p></li>
<li><p>The juggling of replay and record journals performed by
  <code>with-bundle</code> is also thread-safe.</p></li>
<li><p>It is ensured that there is at most one <a href="#JOURNAL:FILE-JOURNAL%20CLASS" title="JOURNAL:FILE-JOURNAL CLASS"><code>file-journal</code></a> object in the
  same Lisp image is backed by the same file.</p></li>
<li><p>Similarly, there is at most <a href="#JOURNAL:FILE-BUNDLE%20CLASS" title="JOURNAL:FILE-BUNDLE CLASS"><code>file-bundle</code></a> object for a directory.</p></li>
</ul>

<h5>Process safety</h5>

<p>Currently, there is no protection against multiple OS processes
writing the same <code>file-journal</code> or <code>file-bundle</code>.</p>

<h5>Signal safety</h5>

<p>Journal is <em>designed</em> to be <a href="#JOURNAL:@ASYNC-UNWIND%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@ASYNC-UNWIND MGL-PAX:GLOSSARY-TERM">async-unwind</a> safe but <em>not reentrant</em>.
Interrupts are disabled only for the most critical cleanup forms. If
a thread is killed without unwinding, that constitutes
<a href="#JOURNAL:@ABORTED-EXECUTION%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@ABORTED-EXECUTION MGL-PAX:GLOSSARY-TERM">aborted execution</a>, so guarantees about <a href="#JOURNAL:@SYNCHRONIZATION%20MGL-PAX:SECTION" title="Synchronization to storage">Synchronization to storage</a> apply, but
<a href="#JOURNAL:JOURNAL%20CLASS" title="JOURNAL:JOURNAL CLASS"><code>journal</code></a> objects written by the thread are not safe to access, and
the Lisp should probably be restarted.</p>

<p><a id="x-28JOURNAL-3A-40EVENTS-REFERENCE-20MGL-PAX-3ASECTION-29"></a>
<a id="JOURNAL:@EVENTS-REFERENCE%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#JOURNAL:@SAFETY%20MGL-PAX:SECTION" title="Safety">&#8592;</a> <a href="journal-manual.html" title="Journal manual">&#8593;</a> <a href="#JOURNAL:@EVENT-VERSIONS%20MGL-PAX:SECTION" title="Event versions">&#8594;</a> <a href="#JOURNAL:@EVENTS-REFERENCE%20MGL-PAX:SECTION" title="Events reference">&#8634;</a> <a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L169">&#955;</a></span></span></p>

<h2><a href="#JOURNAL:@EVENTS-REFERENCE%20MGL-PAX:SECTION">13 Events reference</a></h2>

<p>Events are normally triggered upon entering and leaving the
dynamic extent of a <a href="#JOURNAL:JOURNALED%20MGL-PAX:MACRO" title="JOURNAL:JOURNALED MGL-PAX:MACRO"><code>journaled</code></a> <a href="#JOURNAL:@BLOCK%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@BLOCK MGL-PAX:GLOSSARY-TERM">block</a> (see <a href="#JOURNAL:@IN-EVENTS%20MGL-PAX:SECTION" title="In-events">In-events</a> and
<a href="#JOURNAL:@OUT-EVENTS%20MGL-PAX:SECTION" title="Out-events">Out-events</a>) and also by <a href="#JOURNAL:LOGGED%20MGL-PAX:MACRO" title="JOURNAL:LOGGED MGL-PAX:MACRO"><code>logged</code></a>. Apart from being part of the
low-level substrate of the Journal library, working with events
directly is sometimes useful when writing tests that inspect
recorded events. Otherwise, skip this entire section.</p>

<p>All <a href="#JOURNAL:EVENT%20TYPE" title="JOURNAL:EVENT TYPE"><code>event</code></a>s have <a href="#JOURNAL:EVENT-NAME%20FUNCTION" title="JOURNAL:EVENT-NAME FUNCTION"><code>event-name</code></a> and <code>event-version</code>(<a href="#JOURNAL:EVENT-VERSION%20FUNCTION" title="JOURNAL:EVENT-VERSION FUNCTION"><code>0</code></a> <a href="#JOURNAL:EVENT-VERSION%20TYPE" title="JOURNAL:EVENT-VERSION TYPE"><code>1</code></a>), which feature
prominently in <a href="#JOURNAL:@THE-REPLAY-STRATEGY%20MGL-PAX:SECTION" title="The replay strategy">The replay strategy</a>. After the examples in
<a href="#JOURNAL:@IN-EVENTS%20MGL-PAX:SECTION" title="In-events">In-events</a> and <a href="#JOURNAL:@OUT-EVENTS%20MGL-PAX:SECTION" title="Out-events">Out-events</a>, the following example is a reminder of
how events look in the simplest case.</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">with-journaling</span></i> <span class="paren2">(<span class="code"><span class="keyword">:record</span> t</span>)</span>
  <span class="paren2">(<span class="code">journaled <span class="paren3">(<span class="code">foo <span class="keyword">:version</span> 1 <span class="keyword">:args</span> '<span class="paren4">(<span class="code">1 2</span>)</span></span>)</span>
    <span class="paren3">(<span class="code">+ 1 2</span>)</span></span>)</span>
  <span class="paren2">(<span class="code">logged <span class="paren3">(<span class="code"></span>)</span> <span class="string">"Oops"</span></span>)</span>
  <span class="paren2">(<span class="code">list-events</span>)</span></span>)</span>
=&gt; <span class="paren1">(<span class="code"><span class="paren2">(<span class="code"><span class="keyword">:IN</span> FOO <span class="keyword">:VERSION</span> 1 <span class="keyword">:ARGS</span> <span class="paren3">(<span class="code">1 2</span>)</span></span>)</span>
    <span class="paren2">(<span class="code"><span class="keyword">:OUT</span> FOO <span class="keyword">:VERSION</span> 1 <span class="keyword">:VALUES</span> <span class="paren3">(<span class="code">3</span>)</span></span>)</span>
    <span class="paren2">(<span class="code"><span class="keyword">:LEAF</span> <span class="string">"Oops"</span></span>)</span></span>)</span></span></code></pre>

<p>So, a <code>journaled</code> <a href="#JOURNAL:@BLOCK%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@BLOCK MGL-PAX:GLOSSARY-TERM">block</a> generates an <a href="#JOURNAL:IN-EVENT%20TYPE" title="JOURNAL:IN-EVENT TYPE"><code>in-event</code></a> and an <a href="#JOURNAL:OUT-EVENT%20TYPE" title="JOURNAL:OUT-EVENT TYPE"><code>out-event</code></a>, which
are simple property lists. The following reference lists these
properties, their semantics and the functions to read them.</p>

<p><a id="x-28JOURNAL-3AEVENT-20TYPE-29"></a>
<a id="JOURNAL:EVENT%20TYPE"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L204">[type]</a></span> <span class="reference-object"><a href="#JOURNAL:EVENT%20TYPE" >event</a></span></span></span></p>

<p>An event is either an <a href="#JOURNAL:IN-EVENT%20TYPE" title="JOURNAL:IN-EVENT TYPE"><code>in-event</code></a>, an <a href="#JOURNAL:OUT-EVENT%20TYPE" title="JOURNAL:OUT-EVENT TYPE"><code>out-event</code></a> or a <a href="#JOURNAL:LEAF-EVENT%20TYPE" title="JOURNAL:LEAF-EVENT TYPE"><code>leaf-event</code></a>.</p></li>
</ul>

<p><a id="x-28JOURNAL-3AEVENT-3D-20FUNCTION-29"></a>
<a id="JOURNAL:EVENT%3D%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L423">[function]</a></span> <span class="reference-object"><a href="#JOURNAL:EVENT%3D%20FUNCTION" >event=</a></span></span> <span class="locative-args">event-1 event-2</span></span></p>

<p>Return whether <code>event-1</code> and <code>event-2</code> represent the same event.
In- and out-events belonging to the same <a href="#JOURNAL:@FRAME%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@FRAME MGL-PAX:GLOSSARY-TERM">frame</a> are <em>not</em> the same
event. <a href="#JOURNAL:EVENT-OUTCOME%20FUNCTION" title="JOURNAL:EVENT-OUTCOME FUNCTION"><code>event-outcome</code></a>s are not compared when <code>event-exit</code>(<a href="#JOURNAL:EVENT-EXIT%20FUNCTION" title="JOURNAL:EVENT-EXIT FUNCTION"><code>0</code></a> <a href="#JOURNAL:EVENT-EXIT%20TYPE" title="JOURNAL:EVENT-EXIT TYPE"><code>1</code></a>) is <code>:error</code> to
avoid undue dependence on implementation specific string
representations. This function is useful in conjunction with
<a href="#JOURNAL:MAKE-IN-EVENT%20FUNCTION" title="JOURNAL:MAKE-IN-EVENT FUNCTION"><code>make-in-event</code></a> and <a href="#JOURNAL:MAKE-OUT-EVENT%20FUNCTION" title="JOURNAL:MAKE-OUT-EVENT FUNCTION"><code>make-out-event</code></a> to write tests.</p></li>
</ul>

<p><a id="x-28JOURNAL-3AEVENT-NAME-20FUNCTION-29"></a>
<a id="JOURNAL:EVENT-NAME%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L209">[function]</a></span> <span class="reference-object"><a href="#JOURNAL:EVENT-NAME%20FUNCTION" >event-name</a></span></span> <span class="locative-args">event</span></span></p>

<p>The name of an event can be of any type. It is often a symbol or a
string. When replaying, names are compared with <a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_equal.htm" title="EQUAL FUNCTION"><code>equal</code></a>. All <code>event</code>s
have names. The names of the in- and out-events belonging to the
same <a href="#JOURNAL:@FRAME%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@FRAME MGL-PAX:GLOSSARY-TERM">frame</a> are the same.</p></li>
</ul>

<p><a id="x-28JOURNAL-3A-40EVENT-VERSIONS-20MGL-PAX-3ASECTION-29"></a>
<a id="JOURNAL:@EVENT-VERSIONS%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#JOURNAL:@EVENTS-REFERENCE%20MGL-PAX:SECTION" title="Events reference">&#8592;</a> <a href="#JOURNAL:@EVENTS-REFERENCE%20MGL-PAX:SECTION" title="Events reference">&#8593;</a> <a href="#JOURNAL:@IN-EVENTS-REFERENCE%20MGL-PAX:SECTION" title="In-events">&#8594;</a> <a href="#JOURNAL:@EVENT-VERSIONS%20MGL-PAX:SECTION" title="Event versions">&#8634;</a> <a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L217">&#955;</a></span></span></p>

<h3><a href="#JOURNAL:@EVENT-VERSIONS%20MGL-PAX:SECTION">13.1 Event versions</a></h3>

<p><a id="x-28JOURNAL-3AEVENT-VERSION-20FUNCTION-29"></a>
<a id="JOURNAL:EVENT-VERSION%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L234">[function]</a></span> <span class="reference-object"><a href="#JOURNAL:EVENT-VERSION%20FUNCTION" >event-version</a></span></span> <span class="locative-args">event</span></span></p>

<p>Return the version of <code>event</code> of type <a href="#JOURNAL:EVENT-VERSION%20TYPE" title="JOURNAL:EVENT-VERSION TYPE"><code>event-version</code></a>.</p></li>
</ul>

<p><a id="x-28JOURNAL-3ALOG-EVENT-P-20FUNCTION-29"></a>
<a id="JOURNAL:LOG-EVENT-P%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L261">[function]</a></span> <span class="reference-object"><a href="#JOURNAL:LOG-EVENT-P%20FUNCTION" >log-event-p</a></span></span> <span class="locative-args">event</span></span></p>

<p>See if <code>event</code> is a <a href="#JOURNAL:LOG-EVENT%20TYPE" title="JOURNAL:LOG-EVENT TYPE"><code>log-event</code></a>.</p></li>
</ul>

<p><a id="x-28JOURNAL-3AVERSIONED-EVENT-P-20FUNCTION-29"></a>
<a id="JOURNAL:VERSIONED-EVENT-P%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L266">[function]</a></span> <span class="reference-object"><a href="#JOURNAL:VERSIONED-EVENT-P%20FUNCTION" >versioned-event-p</a></span></span> <span class="locative-args">event</span></span></p>

<p>See if <code>event</code> is a <a href="#JOURNAL:VERSIONED-EVENT%20TYPE" title="JOURNAL:VERSIONED-EVENT TYPE"><code>versioned-event</code></a>.</p></li>
</ul>

<p><a id="x-28JOURNAL-3AEXTERNAL-EVENT-P-20FUNCTION-29"></a>
<a id="JOURNAL:EXTERNAL-EVENT-P%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L271">[function]</a></span> <span class="reference-object"><a href="#JOURNAL:EXTERNAL-EVENT-P%20FUNCTION" >external-event-p</a></span></span> <span class="locative-args">event</span></span></p>

<p>See if <code>event</code> is an <a href="#JOURNAL:EXTERNAL-EVENT%20TYPE" title="JOURNAL:EXTERNAL-EVENT TYPE"><code>external-event</code></a>.</p></li>
</ul>

<p><a id="x-28JOURNAL-3A-40IN-EVENTS-REFERENCE-20MGL-PAX-3ASECTION-29"></a>
<a id="JOURNAL:@IN-EVENTS-REFERENCE%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#JOURNAL:@EVENT-VERSIONS%20MGL-PAX:SECTION" title="Event versions">&#8592;</a> <a href="#JOURNAL:@EVENTS-REFERENCE%20MGL-PAX:SECTION" title="Events reference">&#8593;</a> <a href="#JOURNAL:@OUT-EVENTS-REFERENCE%20MGL-PAX:SECTION" title="Out-events">&#8594;</a> <a href="#JOURNAL:@IN-EVENTS-REFERENCE%20MGL-PAX:SECTION" title="In-events">&#8634;</a> <a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L276">&#955;</a></span></span></p>

<h3><a href="#JOURNAL:@IN-EVENTS-REFERENCE%20MGL-PAX:SECTION">13.2 In-events</a></h3>

<p><a id="x-28JOURNAL-3AIN-EVENT-20TYPE-29"></a>
<a id="JOURNAL:IN-EVENT%20TYPE"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L282">[type]</a></span> <span class="reference-object"><a href="#JOURNAL:IN-EVENT%20TYPE" >in-event</a></span></span></span></p>

<p><code>in-event</code>s are triggered upon entering the dynamic extent of a
<a href="#JOURNAL:JOURNALED%20MGL-PAX:MACRO" title="JOURNAL:JOURNALED MGL-PAX:MACRO"><code>journaled</code></a> <a href="#JOURNAL:@BLOCK%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@BLOCK MGL-PAX:GLOSSARY-TERM">block</a>. <code>in-event</code>s have <a href="#JOURNAL:EVENT-NAME%20FUNCTION" title="JOURNAL:EVENT-NAME FUNCTION"><code>event-name</code></a>,
<a href="#JOURNAL:EVENT-VERSION%20FUNCTION" title="JOURNAL:EVENT-VERSION FUNCTION"><code>event-version</code></a>, and <a href="#JOURNAL:EVENT-ARGS%20FUNCTION" title="JOURNAL:EVENT-ARGS FUNCTION"><code>event-args</code></a>. See <a href="#JOURNAL:@IN-EVENTS%20MGL-PAX:SECTION" title="In-events">In-events</a> for a more
introductory treatment.</p></li>
</ul>

<p><a id="x-28JOURNAL-3AIN-EVENT-P-20FUNCTION-29"></a>
<a id="JOURNAL:IN-EVENT-P%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L290">[function]</a></span> <span class="reference-object"><a href="#JOURNAL:IN-EVENT-P%20FUNCTION" >in-event-p</a></span></span> <span class="locative-args">event</span></span></p>

<p>See if <code>event</code> is a <a href="#JOURNAL:IN-EVENT%20TYPE" title="JOURNAL:IN-EVENT TYPE"><code>in-event</code></a>.</p></li>
</ul>

<p><a id="x-28JOURNAL-3AMAKE-IN-EVENT-20FUNCTION-29"></a>
<a id="JOURNAL:MAKE-IN-EVENT%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L298">[function]</a></span> <span class="reference-object"><a href="#JOURNAL:MAKE-IN-EVENT%20FUNCTION" >make-in-event</a></span></span> <span class="locative-args">&amp;key name version args</span></span></p>

<p>Create an <a href="#JOURNAL:IN-EVENT%20TYPE" title="JOURNAL:IN-EVENT TYPE"><code>in-event</code></a> with <code>name</code>, <code>version</code> (of type <a href="#JOURNAL:EVENT-VERSION%20TYPE" title="JOURNAL:EVENT-VERSION TYPE"><code>event-version</code></a>) and
<code>args</code> as its <a href="#JOURNAL:EVENT-NAME%20FUNCTION" title="JOURNAL:EVENT-NAME FUNCTION"><code>event-name</code></a>, <a href="#JOURNAL:EVENT-VERSION%20FUNCTION" title="JOURNAL:EVENT-VERSION FUNCTION"><code>event-version</code></a> and <a href="#JOURNAL:EVENT-ARGS%20FUNCTION" title="JOURNAL:EVENT-ARGS FUNCTION"><code>event-args</code></a>.</p></li>
</ul>

<p><a id="x-28JOURNAL-3AEVENT-ARGS-20FUNCTION-29"></a>
<a id="JOURNAL:EVENT-ARGS%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L313">[function]</a></span> <span class="reference-object"><a href="#JOURNAL:EVENT-ARGS%20FUNCTION" >event-args</a></span></span> <span class="locative-args">in-event</span></span></p>

<p>Return the arguments of <code>in-event</code>, normally populated using the <code>args</code>
form in <a href="#JOURNAL:JOURNALED%20MGL-PAX:MACRO" title="JOURNAL:JOURNALED MGL-PAX:MACRO"><code>journaled</code></a>.</p></li>
</ul>

<p><a id="x-28JOURNAL-3A-40OUT-EVENTS-REFERENCE-20MGL-PAX-3ASECTION-29"></a>
<a id="JOURNAL:@OUT-EVENTS-REFERENCE%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#JOURNAL:@IN-EVENTS-REFERENCE%20MGL-PAX:SECTION" title="In-events">&#8592;</a> <a href="#JOURNAL:@EVENTS-REFERENCE%20MGL-PAX:SECTION" title="Events reference">&#8593;</a> <a href="#JOURNAL:@LEAF-EVENTS-REFERENCE%20MGL-PAX:SECTION" title="Leaf-events">&#8594;</a> <a href="#JOURNAL:@OUT-EVENTS-REFERENCE%20MGL-PAX:SECTION" title="Out-events">&#8634;</a> <a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L319">&#955;</a></span></span></p>

<h3><a href="#JOURNAL:@OUT-EVENTS-REFERENCE%20MGL-PAX:SECTION">13.3 Out-events</a></h3>

<p><a id="x-28JOURNAL-3AOUT-EVENT-20TYPE-29"></a>
<a id="JOURNAL:OUT-EVENT%20TYPE"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L328">[type]</a></span> <span class="reference-object"><a href="#JOURNAL:OUT-EVENT%20TYPE" >out-event</a></span></span></span></p>

<p><code>out-event</code>s are triggered upon leaving the dynamic extent of the
<a href="#JOURNAL:JOURNALED%20MGL-PAX:MACRO" title="JOURNAL:JOURNALED MGL-PAX:MACRO"><code>journaled</code></a> <a href="#JOURNAL:@BLOCK%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@BLOCK MGL-PAX:GLOSSARY-TERM">block</a>. <code>out-event</code>s have <a href="#JOURNAL:EVENT-NAME%20FUNCTION" title="JOURNAL:EVENT-NAME FUNCTION"><code>event-name</code></a>,
<a href="#JOURNAL:EVENT-VERSION%20FUNCTION" title="JOURNAL:EVENT-VERSION FUNCTION"><code>event-version</code></a>, <a href="#JOURNAL:EVENT-EXIT%20FUNCTION" title="JOURNAL:EVENT-EXIT FUNCTION"><code>event-exit</code></a> and <a href="#JOURNAL:EVENT-OUTCOME%20FUNCTION" title="JOURNAL:EVENT-OUTCOME FUNCTION"><code>event-outcome</code></a>.
See <a href="#JOURNAL:@OUT-EVENTS%20MGL-PAX:SECTION" title="Out-events">Out-events</a> for a more introductory treatment.</p></li>
</ul>

<p><a id="x-28JOURNAL-3AOUT-EVENT-P-20FUNCTION-29"></a>
<a id="JOURNAL:OUT-EVENT-P%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L336">[function]</a></span> <span class="reference-object"><a href="#JOURNAL:OUT-EVENT-P%20FUNCTION" >out-event-p</a></span></span> <span class="locative-args">event</span></span></p>

<p>See if <code>event</code> is an <a href="#JOURNAL:OUT-EVENT%20TYPE" title="JOURNAL:OUT-EVENT TYPE"><code>out-event</code></a>.</p></li>
</ul>

<p><a id="x-28JOURNAL-3AMAKE-OUT-EVENT-20FUNCTION-29"></a>
<a id="JOURNAL:MAKE-OUT-EVENT%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L341">[function]</a></span> <span class="reference-object"><a href="#JOURNAL:MAKE-OUT-EVENT%20FUNCTION" >make-out-event</a></span></span> <span class="locative-args">&amp;key name version exit outcome</span></span></p>

<p>Create an <a href="#JOURNAL:OUT-EVENT%20TYPE" title="JOURNAL:OUT-EVENT TYPE"><code>out-event</code></a> with <code>name</code>, <code>version</code> (of type <a href="#JOURNAL:EVENT-VERSION%20TYPE" title="JOURNAL:EVENT-VERSION TYPE"><code>event-version</code></a>),
<code>exit</code> (of type <a href="#JOURNAL:EVENT-EXIT%20TYPE" title="JOURNAL:EVENT-EXIT TYPE"><code>event-exit</code></a>), and <code>outcome</code> as its <a href="#JOURNAL:EVENT-NAME%20FUNCTION" title="JOURNAL:EVENT-NAME FUNCTION"><code>event-name</code></a>,
<a href="#JOURNAL:EVENT-VERSION%20FUNCTION" title="JOURNAL:EVENT-VERSION FUNCTION"><code>event-version</code></a>, <a href="#JOURNAL:EVENT-EXIT%20FUNCTION" title="JOURNAL:EVENT-EXIT FUNCTION"><code>event-exit</code></a> and <a href="#JOURNAL:EVENT-OUTCOME%20FUNCTION" title="JOURNAL:EVENT-OUTCOME FUNCTION"><code>event-outcome</code></a>.</p></li>
</ul>

<p><a id="x-28JOURNAL-3AEVENT-EXIT-20FUNCTION-29"></a>
<a id="JOURNAL:EVENT-EXIT%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L355">[function]</a></span> <span class="reference-object"><a href="#JOURNAL:EVENT-EXIT%20FUNCTION" >event-exit</a></span></span> <span class="locative-args">out-event</span></span></p>

<p>Return how the journaled <a href="#JOURNAL:@BLOCK%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@BLOCK MGL-PAX:GLOSSARY-TERM">block</a> finished. See <a href="#JOURNAL:EVENT-EXIT%20TYPE" title="JOURNAL:EVENT-EXIT TYPE"><code>event-exit</code></a>
for the possible types.</p></li>
</ul>

<p><a id="x-28JOURNAL-3AEXPECTED-OUTCOME-P-20FUNCTION-29"></a>
<a id="JOURNAL:EXPECTED-OUTCOME-P%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L380">[function]</a></span> <span class="reference-object"><a href="#JOURNAL:EXPECTED-OUTCOME-P%20FUNCTION" >expected-outcome-p</a></span></span> <span class="locative-args">out-event</span></span></p>

<p>See if <code>out-event</code> has an <a href="#JOURNAL:@EXPECTED-OUTCOME%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@EXPECTED-OUTCOME MGL-PAX:GLOSSARY-TERM">expected outcome</a>.</p></li>
</ul>

<p><a id="x-28JOURNAL-3AUNEXPECTED-OUTCOME-P-20FUNCTION-29"></a>
<a id="JOURNAL:UNEXPECTED-OUTCOME-P%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L386">[function]</a></span> <span class="reference-object"><a href="#JOURNAL:UNEXPECTED-OUTCOME-P%20FUNCTION" >unexpected-outcome-p</a></span></span> <span class="locative-args">out-event</span></span></p>

<p>See if <code>out-event</code> has an <a href="#JOURNAL:@UNEXPECTED-OUTCOME%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@UNEXPECTED-OUTCOME MGL-PAX:GLOSSARY-TERM">unexpected outcome</a>.</p></li>
</ul>

<p><a id="x-28JOURNAL-3AEVENT-OUTCOME-20FUNCTION-29"></a>
<a id="JOURNAL:EVENT-OUTCOME%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L392">[function]</a></span> <span class="reference-object"><a href="#JOURNAL:EVENT-OUTCOME%20FUNCTION" >event-outcome</a></span></span> <span class="locative-args">out-event</span></span></p>

<p>Return the outcome of the <a href="#JOURNAL:@FRAME%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@FRAME MGL-PAX:GLOSSARY-TERM">frame</a> (or loosely speaking of a <a href="#JOURNAL:@BLOCK%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@BLOCK MGL-PAX:GLOSSARY-TERM">block</a>)
to which <code>out-event</code> belongs.</p></li>
</ul>

<p><a id="x-28JOURNAL-3A-40LEAF-EVENTS-REFERENCE-20MGL-PAX-3ASECTION-29"></a>
<a id="JOURNAL:@LEAF-EVENTS-REFERENCE%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#JOURNAL:@OUT-EVENTS-REFERENCE%20MGL-PAX:SECTION" title="Out-events">&#8592;</a> <a href="#JOURNAL:@EVENTS-REFERENCE%20MGL-PAX:SECTION" title="Events reference">&#8593;</a> <a href="#JOURNAL:@JOURNALS-REFERENCE%20MGL-PAX:SECTION" title="Journals reference">&#8594;</a> <a href="#JOURNAL:@LEAF-EVENTS-REFERENCE%20MGL-PAX:SECTION" title="Leaf-events">&#8634;</a> <a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L401">&#955;</a></span></span></p>

<h3><a href="#JOURNAL:@LEAF-EVENTS-REFERENCE%20MGL-PAX:SECTION">13.4 Leaf-events</a></h3>

<p><a id="x-28JOURNAL-3ALEAF-EVENT-20TYPE-29"></a>
<a id="JOURNAL:LEAF-EVENT%20TYPE"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L406">[type]</a></span> <span class="reference-object"><a href="#JOURNAL:LEAF-EVENT%20TYPE" >leaf-event</a></span></span></span></p>

<p>Leaf events are triggered by <a href="#JOURNAL:LOGGED%20MGL-PAX:MACRO" title="JOURNAL:LOGGED MGL-PAX:MACRO"><code>logged</code></a>. Unlike <a href="#JOURNAL:IN-EVENT%20TYPE" title="JOURNAL:IN-EVENT TYPE"><code>in-event</code></a>s and
<a href="#JOURNAL:OUT-EVENT%20TYPE" title="JOURNAL:OUT-EVENT TYPE"><code>out-event</code></a>s, which represent a <a href="#JOURNAL:@FRAME%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@FRAME MGL-PAX:GLOSSARY-TERM">frame</a>, leaf events represent a point
in execution thus cannot have children. They are also the poorest of
their kind: they only have an <a href="#JOURNAL:EVENT-NAME%20FUNCTION" title="JOURNAL:EVENT-NAME FUNCTION"><code>event-name</code></a>. Their <code>version</code> is always
<code>nil</code>, which makes them <a href="#JOURNAL:LOG-EVENT%20TYPE" title="JOURNAL:LOG-EVENT TYPE"><code>log-event</code></a>s.</p></li>
</ul>

<p><a id="x-28JOURNAL-3ALEAF-EVENT-P-20FUNCTION-29"></a>
<a id="JOURNAL:LEAF-EVENT-P%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L414">[function]</a></span> <span class="reference-object"><a href="#JOURNAL:LEAF-EVENT-P%20FUNCTION" >leaf-event-p</a></span></span> <span class="locative-args">event</span></span></p>

<p>See if <code>event</code> is a <a href="#JOURNAL:LEAF-EVENT%20TYPE" title="JOURNAL:LEAF-EVENT TYPE"><code>leaf-event</code></a>.</p></li>
</ul>

<p><a id="x-28JOURNAL-3AMAKE-LEAF-EVENT-20FUNCTION-29"></a>
<a id="JOURNAL:MAKE-LEAF-EVENT%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L418">[function]</a></span> <span class="reference-object"><a href="#JOURNAL:MAKE-LEAF-EVENT%20FUNCTION" >make-leaf-event</a></span></span> <span class="locative-args">name</span></span></p>

<p>Create a <a href="#JOURNAL:LEAF-EVENT%20TYPE" title="JOURNAL:LEAF-EVENT TYPE"><code>leaf-event</code></a> with <code>name</code>.</p></li>
</ul>

<p><a id="x-28JOURNAL-3A-40JOURNALS-REFERENCE-20MGL-PAX-3ASECTION-29"></a>
<a id="JOURNAL:@JOURNALS-REFERENCE%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#JOURNAL:@LEAF-EVENTS-REFERENCE%20MGL-PAX:SECTION" title="Leaf-events">&#8592;</a> <a href="journal-manual.html" title="Journal manual">&#8593;</a> <a href="#JOURNAL:@COMPARING-JOURNALS%20MGL-PAX:SECTION" title="Comparing journals">&#8594;</a> <a href="#JOURNAL:@JOURNALS-REFERENCE%20MGL-PAX:SECTION" title="Journals reference">&#8634;</a> <a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L438">&#955;</a></span></span></p>

<h2><a href="#JOURNAL:@JOURNALS-REFERENCE%20MGL-PAX:SECTION">14 Journals reference</a></h2>

<p>In <a href="#JOURNAL:@JOURNAL-BASICS%20MGL-PAX:SECTION" title="Basics">Basics</a>, we covered the bare minimum needed to work with
journals. Here, we go into the details.</p>

<p><a id="x-28JOURNAL-3AJOURNAL-20CLASS-29"></a>
<a id="JOURNAL:JOURNAL%20CLASS"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L453">[class]</a></span> <span class="reference-object"><a href="#JOURNAL:JOURNAL%20CLASS" >journal</a></span></span></span></p>

<p><code>journal</code> is an abstract base class for a sequence of
events. In case of <a href="#JOURNAL:FILE-JOURNAL%20CLASS" title="JOURNAL:FILE-JOURNAL CLASS"><code>file-journal</code></a>s, the events are stored in a file,
while for <a href="#JOURNAL:IN-MEMORY-JOURNAL%20CLASS" title="JOURNAL:IN-MEMORY-JOURNAL CLASS"><code>in-memory-journal</code></a>s, they are in a Lisp array. When a
journal is opened, it is possible to perform I/O on it (see
<a href="#JOURNAL:@STREAMLETS-REFERENCE%20MGL-PAX:SECTION" title="Streamlets reference">Streamlets reference</a>), which is normally taken care of by
<a href="#JOURNAL:WITH-JOURNALING%20MGL-PAX:MACRO" title="JOURNAL:WITH-JOURNALING MGL-PAX:MACRO"><code>with-journaling</code></a>. For this reason, the user's involvement with
journals normally only consists of creating and using them in
<code>with-journaling</code>.</p></li>
</ul>

<p><a id="x-28JOURNAL-3AJOURNAL-STATE-20-28MGL-PAX-3AREADER-20JOURNAL-3AJOURNAL-29-29"></a>
<a id="JOURNAL:JOURNAL-STATE%20%28MGL-PAX:READER%20JOURNAL:JOURNAL%29"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L454">[reader]</a></span> <span class="reference-object"><a href="#JOURNAL:JOURNAL-STATE%20%28MGL-PAX:READER%20JOURNAL:JOURNAL%29" >journal-state</a></span></span> <span class="locative-args">journal (:state)</span></span></p>

<p>Return the state of <a href="#JOURNAL:JOURNAL%20CLASS" title="JOURNAL:JOURNAL CLASS"><code>journal</code></a>, which is of type
<a href="#JOURNAL:JOURNAL-STATE%20TYPE" title="JOURNAL:JOURNAL-STATE TYPE"><code>journal-state</code></a>.</p></li>
</ul>

<p><a id="x-28JOURNAL-3AJOURNAL-SYNC-20-28MGL-PAX-3AREADER-20JOURNAL-3AJOURNAL-29-29"></a>
<a id="JOURNAL:JOURNAL-SYNC%20%28MGL-PAX:READER%20JOURNAL:JOURNAL%29"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L458">[reader]</a></span> <span class="reference-object"><a href="#JOURNAL:JOURNAL-SYNC%20%28MGL-PAX:READER%20JOURNAL:JOURNAL%29" >journal-sync</a></span></span> <span class="locative-args">journal (:sync = nil)</span></span></p>

<p>The <code>sync</code> argument specified at instantiation. See
<a href="#JOURNAL:@SYNCHRONIZATION-STRATEGIES%20MGL-PAX:SECTION" title="Synchronization strategies">Synchronization strategies</a>.</p></li>
</ul>

<p><a id="x-28JOURNAL-3ASYNC-JOURNAL-20FUNCTION-29"></a>
<a id="JOURNAL:SYNC-JOURNAL%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L4791">[function]</a></span> <span class="reference-object"><a href="#JOURNAL:SYNC-JOURNAL%20FUNCTION" >sync-journal</a></span></span> <span class="locative-args">&amp;optional (journal (record-journal))</span></span></p>

<p>Durably persist changes made to <code>journal</code> if <a href="#JOURNAL:JOURNAL-SYNC%20%28MGL-PAX:READER%20JOURNAL:JOURNAL%29" title="JOURNAL:JOURNAL-SYNC (MGL-PAX:READER JOURNAL:JOURNAL)"><code>journal-sync</code></a> is <code>t</code>.
The changes that are persisted are </p>

<ul>
<li><p><a href="#JOURNAL:WRITE-EVENT%20GENERIC-FUNCTION" title="JOURNAL:WRITE-EVENT GENERIC-FUNCTION"><code>write-event</code></a>s and <a href="#JOURNAL:JOURNAL-STATE%20TYPE" title="JOURNAL:JOURNAL-STATE TYPE"><code>journal-state</code></a> changes made in an enclosing
  WITH-JOURNALING; and</p></li>
<li><p><code>log-record</code>s from any thread. </p></li>
</ul>

<p>In particular, writes made in a <a href="#JOURNAL:WITH-JOURNALING%20MGL-PAX:MACRO" title="JOURNAL:WITH-JOURNALING MGL-PAX:MACRO"><code>with-journaling</code></a> in another thread
are not persisted. <code>sync-journal</code> is a noop if <code>journal-sync</code> is <code>nil</code>. It
is safe to call from any thread.</p></li>
</ul>

<p><a id="x-28JOURNAL-3AJOURNAL-REPLAY-MISMATCH-20-28MGL-PAX-3AREADER-20JOURNAL-3AJOURNAL-29-29"></a>
<a id="JOURNAL:JOURNAL-REPLAY-MISMATCH%20%28MGL-PAX:READER%20JOURNAL:JOURNAL%29"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L472">[reader]</a></span> <span class="reference-object"><a href="#JOURNAL:JOURNAL-REPLAY-MISMATCH%20%28MGL-PAX:READER%20JOURNAL:JOURNAL%29" >journal-replay-mismatch</a></span></span> <span class="locative-args">journal (= nil)</span></span></p>

<p>If <a href="#JOURNAL:JOURNAL-DIVERGENT-P%20FUNCTION" title="JOURNAL:JOURNAL-DIVERGENT-P FUNCTION"><code>journal-divergent-p</code></a>, then this is a list of two
elements: the <a href="#JOURNAL:READ-POSITION%20GENERIC-FUNCTION" title="JOURNAL:READ-POSITION GENERIC-FUNCTION"><code>read-position</code></a>s in the <a href="#JOURNAL:RECORD-JOURNAL%20FUNCTION" title="JOURNAL:RECORD-JOURNAL FUNCTION"><code>record-journal</code></a> and
<a href="#JOURNAL:REPLAY-JOURNAL%20FUNCTION" title="JOURNAL:REPLAY-JOURNAL FUNCTION"><code>replay-journal</code></a> of the first events that were different (ignoring
<a href="#JOURNAL:LOG-EVENT%20TYPE" title="JOURNAL:LOG-EVENT TYPE"><code>log-event</code></a>s). It is <code>nil</code>, otherwise.</p></li>
</ul>

<p><a id="x-28JOURNAL-3AJOURNAL-DIVERGENT-P-20FUNCTION-29"></a>
<a id="JOURNAL:JOURNAL-DIVERGENT-P%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L487">[function]</a></span> <span class="reference-object"><a href="#JOURNAL:JOURNAL-DIVERGENT-P%20FUNCTION" >journal-divergent-p</a></span></span> <span class="locative-args">journal</span></span></p>

<p>See if <a href="#JOURNAL:WITH-JOURNALING%20MGL-PAX:MACRO" title="JOURNAL:WITH-JOURNALING MGL-PAX:MACRO"><code>with-journaling</code></a> recorded any event so far in this journal
that was not <a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_equal.htm" title="EQUAL FUNCTION"><code>equal</code></a> to its <a href="#JOURNAL:@REPLAY-EVENT%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@REPLAY-EVENT MGL-PAX:GLOSSARY-TERM">replay event</a> or it had no corresponding
replay event. This completely ignores <a href="#JOURNAL:LOG-EVENT%20TYPE" title="JOURNAL:LOG-EVENT TYPE"><code>log-event</code></a>s in both journals
being compared and can be called any time during <a href="#JOURNAL:@REPLAY%20MGL-PAX:SECTION" title="Replay">Replay</a>. It plays a
role in <a href="#JOURNAL:WITH-BUNDLE%20MGL-PAX:MACRO" title="JOURNAL:WITH-BUNDLE MGL-PAX:MACRO"><code>with-bundle</code></a> deciding when a journal is important enough to
keep and also in <a href="#JOURNAL:@SYNCHRONIZATION-WITH-IN-MEMORY-JOURNALS%20MGL-PAX:SECTION" title="Synchronization with in-memory journals">Synchronization with in-memory journals</a>.</p>

<p>The position of the first mismatch is available via
<a href="#JOURNAL:JOURNAL-REPLAY-MISMATCH%20%28MGL-PAX:READER%20JOURNAL:JOURNAL%29" title="JOURNAL:JOURNAL-REPLAY-MISMATCH (MGL-PAX:READER JOURNAL:JOURNAL)"><code>journal-replay-mismatch</code></a>.</p></li>
</ul>

<p><a id="x-28JOURNAL-3A-40COMPARING-JOURNALS-20MGL-PAX-3ASECTION-29"></a>
<a id="JOURNAL:@COMPARING-JOURNALS%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#JOURNAL:@JOURNALS-REFERENCE%20MGL-PAX:SECTION" title="Journals reference">&#8592;</a> <a href="#JOURNAL:@JOURNALS-REFERENCE%20MGL-PAX:SECTION" title="Journals reference">&#8593;</a> <a href="#JOURNAL:@IN-MEMORY-JOURNALS%20MGL-PAX:SECTION" title="In-memory journals">&#8594;</a> <a href="#JOURNAL:@COMPARING-JOURNALS%20MGL-PAX:SECTION" title="Comparing journals">&#8634;</a> <a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L516">&#955;</a></span></span></p>

<h3><a href="#JOURNAL:@COMPARING-JOURNALS%20MGL-PAX:SECTION">14.1 Comparing journals</a></h3>

<p>After replay finished (i.e. <a href="#JOURNAL:WITH-JOURNALING%20MGL-PAX:MACRO" title="JOURNAL:WITH-JOURNALING MGL-PAX:MACRO"><code>with-journaling</code></a> completed), we can ask
whether there were any changes produced. This is answered in the
strictest sense by <a href="#JOURNAL:IDENTICAL-JOURNALS-P%20GENERIC-FUNCTION" title="JOURNAL:IDENTICAL-JOURNALS-P GENERIC-FUNCTION"><code>identical-journals-p</code></a> and somewhat more
functionally by <a href="#JOURNAL:EQUIVALENT-REPLAY-JOURNALS-P%20GENERIC-FUNCTION" title="JOURNAL:EQUIVALENT-REPLAY-JOURNALS-P GENERIC-FUNCTION"><code>equivalent-replay-journals-p</code></a>.</p>

<p>Also see <a href="#JOURNAL:JOURNAL-DIVERGENT-P%20FUNCTION" title="JOURNAL:JOURNAL-DIVERGENT-P FUNCTION"><code>journal-divergent-p</code></a>.</p>

<p><a id="x-28JOURNAL-3AIDENTICAL-JOURNALS-P-20GENERIC-FUNCTION-29"></a>
<a id="JOURNAL:IDENTICAL-JOURNALS-P%20GENERIC-FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L526">[generic-function]</a></span> <span class="reference-object"><a href="#JOURNAL:IDENTICAL-JOURNALS-P%20GENERIC-FUNCTION" >identical-journals-p</a></span></span> <span class="locative-args">journal-1 journal-2</span></span></p>

<p>Compare two journals in a strict sense: whether
they have the same <a href="#JOURNAL:JOURNAL-STATE%20TYPE" title="JOURNAL:JOURNAL-STATE TYPE"><code>journal-state</code></a> and the lists of their events (as
in <a href="#JOURNAL:LIST-EVENTS%20FUNCTION" title="JOURNAL:LIST-EVENTS FUNCTION"><code>list-events</code></a>) are <a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_equal.htm" title="EQUAL FUNCTION"><code>equal</code></a>.</p></li>
</ul>

<p><a id="x-28JOURNAL-3AEQUIVALENT-REPLAY-JOURNALS-P-20GENERIC-FUNCTION-29"></a>
<a id="JOURNAL:EQUIVALENT-REPLAY-JOURNALS-P%20GENERIC-FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L548">[generic-function]</a></span> <span class="reference-object"><a href="#JOURNAL:EQUIVALENT-REPLAY-JOURNALS-P%20GENERIC-FUNCTION" >equivalent-replay-journals-p</a></span></span> <span class="locative-args">journal-1 journal-2</span></span></p>

<p>See if two journals are equivalent when used the
for <code>replay</code> in <a href="#JOURNAL:WITH-JOURNALING%20MGL-PAX:MACRO" title="JOURNAL:WITH-JOURNALING MGL-PAX:MACRO"><code>with-journaling</code></a>. <code>equivalent-replay-journals-p</code> is like
<a href="#JOURNAL:IDENTICAL-JOURNALS-P%20GENERIC-FUNCTION" title="JOURNAL:IDENTICAL-JOURNALS-P GENERIC-FUNCTION"><code>identical-journals-p</code></a>, but it ignores <a href="#JOURNAL:LOG-EVENT%20TYPE" title="JOURNAL:LOG-EVENT TYPE"><code>log-event</code></a>s and allows events
with <code>event-exit</code>(<a href="#JOURNAL:EVENT-EXIT%20FUNCTION" title="JOURNAL:EVENT-EXIT FUNCTION"><code>0</code></a> <a href="#JOURNAL:EVENT-EXIT%20TYPE" title="JOURNAL:EVENT-EXIT TYPE"><code>1</code></a>) <code>:error</code> to differ in their outcomes, which may very
well be implementation specific, anyway. Also, it considers two
groups of states as different <code>:new</code>, <code>:replaying</code>, <code>:mismatched</code>, <code>:failed</code>
vs <code>:recording</code>, <code>:logging</code>, COMPLETED.</p></li>
</ul>

<p>The rest of section is about concrete subclasses of <a href="#JOURNAL:JOURNAL%20CLASS" title="JOURNAL:JOURNAL CLASS"><code>journal</code></a>.</p>

<p><a id="x-28JOURNAL-3A-40IN-MEMORY-JOURNALS-20MGL-PAX-3ASECTION-29"></a>
<a id="JOURNAL:@IN-MEMORY-JOURNALS%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#JOURNAL:@COMPARING-JOURNALS%20MGL-PAX:SECTION" title="Comparing journals">&#8592;</a> <a href="#JOURNAL:@JOURNALS-REFERENCE%20MGL-PAX:SECTION" title="Journals reference">&#8593;</a> <a href="#JOURNAL:@FILE-JOURNALS%20MGL-PAX:SECTION" title="File journals">&#8594;</a> <a href="#JOURNAL:@IN-MEMORY-JOURNALS%20MGL-PAX:SECTION" title="In-memory journals">&#8634;</a> <a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L4927">&#955;</a></span></span></p>

<h3><a href="#JOURNAL:@IN-MEMORY-JOURNALS%20MGL-PAX:SECTION">14.2 In-memory journals</a></h3>

<p><a id="x-28JOURNAL-3AIN-MEMORY-JOURNAL-20CLASS-29"></a>
<a id="JOURNAL:IN-MEMORY-JOURNAL%20CLASS"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L4933">[class]</a></span> <span class="reference-object"><a href="#JOURNAL:IN-MEMORY-JOURNAL%20CLASS" >in-memory-journal</a></span></span> <span class="locative-args"><a href="#JOURNAL:JOURNAL%20CLASS" title="JOURNAL:JOURNAL CLASS">journal</a></span></span></p>

<p><code>in-memory-journal</code>s are backed by a non-persistent
Lisp array of events. Much quicker than <a href="#JOURNAL:FILE-JOURNAL%20CLASS" title="JOURNAL:FILE-JOURNAL CLASS"><code>file-journal</code></a>s, they are
ideal for smallish journals persisted manually (see
<a href="#JOURNAL:@SYNCHRONIZATION-WITH-IN-MEMORY-JOURNALS%20MGL-PAX:SECTION" title="Synchronization with in-memory journals">Synchronization with in-memory journals</a> for an example).</p>

<p>They are also useful for writing tests based on what events were
generated. They differ from <code>file-journal</code>s in that events written to
<code>in-memory-journal</code>s are not serialized (and deserialized on replay)
with the following consequences for the objects recorded by
<a href="#JOURNAL:JOURNALED%20MGL-PAX:MACRO" title="JOURNAL:JOURNALED MGL-PAX:MACRO"><code>journaled</code></a> (i.e. its <code>name</code>, <code>args</code> arguments, and also the return <code>values</code>(<a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_values.htm" title="VALUES FUNCTION"><code>0</code></a> <a href="http://www.lispworks.com/documentation/HyperSpec/Body/t_values.htm" title="VALUES TYPE"><code>1</code></a>)
of the block, or the value returned by <code>condition</code>(<a href="http://www.lispworks.com/documentation/HyperSpec/Body/e_cnd.htm" title="CONDITION CONDITION"><code>0</code></a> <a href="pax-manual.html#CONDITION%20MGL-PAX:LOCATIVE" title="CONDITION MGL-PAX:LOCATIVE"><code>1</code></a>)):</p>

<ul>
<li><p>These objects need not be <a href="#JOURNAL:@READABLE%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@READABLE MGL-PAX:GLOSSARY-TERM">readable</a>.</p></li>
<li><p>Their identity (<a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_eq.htm" title="EQ FUNCTION"><code>eq</code></a>ness) is not lost.</p></li>
<li><p>They must <strong>must not be mutated</strong> in any way.</p></li>
</ul></li>
</ul>

<p><a id="x-28JOURNAL-3AMAKE-IN-MEMORY-JOURNAL-20FUNCTION-29"></a>
<a id="JOURNAL:MAKE-IN-MEMORY-JOURNAL%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L4988">[function]</a></span> <span class="reference-object"><a href="#JOURNAL:MAKE-IN-MEMORY-JOURNAL%20FUNCTION" >make-in-memory-journal</a></span></span> <span class="locative-args">&amp;key (events nil eventsp) state (sync nil syncp) sync-fn</span></span></p>

<p>Create an <a href="#JOURNAL:IN-MEMORY-JOURNAL%20CLASS" title="JOURNAL:IN-MEMORY-JOURNAL CLASS"><code>in-memory-journal</code></a>.</p>

<p>The returned journal's <a href="#JOURNAL:JOURNAL-STATE%20TYPE" title="JOURNAL:JOURNAL-STATE TYPE"><code>journal-state</code></a> will be set to <code>state</code>. If <code>state</code>
is <code>nil</code>, then it is replaced by a default value, which is <code>:completed</code>
if the <code>events</code> argument is provided, else it is <code>:new</code>.</p>

<p>Thus, <code>(make-in-memory-journal)</code> creates a journal suitable for
recording, and to make a replay journal, use <code>:state</code> <code>:completed</code> with
some sequence of <code>events</code>:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code">make-in-memory-journal <span class="keyword">:events</span> '<span class="paren2">(<span class="code"><span class="paren3">(<span class="code"><span class="keyword">:in</span> foo <span class="keyword">:version</span> 1</span>)</span></span>)</span> <span class="keyword">:state</span> <span class="keyword">:completed</span></span>)</span></span></code></pre>

<p><code>sync</code> determines when <code>sync-fn</code> will be invoked on the <a href="#JOURNAL:RECORD-JOURNAL%20FUNCTION" title="JOURNAL:RECORD-JOURNAL FUNCTION"><code>record-journal</code></a>.
<code>sync</code> defaults to <code>t</code> if <code>sync-fn</code>, else to <code>nil</code>. For a description of
possible values, see <a href="#JOURNAL:@SYNCHRONIZATION-STRATEGIES%20MGL-PAX:SECTION" title="Synchronization strategies">Synchronization strategies</a>. For more
discussion, see <a href="#JOURNAL:@SYNCHRONIZATION-WITH-IN-MEMORY-JOURNALS%20MGL-PAX:SECTION" title="Synchronization with in-memory journals">Synchronization with in-memory journals</a>.</p></li>
</ul>

<p><a id="x-28JOURNAL-3AJOURNAL-EVENTS-20-28MGL-PAX-3AREADER-20JOURNAL-3AIN-MEMORY-JOURNAL-29-29"></a>
<a id="JOURNAL:JOURNAL-EVENTS%20%28MGL-PAX:READER%20JOURNAL:IN-MEMORY-JOURNAL%29"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L4934">[reader]</a></span> <span class="reference-object"><a href="#JOURNAL:JOURNAL-EVENTS%20%28MGL-PAX:READER%20JOURNAL:IN-MEMORY-JOURNAL%29" >journal-events</a></span></span> <span class="locative-args">in-memory-journal (:events)</span></span></p>

<p>A sequence of events in the journal. Not to be
mutated by client code.</p></li>
</ul>

<p><a id="x-28JOURNAL-3AJOURNAL-PREVIOUS-SYNC-POSITION-20-28MGL-PAX-3AREADER-20JOURNAL-3AIN-MEMORY-JOURNAL-29-29"></a>
<a id="JOURNAL:JOURNAL-PREVIOUS-SYNC-POSITION%20%28MGL-PAX:READER%20JOURNAL:IN-MEMORY-JOURNAL%29"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L4939">[reader]</a></span> <span class="reference-object"><a href="#JOURNAL:JOURNAL-PREVIOUS-SYNC-POSITION%20%28MGL-PAX:READER%20JOURNAL:IN-MEMORY-JOURNAL%29" >journal-previous-sync-position</a></span></span> <span class="locative-args">in-memory-journal (= 0)</span></span></p>

<p>The length of <a href="#JOURNAL:JOURNAL-EVENTS%20%28MGL-PAX:READER%20JOURNAL:IN-MEMORY-JOURNAL%29" title="JOURNAL:JOURNAL-EVENTS (MGL-PAX:READER JOURNAL:IN-MEMORY-JOURNAL)"><code>journal-events</code></a> at the time of the
most recent invocation of <code>sync-fn</code>.</p></li>
</ul>

<p><a id="x-28JOURNAL-3A-40FILE-JOURNALS-20MGL-PAX-3ASECTION-29"></a>
<a id="JOURNAL:@FILE-JOURNALS%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#JOURNAL:@IN-MEMORY-JOURNALS%20MGL-PAX:SECTION" title="In-memory journals">&#8592;</a> <a href="#JOURNAL:@JOURNALS-REFERENCE%20MGL-PAX:SECTION" title="Journals reference">&#8593;</a> <a href="#JOURNAL:@PPRINT-JOURNALS%20MGL-PAX:SECTION" title="Pretty-printing journals">&#8594;</a> <a href="#JOURNAL:@FILE-JOURNALS%20MGL-PAX:SECTION" title="File journals">&#8634;</a> <a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L5067">&#955;</a></span></span></p>

<h3><a href="#JOURNAL:@FILE-JOURNALS%20MGL-PAX:SECTION">14.3 File journals</a></h3>

<p><a id="x-28JOURNAL-3AFILE-JOURNAL-20CLASS-29"></a>
<a id="JOURNAL:FILE-JOURNAL%20CLASS"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L5072">[class]</a></span> <span class="reference-object"><a href="#JOURNAL:FILE-JOURNAL%20CLASS" >file-journal</a></span></span> <span class="locative-args"><a href="#JOURNAL:JOURNAL%20CLASS" title="JOURNAL:JOURNAL CLASS">journal</a></span></span></p>

<p>A <code>file-journal</code> is a journal whose contents and
<a href="#JOURNAL:JOURNAL-STATE%20TYPE" title="JOURNAL:JOURNAL-STATE TYPE"><code>journal-state</code></a> are persisted in a file. This is the <a href="#JOURNAL:JOURNAL%20CLASS" title="JOURNAL:JOURNAL CLASS"><code>journal</code></a>
subclass with out-of-the-box persistence, but see <a href="#JOURNAL:@FILE-BUNDLES%20MGL-PAX:SECTION" title="File bundles">File bundles</a> for
a more full-featured solution for repeated <a href="#JOURNAL:@REPLAY%20MGL-PAX:SECTION" title="Replay">Replay</a>s.</p>

<p>Since serialization in <code>file-journal</code>s is built on top of Lisp <a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_rd_rd.htm" title="READ FUNCTION"><code>read</code></a>
and <a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_wr_pr.htm" title="WRITE FUNCTION"><code>write</code></a>, everything that <a href="#JOURNAL:JOURNALED%20MGL-PAX:MACRO" title="JOURNAL:JOURNALED MGL-PAX:MACRO"><code>journaled</code></a> records in events (i.e. its
<code>name</code>, <code>args</code> arguments, and also the return <code>values</code>(<a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_values.htm" title="VALUES FUNCTION"><code>0</code></a> <a href="http://www.lispworks.com/documentation/HyperSpec/Body/t_values.htm" title="VALUES TYPE"><code>1</code></a>) of the block, or
the value returned by <code>condition</code>(<a href="http://www.lispworks.com/documentation/HyperSpec/Body/e_cnd.htm" title="CONDITION CONDITION"><code>0</code></a> <a href="pax-manual.html#CONDITION%20MGL-PAX:LOCATIVE" title="CONDITION MGL-PAX:LOCATIVE"><code>1</code></a>)) must be <a href="#JOURNAL:@READABLE%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@READABLE MGL-PAX:GLOSSARY-TERM">readable</a>.</p>

<p>File journals are human-readable and editable by hand with some
care. When editing, the following needs to be remembered:</p>

<ul>
<li><p>The first character of the file represents its <code>journal-state</code>. It
  is a <code>#\Space</code> (for state <code>:new</code>, <code>:replaying</code>, <code>:mismatched</code> and
  <code>:failed</code>), or a <code>#\Newline</code> (for state <code>:recording</code>, <code>:logging</code> and
  <code>:completed</code>).</p></li>
<li><p>If the journal has <code>sync</code> (see <a href="#JOURNAL:@SYNCHRONIZATION-STRATEGIES%20MGL-PAX:SECTION" title="Synchronization strategies">Synchronization strategies</a>), then
  between two events, there may be <code>#\Del</code> (also called <code>#\Rubout</code>)
  or <code>#\Ack</code> characters (<a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_char_c.htm" title="CHAR-CODE FUNCTION"><code>char-code</code></a> 127 and 6). <code>#\Del</code> marks the end
  of the journal contents that may be read back: it's kind of an
  uncommitted-transaction marker for the events that follow it.
  <code>#\Ack</code> characters, of which there may be many in the file, mark
  the sequence of events until the next marker of either kind as
  valid (or committed). <code>#\Ack</code> characters are ignored when reading
  the journal.</p></li>
</ul>

<p>Thus, when editing a file, don't change the first character and
leave the <code>#\Del</code> character, if any, where it is. Also see
<a href="#JOURNAL:@SYNCHRONIZATION-WITH-FILE-JOURNALS%20MGL-PAX:SECTION" title="Synchronization with file journals">Synchronization with file journals</a>.</p></li>
</ul>

<p><a id="x-28JOURNAL-3AMAKE-FILE-JOURNAL-20FUNCTION-29"></a>
<a id="JOURNAL:MAKE-FILE-JOURNAL%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L5131">[function]</a></span> <span class="reference-object"><a href="#JOURNAL:MAKE-FILE-JOURNAL%20FUNCTION" >make-file-journal</a></span></span> <span class="locative-args">pathname &amp;key sync</span></span></p>

<p>Return a <a href="#JOURNAL:FILE-JOURNAL%20CLASS" title="JOURNAL:FILE-JOURNAL CLASS"><code>file-journal</code></a> backed by the file with <code>pathname</code>. The file is
created when the journal is opened for writing. For a description of
<code>sync</code>, see <a href="#JOURNAL:@SYNCHRONIZATION-STRATEGIES%20MGL-PAX:SECTION" title="Synchronization strategies">Synchronization strategies</a>.</p>

<p>If there is already an existing <code>file-journal</code> backed by the same
file, then that object is returned. If the existing object has
different options (e.g. it has <code>sync</code> <code>t</code> while the <code>sync</code> argument is <code>nil</code>
here), then a <a href="#JOURNAL:JOURNAL-ERROR%20CONDITION" title="JOURNAL:JOURNAL-ERROR CONDITION"><code>journal-error</code></a> is signalled.</p>

<p>If there is already an existing <code>file-journal</code> backed by the same
file, the <a href="#JOURNAL:JOURNAL-STATE%20TYPE" title="JOURNAL:JOURNAL-STATE TYPE"><code>journal-state</code></a> is not <code>:new</code>, but the file doesn't exist,
then the existing object is <strong>invalidated</strong>: attempts to write will
fail with <code>journal-error</code>. If the existing journal object is being
written, then invalidation fails with a <code>journal-error</code>. After
invalidation, a new <code>file-journal</code> object is created.</p></li>
</ul>

<p><a id="x-28JOURNAL-3APATHNAME-OF-20-28MGL-PAX-3AREADER-20JOURNAL-3AFILE-JOURNAL-29-29"></a>
<a id="JOURNAL:PATHNAME-OF%20%28MGL-PAX:READER%20JOURNAL:FILE-JOURNAL%29"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L5073">[reader]</a></span> <span class="reference-object"><a href="#JOURNAL:PATHNAME-OF%20%28MGL-PAX:READER%20JOURNAL:FILE-JOURNAL%29" >pathname-of</a></span></span> <span class="locative-args">file-journal (:pathname)</span></span></p>

<p>The pathname of the file backing the journal.</p></li>
</ul>

<p><a id="x-28JOURNAL-3A-40PPRINT-JOURNALS-20MGL-PAX-3ASECTION-29"></a>
<a id="JOURNAL:@PPRINT-JOURNALS%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#JOURNAL:@FILE-JOURNALS%20MGL-PAX:SECTION" title="File journals">&#8592;</a> <a href="#JOURNAL:@JOURNALS-REFERENCE%20MGL-PAX:SECTION" title="Journals reference">&#8593;</a> <a href="#JOURNAL:@BUNDLES-REFERENCE%20MGL-PAX:SECTION" title="Bundles reference">&#8594;</a> <a href="#JOURNAL:@PPRINT-JOURNALS%20MGL-PAX:SECTION" title="Pretty-printing journals">&#8634;</a> <a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L2016">&#955;</a></span></span></p>

<h3><a href="#JOURNAL:@PPRINT-JOURNALS%20MGL-PAX:SECTION">14.4 Pretty-printing journals</a></h3>

<p><a id="x-28JOURNAL-3APPRINT-JOURNAL-20CLASS-29"></a>
<a id="JOURNAL:PPRINT-JOURNAL%20CLASS"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L2023">[class]</a></span> <span class="reference-object"><a href="#JOURNAL:PPRINT-JOURNAL%20CLASS" >pprint-journal</a></span></span> <span class="locative-args"><a href="#JOURNAL:JOURNAL%20CLASS" title="JOURNAL:JOURNAL CLASS">journal</a></span></span></p>

<p>Events written to a <code>pprint-journal</code> have a
customizable output format. <code>pprint-journal</code>s are intended for
producing prettier output for <a href="#JOURNAL:@LOGGING%20MGL-PAX:SECTION" title="Logging">Logging</a> and <a href="#JOURNAL:@TRACING%20MGL-PAX:SECTION" title="Tracing">Tracing</a>, but they do not
support reads, so they cannot be used as a <a href="#JOURNAL:REPLAY-JOURNAL%20FUNCTION" title="JOURNAL:REPLAY-JOURNAL FUNCTION"><code>replay-journal</code></a> or in
<a href="#JOURNAL:LIST-EVENTS%20FUNCTION" title="JOURNAL:LIST-EVENTS FUNCTION"><code>list-events</code></a>, for example. On the other hand, events written to
<code>pprint-journal</code>s need not be <a href="#JOURNAL:@READABLE%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@READABLE MGL-PAX:GLOSSARY-TERM">readable</a>.</p></li>
</ul>

<p><a id="x-28JOURNAL-3AMAKE-PPRINT-JOURNAL-20FUNCTION-29"></a>
<a id="JOURNAL:MAKE-PPRINT-JOURNAL%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L2052">[function]</a></span> <span class="reference-object"><a href="#JOURNAL:MAKE-PPRINT-JOURNAL%20FUNCTION" >make-pprint-journal</a></span></span> <span class="locative-args">&amp;key (stream (make-synonym-stream '*standard-output*)) (pretty t) (prettifier 'prettify-event) log-decorator</span></span></p>

<p>Creates a <a href="#JOURNAL:PPRINT-JOURNAL%20CLASS" title="JOURNAL:PPRINT-JOURNAL CLASS"><code>pprint-journal</code></a>.</p></li>
</ul>

<p><a id="x-28JOURNAL-3APPRINT-JOURNAL-STREAM-20-28MGL-PAX-3AACCESSOR-20JOURNAL-3APPRINT-JOURNAL-29-29"></a>
<a id="JOURNAL:PPRINT-JOURNAL-STREAM%20%28MGL-PAX:ACCESSOR%20JOURNAL:PPRINT-JOURNAL%29"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L2024">[accessor]</a></span> <span class="reference-object"><a href="#JOURNAL:PPRINT-JOURNAL-STREAM%20%28MGL-PAX:ACCESSOR%20JOURNAL:PPRINT-JOURNAL%29" >pprint-journal-stream</a></span></span> <span class="locative-args">pprint-journal (:stream = *standard-output*)</span></span></p>

<p>The stream where events are dumped. May be set any
time to another <a href="http://www.lispworks.com/documentation/HyperSpec/Body/t_stream.htm" title="STREAM CLASS"><code>stream</code></a>.</p></li>
</ul>

<p><a id="x-28JOURNAL-3APPRINT-JOURNAL-PRETTY-20-28MGL-PAX-3AACCESSOR-20JOURNAL-3APPRINT-JOURNAL-29-29"></a>
<a id="JOURNAL:PPRINT-JOURNAL-PRETTY%20%28MGL-PAX:ACCESSOR%20JOURNAL:PPRINT-JOURNAL%29"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L2029">[accessor]</a></span> <span class="reference-object"><a href="#JOURNAL:PPRINT-JOURNAL-PRETTY%20%28MGL-PAX:ACCESSOR%20JOURNAL:PPRINT-JOURNAL%29" >pprint-journal-pretty</a></span></span> <span class="locative-args">pprint-journal (:pretty = t)</span></span></p>

<p>Whether to use <a href="#JOURNAL:PPRINT-JOURNAL-PRETTIFIER%20%28MGL-PAX:ACCESSOR%20JOURNAL:PPRINT-JOURNAL%29" title="JOURNAL:PPRINT-JOURNAL-PRETTIFIER (MGL-PAX:ACCESSOR JOURNAL:PPRINT-JOURNAL)"><code>pprint-journal-prettifier</code></a> or write
events in as the property lists they are. A
<a href="#JOURNAL:@BOOLEAN-VALUED-SYMBOL%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@BOOLEAN-VALUED-SYMBOL MGL-PAX:GLOSSARY-TERM">boolean-valued symbol</a>.</p></li>
</ul>

<p><a id="x-28JOURNAL-3APPRINT-JOURNAL-PRETTIFIER-20-28MGL-PAX-3AACCESSOR-20JOURNAL-3APPRINT-JOURNAL-29-29"></a>
<a id="JOURNAL:PPRINT-JOURNAL-PRETTIFIER%20%28MGL-PAX:ACCESSOR%20JOURNAL:PPRINT-JOURNAL%29"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L2035">[accessor]</a></span> <span class="reference-object"><a href="#JOURNAL:PPRINT-JOURNAL-PRETTIFIER%20%28MGL-PAX:ACCESSOR%20JOURNAL:PPRINT-JOURNAL%29" >pprint-journal-prettifier</a></span></span> <span class="locative-args">pprint-journal (:prettifier = 'prettify-event)</span></span></p>

<p>A function like <a href="#JOURNAL:PRETTIFY-EVENT%20FUNCTION" title="JOURNAL:PRETTIFY-EVENT FUNCTION"><code>prettify-event</code></a> that writes an
event to a stream. Only used when <a href="#JOURNAL:PPRINT-JOURNAL-PRETTY%20%28MGL-PAX:ACCESSOR%20JOURNAL:PPRINT-JOURNAL%29" title="JOURNAL:PPRINT-JOURNAL-PRETTY (MGL-PAX:ACCESSOR JOURNAL:PPRINT-JOURNAL)"><code>pprint-journal-pretty</code></a>, this is
the output format customization knob. Also see <a href="#JOURNAL:@DECORATION%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@DECORATION MGL-PAX:GLOSSARY-TERM">decoration</a>s.</p></li>
</ul>

<p><a id="x-28JOURNAL-3A-40BUNDLES-REFERENCE-20MGL-PAX-3ASECTION-29"></a>
<a id="JOURNAL:@BUNDLES-REFERENCE%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#JOURNAL:@PPRINT-JOURNALS%20MGL-PAX:SECTION" title="Pretty-printing journals">&#8592;</a> <a href="journal-manual.html" title="Journal manual">&#8593;</a> <a href="#JOURNAL:@IN-MEMORY-BUNDLES%20MGL-PAX:SECTION" title="In-memory bundles">&#8594;</a> <a href="#JOURNAL:@BUNDLES-REFERENCE%20MGL-PAX:SECTION" title="Bundles reference">&#8634;</a> <a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L5550">&#955;</a></span></span></p>

<h2><a href="#JOURNAL:@BUNDLES-REFERENCE%20MGL-PAX:SECTION">15 Bundles reference</a></h2>

<p>In <a href="#JOURNAL:@BUNDLES%20MGL-PAX:SECTION" title="Bundles">Bundles</a>, we covered the repeated replay problem that
<a href="#JOURNAL:WITH-BUNDLE%20MGL-PAX:MACRO" title="JOURNAL:WITH-BUNDLE MGL-PAX:MACRO"><code>with-bundle</code></a> automates. Here, we provide a reference for the bundle
classes.</p>

<p><a id="x-28JOURNAL-3ABUNDLE-20CLASS-29"></a>
<a id="JOURNAL:BUNDLE%20CLASS"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L5560">[class]</a></span> <span class="reference-object"><a href="#JOURNAL:BUNDLE%20CLASS" >bundle</a></span></span></span></p>

<p>A <code>bundle</code> consists of a sequence of journals which
are all reruns of the same code, hopefully making more and more
progress towards completion. These journals are <a href="#JOURNAL:@REPLAY%20MGL-PAX:SECTION" title="Replay">Replay</a>s of the
previous successful one, extending it with new events. Upon
replay (see <a href="#JOURNAL:WITH-BUNDLE%20MGL-PAX:MACRO" title="JOURNAL:WITH-BUNDLE MGL-PAX:MACRO"><code>with-bundle</code></a>), the latest journal in the bundle in
<a href="#JOURNAL:JOURNAL-STATE%20TYPE" title="JOURNAL:JOURNAL-STATE TYPE"><code>journal-state</code></a> <code>:completed</code> plays the role of the replay journal, and a
new journal is added to the bundle for recording. If the replay
succeeds, this new journal eventually becomes <code>:completed</code> and takes
over the role of the replay journal for future replays until another
replay succeeds. When the bundle is created and it has no journals
yet, the replay journal is an empty, completed one.</p>

<p>This is an abstract base class. Direct subclasses are
<a href="#JOURNAL:IN-MEMORY-BUNDLE%20CLASS" title="JOURNAL:IN-MEMORY-BUNDLE CLASS"><code>in-memory-bundle</code></a> and <a href="#JOURNAL:FILE-BUNDLE%20CLASS" title="JOURNAL:FILE-BUNDLE CLASS"><code>file-bundle</code></a>.</p></li>
</ul>

<p><a id="x-28JOURNAL-3AMAX-N-FAILED-20-28MGL-PAX-3AACCESSOR-20JOURNAL-3ABUNDLE-29-29"></a>
<a id="JOURNAL:MAX-N-FAILED%20%28MGL-PAX:ACCESSOR%20JOURNAL:BUNDLE%29"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L5563">[accessor]</a></span> <span class="reference-object"><a href="#JOURNAL:MAX-N-FAILED%20%28MGL-PAX:ACCESSOR%20JOURNAL:BUNDLE%29" >max-n-failed</a></span></span> <span class="locative-args">bundle (:max-n-failed = 1)</span></span></p>

<p>If <code>max-n-failed</code> is non-NIL, and the number of
journals of <a href="#JOURNAL:JOURNAL-STATE%20TYPE" title="JOURNAL:JOURNAL-STATE TYPE"><code>journal-state</code></a> <code>:failed</code> in the bundle exceeds
its value, then some journals (starting with the oldest) are
deleted.</p></li>
</ul>

<p><a id="x-28JOURNAL-3AMAX-N-COMPLETED-20-28MGL-PAX-3AACCESSOR-20JOURNAL-3ABUNDLE-29-29"></a>
<a id="JOURNAL:MAX-N-COMPLETED%20%28MGL-PAX:ACCESSOR%20JOURNAL:BUNDLE%29"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L5569">[accessor]</a></span> <span class="reference-object"><a href="#JOURNAL:MAX-N-COMPLETED%20%28MGL-PAX:ACCESSOR%20JOURNAL:BUNDLE%29" >max-n-completed</a></span></span> <span class="locative-args">bundle (:max-n-completed = 1)</span></span></p>

<p>If <code>max-n-completed</code> is non-NIL, and the number of
journals of <a href="#JOURNAL:JOURNAL-STATE%20TYPE" title="JOURNAL:JOURNAL-STATE TYPE"><code>journal-state</code></a> <code>:completed</code> in the bundle exceeds
its value, then some journals (starting with the oldest) are
deleted.</p></li>
</ul>

<p><a id="x-28JOURNAL-3A-40IN-MEMORY-BUNDLES-20MGL-PAX-3ASECTION-29"></a>
<a id="JOURNAL:@IN-MEMORY-BUNDLES%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#JOURNAL:@BUNDLES-REFERENCE%20MGL-PAX:SECTION" title="Bundles reference">&#8592;</a> <a href="#JOURNAL:@BUNDLES-REFERENCE%20MGL-PAX:SECTION" title="Bundles reference">&#8593;</a> <a href="#JOURNAL:@FILE-BUNDLES%20MGL-PAX:SECTION" title="File bundles">&#8594;</a> <a href="#JOURNAL:@IN-MEMORY-BUNDLES%20MGL-PAX:SECTION" title="In-memory bundles">&#8634;</a> <a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L5668">&#955;</a></span></span></p>

<h3><a href="#JOURNAL:@IN-MEMORY-BUNDLES%20MGL-PAX:SECTION">15.1 In-memory bundles</a></h3>

<p><a id="x-28JOURNAL-3AIN-MEMORY-BUNDLE-20CLASS-29"></a>
<a id="JOURNAL:IN-MEMORY-BUNDLE%20CLASS"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L5672">[class]</a></span> <span class="reference-object"><a href="#JOURNAL:IN-MEMORY-BUNDLE%20CLASS" >in-memory-bundle</a></span></span> <span class="locative-args"><a href="#JOURNAL:BUNDLE%20CLASS" title="JOURNAL:BUNDLE CLASS">bundle</a></span></span></p>

<p>An <code>in-memory-bundle</code> is a <a href="#JOURNAL:BUNDLE%20CLASS" title="JOURNAL:BUNDLE CLASS"><code>bundle</code></a> that is built on
<a href="#JOURNAL:IN-MEMORY-JOURNAL%20CLASS" title="JOURNAL:IN-MEMORY-JOURNAL CLASS"><code>in-memory-journal</code></a>s. <code>in-memory-bundle</code>s have limited utility as a
persistence mechanism and are provided mainly for reasons of
symmetry and for testing. See
<a href="#JOURNAL:@SYNCHRONIZATION-WITH-IN-MEMORY-JOURNALS%20MGL-PAX:SECTION" title="Synchronization with in-memory journals">Synchronization with in-memory journals</a> for an example of how to
achieve persistence without bundles.</p></li>
</ul>

<p><a id="x-28JOURNAL-3AMAKE-IN-MEMORY-BUNDLE-20FUNCTION-29"></a>
<a id="JOURNAL:MAKE-IN-MEMORY-BUNDLE%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L5682">[function]</a></span> <span class="reference-object"><a href="#JOURNAL:MAKE-IN-MEMORY-BUNDLE%20FUNCTION" >make-in-memory-bundle</a></span></span> <span class="locative-args">&amp;key (max-n-failed 1) (max-n-completed 1) sync sync-fn</span></span></p>

<p>Create a new <a href="#JOURNAL:IN-MEMORY-BUNDLE%20CLASS" title="JOURNAL:IN-MEMORY-BUNDLE CLASS"><code>in-memory-bundle</code></a> with <a href="#JOURNAL:MAX-N-FAILED%20%28MGL-PAX:ACCESSOR%20JOURNAL:BUNDLE%29" title="JOURNAL:MAX-N-FAILED (MGL-PAX:ACCESSOR JOURNAL:BUNDLE)"><code>max-n-failed</code></a> and <a href="#JOURNAL:MAX-N-COMPLETED%20%28MGL-PAX:ACCESSOR%20JOURNAL:BUNDLE%29" title="JOURNAL:MAX-N-COMPLETED (MGL-PAX:ACCESSOR JOURNAL:BUNDLE)"><code>max-n-completed</code></a>. <code>sync</code> and <code>sync-fn</code>
are passed on to <a href="#JOURNAL:MAKE-IN-MEMORY-JOURNAL%20FUNCTION" title="JOURNAL:MAKE-IN-MEMORY-JOURNAL FUNCTION"><code>make-in-memory-journal</code></a>.</p></li>
</ul>

<p><a id="x-28JOURNAL-3A-40FILE-BUNDLES-20MGL-PAX-3ASECTION-29"></a>
<a id="JOURNAL:@FILE-BUNDLES%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#JOURNAL:@IN-MEMORY-BUNDLES%20MGL-PAX:SECTION" title="In-memory bundles">&#8592;</a> <a href="#JOURNAL:@BUNDLES-REFERENCE%20MGL-PAX:SECTION" title="Bundles reference">&#8593;</a> <a href="#JOURNAL:@STREAMLETS-REFERENCE%20MGL-PAX:SECTION" title="Streamlets reference">&#8594;</a> <a href="#JOURNAL:@FILE-BUNDLES%20MGL-PAX:SECTION" title="File bundles">&#8634;</a> <a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L5702">&#955;</a></span></span></p>

<h3><a href="#JOURNAL:@FILE-BUNDLES%20MGL-PAX:SECTION">15.2 File bundles</a></h3>

<p><a id="x-28JOURNAL-3AFILE-BUNDLE-20CLASS-29"></a>
<a id="JOURNAL:FILE-BUNDLE%20CLASS"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L5708">[class]</a></span> <span class="reference-object"><a href="#JOURNAL:FILE-BUNDLE%20CLASS" >file-bundle</a></span></span> <span class="locative-args"><a href="#JOURNAL:BUNDLE%20CLASS" title="JOURNAL:BUNDLE CLASS">bundle</a></span></span></p>

<p>A <code>file-bundle</code> is a <a href="#JOURNAL:BUNDLE%20CLASS" title="JOURNAL:BUNDLE CLASS"><code>bundle</code></a> that is built on
<a href="#JOURNAL:FILE-JOURNAL%20CLASS" title="JOURNAL:FILE-JOURNAL CLASS"><code>file-journal</code></a>s. It provides easy replay-based persistence.</p></li>
</ul>

<p><a id="x-28JOURNAL-3ADIRECTORY-OF-20-28MGL-PAX-3AREADER-20JOURNAL-3AFILE-BUNDLE-29-29"></a>
<a id="JOURNAL:DIRECTORY-OF%20%28MGL-PAX:READER%20JOURNAL:FILE-BUNDLE%29"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L5709">[reader]</a></span> <span class="reference-object"><a href="#JOURNAL:DIRECTORY-OF%20%28MGL-PAX:READER%20JOURNAL:FILE-BUNDLE%29" >directory-of</a></span></span> <span class="locative-args">file-bundle (:directory)</span></span></p>

<p>The directory where the files backing the
<a href="#JOURNAL:FILE-JOURNAL%20CLASS" title="JOURNAL:FILE-JOURNAL CLASS"><code>file-journal</code></a>s in the <a href="#JOURNAL:FILE-BUNDLE%20CLASS" title="JOURNAL:FILE-BUNDLE CLASS"><code>file-bundle</code></a> are kept.</p></li>
</ul>

<p><a id="x-28JOURNAL-3AMAKE-FILE-BUNDLE-20FUNCTION-29"></a>
<a id="JOURNAL:MAKE-FILE-BUNDLE%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L5727">[function]</a></span> <span class="reference-object"><a href="#JOURNAL:MAKE-FILE-BUNDLE%20FUNCTION" >make-file-bundle</a></span></span> <span class="locative-args">directory &amp;key (max-n-failed 1) (max-n-completed 1) sync</span></span></p>

<p>Return a <a href="#JOURNAL:FILE-BUNDLE%20CLASS" title="JOURNAL:FILE-BUNDLE CLASS"><code>file-bundle</code></a> object backed by <a href="#JOURNAL:FILE-JOURNAL%20CLASS" title="JOURNAL:FILE-JOURNAL CLASS"><code>file-journal</code></a>s in <code>directory</code>.
See <a href="#JOURNAL:MAX-N-FAILED%20%28MGL-PAX:ACCESSOR%20JOURNAL:BUNDLE%29" title="JOURNAL:MAX-N-FAILED (MGL-PAX:ACCESSOR JOURNAL:BUNDLE)"><code>max-n-failed</code></a> and
<a href="#JOURNAL:MAX-N-COMPLETED%20%28MGL-PAX:ACCESSOR%20JOURNAL:BUNDLE%29" title="JOURNAL:MAX-N-COMPLETED (MGL-PAX:ACCESSOR JOURNAL:BUNDLE)"><code>max-n-completed</code></a>. For a description of <code>sync</code>, see
<a href="#JOURNAL:@SYNCHRONIZATION-STRATEGIES%20MGL-PAX:SECTION" title="Synchronization strategies">Synchronization strategies</a>.</p>

<p>If there is already a <code>file-bundle</code> with the same directory (according
to <a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_tn.htm" title="TRUENAME FUNCTION"><code>truename</code></a>), return that object is returned if it has the same
<code>max-n-failed</code>, <code>max-n-completed</code> and <code>sync</code> options, else <a href="#JOURNAL:JOURNAL-ERROR%20CONDITION" title="JOURNAL:JOURNAL-ERROR CONDITION"><code>journal-error</code></a>
is signalled.</p></li>
</ul>

<p><a id="x-28JOURNAL-3ADELETE-FILE-BUNDLE-20FUNCTION-29"></a>
<a id="JOURNAL:DELETE-FILE-BUNDLE%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L5791">[function]</a></span> <span class="reference-object"><a href="#JOURNAL:DELETE-FILE-BUNDLE%20FUNCTION" >delete-file-bundle</a></span></span> <span class="locative-args">directory</span></span></p>

<p>Delete all journal files (<code>*.jrn</code>) from <code>directory</code>. Delete the
directory if empty after the journal files were deleted, else signal
an error. Existing <a href="#JOURNAL:FILE-BUNDLE%20CLASS" title="JOURNAL:FILE-BUNDLE CLASS"><code>file-bundle</code></a> objects are not updated, so
<a href="#JOURNAL:MAKE-FILE-JOURNAL%20FUNCTION" title="JOURNAL:MAKE-FILE-JOURNAL FUNCTION"><code>make-file-journal</code></a> with FORCE-RELOAD may be required.</p></li>
</ul>

<p><a id="x-28JOURNAL-3A-40STREAMLETS-REFERENCE-20MGL-PAX-3ASECTION-29"></a>
<a id="JOURNAL:@STREAMLETS-REFERENCE%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#JOURNAL:@FILE-BUNDLES%20MGL-PAX:SECTION" title="File bundles">&#8592;</a> <a href="journal-manual.html" title="Journal manual">&#8593;</a> <a href="#JOURNAL:@OPENING-AND-CLOSING%20MGL-PAX:SECTION" title="Opening and closing">&#8594;</a> <a href="#JOURNAL:@STREAMLETS-REFERENCE%20MGL-PAX:SECTION" title="Streamlets reference">&#8634;</a> <a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L568">&#955;</a></span></span></p>

<h2><a href="#JOURNAL:@STREAMLETS-REFERENCE%20MGL-PAX:SECTION">16 Streamlets reference</a></h2>

<p>This section is relevant mostly for implementing new kinds of
<a href="#JOURNAL:JOURNAL%20CLASS" title="JOURNAL:JOURNAL CLASS"><code>journal</code></a>s in addition to <a href="#JOURNAL:FILE-JOURNAL%20CLASS" title="JOURNAL:FILE-JOURNAL CLASS"><code>file-journal</code></a>s and <a href="#JOURNAL:IN-MEMORY-JOURNAL%20CLASS" title="JOURNAL:IN-MEMORY-JOURNAL CLASS"><code>in-memory-journal</code></a>s. In
normal operation, <a href="#JOURNAL:STREAMLET%20CLASS" title="JOURNAL:STREAMLET CLASS"><code>streamlet</code></a>s are not worked with directly.</p>

<p><a id="x-28JOURNAL-3A-40OPENING-AND-CLOSING-20MGL-PAX-3ASECTION-29"></a>
<a id="JOURNAL:@OPENING-AND-CLOSING%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#JOURNAL:@STREAMLETS-REFERENCE%20MGL-PAX:SECTION" title="Streamlets reference">&#8592;</a> <a href="#JOURNAL:@STREAMLETS-REFERENCE%20MGL-PAX:SECTION" title="Streamlets reference">&#8593;</a> <a href="#JOURNAL:@READING-FROM-STREAMLETS%20MGL-PAX:SECTION" title="Reading from streamlets">&#8594;</a> <a href="#JOURNAL:@OPENING-AND-CLOSING%20MGL-PAX:SECTION" title="Opening and closing">&#8634;</a> <a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L576">&#955;</a></span></span></p>

<h3><a href="#JOURNAL:@OPENING-AND-CLOSING%20MGL-PAX:SECTION">16.1 Opening and closing</a></h3>

<p><a id="x-28JOURNAL-3ASTREAMLET-20CLASS-29"></a>
<a id="JOURNAL:STREAMLET%20CLASS"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L588">[class]</a></span> <span class="reference-object"><a href="#JOURNAL:STREAMLET%20CLASS" >streamlet</a></span></span></span></p>

<p>A <code>streamlet</code> is a handle to perform I/O on a
<a href="#JOURNAL:JOURNAL%20CLASS" title="JOURNAL:JOURNAL CLASS"><code>journal</code></a>. The high-level stuff (<a href="#JOURNAL:WITH-JOURNALING%20MGL-PAX:MACRO" title="JOURNAL:WITH-JOURNALING MGL-PAX:MACRO"><code>with-journaling</code></a>, <a href="#JOURNAL:JOURNALED%20MGL-PAX:MACRO" title="JOURNAL:JOURNALED MGL-PAX:MACRO"><code>journaled</code></a>, etc) is
built on top of streamlets.</p></li>
</ul>

<p><a id="x-28JOURNAL-3AJOURNAL-20-28MGL-PAX-3AREADER-20JOURNAL-3ASTREAMLET-29-29"></a>
<a id="JOURNAL:JOURNAL%20%28MGL-PAX:READER%20JOURNAL:STREAMLET%29"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L589">[reader]</a></span> <span class="reference-object"><a href="#JOURNAL:JOURNAL%20%28MGL-PAX:READER%20JOURNAL:STREAMLET%29" >journal</a></span></span> <span class="locative-args">streamlet (:journal)</span></span></p>

<p>The <code>journal</code> that was passed to <a href="#JOURNAL:OPEN-STREAMLET%20GENERIC-FUNCTION" title="JOURNAL:OPEN-STREAMLET GENERIC-FUNCTION"><code>open-streamlet</code></a>.
This is the journal <code>streamlet</code> operates on.</p></li>
</ul>

<p><a id="x-28JOURNAL-3AOPEN-STREAMLET-20GENERIC-FUNCTION-29"></a>
<a id="JOURNAL:OPEN-STREAMLET%20GENERIC-FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L633">[generic-function]</a></span> <span class="reference-object"><a href="#JOURNAL:OPEN-STREAMLET%20GENERIC-FUNCTION" >open-streamlet</a></span></span> <span class="locative-args">journal &amp;key direction</span></span></p>

<p>Return a <a href="#JOURNAL:STREAMLET%20CLASS" title="JOURNAL:STREAMLET CLASS"><code>streamlet</code></a> suitable for performing I/O on
<code>journal</code>. <code>direction</code> (defaults to <code>:input</code>) is one of <code>:input</code>, <code>:output</code>,
<code>:io</code>, and it has the same purpose as the similarly named argument of
<a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_open.htm" title="OPEN FUNCTION"><code>cl:open</code></a>.</p></li>
</ul>

<p><a id="x-28JOURNAL-3ACLOSE-STREAMLET-20GENERIC-FUNCTION-29"></a>
<a id="JOURNAL:CLOSE-STREAMLET%20GENERIC-FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L680">[generic-function]</a></span> <span class="reference-object"><a href="#JOURNAL:CLOSE-STREAMLET%20GENERIC-FUNCTION" >close-streamlet</a></span></span> <span class="locative-args">streamlet</span></span></p>

<p>Close <code>streamlet</code>, which was returned by
<a href="#JOURNAL:OPEN-STREAMLET%20GENERIC-FUNCTION" title="JOURNAL:OPEN-STREAMLET GENERIC-FUNCTION"><code>open-streamlet</code></a>. After closing, <code>streamlet</code> may not longer be used for
IO.</p></li>
</ul>

<p><a id="x-28JOURNAL-3AMAKE-STREAMLET-FINALIZER-20GENERIC-FUNCTION-29"></a>
<a id="JOURNAL:MAKE-STREAMLET-FINALIZER%20GENERIC-FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L694">[generic-function]</a></span> <span class="reference-object"><a href="#JOURNAL:MAKE-STREAMLET-FINALIZER%20GENERIC-FUNCTION" >make-streamlet-finalizer</a></span></span> <span class="locative-args">streamlet</span></span></p>

<p>Return <code>nil</code> or a function of no arguments suitable
as a finalizer for <code>streamlet</code>. That is, a function that closes
<code>streamlet</code> but holds no reference to it. This is intended for
streamlets that are not dynamic-extent, so using <a href="#JOURNAL:WITH-OPEN-JOURNAL%20MGL-PAX:MACRO" title="JOURNAL:WITH-OPEN-JOURNAL MGL-PAX:MACRO"><code>with-open-journal</code></a>
is not appropriate.</p></li>
</ul>

<p><a id="x-28JOURNAL-3AOPEN-STREAMLET-P-20GENERIC-FUNCTION-29"></a>
<a id="JOURNAL:OPEN-STREAMLET-P%20GENERIC-FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L701">[generic-function]</a></span> <span class="reference-object"><a href="#JOURNAL:OPEN-STREAMLET-P%20GENERIC-FUNCTION" >open-streamlet-p</a></span></span> <span class="locative-args">streamlet</span></span></p>

<p>Return true if <code>streamlet</code> is open. <code>streamlet</code>s are
open until they have been explicitly closed with <a href="#JOURNAL:CLOSE-STREAMLET%20GENERIC-FUNCTION" title="JOURNAL:CLOSE-STREAMLET GENERIC-FUNCTION"><code>close-streamlet</code></a>.</p></li>
</ul>

<p><a id="x-28JOURNAL-3AINPUT-STREAMLET-P-20FUNCTION-29"></a>
<a id="JOURNAL:INPUT-STREAMLET-P%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L620">[function]</a></span> <span class="reference-object"><a href="#JOURNAL:INPUT-STREAMLET-P%20FUNCTION" >input-streamlet-p</a></span></span> <span class="locative-args">streamlet</span></span></p>

<p>See if <code>streamlet</code> was opened for input (the <code>direction</code> argument of
<a href="#JOURNAL:OPEN-STREAMLET%20GENERIC-FUNCTION" title="JOURNAL:OPEN-STREAMLET GENERIC-FUNCTION"><code>open-streamlet</code></a> was <code>:input</code> or <code>:io</code>).</p></li>
</ul>

<p><a id="x-28JOURNAL-3AOUTPUT-STREAMLET-P-20FUNCTION-29"></a>
<a id="JOURNAL:OUTPUT-STREAMLET-P%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L628">[function]</a></span> <span class="reference-object"><a href="#JOURNAL:OUTPUT-STREAMLET-P%20FUNCTION" >output-streamlet-p</a></span></span> <span class="locative-args">streamlet</span></span></p>

<p>See if <code>streamlet</code> was opened for input (the <code>direction</code> argument of
<a href="#JOURNAL:OPEN-STREAMLET%20GENERIC-FUNCTION" title="JOURNAL:OPEN-STREAMLET GENERIC-FUNCTION"><code>open-streamlet</code></a> was <code>:output</code> or <code>:io</code>).</p></li>
</ul>

<p><a id="x-28JOURNAL-3AWITH-OPEN-JOURNAL-20MGL-PAX-3AMACRO-29"></a>
<a id="JOURNAL:WITH-OPEN-JOURNAL%20MGL-PAX:MACRO"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L707">[macro]</a></span> <span class="reference-object"><a href="#JOURNAL:WITH-OPEN-JOURNAL%20MGL-PAX:MACRO" >with-open-journal</a></span></span> <span class="locative-args">(var journal &amp;key (direction :input)) &amp;body body</span></span></p>

<p>This is like <a href="http://www.lispworks.com/documentation/HyperSpec/Body/m_w_open.htm" title="WITH-OPEN-FILE MGL-PAX:MACRO"><code>with-open-file</code></a> but for <code>journal</code>s.
Open the journal designated by <code>journal</code> (see <a href="#JOURNAL:TO-JOURNAL%20GENERIC-FUNCTION" title="JOURNAL:TO-JOURNAL GENERIC-FUNCTION"><code>to-journal</code></a>) with
<a href="#JOURNAL:OPEN-STREAMLET%20GENERIC-FUNCTION" title="JOURNAL:OPEN-STREAMLET GENERIC-FUNCTION"><code>open-streamlet</code></a>, passing <code>direction</code> along, and bind <code>var</code> to the
resulting <a href="#JOURNAL:STREAMLET%20CLASS" title="JOURNAL:STREAMLET CLASS"><code>streamlet</code></a>. Call <a href="#JOURNAL:CLOSE-STREAMLET%20GENERIC-FUNCTION" title="JOURNAL:CLOSE-STREAMLET GENERIC-FUNCTION"><code>close-streamlet</code></a> after <code>body</code> finishes. If
<code>journal</code> is <code>nil</code>, then <code>var</code> is bound to <code>nil</code> and no streamlet is
created.</p></li>
</ul>

<p><a id="x-28JOURNAL-3ASTREAMLET-ERROR-20CONDITION-29"></a>
<a id="JOURNAL:STREAMLET-ERROR%20CONDITION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L736">[condition]</a></span> <span class="reference-object"><a href="#JOURNAL:STREAMLET-ERROR%20CONDITION" >streamlet-error</a></span></span> <span class="locative-args"><a href="http://www.lispworks.com/documentation/HyperSpec/Body/e_error.htm" title="ERROR CONDITION">error</a></span></span></p>

<p>Like <a href="http://www.lispworks.com/documentation/HyperSpec/Body/e_stm_er.htm" title="STREAM-ERROR CONDITION"><code>cl:stream-error:</code></a> failures pertaining to I/O on
a closed <a href="#JOURNAL:STREAMLET%20CLASS" title="JOURNAL:STREAMLET CLASS"><code>streamlet</code></a> or of the wrong <code>direction</code>. Actual I/O errors are
<em>not</em> encapsulated in <code>streamlet-error</code>.</p></li>
</ul>

<p><a id="x-28JOURNAL-3A-40READING-FROM-STREAMLETS-20MGL-PAX-3ASECTION-29"></a>
<a id="JOURNAL:@READING-FROM-STREAMLETS%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#JOURNAL:@OPENING-AND-CLOSING%20MGL-PAX:SECTION" title="Opening and closing">&#8592;</a> <a href="#JOURNAL:@STREAMLETS-REFERENCE%20MGL-PAX:SECTION" title="Streamlets reference">&#8593;</a> <a href="#JOURNAL:@WRITING-TO-STREAMLETS%20MGL-PAX:SECTION" title="Writing to streamlets">&#8594;</a> <a href="#JOURNAL:@READING-FROM-STREAMLETS%20MGL-PAX:SECTION" title="Reading from streamlets">&#8634;</a> <a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L760">&#955;</a></span></span></p>

<h3><a href="#JOURNAL:@READING-FROM-STREAMLETS%20MGL-PAX:SECTION">16.2 Reading from streamlets</a></h3>

<p><a id="x-28JOURNAL-3AREAD-EVENT-20GENERIC-FUNCTION-29"></a>
<a id="JOURNAL:READ-EVENT%20GENERIC-FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L768">[generic-function]</a></span> <span class="reference-object"><a href="#JOURNAL:READ-EVENT%20GENERIC-FUNCTION" >read-event</a></span></span> <span class="locative-args">streamlet &amp;optional eoj-error-p</span></span></p>

<p>Read the event at the current read position from
<code>streamlet</code>, and move the read position to the event after. If there
are no more events, signal <a href="#JOURNAL:END-OF-JOURNAL%20CONDITION" title="JOURNAL:END-OF-JOURNAL CONDITION"><code>end-of-journal</code></a> or return <code>nil</code> depending on
<code>eoj-error-p</code>. Signals <a href="#JOURNAL:STREAMLET-ERROR%20CONDITION" title="JOURNAL:STREAMLET-ERROR CONDITION"><code>streamlet-error</code></a> if <code>streamlet</code> is not
<a href="#JOURNAL:INPUT-STREAMLET-P%20FUNCTION" title="JOURNAL:INPUT-STREAMLET-P FUNCTION"><code>input-streamlet-p</code></a> or not <a href="#JOURNAL:OPEN-STREAMLET-P%20GENERIC-FUNCTION" title="JOURNAL:OPEN-STREAMLET-P GENERIC-FUNCTION"><code>open-streamlet-p</code></a>.</p></li>
</ul>

<p><a id="x-28JOURNAL-3AREAD-POSITION-20GENERIC-FUNCTION-29"></a>
<a id="JOURNAL:READ-POSITION%20GENERIC-FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L788">[generic-function]</a></span> <span class="reference-object"><a href="#JOURNAL:READ-POSITION%20GENERIC-FUNCTION" >read-position</a></span></span> <span class="locative-args">streamlet</span></span></p>

<p>Return an integer that identifies the position of
the next event to be read from <code>streamlet</code>. <a href="http://www.lispworks.com/documentation/HyperSpec/Body/m_setf.htm" title="SETF MGL-PAX:MACRO"><code>setf</code></a>able, see
<a href="#JOURNAL:SET-READ-POSITION%20GENERIC-FUNCTION" title="JOURNAL:SET-READ-POSITION GENERIC-FUNCTION"><code>set-read-position</code></a>.</p></li>
</ul>

<p><a id="x-28JOURNAL-3ASET-READ-POSITION-20GENERIC-FUNCTION-29"></a>
<a id="JOURNAL:SET-READ-POSITION%20GENERIC-FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L793">[generic-function]</a></span> <span class="reference-object"><a href="#JOURNAL:SET-READ-POSITION%20GENERIC-FUNCTION" >set-read-position</a></span></span> <span class="locative-args">streamlet position</span></span></p>

<p>Set the read position of <code>streamlet</code> to <code>position</code>,
which must have been acquired from <a href="#JOURNAL:READ-POSITION%20GENERIC-FUNCTION" title="JOURNAL:READ-POSITION GENERIC-FUNCTION"><code>read-position</code></a>.</p></li>
</ul>

<p><a id="x-28JOURNAL-3ASAVE-EXCURSION-20MGL-PAX-3AMACRO-29"></a>
<a id="JOURNAL:SAVE-EXCURSION%20MGL-PAX:MACRO"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L799">[macro]</a></span> <span class="reference-object"><a href="#JOURNAL:SAVE-EXCURSION%20MGL-PAX:MACRO" >save-excursion</a></span></span> <span class="locative-args">(streamlet) &amp;body body</span></span></p>

<p>Save <a href="#JOURNAL:READ-POSITION%20GENERIC-FUNCTION" title="JOURNAL:READ-POSITION GENERIC-FUNCTION"><code>read-position</code></a> of <code>streamlet</code>, execute <code>body</code>, and make sure to
restore the saved read position.</p></li>
</ul>

<p><a id="x-28JOURNAL-3APEEK-EVENT-20GENERIC-FUNCTION-29"></a>
<a id="JOURNAL:PEEK-EVENT%20GENERIC-FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L811">[generic-function]</a></span> <span class="reference-object"><a href="#JOURNAL:PEEK-EVENT%20GENERIC-FUNCTION" >peek-event</a></span></span> <span class="locative-args">streamlet</span></span></p>

<p>Read the next event from <code>streamlet</code> without changing
the read position, or return <code>nil</code> if there is no event to be read.</p></li>
</ul>

<p><a id="x-28JOURNAL-3APEEK-EVENT-20-28METHOD-20NIL-20-28JOURNAL-3ASTREAMLET-29-29-29"></a>
<a id="JOURNAL:PEEK-EVENT%20%28METHOD%20NIL%20%28JOURNAL:STREAMLET%29%29"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L811">[method]</a></span> <span class="reference-object"><a href="#JOURNAL:PEEK-EVENT%20%28METHOD%20NIL%20%28JOURNAL:STREAMLET%29%29" >peek-event</a></span></span> <span class="locative-args">(streamlet streamlet)</span></span></p>

<p>This is a slow default implementation, which relies on
<a href="#JOURNAL:SAVE-EXCURSION%20MGL-PAX:MACRO" title="JOURNAL:SAVE-EXCURSION MGL-PAX:MACRO"><code>save-excursion</code></a> and <a href="#JOURNAL:READ-EVENT%20GENERIC-FUNCTION" title="JOURNAL:READ-EVENT GENERIC-FUNCTION"><code>read-event</code></a>.</p></li>
</ul>

<p><a id="x-28JOURNAL-3A-40WRITING-TO-STREAMLETS-20MGL-PAX-3ASECTION-29"></a>
<a id="JOURNAL:@WRITING-TO-STREAMLETS%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#JOURNAL:@READING-FROM-STREAMLETS%20MGL-PAX:SECTION" title="Reading from streamlets">&#8592;</a> <a href="#JOURNAL:@STREAMLETS-REFERENCE%20MGL-PAX:SECTION" title="Streamlets reference">&#8593;</a> <a href="#JOURNAL:@JOURNAL%2FGLOSSARY%20MGL-PAX:SECTION" title="Glossary">&#8594;</a> <a href="#JOURNAL:@WRITING-TO-STREAMLETS%20MGL-PAX:SECTION" title="Writing to streamlets">&#8634;</a> <a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L821">&#955;</a></span></span></p>

<h3><a href="#JOURNAL:@WRITING-TO-STREAMLETS%20MGL-PAX:SECTION">16.3 Writing to streamlets</a></h3>

<p><a id="x-28JOURNAL-3AWRITE-EVENT-20GENERIC-FUNCTION-29"></a>
<a id="JOURNAL:WRITE-EVENT%20GENERIC-FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L828">[generic-function]</a></span> <span class="reference-object"><a href="#JOURNAL:WRITE-EVENT%20GENERIC-FUNCTION" >write-event</a></span></span> <span class="locative-args">event streamlet</span></span></p>

<p>Write <code>event</code> to <code>streamlet</code>.
Writing always happens at the end of <code>streamlet</code>'s journal regardless
of the <a href="#JOURNAL:READ-POSITION%20GENERIC-FUNCTION" title="JOURNAL:READ-POSITION GENERIC-FUNCTION"><code>read-position</code></a>, and the read position is not changed. Signals
<a href="#JOURNAL:STREAMLET-ERROR%20CONDITION" title="JOURNAL:STREAMLET-ERROR CONDITION"><code>streamlet-error</code></a> if <code>streamlet</code> is not <a href="#JOURNAL:OUTPUT-STREAMLET-P%20FUNCTION" title="JOURNAL:OUTPUT-STREAMLET-P FUNCTION"><code>output-streamlet-p</code></a> or not
<a href="#JOURNAL:OPEN-STREAMLET-P%20GENERIC-FUNCTION" title="JOURNAL:OPEN-STREAMLET-P GENERIC-FUNCTION"><code>open-streamlet-p</code></a>.</p></li>
</ul>

<p><a id="x-28JOURNAL-3AWRITE-EVENT-20-28METHOD-20NIL-20-28T-20JOURNAL-3AJOURNAL-29-29-29"></a>
<a id="JOURNAL:WRITE-EVENT%20%28METHOD%20NIL%20%28T%20JOURNAL:JOURNAL%29%29"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L828">[method]</a></span> <span class="reference-object"><a href="#JOURNAL:WRITE-EVENT%20%28METHOD%20NIL%20%28T%20JOURNAL:JOURNAL%29%29" >write-event</a></span></span> <span class="locative-args">event (journal journal)</span></span></p>

<p>For convenience, it is possible to write directly to a <code>journal</code>,
in which case the journal's internal output streamlet is used.
This internal streamlet is opened for <code>:output</code> and may be used by
<a href="#JOURNAL:@LOG-RECORD%20MGL-PAX:SECTION" title="`:log-record`"><code>:log-record</code></a>.</p></li>
</ul>

<p><a id="x-28JOURNAL-3AWRITE-POSITION-20GENERIC-FUNCTION-29"></a>
<a id="JOURNAL:WRITE-POSITION%20GENERIC-FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L861">[generic-function]</a></span> <span class="reference-object"><a href="#JOURNAL:WRITE-POSITION%20GENERIC-FUNCTION" >write-position</a></span></span> <span class="locative-args">streamlet</span></span></p>

<p>Return an integer that identifies the position of
the next event to be written to <code>streamlet</code>.</p></li>
</ul>

<p><a id="x-28JOURNAL-3AREQUEST-COMPLETED-ON-ABORT-20GENERIC-FUNCTION-29"></a>
<a id="JOURNAL:REQUEST-COMPLETED-ON-ABORT%20GENERIC-FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L871">[generic-function]</a></span> <span class="reference-object"><a href="#JOURNAL:REQUEST-COMPLETED-ON-ABORT%20GENERIC-FUNCTION" >request-completed-on-abort</a></span></span> <span class="locative-args">streamlet</span></span></p>

<p>Make it so that upon <a href="#JOURNAL:@ABORTED-EXECUTION%20MGL-PAX:GLOSSARY-TERM" title="JOURNAL:@ABORTED-EXECUTION MGL-PAX:GLOSSARY-TERM">aborted execution</a>,
<code>streamlet</code>'s <a href="#JOURNAL:JOURNAL%20CLASS" title="JOURNAL:JOURNAL CLASS"><code>journal</code></a> will be in <a href="#JOURNAL:JOURNAL-STATE%20TYPE" title="JOURNAL:JOURNAL-STATE TYPE"><code>journal-state</code></a> <code>:completed</code> when loaded
fresh (e.g. when creating a <a href="#JOURNAL:FILE-JOURNAL%20CLASS" title="JOURNAL:FILE-JOURNAL CLASS"><code>file-journal</code></a> with an existing file). Any
previously written events must be persisted before making this
change. Before <code>request-completed-on-abort</code> is called, a journal must
be reloaded in state <code>:failed</code>.</p>

<p>It is permissible to defer carrying out this request until the next
<a href="#JOURNAL:SYNC-STREAMLET%20GENERIC-FUNCTION" title="JOURNAL:SYNC-STREAMLET GENERIC-FUNCTION"><code>sync-streamlet</code></a> call. If the request was carried out, return true. If
it was deferred, return <code>nil</code>.</p></li>
</ul>

<p><a id="x-28JOURNAL-3ASYNC-STREAMLET-20GENERIC-FUNCTION-29"></a>
<a id="JOURNAL:SYNC-STREAMLET%20GENERIC-FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L887">[generic-function]</a></span> <span class="reference-object"><a href="#JOURNAL:SYNC-STREAMLET%20GENERIC-FUNCTION" >sync-streamlet</a></span></span> <span class="locative-args">streamlet</span></span></p>

<p>Durably persist the effects of all preceding
<a href="#JOURNAL:WRITE-EVENT%20GENERIC-FUNCTION" title="JOURNAL:WRITE-EVENT GENERIC-FUNCTION"><code>write-event</code></a> calls made via <code>streamlet</code> to its journal and any deferred
<a href="#JOURNAL:REQUEST-COMPLETED-ON-ABORT%20GENERIC-FUNCTION" title="JOURNAL:REQUEST-COMPLETED-ON-ABORT GENERIC-FUNCTION"><code>request-completed-on-abort</code></a> in this order.</p></li>
</ul>

<p><a id="x-28JOURNAL-3A-40JOURNAL-2FGLOSSARY-20MGL-PAX-3ASECTION-29"></a>
<a id="JOURNAL:@JOURNAL%2FGLOSSARY%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#JOURNAL:@WRITING-TO-STREAMLETS%20MGL-PAX:SECTION" title="Writing to streamlets">&#8592;</a> <a href="journal-manual.html" title="Journal manual">&#8593;</a> <a href="#JOURNAL:@JOURNAL%2FGLOSSARY%20MGL-PAX:SECTION" title="Glossary">&#8634;</a> <a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L5821">&#955;</a></span></span></p>

<h2><a href="#JOURNAL:@JOURNAL%2FGLOSSARY%20MGL-PAX:SECTION">17 Glossary</a></h2>

<p><a id="x-28JOURNAL-3A-40ASYNC-UNWIND-20MGL-PAX-3AGLOSSARY-TERM-29"></a>
<a id="JOURNAL:@ASYNC-UNWIND%20MGL-PAX:GLOSSARY-TERM"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L5827">[glossary-term]</a></span> <span class="reference-object"><a href="#JOURNAL:@ASYNC-UNWIND%20MGL-PAX:GLOSSARY-TERM" >async-unwind</a></span></span></span></p>

<p>If an asynchronous event, say a <code>sigint</code> triggered by <code>C-c</code>, is
delivered to a thread running Lisp or foreign code called from Lisp,
a Lisp condition is typically signalled. If the handler for this
condition unwinds the stack, then we have an asynchronous unwind.
Another example is <code>bt:interrupt-thread</code>, which, as it can execute
arbitrary code, may unwind the stack in the target thread.</p></li>
</ul>

<p><a id="x-28JOURNAL-3A-40BOOLEAN-VALUED-SYMBOL-20MGL-PAX-3AGLOSSARY-TERM-29"></a>
<a id="JOURNAL:@BOOLEAN-VALUED-SYMBOL%20MGL-PAX:GLOSSARY-TERM"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L5835">[glossary-term]</a></span> <span class="reference-object"><a href="#JOURNAL:@BOOLEAN-VALUED-SYMBOL%20MGL-PAX:GLOSSARY-TERM" >boolean-valued symbol</a></span></span></span></p>

<p>Imagine writing two <a href="http://www.lispworks.com/documentation/HyperSpec/Body/t_stream.htm" title="STREAM CLASS"><code>stream</code></a>s with a spaghetti of functions and
wanting to have pretty-printed output on one of them. Unfortunately,
binding <a href="http://www.lispworks.com/documentation/HyperSpec/Body/v_pr_pre.htm" title="*PRINT-PRETTY* VARIABLE"><code>*print-pretty*</code></a> to <code>t</code> will affect writes to both streams.</p>

<p>One solution would be to have streams look up their own print-pretty
flag with <code>(symbol-value (stream-pretty-print stream))</code> and have the
caller specify the dynamic variable they want:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">defvar</span></i> <span class="special">*print-pretty-1*</span> nil</span>)</span>
<span class="paren1">(<span class="code">setf <span class="paren2">(<span class="code">stream-print-pretty stream-1</span>)</span> '<span class="special">*print-pretty-1*</span></span>)</span>
<span class="paren1">(<span class="code"><i><span class="symbol">let</span></i> <span class="paren2">(<span class="code"><span class="paren3">(<span class="code"><span class="special">*print-pretty-1*</span> t</span>)</span></span>)</span>
  <span class="paren2">(<span class="code">spaghetti stream-1 stream-2</span>)</span></span>)</span></span></code></pre>

<p>Note that if the default <code>stream-print-pretty</code> is <code>'*print-pretty*</code>,
then we have the normal Common Lisp behaviour. Setting
<code>stream-print-pretty</code> to <code>nil</code> or <code>t</code> also works, because they are
self-evaluating.</p>

<p>The above hypothetical example demonstrates the concept of
boolean-valued symbols on <code>cl:stream</code>s. In Journal, they are used by
<a href="#JOURNAL:MAKE-LOG-DECORATOR%20FUNCTION" title="JOURNAL:MAKE-LOG-DECORATOR FUNCTION"><code>make-log-decorator</code></a> and <a href="#JOURNAL:PPRINT-JOURNAL%20CLASS" title="JOURNAL:PPRINT-JOURNAL CLASS"><code>pprint-journal</code></a>s.</p></li>
</ul>

<p><a id="x-28JOURNAL-3A-40NON-LOCAL-EXIT-20MGL-PAX-3AGLOSSARY-TERM-29"></a>
<a id="JOURNAL:@NON-LOCAL-EXIT%20MGL-PAX:GLOSSARY-TERM"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L5860">[glossary-term]</a></span> <span class="reference-object"><a href="#JOURNAL:@NON-LOCAL-EXIT%20MGL-PAX:GLOSSARY-TERM" >non-local exit</a></span></span></span></p>

<p>This is a term from the Common Lisp ANSI standard. If a form does
not return normally, but control is transferred via <a href="http://www.lispworks.com/documentation/HyperSpec/Body/s_go.htm" title="GO MGL-PAX:MACRO"><code>go</code></a>, <a href="http://www.lispworks.com/documentation/HyperSpec/Body/m_return.htm" title="RETURN MGL-PAX:MACRO"><code>return</code></a>,
<a href="http://www.lispworks.com/documentation/HyperSpec/Body/s_ret_fr.htm" title="RETURN-FROM MGL-PAX:MACRO"><code>return-from</code></a> or <a href="http://www.lispworks.com/documentation/HyperSpec/Body/s_throw.htm" title="THROW MGL-PAX:MACRO"><code>throw</code></a>, then it is said to have performed a non-local
exit. This definition of a non-local exit includes <code>event-exit</code>(<a href="#JOURNAL:EVENT-EXIT%20FUNCTION" title="JOURNAL:EVENT-EXIT FUNCTION"><code>0</code></a> <a href="#JOURNAL:EVENT-EXIT%20TYPE" title="JOURNAL:EVENT-EXIT TYPE"><code>1</code></a>)
<code>:condition</code>, <code>:error</code> and <code>:nlx</code>.</p></li>
</ul>

<p><a id="x-28JOURNAL-3A-40READABLE-20MGL-PAX-3AGLOSSARY-TERM-29"></a>
<a id="JOURNAL:@READABLE%20MGL-PAX:GLOSSARY-TERM"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/journal/blob/d69c6332e9bd03e49d91dd6c78fd40cadf81d91f/src/journal.lisp#L5867">[glossary-term]</a></span> <span class="reference-object"><a href="#JOURNAL:@READABLE%20MGL-PAX:GLOSSARY-TERM" >readable</a></span></span></span></p>

<p>In Common Lisp, readable objects are those that can be printed readably.
Anything written to stream-based journals needs to be readable.</p></li>
</ul>
  </div>
</div>
<script>$('#page-toc').toc({'selectors': 'h1,h2,h3,h4'});</script>
</body>
</html>
