<!DOCTYPE html>
<html xmlns='http://www.w3.org/1999/xhtml' xml:lang='en' lang='en'>
<head>
<title>LMDB Manual</title>
<link type='text/css' href='style.css' rel='stylesheet'/>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<script src="jquery.min.js"></script>
<script src="toc.min.js"></script>
<script type="text/x-mathjax-config">
     MathJax.Hub.Config({
       tex2jax: {
         inlineMath: [['$','$']],
         processEscapes: true
       }
     });
   </script>
   <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML">
   </script>
   </head>
<body>
<div id="content-container">
<div id="toc">
<div id="toc-header"><ul><li><a href="index.html">PAX World</a></li></ul></div>
<div id="page-toc">
</div>
<div id="toc-footer"><ul><li><a href="https://github.com/melisgl/mgl-pax">[generated by MGL-PAX]</a></li></ul></div>
</div>
<div id="content">
<p><a id='x-28LMDB-3A-40LMDB-MANUAL-20MGL-PAX-3ASECTION-29'></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#x-28-23A-28-284-29-20BASE-CHAR-20-2E-20-22lmdb-22-29-20ASDF-2FSYSTEM-3ASYSTEM-29" title="(#A((4) BASE-CHAR . \&quot;lmdb\&quot;) ASDF/SYSTEM:SYSTEM)">&#8594;</a> <a href="#x-28LMDB-3A-40LMDB-MANUAL-20MGL-PAX-3ASECTION-29" title="LMDB Manual">&#8634;</a> <a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L134">&#955;</a></span></span></p>

<h1><a href="#x-28LMDB-3A-40LMDB-MANUAL-20MGL-PAX-3ASECTION-29">LMDB Manual</a></h1>

<h2>Table of Contents</h2>

<ul>
<li><a href="#x-28-23A-28-284-29-20BASE-CHAR-20-2E-20-22lmdb-22-29-20ASDF-2FSYSTEM-3ASYSTEM-29" title="(#A((4) BASE-CHAR . \&quot;lmdb\&quot;) ASDF/SYSTEM:SYSTEM)">1 LMDB ASDF System Details</a></li>
<li><a href="#x-28LMDB-3A-40LMDB-2FLINKS-20MGL-PAX-3ASECTION-29" title="Links">2 Links</a></li>
<li><a href="#x-28LMDB-3A-40LMDB-2FINTRODUCTION-20MGL-PAX-3ASECTION-29" title="Introduction">3 Introduction</a></li>
<li><a href="#x-28LMDB-3A-40LMDB-2FDESIGN-AND-IMPLEMENTATION-20MGL-PAX-3ASECTION-29" title="Design and implementation">4 Design and implementation</a>

<ul>
<li><a href="#x-28LMDB-3A-40LMDB-2FSAFETY-20MGL-PAX-3ASECTION-29" title="Safety">4.1 Safety</a></li>
<li><a href="#x-28LMDB-3A-40LMDB-2FDEVIATIONS-FROM-THE-LMDB-API-20MGL-PAX-3ASECTION-29" title="Deviations from the C lmdb API">4.2 Deviations from the C lmdb API</a></li>
</ul></li>
<li><a href="#x-28LMDB-3A-40LMDB-2FVERSION-20MGL-PAX-3ASECTION-29" title="Library versions">5 Library versions</a></li>
<li><a href="#x-28LMDB-3A-40LMDB-2FENVIRONMENTS-20MGL-PAX-3ASECTION-29" title="Environments">6 Environments</a>

<ul>
<li><a href="#x-28LMDB-3A-40LMDB-2FENV-REFERENCE-20MGL-PAX-3ASECTION-29" title="Environments reference">6.1 Environments reference</a></li>
<li><a href="#x-28LMDB-3A-40LMDB-2FOPENING-AND-CLOSING-ENV-20MGL-PAX-3ASECTION-29" title="Opening and closing environments">6.2 Opening and closing environments</a></li>
<li><a href="#x-28LMDB-3A-40LMDB-2FMISC-ENV-20MGL-PAX-3ASECTION-29" title="Miscellaneous environment functions">6.3 Miscellaneous environment functions</a></li>
</ul></li>
<li><a href="#x-28LMDB-3A-40LMDB-2FTRANSACTIONS-20MGL-PAX-3ASECTION-29" title="Transactions">7 Transactions</a>

<ul>
<li><a href="#x-28LMDB-3A-40LMDB-2FNESTING-TRANSACTIONS-20MGL-PAX-3ASECTION-29" title="Nesting transactions">7.1 Nesting transactions</a></li>
</ul></li>
<li><a href="#x-28LMDB-3A-40LMDB-2FDATABASES-20MGL-PAX-3ASECTION-29" title="Databases">8 Databases</a>

<ul>
<li><a href="#x-28LMDB-3A-40LMDB-2FTHE-UNNAMED-DATABASE-20MGL-PAX-3ASECTION-29" title="The unnamed database">8.1 The unnamed database</a></li>
<li><a href="#x-28LMDB-3A-40DUPSORT-20MGL-PAX-3ASECTION-29" title="DUPSORT">8.2 DUPSORT</a></li>
<li><a href="#x-28LMDB-3A-40LMDB-2FDATABASE-API-20MGL-PAX-3ASECTION-29" title="Database API">8.3 Database API</a></li>
</ul></li>
<li><a href="#x-28LMDB-3A-40LMDB-2FENCODINGS-20MGL-PAX-3ASECTION-29" title="Encoding and decoding data">9 Encoding and decoding data</a>

<ul>
<li><a href="#x-28LMDB-3A-40LMDB-2FOVERRIDING-ENCODINGS-20MGL-PAX-3ASECTION-29" title="Overriding encodings">9.1 Overriding encodings</a></li>
</ul></li>
<li><a href="#x-28LMDB-3A-40LMDB-2FBASIC-OPERATIONS-20MGL-PAX-3ASECTION-29" title="Basic operations">10 Basic operations</a></li>
<li><a href="#x-28LMDB-3A-40LMDB-2FCURSORS-20MGL-PAX-3ASECTION-29" title="Cursors">11 Cursors</a>

<ul>
<li><a href="#x-28LMDB-3A-40LMDB-2FPOSITIONING-CURSORS-20MGL-PAX-3ASECTION-29" title="Positioning cursors">11.1 Positioning cursors</a></li>
<li><a href="#x-28LMDB-3A-40LMDB-2FBASIC-CURSOR-OPERATIONS-20MGL-PAX-3ASECTION-29" title="Basic cursor operations">11.2 Basic cursor operations</a></li>
<li><a href="#x-28LMDB-3A-40LMDB-2FMISC-CURSOR-20MGL-PAX-3ASECTION-29" title="Miscellaneous cursor operations">11.3 Miscellaneous cursor operations</a></li>
</ul></li>
<li><a href="#x-28LMDB-3A-40LMDB-2FCONDITIONS-20MGL-PAX-3ASECTION-29" title="Conditions">12 Conditions</a>

<ul>
<li><a href="#x-28LMDB-3A-40LMDB-2FERROR-CODE-CONDITIONS-20MGL-PAX-3ASECTION-29" title="Conditions for C lmdb error codes">12.1 Conditions for C lmdb error codes</a></li>
<li><a href="#x-28LMDB-3A-40LMDB-2FADDITIONAL-CONDITIONS-20MGL-PAX-3ASECTION-29" title="Additional conditions">12.2 Additional conditions</a></li>
</ul></li>
</ul>

<h6>[in package LMDB]</h6>

<p><a id='x-28-23A-28-284-29-20BASE-CHAR-20-2E-20-22lmdb-22-29-20ASDF-2FSYSTEM-3ASYSTEM-29'></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#x-28LMDB-3A-40LMDB-MANUAL-20MGL-PAX-3ASECTION-29" title="LMDB Manual">&#8592;</a> <a href="#x-28LMDB-3A-40LMDB-MANUAL-20MGL-PAX-3ASECTION-29" title="LMDB Manual">&#8593;</a> <a href="#x-28LMDB-3A-40LMDB-2FLINKS-20MGL-PAX-3ASECTION-29" title="Links">&#8594;</a> <a href="#x-28-23A-28-284-29-20BASE-CHAR-20-2E-20-22lmdb-22-29-20ASDF-2FSYSTEM-3ASYSTEM-29" title="(#A((4) BASE-CHAR . \&quot;lmdb\&quot;) ASDF/SYSTEM:SYSTEM)">&#8634;</a> <a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/lmdb.asd#L1">&#955;</a></span></span></p>

<h2><a href="#x-28-23A-28-284-29-20BASE-CHAR-20-2E-20-22lmdb-22-29-20ASDF-2FSYSTEM-3ASYSTEM-29">1 LMDB ASDF System Details</a></h2>

<ul>
<li>Version: 0.1</li>
<li>Description: Bindings to <a href="#x-28-23A-28-284-29-20BASE-CHAR-20-2E-20-22lmdb-22-29-20ASDF-2FSYSTEM-3ASYSTEM-29" title="(#A((4) BASE-CHAR . \&quot;lmdb\&quot;) ASDF/SYSTEM:SYSTEM)"><code>LMDB</code></a>, the Lightning Memory-mapped Database.</li>
<li>Licence: MIT, see COPYING.</li>
<li>Author: Fernando Borretti <a href="m&#x61;&#105;l&#x74;&#111;:&#x65;&#117;d&#x6F;&#120;i&#x61;&#104;p&#x40;&#103;m&#x61;&#105;l&#x2E;&#99;o&#x6D;">m&#x61;&#105;l&#x74;&#111;:&#x65;&#117;d&#x6F;&#120;i&#x61;&#104;p&#x40;&#103;m&#x61;&#105;l&#x2E;&#99;o&#x6D;</a>, James Anderson &lt;james.anderson@setf.de&gt;, GÃ¡bor Melis <a href="m&#x61;&#105;l&#x74;&#111;:&#x6D;&#101;g&#x61;&#64;r&#x65;&#116;e&#x73;&#46;h&#x75;">m&#x61;&#105;l&#x74;&#111;:&#x6D;&#101;g&#x61;&#64;r&#x65;&#116;e&#x73;&#46;h&#x75;</a></li>
<li>Maintainer: Fernando Borretti <a href="m&#x61;&#105;l&#x74;&#111;:&#x65;&#117;d&#x6F;&#120;i&#x61;&#104;p&#x40;&#103;m&#x61;&#105;l&#x2E;&#99;o&#x6D;">m&#x61;&#105;l&#x74;&#111;:&#x65;&#117;d&#x6F;&#120;i&#x61;&#104;p&#x40;&#103;m&#x61;&#105;l&#x2E;&#99;o&#x6D;</a></li>
<li>Homepage: <a href="https://github.com/antimer/lmdb" >https://github.com/antimer/lmdb</a></li>
<li>Bug tracker: <a href="https://github.com/antimer/lmdb/issues" >https://github.com/antimer/lmdb/issues</a></li>
<li>Source control: <a href="git@github.com:antimer/lmdb.git" >GIT</a></li>
</ul>

<p><a id='x-28LMDB-3A-40LMDB-2FLINKS-20MGL-PAX-3ASECTION-29'></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#x-28-23A-28-284-29-20BASE-CHAR-20-2E-20-22lmdb-22-29-20ASDF-2FSYSTEM-3ASYSTEM-29" title="(#A((4) BASE-CHAR . \&quot;lmdb\&quot;) ASDF/SYSTEM:SYSTEM)">&#8592;</a> <a href="#x-28LMDB-3A-40LMDB-MANUAL-20MGL-PAX-3ASECTION-29" title="LMDB Manual">&#8593;</a> <a href="#x-28LMDB-3A-40LMDB-2FINTRODUCTION-20MGL-PAX-3ASECTION-29" title="Introduction">&#8594;</a> <a href="#x-28LMDB-3A-40LMDB-2FLINKS-20MGL-PAX-3ASECTION-29" title="Links">&#8634;</a> <a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L148">&#955;</a></span></span></p>

<h2><a href="#x-28LMDB-3A-40LMDB-2FLINKS-20MGL-PAX-3ASECTION-29">2 Links</a></h2>

<p>Here is the <a href="https://github.com/antimer/lmdb" >official repository</a>
and the <a href="http://melisgl.github.io/mgl-pax-world/lmdb-manual.html" >HTML
documentation</a>
for the latest version.</p>

<p><a id='x-28LMDB-3A-40LMDB-2FINTRODUCTION-20MGL-PAX-3ASECTION-29'></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#x-28LMDB-3A-40LMDB-2FLINKS-20MGL-PAX-3ASECTION-29" title="Links">&#8592;</a> <a href="#x-28LMDB-3A-40LMDB-MANUAL-20MGL-PAX-3ASECTION-29" title="LMDB Manual">&#8593;</a> <a href="#x-28LMDB-3A-40LMDB-2FDESIGN-AND-IMPLEMENTATION-20MGL-PAX-3ASECTION-29" title="Design and implementation">&#8594;</a> <a href="#x-28LMDB-3A-40LMDB-2FINTRODUCTION-20MGL-PAX-3ASECTION-29" title="Introduction">&#8634;</a> <a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L154">&#955;</a></span></span></p>

<h2><a href="#x-28LMDB-3A-40LMDB-2FINTRODUCTION-20MGL-PAX-3ASECTION-29">3 Introduction</a></h2>

<p><a href="http://www.lmdb.tech/doc/" >LMDB</a>, the Lightning Memory-mapped
Database, is an <a href="https://en.wikipedia.org/wiki/ACID" >ACID</a> key-value
database with
<a href="https://en.wikipedia.org/wiki/Multiversion_concurrency_control" >MVCC</a>.
It is a small C library (&quot;C lmdb&quot; from now on), around which <a href="#x-28-23A-28-284-29-20BASE-CHAR-20-2E-20-22lmdb-22-29-20ASDF-2FSYSTEM-3ASYSTEM-29" title="(#A((4) BASE-CHAR . \&quot;lmdb\&quot;) ASDF/SYSTEM:SYSTEM)"><code>LMDB</code></a> is
a Common Lisp wrapper. <code>LMDB</code> covers most of C lmdb's functionality,
has a simplified API, much needed <a href="#x-28LMDB-3A-40LMDB-2FSAFETY-20MGL-PAX-3ASECTION-29" title="Safety">Safety</a> checks, and
comprehensive documentation.</p>

<p>Compared to other key-value stores, <code>LMDB</code>'s distuingishing features
are:</p>

<ul>
<li><p>Transactions span multiple keys.</p></li>
<li><p>Embedded. It has no server but can be used concurrently not only
  by multiple threads but by multiple OS processes, too.</p></li>
<li><p>Extremely high read performance: millions of transactions per
  second.</p></li>
<li><p>Very low maintenance.</p></li>
</ul>

<p>Other notable things:</p>

<ul>
<li><p>With its default - the most durable - settings, it has average
  write performance, which is bottlenecked by <code>fsync()</code>.</p></li>
<li><p>Readers don't block readers or writers, but there is at most one
  writer at a time.</p></li>
<li><p>Extremely simple, crash-proof design.</p></li>
<li><p>The entire database (called <em>environment</em>) is backed by a single
  memory-mapped file, with a
  <a href="https://en.wikipedia.org/wiki/Copy-on-write" >copy-on-write</a>
  <a href="https://en.wikipedia.org/wiki/B%2B_tree" >B+ tree</a>.</p></li>
<li><p>No transaction log.</p></li>
<li><p>It is very much like <a href="https://en.wikipedia.org/wiki/Berkeley_DB" >Berkeley
  DB</a> done right, without
  the fluff and much improved administration.</p></li>
</ul>

<p>Do read the <a href="http://www.lmdb.tech/doc/" >Caveats</a>, though. On the
Lisp side, this library <strong>will not work with virtual threads</strong>
because <code>LMDB</code>'s write locking is tied to native threads.</p>

<p>Using <code>LMDB</code> is easy:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">with-temporary-env</span></i> <span class="paren2">(<span class="code"><span class="special">*env*</span></span>)</span>
  <span class="paren2">(<span class="code"><a href="http://www.lispworks.com/reference/HyperSpec/Body/s_let_l.htm" class="symbol"><i><span class="symbol">let</span></i></a> <span class="paren3">(<span class="code"><span class="paren4">(<span class="code">db <span class="paren5">(<span class="code">get-db <span class="string">"test"</span></span>)</span></span>)</span></span>)</span>
    <span class="paren3">(<span class="code"><i><span class="symbol">with-txn</span></i> <span class="paren4">(<span class="code"><span class="keyword">:write</span> <a href="http://www.lispworks.com/reference/HyperSpec/Body/a_t.htm" class="symbol">t</a></span>)</span>
      <span class="paren4">(<span class="code">put db <span class="string">"k1"</span> #<span class="paren5">(<span class="code">2 3</span>)</span></span>)</span>
      <span class="paren4">(<span class="code"><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_wr_pr.htm" class="symbol">print</a> <span class="paren5">(<span class="code">g3t db <span class="string">"k1"</span></span>)</span></span>)</span> <span class="comment">; =&gt; #(2 3)
</span>      <span class="paren4">(<span class="code">del db <span class="string">"k1"</span></span>)</span></span>)</span></span>)</span></span>)</span></span></code></pre>

<p>More typically, the environment and databases are opened once so
that multiple threads and transactions can access them:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_defpar.htm" class="symbol"><i><span class="symbol">defvar</span></i></a> <span class="special">*test-db*</span></span>)</span>

<span class="paren1">(<span class="code"><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_when_.htm" class="symbol">unless</a> <span class="special">*env*</span>
  <span class="paren2">(<span class="code"><a href="http://www.lispworks.com/reference/HyperSpec/Body/s_setq.htm" class="symbol"><i><span class="symbol">setq</span></i></a> <span class="special">*env*</span> <span class="paren3">(<span class="code">open-env <span class="string">"/tmp/lmdb-test-env/"</span> <span class="keyword">:if-does-not-exist</span> <span class="keyword">:create</span></span>)</span></span>)</span>
  <span class="paren2">(<span class="code"><a href="http://www.lispworks.com/reference/HyperSpec/Body/s_setq.htm" class="symbol"><i><span class="symbol">setq</span></i></a> <span class="special">*test-db*</span> <span class="paren3">(<span class="code">get-db <span class="string">"test"</span> <span class="keyword">:value-encoding</span> <span class="keyword">:utf-8</span></span>)</span></span>)</span></span>)</span>

<span class="paren1">(<span class="code"><i><span class="symbol">with-txn</span></i> <span class="paren2">(<span class="code"><span class="keyword">:write</span> <a href="http://www.lispworks.com/reference/HyperSpec/Body/a_t.htm" class="symbol">t</a></span>)</span>
  <span class="paren2">(<span class="code">put <span class="special">*test-db*</span> 1 <span class="string">"hello"</span></span>)</span>
  <span class="paren2">(<span class="code"><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_wr_pr.htm" class="symbol">print</a> <span class="paren3">(<span class="code">g3t <span class="special">*test-db*</span> 1</span>)</span></span>)</span> <span class="comment">; =&gt; "hello"
</span>  <span class="paren2">(<span class="code">del <span class="special">*test-db*</span> 1</span>)</span></span>)</span></span></code></pre>

<p>Note how <code>:VALUE-ENCODING</code> sneaked in above. This was so to make <a href="#x-28LMDB-3AG3T-20FUNCTION-29" title="(LMDB:G3T FUNCTION)"><code>G3T</code></a>
return a string instead of an octet vector.</p>

<p><code>LMDB</code> treats keys and values as opaque byte arrays to be hung on a B+
tree, and only requires a comparison function to be defined over
keys. <code>LMDB</code> knows how to serialize the types <code>(UNSIGNED-BYTE 64)</code> and
<code>STRING</code> (which are often used as keys so sorting must work as
expected). Serialization of the rest of the datatypes is left to the
client. See <a href="#x-28LMDB-3A-40LMDB-2FENCODINGS-20MGL-PAX-3ASECTION-29" title="Encoding and decoding data">Encoding and decoding data</a> for more.</p>

<p><a id='x-28LMDB-3A-40LMDB-2FDESIGN-AND-IMPLEMENTATION-20MGL-PAX-3ASECTION-29'></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#x-28LMDB-3A-40LMDB-2FINTRODUCTION-20MGL-PAX-3ASECTION-29" title="Introduction">&#8592;</a> <a href="#x-28LMDB-3A-40LMDB-MANUAL-20MGL-PAX-3ASECTION-29" title="LMDB Manual">&#8593;</a> <a href="#x-28LMDB-3A-40LMDB-2FSAFETY-20MGL-PAX-3ASECTION-29" title="Safety">&#8594;</a> <a href="#x-28LMDB-3A-40LMDB-2FDESIGN-AND-IMPLEMENTATION-20MGL-PAX-3ASECTION-29" title="Design and implementation">&#8634;</a> <a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L240">&#955;</a></span></span></p>

<h2><a href="#x-28LMDB-3A-40LMDB-2FDESIGN-AND-IMPLEMENTATION-20MGL-PAX-3ASECTION-29">4 Design and implementation</a></h2>

<p><a id='x-28LMDB-3A-40LMDB-2FSAFETY-20MGL-PAX-3ASECTION-29'></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#x-28LMDB-3A-40LMDB-2FDESIGN-AND-IMPLEMENTATION-20MGL-PAX-3ASECTION-29" title="Design and implementation">&#8592;</a> <a href="#x-28LMDB-3A-40LMDB-2FDESIGN-AND-IMPLEMENTATION-20MGL-PAX-3ASECTION-29" title="Design and implementation">&#8593;</a> <a href="#x-28LMDB-3A-40LMDB-2FDEVIATIONS-FROM-THE-LMDB-API-20MGL-PAX-3ASECTION-29" title="Deviations from the C lmdb API">&#8594;</a> <a href="#x-28LMDB-3A-40LMDB-2FSAFETY-20MGL-PAX-3ASECTION-29" title="Safety">&#8634;</a> <a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L244">&#955;</a></span></span></p>

<h3><a href="#x-28LMDB-3A-40LMDB-2FSAFETY-20MGL-PAX-3ASECTION-29">4.1 Safety</a></h3>

<p>The lmdb C API trusts client code to respect its rules. Being C,
managing object lifetimes is the biggest burden. There are also
rules that are documented, but not enforced. This Lisp wrapper tries
to enforce these rules itself and manage object lifetimes in a safe
way to avoid data corruption. How and what it does is described in
the following.</p>

<h5>Environments</h5>

<ul>
<li><p><a href="#x-28LMDB-3AOPEN-ENV-20FUNCTION-29" title="(LMDB:OPEN-ENV FUNCTION)"><code>OPEN-ENV</code></a> checks that the same path is not used in multiple open
  environments to prevent locking issues documented in
  <a href="http://www.lmdb.tech/doc/" >Caveats</a>.</p></li>
<li><p><a href="#x-28LMDB-3ACLOSE-ENV-20FUNCTION-29" title="(LMDB:CLOSE-ENV FUNCTION)"><code>CLOSE-ENV</code></a> waits until all <a href="#x-28LMDB-3A-40ACTIVE-TRANSACTION-20MGL-PAX-3AGLOSSARY-TERM-29" title="(LMDB:@ACTIVE-TRANSACTION MGL-PAX:GLOSSARY-TERM)">active transaction</a>s are finished before
  actually closing the environment. Alternatively, if <code>OPEN-ENV</code> was
  called with <code>:SYNCHRONIZED</code> <code>NIL</code>, to avoid the overhead of
  synchronization, the environment is closed only when garbage
  collected.</p></li>
</ul>

<h5>Transactions</h5>

<ul>
<li><p>Checks are made to detect illegal operations on parent
  transactions (see <a href="#x-28LMDB-3ALMDB-ILLEGAL-ACCESS-TO-PARENT-TXN-ERROR-20CONDITION-29" title="(LMDB:LMDB-ILLEGAL-ACCESS-TO-PARENT-TXN-ERROR CONDITION)"><code>LMDB-ILLEGAL-ACCESS-TO-PARENT-TXN-ERROR</code></a>).</p></li>
<li><p>Access to closed transactions is reliably detected.</p></li>
<li><p>C <a href="#x-28-23A-28-284-29-20BASE-CHAR-20-2E-20-22lmdb-22-29-20ASDF-2FSYSTEM-3ASYSTEM-29" title="(#A((4) BASE-CHAR . \&quot;lmdb\&quot;) ASDF/SYSTEM:SYSTEM)"><code>LMDB</code></a> allows read transactions to be used in multiple threads.
  The synchronization cost of performing this safely (i.e. without
  risking access to closed and freed transaction objects) is
  significant so this is not supported.</p></li>
</ul>

<h5>Databases</h5>

<ul>
<li><p><a href="http://www.lmdb.tech/doc/group__mdb.html#gac08cad5b096925642ca359a6d6f0562a" >mdb_dbi_open()</a>
  is wrapped by <a href="#x-28LMDB-3AGET-DB-20FUNCTION-29" title="(LMDB:GET-DB FUNCTION)"><code>GET-DB</code></a> in a transaction and is protected by a mutex
  to comply with C lmdb's requirements:</p>

<pre><code> A transaction that opens a database must finish (either
 commit or abort) before another transaction may open it.
 Multiple concurrent transactions cannot open the same
 database.
</code></pre></li>
<li><p><a href="http://www.lmdb.tech/doc/group__mdb.html#ga52dd98d0c542378370cd6b712ff961b5" >mdb_dbi_close()</a>
  is too dangerous to be exposed as explained in the <code>GET-DB</code>
  documentation.</p></li>
<li><p>For similar reasons, <a href="#x-28LMDB-3ADROP-DB-20FUNCTION-29" title="(LMDB:DROP-DB FUNCTION)"><code>DROP-DB</code></a> is wrapped in <a href="#x-28LMDB-3AWITH-ENV-20MGL-PAX-3AMACRO-29" title="(LMDB:WITH-ENV MGL-PAX:MACRO)"><code>WITH-ENV</code></a>.</p></li>
<li><p><a href="http://www.lmdb.tech/doc/group__mdb.html#gaa2506ec8dab3d969b0e609cd82e619e5" >mdb_env_set_mapsize()</a>,
  <a href="http://www.lmdb.tech/doc/group__mdb.html#gae687966c24b790630be2a41573fe40e2" >mdb_env_set_max_readers()</a>,
  and <a href="http://www.lmdb.tech/doc/group__mdb.html#gaa2fc2f1f37cb1115e733b62cab2fcdbc" >mdb_env_set_maxdbs()</a>
  are only available through <code>OPEN-ENV</code> because they either require that
  there are no write transactions or do not work on open environments.</p></li>
</ul>

<h5>Cursors</h5>

<ul>
<li>As even read transactions are restricted to a single thread, so
  are cursors. Using a cursor from a thread other than the one in
  which it was created (i.e. the thread of its transaction) raises
  <a href="#x-28LMDB-3ALMDB-CURSOR-THREAD-ERROR-20CONDITION-29" title="(LMDB:LMDB-CURSOR-THREAD-ERROR CONDITION)"><code>LMDB-CURSOR-THREAD-ERROR</code></a>. In return for this restriction, access
  to cursors belonging to closed transactions is reliably detected.</li>
</ul>

<h5>Signal handling</h5>

<p>The C lmdb library handles system calls being interrupted (<code>EINTR</code>
and <code>EAGAIN</code>), but unwinding the stack from interrupts in the middle
of <code>LMDB</code> calls can leave the in-memory data structures such as
transactions inconsistent. If this happens, their further use risks
data corruption. For this reason, calls to <code>LMDB</code> are performed with
interrupts disabled. For SBCL, this means <code>SB-SYS:WITHOUT-INTERRUPTS</code>.
It is an error when compiling <code>LMDB</code> if an equivalent facility is not
found in the Lisp implementation. A warning is signalled if no
substitute is found for <code>SB-SYS:WITH-INTERRUPTS</code> because this makes
the body of <code>WITH-ENV</code>, <a href="#x-28LMDB-3AWITH-TXN-20MGL-PAX-3AMACRO-29" title="(LMDB:WITH-TXN MGL-PAX:MACRO)"><code>WITH-TXN</code></a>, <a href="#x-28LMDB-3AWITH-CURSOR-20MGL-PAX-3AMACRO-29" title="(LMDB:WITH-CURSOR MGL-PAX:MACRO)"><code>WITH-CURSOR</code></a> and similar
uninterruptible.</p>

<p>Operations that do not modify the database (<a href="#x-28LMDB-3AG3T-20FUNCTION-29" title="(LMDB:G3T FUNCTION)"><code>G3T</code></a>, <a href="#x-28LMDB-3ACURSOR-FIRST-20FUNCTION-29" title="(LMDB:CURSOR-FIRST FUNCTION)"><code>CURSOR-FIRST</code></a>,
<a href="#x-28LMDB-3ACURSOR-VALUE-20FUNCTION-29" title="(LMDB:CURSOR-VALUE FUNCTION)"><code>CURSOR-VALUE</code></a>, etc) are async unwind safe, and for performance they
are called without the above provisions.</p>

<p>Note that the library is not reentrant, so don't call <code>LMDB</code> from
signal handlers.</p>

<p><a id='x-28LMDB-3A-40LMDB-2FDEVIATIONS-FROM-THE-LMDB-API-20MGL-PAX-3ASECTION-29'></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#x-28LMDB-3A-40LMDB-2FSAFETY-20MGL-PAX-3ASECTION-29" title="Safety">&#8592;</a> <a href="#x-28LMDB-3A-40LMDB-2FDESIGN-AND-IMPLEMENTATION-20MGL-PAX-3ASECTION-29" title="Design and implementation">&#8593;</a> <a href="#x-28LMDB-3A-40LMDB-2FVERSION-20MGL-PAX-3ASECTION-29" title="Library versions">&#8594;</a> <a href="#x-28LMDB-3A-40LMDB-2FDEVIATIONS-FROM-THE-LMDB-API-20MGL-PAX-3ASECTION-29" title="Deviations from the C lmdb API">&#8634;</a> <a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L328">&#955;</a></span></span></p>

<h3><a href="#x-28LMDB-3A-40LMDB-2FDEVIATIONS-FROM-THE-LMDB-API-20MGL-PAX-3ASECTION-29">4.2 Deviations from the C lmdb API</a></h3>

<p>The following are the most prominent deviations and omissions from
the C lmdb API in addition to those listed in <a href="#x-28LMDB-3A-40LMDB-2FSAFETY-20MGL-PAX-3ASECTION-29" title="Safety">Safety</a>.</p>

<h5>Environments</h5>

<ul>
<li><p><a href="http://www.lmdb.tech/doc/group__mdb.html#ga8550000cd0501a44f57ee6dff0188744" >mdb_reader_list()</a>
  is not implemented.</p></li>
<li><p><a href="http://www.lmdb.tech/doc/group__mdb.html#ga5d51d6130325f7353db0955dbedbc378" >mdb_env_copy()</a>
  and its close kin are not yet implemented.</p></li>
</ul>

<h5>Transactions</h5>

<ul>
<li>Read-only <a href="#x-28LMDB-3AWITH-TXN-20MGL-PAX-3AMACRO-29" title="(LMDB:WITH-TXN MGL-PAX:MACRO)"><code>WITH-TXN</code></a>s are turned into noops when &quot;nested&quot; (unless
  <code>IGNORE-PARENT</code>).</li>
</ul>

<h5>Databases</h5>

<ul>
<li><p><a href="http://www.lmdb.tech/doc/group__mdb.html#ga68e47ffcf72eceec553c72b1784ee0fe" >mdb_set_compare()</a>
  and <a href="http://www.lmdb.tech/doc/group__mdb.html#gacef4ec3dab0bbd9bc978b73c19c879ae" >mdb_set_dupsort()</a>
  are not exposed. If they are needed, implement a foreign comparison
  function and call <code>LIBLMDB:SET-COMPARE</code> or <code>LIBLMDB:SET-DUPSORT</code>
  directly or perhaps change the encoding of the data.</p></li>
<li><p>Working with multiple contiguous values with <code>DUPFIXED</code> is not yet
  implemented. This functionality would belong in <a href="#x-28LMDB-3APUT-20FUNCTION-29" title="(LMDB:PUT FUNCTION)"><code>PUT</code></a>, <a href="#x-28LMDB-3ACURSOR-PUT-20FUNCTION-29" title="(LMDB:CURSOR-PUT FUNCTION)"><code>CURSOR-PUT</code></a>,
  <a href="#x-28LMDB-3ACURSOR-NEXT-20FUNCTION-29" title="(LMDB:CURSOR-NEXT FUNCTION)"><code>CURSOR-NEXT</code></a> and <a href="#x-28LMDB-3ACURSOR-VALUE-20FUNCTION-29" title="(LMDB:CURSOR-VALUE FUNCTION)"><code>CURSOR-VALUE</code></a>.</p></li>
<li><p><code>PUT</code>, <code>CURSOR-PUT</code> do not support the
  <a href="http://www.lmdb.tech/doc/group__mdb__put.html#gac0545c6aea719991e3eae6ccc686efcc" ><code>RESERVE</code></a>
  flag.</p></li>
</ul>

<p><a id='x-28LMDB-3A-40LMDB-2FVERSION-20MGL-PAX-3ASECTION-29'></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#x-28LMDB-3A-40LMDB-2FDEVIATIONS-FROM-THE-LMDB-API-20MGL-PAX-3ASECTION-29" title="Deviations from the C lmdb API">&#8592;</a> <a href="#x-28LMDB-3A-40LMDB-MANUAL-20MGL-PAX-3ASECTION-29" title="LMDB Manual">&#8593;</a> <a href="#x-28LMDB-3A-40LMDB-2FENVIRONMENTS-20MGL-PAX-3ASECTION-29" title="Environments">&#8594;</a> <a href="#x-28LMDB-3A-40LMDB-2FVERSION-20MGL-PAX-3ASECTION-29" title="Library versions">&#8634;</a> <a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L638">&#955;</a></span></span></p>

<h2><a href="#x-28LMDB-3A-40LMDB-2FVERSION-20MGL-PAX-3ASECTION-29">5 Library versions</a></h2>

<p><a id='x-28LMDB-3ALMDB-FOREIGN-VERSION-20FUNCTION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L642">[function]</a></span> <span class="reference-object"><a href="#x-28LMDB-3ALMDB-FOREIGN-VERSION-20FUNCTION-29" >LMDB-FOREIGN-VERSION</a></span></span> <span class="locative-args"></span></span></p>

<p>Return the version of the C lmdb library as a string like <code>0.9.26</code>.</p>

<p>Wraps <a href="http://www.lmdb.tech/doc/group__mdb.html#ga0e5d7298fc39b3c187fffbe30264c968" >mdb_version()</a>.</p></li>
</ul>

<p><a id='x-28LMDB-3ALMDB-BINDING-VERSION-20FUNCTION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L652">[function]</a></span> <span class="reference-object"><a href="#x-28LMDB-3ALMDB-BINDING-VERSION-20FUNCTION-29" >LMDB-BINDING-VERSION</a></span></span> <span class="locative-args"></span></span></p>

<p>Return a string representing the version of C lmdb based on which
the <code>CFFI</code> bindings were created. The version string has the same
format as <a href="#x-28LMDB-3ALMDB-FOREIGN-VERSION-20FUNCTION-29" title="(LMDB:LMDB-FOREIGN-VERSION FUNCTION)"><code>LMDB-FOREIGN-VERSION</code></a>.</p></li>
</ul>

<p><a id='x-28LMDB-3A-40LMDB-2FENVIRONMENTS-20MGL-PAX-3ASECTION-29'></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#x-28LMDB-3A-40LMDB-2FVERSION-20MGL-PAX-3ASECTION-29" title="Library versions">&#8592;</a> <a href="#x-28LMDB-3A-40LMDB-MANUAL-20MGL-PAX-3ASECTION-29" title="LMDB Manual">&#8593;</a> <a href="#x-28LMDB-3A-40LMDB-2FENV-REFERENCE-20MGL-PAX-3ASECTION-29" title="Environments reference">&#8594;</a> <a href="#x-28LMDB-3A-40LMDB-2FENVIRONMENTS-20MGL-PAX-3ASECTION-29" title="Environments">&#8634;</a> <a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L662">&#955;</a></span></span></p>

<h2><a href="#x-28LMDB-3A-40LMDB-2FENVIRONMENTS-20MGL-PAX-3ASECTION-29">6 Environments</a></h2>

<p>An environment (class <a href="#x-28LMDB-3AENV-20CLASS-29" title="(LMDB:ENV CLASS)"><code>ENV</code></a>) is basically a single memory-mapped file
holding all the data, plus some flags determining how we interact
it. An environment can have multiple databases (class <a href="#x-28LMDB-3ADB-20CLASS-29" title="(LMDB:DB CLASS)"><code>DB</code></a>), each of
which is a B+ tree within the same file. An environment is like a
database in a relational db, and the databases in it are like tables
and indices. The terminology comes from <a href="https://docs.oracle.com/cd/E17276_01/html/programmer_reference/env.html" >Berkeley
DB</a>.</p>

<p><a id='x-28LMDB-3A-40LMDB-2FENV-REFERENCE-20MGL-PAX-3ASECTION-29'></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#x-28LMDB-3A-40LMDB-2FENVIRONMENTS-20MGL-PAX-3ASECTION-29" title="Environments">&#8592;</a> <a href="#x-28LMDB-3A-40LMDB-2FENVIRONMENTS-20MGL-PAX-3ASECTION-29" title="Environments">&#8593;</a> <a href="#x-28LMDB-3A-40LMDB-2FOPENING-AND-CLOSING-ENV-20MGL-PAX-3ASECTION-29" title="Opening and closing environments">&#8594;</a> <a href="#x-28LMDB-3A-40LMDB-2FENV-REFERENCE-20MGL-PAX-3ASECTION-29" title="Environments reference">&#8634;</a> <a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L674">&#955;</a></span></span></p>

<h3><a href="#x-28LMDB-3A-40LMDB-2FENV-REFERENCE-20MGL-PAX-3ASECTION-29">6.1 Environments reference</a></h3>

<p><a id='x-28LMDB-3AENV-20CLASS-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L684">[class]</a></span> <span class="reference-object"><a href="#x-28LMDB-3AENV-20CLASS-29" >ENV</a></span></span></span></p>

<p>An environment object through which a memory-mapped
data file can be accessed. Always to be created by <a href="#x-28LMDB-3AOPEN-ENV-20FUNCTION-29" title="(LMDB:OPEN-ENV FUNCTION)"><code>OPEN-ENV</code></a>.</p></li>
</ul>

<p><a id='x-28LMDB-3AENV-PATH-20-28MGL-PAX-3AREADER-20LMDB-3AENV-29-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L687">[reader]</a></span> <span class="reference-object"><a href="#x-28LMDB-3AENV-PATH-20-28MGL-PAX-3AREADER-20LMDB-3AENV-29-29" >ENV-PATH</a></span></span> <span class="locative-args">ENV</span> <span class="locative-args">(:PATH)</span></span></p>

<p>The location of the memory-mapped file and the
environment lock file.</p></li>
</ul>

<p><a id='x-28LMDB-3AENV-MAX-DBS-20-28MGL-PAX-3AREADER-20LMDB-3AENV-29-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L691">[reader]</a></span> <span class="reference-object"><a href="#x-28LMDB-3AENV-MAX-DBS-20-28MGL-PAX-3AREADER-20LMDB-3AENV-29-29" >ENV-MAX-DBS</a></span></span> <span class="locative-args">ENV</span> <span class="locative-args">(:MAX-DBS)</span></span></p>

<p>The maximum number of named databases in the
environment. Currently a moderate number is cheap, but a huge
number gets expensive: 7-120 words per transaction, and every
<a href="#x-28LMDB-3AGET-DB-20FUNCTION-29" title="(LMDB:GET-DB FUNCTION)"><code>GET-DB</code></a> does a linear search of the opened database.</p></li>
</ul>

<p><a id='x-28LMDB-3AENV-MAX-READERS-20-28MGL-PAX-3AREADER-20LMDB-3AENV-29-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L697">[reader]</a></span> <span class="reference-object"><a href="#x-28LMDB-3AENV-MAX-READERS-20-28MGL-PAX-3AREADER-20LMDB-3AENV-29-29" >ENV-MAX-READERS</a></span></span> <span class="locative-args">ENV</span> <span class="locative-args">(:MAX-READERS)</span></span></p>

<p>The maximum number of threads/reader slots. See
the documentation of the <a href="http://lmdb.tech/doc/group__readers.html" >reader lock
table</a> for more.</p></li>
</ul>

<p><a id='x-28LMDB-3AENV-MAP-SIZE-20-28MGL-PAX-3AREADER-20LMDB-3AENV-29-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L702">[reader]</a></span> <span class="reference-object"><a href="#x-28LMDB-3AENV-MAP-SIZE-20-28MGL-PAX-3AREADER-20LMDB-3AENV-29-29" >ENV-MAP-SIZE</a></span></span> <span class="locative-args">ENV</span> <span class="locative-args">(:MAP-SIZE)</span></span></p>

<p>Specifies the size of the data file in bytes.</p></li>
</ul>

<p><a id='x-28LMDB-3AENV-MODE-20-28MGL-PAX-3AREADER-20LMDB-3AENV-29-29'></a></p>

<ul>
<li><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L711">[reader]</a></span> <span class="reference-object"><a href="#x-28LMDB-3AENV-MODE-20-28MGL-PAX-3AREADER-20LMDB-3AENV-29-29" >ENV-MODE</a></span></span> <span class="locative-args">ENV</span> <span class="locative-args">(:MODE)</span></span></li>
</ul>

<p><a id='x-28LMDB-3AENV-FLAGS-20-28MGL-PAX-3AREADER-20LMDB-3AENV-29-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L707">[reader]</a></span> <span class="reference-object"><a href="#x-28LMDB-3AENV-FLAGS-20-28MGL-PAX-3AREADER-20LMDB-3AENV-29-29" >ENV-FLAGS</a></span></span> <span class="locative-args">ENV</span> <span class="locative-args">(:FLAGS)</span></span></p>

<p>A plist of the options as captured by <a href="#x-28LMDB-3AOPEN-ENV-20FUNCTION-29" title="(LMDB:OPEN-ENV FUNCTION)"><code>OPEN-ENV</code></a>.
For example, <code>(:FIXED-MAP NIL :SUBDIR T ...)</code>.</p></li>
</ul>

<p><a id='x-28LMDB-3A-40LMDB-2FOPENING-AND-CLOSING-ENV-20MGL-PAX-3ASECTION-29'></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#x-28LMDB-3A-40LMDB-2FENV-REFERENCE-20MGL-PAX-3ASECTION-29" title="Environments reference">&#8592;</a> <a href="#x-28LMDB-3A-40LMDB-2FENVIRONMENTS-20MGL-PAX-3ASECTION-29" title="Environments">&#8593;</a> <a href="#x-28LMDB-3A-40LMDB-2FMISC-ENV-20MGL-PAX-3ASECTION-29" title="Miscellaneous environment functions">&#8594;</a> <a href="#x-28LMDB-3A-40LMDB-2FOPENING-AND-CLOSING-ENV-20MGL-PAX-3ASECTION-29" title="Opening and closing environments">&#8634;</a> <a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L726">&#955;</a></span></span></p>

<h3><a href="#x-28LMDB-3A-40LMDB-2FOPENING-AND-CLOSING-ENV-20MGL-PAX-3ASECTION-29">6.2 Opening and closing environments</a></h3>

<p><a id='x-28LMDB-3A-2AENV-CLASS-2A-20VARIABLE-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L822">[variable]</a></span> <span class="reference-object"><a href="#x-28LMDB-3A-2AENV-CLASS-2A-20VARIABLE-29" >*ENV-CLASS*</a></span></span> <span class="locative-args">ENV</span></span></p>

<p>The default class <a href="#x-28LMDB-3AOPEN-ENV-20FUNCTION-29" title="(LMDB:OPEN-ENV FUNCTION)"><code>OPEN-ENV</code></a> instaniates. Must be a subclass of <a href="#x-28LMDB-3AENV-20CLASS-29" title="(LMDB:ENV CLASS)"><code>ENV</code></a>.
This provides a way to associate application specific data with <code>ENV</code>
objects.</p></li>
</ul>

<p><a id='x-28LMDB-3AOPEN-ENV-20FUNCTION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L827">[function]</a></span> <span class="reference-object"><a href="#x-28LMDB-3AOPEN-ENV-20FUNCTION-29" >OPEN-ENV</a></span></span> <span class="locative-args">PATH &amp;KEY (CLASS <a href="#x-28LMDB-3A-2AENV-CLASS-2A-20VARIABLE-29" title="(LMDB:*ENV-CLASS* VARIABLE)"><code>*ENV-CLASS*</code></a>) (IF-DOES-NOT-EXIST <code>:ERROR</code>) (SYNCHRONIZED <code>T</code>) (MAX-DBS 1) (MAX-READERS 126) (MAP-SIZE (* 1024 1024)) (MODE 436) (SUBDIR <code>T</code>) (SYNC <code>T</code>) (META-SYNC <code>T</code>) READ-ONLY (TLS <code>T</code>) (READ-AHEAD <code>T</code>) (LOCK <code>T</code>) (MEM-INIT <code>T</code>) FIXED-MAP WRITE-MAP MAP-ASYNC</span></span></p>

<p>Create an <a href="#x-28LMDB-3AENV-20CLASS-29" title="(LMDB:ENV CLASS)"><code>ENV</code></a> object through which the <a href="#x-28-23A-28-284-29-20BASE-CHAR-20-2E-20-22lmdb-22-29-20ASDF-2FSYSTEM-3ASYSTEM-29" title="(#A((4) BASE-CHAR . \&quot;lmdb\&quot;) ASDF/SYSTEM:SYSTEM)"><code>LMDB</code></a> environment can be
accessed and open it. To prevent corruption, an error is signalled
if the same data file is opened multiple times. However, the checks
performed do not work on remote filesystems (see <a href="#x-28LMDB-3AENV-PATH-20-28MGL-PAX-3AREADER-20LMDB-3AENV-29-29" title="(LMDB:ENV-PATH (MGL-PAX:READER LMDB:ENV))"><code>ENV-PATH</code></a>).</p>

<p><a href="#x-28LMDB-3ALMDB-ERROR-20CONDITION-29" title="(LMDB:LMDB-ERROR CONDITION)"><code>LMDB-ERROR</code></a> is signalled if opening the environment fails for any
other reason.</p>

<p>Unless explicitly noted, none of the arguments persist (i.e. they
are not saved in the data file).</p>

<p><code>PATH</code> is the filesystem location of the environment files (see <code>SUBDIR</code>
below for more). Do not use <code>LMDB</code> data files on remote filesystems,
even between processes on the same host. This breaks <code>flock()</code> on
some OSes, possibly memory map sync, and certainly sync between
programs on different hosts.</p>

<p><code>IF-DOES-NOT-EXIST</code> determines what happens if <code>ENV-PATH</code> does not
exists:</p>

<ul>
<li><p><code>:ERROR:</code> An error is signalled.</p></li>
<li><p><code>:CREATE:</code> A new memory-mapped file is created ensuring that all
  containing directories exist.</p></li>
<li><p><code>NIL</code>: Return <code>NIL</code> without doing anything.</p></li>
</ul>

<p>See <a href="#x-28LMDB-3ACLOSE-ENV-20FUNCTION-29" title="(LMDB:CLOSE-ENV FUNCTION)"><code>CLOSE-ENV</code></a> for the description of <code>SYNCHRONIZED</code>.</p>

<ul>
<li><p><code>MAX-DBS</code>: The maximum number of named databases in the environment.
  Currently a moderate number is cheap, but a huge number gets
  expensive: 7-120 words per transaction, and every <a href="#x-28LMDB-3AGET-DB-20FUNCTION-29" title="(LMDB:GET-DB FUNCTION)"><code>GET-DB</code></a> does a
  linear search of the opened database.</p></li>
<li><p><code>MAP-SIZE</code>: Specifies the size of the data file in bytes. The new
  size takes effect immediately for the current process, but will
  not be persisted to any others until a write transaction has been
  committed by the current process. Also, only map size increases
  are persisted into the environment. If the map size is increased
  by another process, and data has grown beyond the range of the
  current mapsize, starting a new transaction (see <a href="#x-28LMDB-3AWITH-TXN-20MGL-PAX-3AMACRO-29" title="(LMDB:WITH-TXN MGL-PAX:MACRO)"><code>WITH-TXN</code></a>) will
  signal <a href="#x-28LMDB-3ALMDB-MAP-RESIZED-ERROR-20CONDITION-29" title="(LMDB:LMDB-MAP-RESIZED-ERROR CONDITION)"><code>LMDB-MAP-RESIZED-ERROR</code></a>. If zero is specified for <code>MAP-SIZE</code>,
  then the persisted size is used from the data file. Also see
  <a href="#x-28LMDB-3ALMDB-MAP-FULL-ERROR-20CONDITION-29" title="(LMDB:LMDB-MAP-FULL-ERROR CONDITION)"><code>LMDB-MAP-FULL-ERROR</code></a>.</p></li>
<li><p><code>MODE</code>: Unix file mode for files created. The default is <code>#o664</code>.
  Has no effect when opening an existing environment.</p></li>
</ul>

<p>The rest of the arguments correspond to <code>LMDB</code> environment flags and
are available in the plist <a href="#x-28LMDB-3AENV-FLAGS-20-28MGL-PAX-3AREADER-20LMDB-3AENV-29-29" title="(LMDB:ENV-FLAGS (MGL-PAX:READER LMDB:ENV))"><code>ENV-FLAGS</code></a>.</p>

<ul>
<li><p><code>SUBDIR</code>: If <code>SUBDIR</code>, then the path is a directory which holds the
  <code>data.mdb</code> and the <code>lock.mdb</code> files. If <code>SUBDIR</code> is <code>NIL</code>, the path
  is the filename of the data file and the lock file has the same
  name plus a <code>-lock</code> suffix.</p></li>
<li><p><code>SYNC</code>: If <code>NIL</code>, don't <code>fsync</code> after commit. This optimization means
  a system crash can corrupt the database or lose the last
  transactions if buffers are not yet flushed to disk. The risk is
  governed by how often the system flushes dirty buffers to disk and
  how often <a href="#x-28LMDB-3ASYNC-ENV-20FUNCTION-29" title="(LMDB:SYNC-ENV FUNCTION)"><code>SYNC-ENV</code></a> is called. However, if the filesystem preserves
  write order (very few do) and the <code>WRITE-MAP</code> (currently
  unsupported) flag is not used, transactions exhibit
  ACI (atomicity, consistency, isolation) properties and only lose
  D (durability). I.e. database integrity is maintained, but a
  system crash may undo the final transactions.</p></li>
<li><p><code>META-SYNC</code>: If <code>NIL</code>, flush system buffers to disk only once per
  transaction, but omit the metadata flush. Defer that until the
  system flushes files to disk, the next commit of a non-read-only
  transaction or <code>SYNC-ENV</code>. This optimization maintains database
  integrity, but a system crash may undo the last committed
  transaction. I.e. it preserves the ACI (atomicity, consistency,
  isolation) but not D (durability) database property.</p></li>
<li><p><code>READ-ONLY</code>: Map the data file in read-only mode. It is an error to
  try to modify anything in it.</p></li>
<li><p><code>TLS</code>: Setting it to <code>NIL</code> allows each OS thread to have multiple
  read-only transactions (see <code>WITH-TXN</code>'s <code>IGNORE-PARENT</code> argument). It
  also allows and transactions not to be tied to a single thread,
  but that's quite dangerous, see <a href="#x-28LMDB-3A-40LMDB-2FSAFETY-20MGL-PAX-3ASECTION-29" title="Safety">Safety</a>.</p></li>
<li><p><code>READ-AHEAD</code>: Turn off readahead as in <code>madvise(MADV_RANDOM)</code>. Most
  operating systems perform read-ahead on read requests by default.
  This option turns it off if the OS supports it. Turning it off may
  help random read performance when the <a href="#x-28LMDB-3ADB-20CLASS-29" title="(LMDB:DB CLASS)"><code>DB</code></a> is larger than RAM and
  system RAM is full. This option is not implemented on Windows.</p></li>
<li><p><code>LOCK</code>: Data corruption lurks here. If <code>NIL</code>, don't do any locking. If
  concurrent access is anticipated, the caller must manage all
  concurrency itself. For proper operation the caller must enforce
  single-writer semantics, and must ensure that no readers are using
  old transactions while a writer is active. The simplest approach
  is to use an exclusive lock so that no readers may be active at
  all when a writer begins.</p></li>
<li><p><code>MEM-INIT</code>: If <code>NIL</code>, don't initialize <code>malloc</code>ed memory before
  writing to unused spaces in the data file. By default, memory for
  pages written to the data file is obtained using <code>malloc</code>. While
  these pages may be reused in subsequent transactions, freshly
  <code>malloc</code>ed pages will be initialized to zeroes before use. This
  avoids persisting leftover data from other code (that used the
  heap and subsequently freed the memory) into the data file. Note
  that many other system libraries may allocate and free memory from
  the heap for arbitrary uses. E.g., stdio may use the heap for file
  I/O buffers. This initialization step has a modest performance
  cost so some applications may want to disable it using this flag.
  This option can be a problem for applications which handle
  sensitive data like passwords, and it makes memory checkers like
  Valgrind noisy. This flag is not needed with <code>WRITE-MAP</code>, which
  writes directly to the mmap instead of using malloc for pages.</p></li>
<li><p><code>FIXED-MAP</code> (experimental): This flag must be specified when
  creating the environment and is stored persistently in the data
  file. If successful, the memory map will always reside at the same
  virtual address and pointers used to reference data items in the
  database will be constant across multiple invocations. This option
  may not always work, depending on how the operating system has
  allocated memory to shared libraries and other uses.</p></li>
</ul>

<p>Unsupported flags (an error is signalled if they are changed from
their default values):</p>

<ul>
<li><p><code>WRITE-MAP</code>: Use a writable memory map unless <code>READ-ONLY</code> is set. This
  is faster and uses fewer mallocs, but loses protection from
  application bugs like wild pointer writes and other bad updates
  into the database. Incompatible with nested transactions. This may
  be slightly faster for <code>DB</code>s that fit entirely in RAM, but is slower
  for <code>DB</code>s larger than RAM. Do not mix processes with and without
  <code>WRITE-MAP</code> on the same environment. This can defeat
  durability (<code>SYNC-ENV</code>, etc).</p></li>
<li><p><code>MAP-ASYNC</code>: When using <code>WRITE-MAP</code>, use asynchronous flushes to disk.
  As with <code>SYNC</code> <code>NIL</code>, a system crash can then corrupt the database or
  lose the last transactions. Calling #sync ensures on-disk database
  integrity until next commit.</p></li>
</ul>

<p>Open environments have a finalizer attached to them that takes care
of freeing foreign resources. Thus, the common idiom:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><a href="http://www.lispworks.com/reference/HyperSpec/Body/s_setq.htm" class="symbol"><i><span class="symbol">setq</span></i></a> <span class="special">*env*</span> <span class="paren2">(<span class="code">open-env <span class="string">"some-path"</span></span>)</span></span>)</span></span></code></pre>

<p>is okay for development, too. No need to always do <a href="#x-28LMDB-3AWITH-ENV-20MGL-PAX-3AMACRO-29" title="(LMDB:WITH-ENV MGL-PAX:MACRO)"><code>WITH-ENV</code></a>,
which does not mesh with threads anyway.</p>

<p>Wraps <a href="http://www.lmdb.tech/doc/group__mdb.html#gaad6be3d8dcd4ea01f8df436f41d158d4" >mdb_env_create()</a>
and <a href="http://www.lmdb.tech/doc/group__mdb.html#ga32a193c6bf4d7d5c5d579e71f22e9340" >mdb_env_open()</a>.</p></li>
</ul>

<p><a id='x-28LMDB-3ACLOSE-ENV-20FUNCTION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L1081">[function]</a></span> <span class="reference-object"><a href="#x-28LMDB-3ACLOSE-ENV-20FUNCTION-29" >CLOSE-ENV</a></span></span> <span class="locative-args">ENV &amp;KEY FORCE</span></span></p>

<p>Close <code>ENV</code> and free the memory. Closing an already closed <code>ENV</code> has no effect.</p>

<p>Since accessing <a href="#x-28LMDB-3A-40LMDB-2FTRANSACTIONS-20MGL-PAX-3ASECTION-29" title="Transactions">Transactions</a>, <a href="#x-28LMDB-3A-40LMDB-2FDATABASES-20MGL-PAX-3ASECTION-29" title="Databases">Databases</a> and
<a href="#x-28LMDB-3A-40LMDB-2FCURSORS-20MGL-PAX-3ASECTION-29" title="Cursors">Cursors</a> after closing their environment would risk database
curruption, <code>CLOSE-ENV</code> makes sure that they are not in use. There are
two ways this can happen:</p>

<ul>
<li><p>If <code>ENV</code> was opened <code>:SYNCHRONIZED</code> (see <a href="#x-28LMDB-3AOPEN-ENV-20FUNCTION-29" title="(LMDB:OPEN-ENV FUNCTION)"><code>OPEN-ENV</code></a>), then <code>CLOSE-ENV</code>
  waits until there are no <a href="#x-28LMDB-3A-40ACTIVE-TRANSACTION-20MGL-PAX-3AGLOSSARY-TERM-29" title="(LMDB:@ACTIVE-TRANSACTION MGL-PAX:GLOSSARY-TERM)">active transaction</a>s in <code>ENV</code> before
  closing it. This requires synchronization and introduces some
  overhead, which might be noticable for workloads involving lots of
  quick read transactions. It is an <a href="#x-28LMDB-3ALMDB-ERROR-20CONDITION-29" title="(LMDB:LMDB-ERROR CONDITION)"><code>LMDB-ERROR</code></a> to attempt to close
  an environment in a <a href="#x-28LMDB-3AWITH-TXN-20MGL-PAX-3AMACRO-29" title="(LMDB:WITH-TXN MGL-PAX:MACRO)"><code>WITH-TXN</code></a> to avoid deadlocks.</p></li>
<li><p>On the other hand, if <code>SYNCHRONIZED</code> was <code>NIL</code>, then - unless <code>FORCE</code> is
  true - calling <code>CLOSE-ENV</code> signals an <code>LMDB-ERROR</code> to avoid the
  <a href="#x-28LMDB-3A-40LMDB-2FSAFETY-20MGL-PAX-3ASECTION-29" title="Safety">Safety</a> issues involved in closing the environment.
  Environments opened with <code>:SYNCHRONIZED</code> <code>NIL</code> are only closed when
  they are garbage collected and their finalizer is run. Still, for
  production it might be worth it to gain the last bit of
  performance.</p></li>
</ul>

<p>Wraps <a href="http://www.lmdb.tech/doc/group__mdb.html#ga4366c43ada8874588b6a62fbda2d1e95" >mdb_env_close()</a>.</p></li>
</ul>

<p><a id='x-28LMDB-3A-2AENV-2A-20VARIABLE-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L1123">[variable]</a></span> <span class="reference-object"><a href="#x-28LMDB-3A-2AENV-2A-20VARIABLE-29" >*ENV*</a></span></span> <span class="locative-args">NIL</span></span></p>

<p>The default <a href="#x-28LMDB-3AENV-20CLASS-29" title="(LMDB:ENV CLASS)"><code>ENV</code></a> for macros and function that take an environment
argument.</p></li>
</ul>

<p><a id='x-28LMDB-3AWITH-ENV-20MGL-PAX-3AMACRO-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L1127">[macro]</a></span> <span class="reference-object"><a href="#x-28LMDB-3AWITH-ENV-20MGL-PAX-3AMACRO-29" >WITH-ENV</a></span></span> <span class="locative-args">(ENV PATH &amp;REST OPEN-ENV-ARGS) &amp;BODY BODY</span></span></p>

<p>Bind the variable <code>ENV</code> to a new enviroment returned by <a href="#x-28LMDB-3AOPEN-ENV-20FUNCTION-29" title="(LMDB:OPEN-ENV FUNCTION)"><code>OPEN-ENV</code></a>
called with <code>PATH</code> and <code>OPEN-ENV-ARGS</code>, execute <code>BODY</code>, and <a href="#x-28LMDB-3ACLOSE-ENV-20FUNCTION-29" title="(LMDB:CLOSE-ENV FUNCTION)"><code>CLOSE-ENV</code></a>. The
following example binds the default environment:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">with-env</span></i> <span class="paren2">(<span class="code"><span class="special">*env*</span> <span class="string">"/tmp/lmdb-test"</span> <span class="keyword">:if-does-not-exist</span> <span class="keyword">:create</span></span>)</span>
  ...</span>)</span></span></code></pre></li>
</ul>

<p><a id='x-28LMDB-3AOPEN-ENV-P-20FUNCTION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L758">[function]</a></span> <span class="reference-object"><a href="#x-28LMDB-3AOPEN-ENV-P-20FUNCTION-29" >OPEN-ENV-P</a></span></span> <span class="locative-args">ENV</span></span></p>

<p>See if <code>ENV</code> is open, i.e. <a href="#x-28LMDB-3AOPEN-ENV-20FUNCTION-29" title="(LMDB:OPEN-ENV FUNCTION)"><code>OPEN-ENV</code></a> has been called on it without a
corresponding <a href="#x-28LMDB-3ACLOSE-ENV-20FUNCTION-29" title="(LMDB:CLOSE-ENV FUNCTION)"><code>CLOSE-ENV</code></a>.</p></li>
</ul>

<p><a id='x-28LMDB-3A-40LMDB-2FMISC-ENV-20MGL-PAX-3ASECTION-29'></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#x-28LMDB-3A-40LMDB-2FOPENING-AND-CLOSING-ENV-20MGL-PAX-3ASECTION-29" title="Opening and closing environments">&#8592;</a> <a href="#x-28LMDB-3A-40LMDB-2FENVIRONMENTS-20MGL-PAX-3ASECTION-29" title="Environments">&#8593;</a> <a href="#x-28LMDB-3A-40LMDB-2FTRANSACTIONS-20MGL-PAX-3ASECTION-29" title="Transactions">&#8594;</a> <a href="#x-28LMDB-3A-40LMDB-2FMISC-ENV-20MGL-PAX-3ASECTION-29" title="Miscellaneous environment functions">&#8634;</a> <a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L1142">&#955;</a></span></span></p>

<h3><a href="#x-28LMDB-3A-40LMDB-2FMISC-ENV-20MGL-PAX-3ASECTION-29">6.3 Miscellaneous environment functions</a></h3>

<p><a id='x-28LMDB-3ACHECK-FOR-STALE-READERS-20FUNCTION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L1150">[function]</a></span> <span class="reference-object"><a href="#x-28LMDB-3ACHECK-FOR-STALE-READERS-20FUNCTION-29" >CHECK-FOR-STALE-READERS</a></span></span> <span class="locative-args">&amp;OPTIONAL (ENV <a href="#x-28LMDB-3A-2AENV-2A-20VARIABLE-29" title="(LMDB:*ENV* VARIABLE)"><code>*ENV*</code></a>)</span></span></p>

<p>Check for stale entries in the reader lock table. See
<a href="http://www.lmdb.tech/doc/" >Caveats</a>. This function is called
automatically by <a href="#x-28LMDB-3AOPEN-ENV-20FUNCTION-29" title="(LMDB:OPEN-ENV FUNCTION)"><code>OPEN-ENV</code></a>. If other OS processes or threads
accessing <code>ENV</code> abort without closing read transactions, call this
function periodically to get rid off them. Alternatively, close all
environments accessing the data file.</p>

<p>Wraps <a href="http://www.lmdb.tech/doc/group__mdb.html#ga366923d08bb384b3d9580a98edf5d668" >mdb_reader_check()</a>.</p></li>
</ul>

<p><a id='x-28LMDB-3AENV-STATISTICS-20FUNCTION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L1166">[function]</a></span> <span class="reference-object"><a href="#x-28LMDB-3AENV-STATISTICS-20FUNCTION-29" >ENV-STATISTICS</a></span></span> <span class="locative-args">&amp;OPTIONAL (ENV <a href="#x-28LMDB-3A-2AENV-2A-20VARIABLE-29" title="(LMDB:*ENV* VARIABLE)"><code>*ENV*</code></a>)</span></span></p>

<p>Return statistics about <code>ENV</code> as a plist.</p>

<ul>
<li><p><code>:PAGE-SIZE:</code> The size of a database page in bytes.</p></li>
<li><p><code>:DEPTH:</code> The height of the B-tree.</p></li>
<li><p><code>:BRANCH-PAGES:</code> The number of internal (non-leaf) pages.</p></li>
<li><p><code>:LEAF-PAGES:</code> The number of leaf pages.</p></li>
<li><p><code>:OVERFLOW-PAGES:</code> The number of overflow pages.</p></li>
<li><p><code>:ENTRIES:</code> The number of data items.</p></li>
</ul>

<p>Wraps <a href="http://www.lmdb.tech/doc/group__mdb.html#gaf881dca452050efbd434cd16e4bae255" >mdb_env_stat()</a>.</p></li>
</ul>

<p><a id='x-28LMDB-3AENV-INFO-20FUNCTION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L1196">[function]</a></span> <span class="reference-object"><a href="#x-28LMDB-3AENV-INFO-20FUNCTION-29" >ENV-INFO</a></span></span> <span class="locative-args">&amp;OPTIONAL (ENV <a href="#x-28LMDB-3A-2AENV-2A-20VARIABLE-29" title="(LMDB:*ENV* VARIABLE)"><code>*ENV*</code></a>)</span></span></p>

<p>Return information about <code>ENV</code> as a plist.</p>

<ul>
<li><p><code>:MAP-ADDRESS:</code> Address of memory map, if fixed (see <a href="#x-28LMDB-3AOPEN-ENV-20FUNCTION-29" title="(LMDB:OPEN-ENV FUNCTION)"><code>OPEN-ENV</code></a>'s
  <code>FIXED-MAP</code>).</p></li>
<li><p><code>:MAP-SIZE:</code> Size of the memory map in bytes.</p></li>
<li><p><code>:LAST-PAGE-NUMBER:</code> Id of the last used page.</p></li>
<li><p><code>:LAST-TXN-ID:</code> Id of the last committed transaction.</p></li>
<li><p><code>:MAXIMUM-READERS:</code> The number of reader slots.</p></li>
<li><p><code>:N-READERS:</code> The number of reader slots current used.</p></li>
</ul>

<p>Wraps <a href="http://www.lmdb.tech/doc/group__mdb.html#ga18769362c7e7d6cf91889a028a5c5947" >mdb_env_info()</a>.</p></li>
</ul>

<p><a id='x-28LMDB-3ASYNC-ENV-20FUNCTION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L1227">[function]</a></span> <span class="reference-object"><a href="#x-28LMDB-3ASYNC-ENV-20FUNCTION-29" >SYNC-ENV</a></span></span> <span class="locative-args">&amp;OPTIONAL (ENV <a href="#x-28LMDB-3A-2AENV-2A-20VARIABLE-29" title="(LMDB:*ENV* VARIABLE)"><code>*ENV*</code></a>)</span></span></p>

<p>Flush the data buffers to disk as in calling <code>fsync()</code>. When <code>ENV</code>
had been opened with <code>:SYNC</code> <code>NIL</code> or <code>:META-SYNC</code> <code>NIL</code>, this may be handy
to force flushing the OS buffers to disk, which avoids potential
durability and integrity issues.</p>

<p>Wraps <a href="http://www.lmdb.tech/doc/group__mdb.html#ga85e61f05aa68b520cc6c3b981dba5037" >mdb_env_sync()</a>.</p></li>
</ul>

<p><a id='x-28LMDB-3AENV-MAX-KEY-SIZE-20FUNCTION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L1237">[function]</a></span> <span class="reference-object"><a href="#x-28LMDB-3AENV-MAX-KEY-SIZE-20FUNCTION-29" >ENV-MAX-KEY-SIZE</a></span></span> <span class="locative-args">&amp;OPTIONAL (ENV <a href="#x-28LMDB-3A-2AENV-2A-20VARIABLE-29" title="(LMDB:*ENV* VARIABLE)"><code>*ENV*</code></a>)</span></span></p>

<p>Return the maximum size of keys and <a href="#x-28LMDB-3A-40DUPSORT-20MGL-PAX-3ASECTION-29" title="DUPSORT">DUPSORT</a> data in bytes. Depends
on the compile-time constant <code>MDB_MAXKEYSIZE</code> in the C library. The
default is 511. If this limit is exceeded <a href="#x-28LMDB-3ALMDB-BAD-VALSIZE-ERROR-20CONDITION-29" title="(LMDB:LMDB-BAD-VALSIZE-ERROR CONDITION)"><code>LMDB-BAD-VALSIZE-ERROR</code></a> is
signalled.</p>

<p>Wraps <a href="http://www.lmdb.tech/doc/group__mdb.html#gaaf0be004f33828bf2fb09d77eb3cef94" >mdb_env_get_maxkeysize()</a>.</p></li>
</ul>

<p><a id='x-28LMDB-3AWITH-TEMPORARY-ENV-20MGL-PAX-3AMACRO-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L1247">[macro]</a></span> <span class="reference-object"><a href="#x-28LMDB-3AWITH-TEMPORARY-ENV-20MGL-PAX-3AMACRO-29" >WITH-TEMPORARY-ENV</a></span></span> <span class="locative-args">(ENV &amp;REST OPEN-ENV-ARGS) &amp;BODY BODY</span></span></p>

<p>Run <code>BODY</code> with an open temporary environment bound to <code>ENV</code>. In more
detail, create an environment in a fresh temporary directory in an
OS specific location. <code>OPEN-ENV-ARGS</code> is a list of keyword arguments
and values for <a href="#x-28LMDB-3AOPEN-ENV-20FUNCTION-29" title="(LMDB:OPEN-ENV FUNCTION)"><code>OPEN-ENV</code></a>. This macro is intended for testing and
examples.</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">with-temporary-env</span></i> <span class="paren2">(<span class="code"><span class="special">*env*</span></span>)</span>
  <span class="paren2">(<span class="code"><a href="http://www.lispworks.com/reference/HyperSpec/Body/s_let_l.htm" class="symbol"><i><span class="symbol">let</span></i></a> <span class="paren3">(<span class="code"><span class="paren4">(<span class="code">db <span class="paren5">(<span class="code">get-db <span class="string">"test"</span></span>)</span></span>)</span></span>)</span>
    <span class="paren3">(<span class="code"><i><span class="symbol">with-txn</span></i> <span class="paren4">(<span class="code"><span class="keyword">:write</span> <a href="http://www.lispworks.com/reference/HyperSpec/Body/a_t.htm" class="symbol">t</a></span>)</span>
      <span class="paren4">(<span class="code">put db <span class="string">"k1"</span> #<span class="paren5">(<span class="code">2 3</span>)</span></span>)</span>
      <span class="paren4">(<span class="code"><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_wr_pr.htm" class="symbol">print</a> <span class="paren5">(<span class="code">g3t db <span class="string">"k1"</span></span>)</span></span>)</span> <span class="comment">; =&gt; #(2 3)
</span>      <span class="paren4">(<span class="code">del db <span class="string">"k1"</span></span>)</span></span>)</span></span>)</span></span>)</span></span></code></pre>

<p>Since data corruption in temporary environments is not a concern,
unlike <a href="#x-28LMDB-3AWITH-ENV-20MGL-PAX-3AMACRO-29" title="(LMDB:WITH-ENV MGL-PAX:MACRO)"><code>WITH-ENV</code></a>, <code>WITH-TEMPORARY-ENV</code> closes the environment even if
it was opened with <code>:SYNCHRONIZED</code> <code>NIL</code> (see <code>OPEN-ENV</code> and
<a href="#x-28LMDB-3ACLOSE-ENV-20FUNCTION-29" title="(LMDB:CLOSE-ENV FUNCTION)"><code>CLOSE-ENV</code></a>).</p></li>
</ul>

<p><a id='x-28LMDB-3A-40LMDB-2FTRANSACTIONS-20MGL-PAX-3ASECTION-29'></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#x-28LMDB-3A-40LMDB-2FMISC-ENV-20MGL-PAX-3ASECTION-29" title="Miscellaneous environment functions">&#8592;</a> <a href="#x-28LMDB-3A-40LMDB-MANUAL-20MGL-PAX-3ASECTION-29" title="LMDB Manual">&#8593;</a> <a href="#x-28LMDB-3A-40LMDB-2FNESTING-TRANSACTIONS-20MGL-PAX-3ASECTION-29" title="Nesting transactions">&#8594;</a> <a href="#x-28LMDB-3A-40LMDB-2FTRANSACTIONS-20MGL-PAX-3ASECTION-29" title="Transactions">&#8634;</a> <a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L1296">&#955;</a></span></span></p>

<h2><a href="#x-28LMDB-3A-40LMDB-2FTRANSACTIONS-20MGL-PAX-3ASECTION-29">7 Transactions</a></h2>

<p>The <a href="#x-28-23A-28-284-29-20BASE-CHAR-20-2E-20-22lmdb-22-29-20ASDF-2FSYSTEM-3ASYSTEM-29" title="(#A((4) BASE-CHAR . \&quot;lmdb\&quot;) ASDF/SYSTEM:SYSTEM)"><code>LMDB</code></a> environment supports transactional reads and writes. By
default, these provide the standard ACID (atomicity, consistency,
isolation, durability) guarantees. Writes from a transaction are not
immediately visible to other transactions. When the transaction is
committed, all its writes become visible atomically for future
transactions even if Lisp crashes or there is power failure. If the
transaction is aborted, its writes are discarded.</p>

<p>Transactions span the entire environment (see <a href="#x-28LMDB-3AENV-20CLASS-29" title="(LMDB:ENV CLASS)"><code>ENV</code></a>). All the updates
made in the course of an update transaction - writing records across
all databases, creating databases, and destroying databases - are
either completed atomically or rolled back.</p>

<p>Write transactions can be nested. Child transactions see the
uncommitted writes of their parent. The child transaction can commit
or abort, at which point its writes become visible to the parent
transaction or are discarded. If the parent aborts, all of the
writes performed in the context of the parent, including those from
committed child transactions, are discarded.</p>

<p><a id='x-28LMDB-3AWITH-TXN-20MGL-PAX-3AMACRO-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L1444">[macro]</a></span> <span class="reference-object"><a href="#x-28LMDB-3AWITH-TXN-20MGL-PAX-3AMACRO-29" >WITH-TXN</a></span></span> <span class="locative-args">(&amp;KEY (ENV '<a href="#x-28LMDB-3A-2AENV-2A-20VARIABLE-29" title="(LMDB:*ENV* VARIABLE)"><code>*ENV*</code></a>) WRITE IGNORE-PARENT (SYNC <code>T</code>) (META-SYNC <code>T</code>)) &amp;BODY BODY</span></span></p>

<p>Start a transaction in <code>ENV</code>, execute <code>BODY</code>. Then, if the transaction
is open (see <a href="#x-28LMDB-3AOPEN-TXN-P-20FUNCTION-29" title="(LMDB:OPEN-TXN-P FUNCTION)"><code>OPEN-TXN-P</code></a>) and <code>BODY</code> returned normally, attempt to
commit the transaction. Next, if <code>BODY</code> performed a non-local exit or
committing failed, but the transaction is still open, then abort it.
It is explicitly allowed to call <a href="#x-28LMDB-3ACOMMIT-TXN-20FUNCTION-29" title="(LMDB:COMMIT-TXN FUNCTION)"><code>COMMIT-TXN</code></a> or <a href="#x-28LMDB-3AABORT-TXN-20FUNCTION-29" title="(LMDB:ABORT-TXN FUNCTION)"><code>ABORT-TXN</code></a> within
<code>WITH-TXN</code>.</p>

<p>Transactions provide ACID guarantees (with <code>SYNC</code> and <code>META-SYNC</code> both
on). They span the entire environment, they are not specific to
individual <a href="#x-28LMDB-3ADB-20CLASS-29" title="(LMDB:DB CLASS)"><code>DB</code></a>.</p>

<ul>
<li><p>If <code>WRITE</code> is <code>NIL</code>, the transaction is read-only and no writes (e.g.
  <a href="#x-28LMDB-3APUT-20FUNCTION-29" title="(LMDB:PUT FUNCTION)"><code>PUT</code></a>) may be performed in the transaction. On the flipside, many
  read-only transactions can run concurrently (see <a href="#x-28LMDB-3AENV-MAX-READERS-20-28MGL-PAX-3AREADER-20LMDB-3AENV-29-29" title="(LMDB:ENV-MAX-READERS (MGL-PAX:READER LMDB:ENV))"><code>ENV-MAX-READERS</code></a>),
  while write transactions are mutually exclusive. Furthermore, the
  single write transaction can also run concurrently with read
  transactions, just keep in mind that read transactions hold on to
  the state of the environment at the time of their creation and
  thus prevent pages since replaced from being reused.</p></li>
<li><p>If <code>IGNORE-PARENT</code> is true, then in an enclosing <code>WITH-TXN</code>, instead
  of creating a child transaction, start an independent transaction.</p></li>
<li><p>If <code>SYNC</code> is <code>NIL</code>, then no flushing of buffers will take place after
  a commit as if the environment had been opened with <code>:SYNC</code> <code>NIL</code>.</p></li>
<li><p>Likewise, <code>META-SYNC</code> is the per-transaction equivalent of the
  <a href="#x-28LMDB-3AOPEN-ENV-20FUNCTION-29" title="(LMDB:OPEN-ENV FUNCTION)"><code>OPEN-ENV</code></a>'s <code>META-SYNC</code>.</p></li>
</ul>

<p>Also see <a href="#x-28LMDB-3A-40LMDB-2FNESTING-TRANSACTIONS-20MGL-PAX-3ASECTION-29" title="Nesting transactions">Nesting transactions</a>.</p>

<p>Wraps <a href="http://www.lmdb.tech/doc/group__mdb.html#gad7ea55da06b77513609efebd44b26920" >mdb_txn_begin()</a>.</p></li>
</ul>

<p><a id='x-28LMDB-3A-40ACTIVE-TRANSACTION-20MGL-PAX-3AGLOSSARY-TERM-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L1343">[glossary-term]</a></span> <span class="reference-object"><a href="#x-28LMDB-3A-40ACTIVE-TRANSACTION-20MGL-PAX-3AGLOSSARY-TERM-29" >active transaction</a></span></span></span></p>

<p>The active transaction in some environment and thread is the
transaction of the innermost <a href="#x-28LMDB-3AWITH-TXN-20MGL-PAX-3AMACRO-29" title="(LMDB:WITH-TXN MGL-PAX:MACRO)"><code>WITH-TXN</code></a> being executed in the thread
that belongs to the environment. In most cases, this is simply the
enclosing <code>WITH-TXN</code>, but if <code>WITH-TXN</code>s with different <code>:ENV</code> arguments
are nested, then it may not be:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">with-temporary-env</span></i> <span class="paren2">(<span class="code">env</span>)</span>
  <span class="paren2">(<span class="code"><a href="http://www.lispworks.com/reference/HyperSpec/Body/s_let_l.htm" class="symbol"><i><span class="symbol">let</span></i></a> <span class="paren3">(<span class="code"><span class="paren4">(<span class="code">db <span class="paren5">(<span class="code">get-db <span class="string">"db"</span> <span class="keyword">:env</span> env</span>)</span></span>)</span></span>)</span>
    <span class="paren3">(<span class="code"><i><span class="symbol">with-temporary-env</span></i> <span class="paren4">(<span class="code">inner-env</span>)</span>
      <span class="paren4">(<span class="code"><i><span class="symbol">with-txn</span></i> <span class="paren5">(<span class="code"><span class="keyword">:env</span> env <span class="keyword">:write</span> <a href="http://www.lispworks.com/reference/HyperSpec/Body/a_t.htm" class="symbol">t</a></span>)</span>
        <span class="paren5">(<span class="code"><i><span class="symbol">with-txn</span></i> <span class="paren6">(<span class="code"><span class="keyword">:env</span> inner-env</span>)</span>
          <span class="paren6">(<span class="code">put db #<span class="paren1">(<span class="code">1</span>)</span> #<span class="paren1">(<span class="code">2</span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span></code></pre>

<p>In the above example, <a href="#x-28LMDB-3ADB-20CLASS-29" title="(LMDB:DB CLASS)"><code>DB</code></a> is known to belong to <a href="#x-28LMDB-3AENV-20CLASS-29" title="(LMDB:ENV CLASS)"><code>ENV</code></a> so although the
immediately enclosing transaction belongs to INNER-ENV, <a href="#x-28LMDB-3APUT-20FUNCTION-29" title="(LMDB:PUT FUNCTION)"><code>PUT</code></a> is
executed in context of the outer, write transaction because that's
the innermost in <code>ENV</code>.</p>

<p>Operations that require a transaction always attempt to use the
active transaction even if it is not open (see <a href="#x-28LMDB-3AOPEN-TXN-P-20FUNCTION-29" title="(LMDB:OPEN-TXN-P FUNCTION)"><code>OPEN-TXN-P</code></a>).</p></li>
</ul>

<p><a id='x-28LMDB-3AOPEN-TXN-P-20FUNCTION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L1421">[function]</a></span> <span class="reference-object"><a href="#x-28LMDB-3AOPEN-TXN-P-20FUNCTION-29" >OPEN-TXN-P</a></span></span> <span class="locative-args">&amp;OPTIONAL ENV</span></span></p>

<p>See if there is an active transaction and it is open, i.e.
<a href="#x-28LMDB-3ACOMMIT-TXN-20FUNCTION-29" title="(LMDB:COMMIT-TXN FUNCTION)"><code>COMMIT-TXN</code></a> or <a href="#x-28LMDB-3AABORT-TXN-20FUNCTION-29" title="(LMDB:ABORT-TXN FUNCTION)"><code>ABORT-TXN</code></a> have not been called on it. Also, <a href="#x-28LMDB-3ARESET-TXN-20FUNCTION-29" title="(LMDB:RESET-TXN FUNCTION)"><code>RESET-TXN</code></a>
without a corresponding <a href="#x-28LMDB-3ARENEW-TXN-20FUNCTION-29" title="(LMDB:RENEW-TXN FUNCTION)"><code>RENEW-TXN</code></a> closes the transaction.</p></li>
</ul>

<p><a id='x-28LMDB-3ATXN-ID-20FUNCTION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L1436">[function]</a></span> <span class="reference-object"><a href="#x-28LMDB-3ATXN-ID-20FUNCTION-29" >TXN-ID</a></span></span> <span class="locative-args"></span></span></p>

<p>The ID of <code>TXN</code>. IDs are integers incrementing from 1. For a
read-only transaction, this corresponds to the snapshot being read;
concurrent readers will frequently have the same transaction ID.
Only committed write transactions increment the ID. If a transaction
aborts, the ID may be re-used by the next writer.</p></li>
</ul>

<p><a id='x-28LMDB-3ACOMMIT-TXN-20FUNCTION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L1641">[function]</a></span> <span class="reference-object"><a href="#x-28LMDB-3ACOMMIT-TXN-20FUNCTION-29" >COMMIT-TXN</a></span></span> <span class="locative-args">&amp;OPTIONAL ENV</span></span></p>

<p>Commit the innermost enclosig transaction (or <a href="#x-28LMDB-3A-40ACTIVE-TRANSACTION-20MGL-PAX-3AGLOSSARY-TERM-29" title="(LMDB:@ACTIVE-TRANSACTION MGL-PAX:GLOSSARY-TERM)">active transaction</a>
belonging to <code>ENV</code> if <code>ENV</code> is specified) or signal an error if it is
not open. If <code>TXN</code> is not nested in another transaction, committing
makes updates performed visible to future transactions. If <code>TXN</code> is a
child transaction, then committing makes updates visible to its
parent only. For read-only transactions, committing releases the
reference to a historical version environment, allowing reuse of
pages replaced since.</p>

<p>Wraps <a href="http://www.lmdb.tech/doc/group__mdb.html#ga846fbd6f46105617ac9f4d76476f6597" >mdb_txn_commit()</a>.</p></li>
</ul>

<p><a id='x-28LMDB-3AABORT-TXN-20FUNCTION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L1659">[function]</a></span> <span class="reference-object"><a href="#x-28LMDB-3AABORT-TXN-20FUNCTION-29" >ABORT-TXN</a></span></span> <span class="locative-args">&amp;OPTIONAL ENV</span></span></p>

<p>Close <code>TXN</code> by discarding all updates performed, which will then not
be visible to either parent or future transactions. Aborting an
already closed transaction is a noop. Always succeeds.</p>

<p>Wraps <a href="http://www.lmdb.tech/doc/group__mdb.html#ga73a5938ae4c3239ee11efa07eb22b882" >mdb_txn_abort()</a>.</p></li>
</ul>

<p><a id='x-28LMDB-3ARENEW-TXN-20FUNCTION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L1688">[function]</a></span> <span class="reference-object"><a href="#x-28LMDB-3ARENEW-TXN-20FUNCTION-29" >RENEW-TXN</a></span></span> <span class="locative-args">&amp;OPTIONAL ENV</span></span></p>

<p>Renew <code>TXN</code> that was reset by <a href="#x-28LMDB-3ARESET-TXN-20FUNCTION-29" title="(LMDB:RESET-TXN FUNCTION)"><code>RESET-TXN</code></a>. This acquires a new reader
lock that had been released by <code>RESET-TXN</code>. After renewal, it is as if
<code>TXN</code> had just been started.</p>

<p>Wraps <a href="http://www.lmdb.tech/doc/group__mdb.html#ga6c6f917959517ede1c504cf7c720ce6d" >mdb_txn_renew()</a>.</p></li>
</ul>

<p><a id='x-28LMDB-3ARESET-TXN-20FUNCTION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L1671">[function]</a></span> <span class="reference-object"><a href="#x-28LMDB-3ARESET-TXN-20FUNCTION-29" >RESET-TXN</a></span></span> <span class="locative-args">&amp;OPTIONAL ENV</span></span></p>

<p>Abort the open, read-only <code>TXN</code>, release the reference to the
historical version of the environment, but make it faster to start
another read-only transaction with <a href="#x-28LMDB-3ARENEW-TXN-20FUNCTION-29" title="(LMDB:RENEW-TXN FUNCTION)"><code>RENEW-TXN</code></a>. This is accomplished
by not deallocating some data structures, and keeping the slot in
the reader table. Cursors opened within the transaction must not be
used again, except if renewed (see RENEW-CURSOR). If <code>TXN</code> is an open,
read-only transaction, this function always succeeds.</p>

<p>Wraps <a href="http://www.lmdb.tech/doc/group__mdb.html#ga02b06706f8a66249769503c4e88c56cd" >mdb_txn_reset()</a>.</p></li>
</ul>

<p><a id='x-28LMDB-3A-40LMDB-2FNESTING-TRANSACTIONS-20MGL-PAX-3ASECTION-29'></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#x-28LMDB-3A-40LMDB-2FTRANSACTIONS-20MGL-PAX-3ASECTION-29" title="Transactions">&#8592;</a> <a href="#x-28LMDB-3A-40LMDB-2FTRANSACTIONS-20MGL-PAX-3ASECTION-29" title="Transactions">&#8593;</a> <a href="#x-28LMDB-3A-40LMDB-2FDATABASES-20MGL-PAX-3ASECTION-29" title="Databases">&#8594;</a> <a href="#x-28LMDB-3A-40LMDB-2FNESTING-TRANSACTIONS-20MGL-PAX-3ASECTION-29" title="Nesting transactions">&#8634;</a> <a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L1705">&#955;</a></span></span></p>

<h3><a href="#x-28LMDB-3A-40LMDB-2FNESTING-TRANSACTIONS-20MGL-PAX-3ASECTION-29">7.1 Nesting transactions</a></h3>

<p>When <a href="#x-28LMDB-3AWITH-TXN-20MGL-PAX-3AMACRO-29" title="(LMDB:WITH-TXN MGL-PAX:MACRO)"><code>WITH-TXN</code></a>s are nested (i.e. one is executed in the dynamic
extent of another), we speak of nested transactions. Transaction can
be nested to arbitrary levels. Child transactions may be committed
or aborted independently from their parent transaction (the
immediately enclosing <code>WITH-TXN</code>). Committing a child transaction only
makes the updates made by it visible to the parent. If the parent
then aborts, the child's updates are aborted too. If the parent
commits, all child transactions that were not aborted are committed,
too.</p>

<p>Actually, the C lmdb library only supports nesting write
transactions. To simplify usage, the Lisp side turns read-only
<code>WITH-TXN</code>s nested in another <code>WITH-TXN</code>s into noops.</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">with-temporary-env</span></i> <span class="paren2">(<span class="code"><span class="special">*env*</span></span>)</span>
  <span class="paren2">(<span class="code"><a href="http://www.lispworks.com/reference/HyperSpec/Body/s_let_l.htm" class="symbol"><i><span class="symbol">let</span></i></a> <span class="paren3">(<span class="code"><span class="paren4">(<span class="code">db <span class="paren5">(<span class="code">get-db <span class="string">"test"</span> <span class="keyword">:value-encoding</span> <span class="keyword">:uint64</span></span>)</span></span>)</span></span>)</span>
    <span class="comment">;; Create a top-level write transaction.
</span>    <span class="paren3">(<span class="code"><i><span class="symbol">with-txn</span></i> <span class="paren4">(<span class="code"><span class="keyword">:write</span> <a href="http://www.lispworks.com/reference/HyperSpec/Body/a_t.htm" class="symbol">t</a></span>)</span>
      <span class="paren4">(<span class="code">put db <span class="string">"p"</span> 0</span>)</span>
      <span class="comment">;; First child transaction
</span>      <span class="paren4">(<span class="code"><i><span class="symbol">with-txn</span></i> <span class="paren5">(<span class="code"><span class="keyword">:write</span> <a href="http://www.lispworks.com/reference/HyperSpec/Body/a_t.htm" class="symbol">t</a></span>)</span>
        <span class="comment">;; Writes of the parent are visible in children.
</span>        <span class="paren5">(<span class="code"><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_assert.htm" class="symbol">assert</a> <span class="paren6">(<span class="code">= <span class="paren1">(<span class="code">g3t db <span class="string">"p"</span></span>)</span> 0</span>)</span></span>)</span>
        <span class="paren5">(<span class="code">put db <span class="string">"c1"</span> 1</span>)</span></span>)</span>
      <span class="comment">;; Parent sees what the child committed (but it's not visible to
</span>      <span class="comment">;; unrelated transactions).
</span>      <span class="paren4">(<span class="code"><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_assert.htm" class="symbol">assert</a> <span class="paren5">(<span class="code">= <span class="paren6">(<span class="code">g3t db <span class="string">"c1"</span></span>)</span> 1</span>)</span></span>)</span>
      <span class="comment">;; Second child transaction
</span>      <span class="paren4">(<span class="code"><i><span class="symbol">with-txn</span></i> <span class="paren5">(<span class="code"><span class="keyword">:write</span> <a href="http://www.lispworks.com/reference/HyperSpec/Body/a_t.htm" class="symbol">t</a></span>)</span>
        <span class="comment">;; Sees writes from the parent that came from the first child.
</span>        <span class="paren5">(<span class="code"><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_assert.htm" class="symbol">assert</a> <span class="paren6">(<span class="code">= <span class="paren1">(<span class="code">g3t db <span class="string">"c1"</span></span>)</span> 1</span>)</span></span>)</span>
        <span class="paren5">(<span class="code">put db <span class="string">"c1"</span> 2</span>)</span>
        <span class="paren5">(<span class="code">put db <span class="string">"c2"</span> 2</span>)</span>
        <span class="paren5">(<span class="code">abort-txn</span>)</span></span>)</span></span>)</span>
    <span class="comment">;; Create a top-level read transaction to check what was committed.
</span>    <span class="paren3">(<span class="code"><i><span class="symbol">with-txn</span></i> <span class="paren4">(<span class="code"></span>)</span>
      <span class="comment">;; Since the second child aborted, its writes are discarded.
</span>      <span class="paren4">(<span class="code"><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_assert.htm" class="symbol">assert</a> <span class="paren5">(<span class="code">= <span class="paren6">(<span class="code">g3t db <span class="string">"p"</span></span>)</span> 0</span>)</span></span>)</span>
      <span class="paren4">(<span class="code"><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_assert.htm" class="symbol">assert</a> <span class="paren5">(<span class="code">= <span class="paren6">(<span class="code">g3t db <span class="string">"c1"</span></span>)</span> 1</span>)</span></span>)</span>
      <span class="paren4">(<span class="code"><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_assert.htm" class="symbol">assert</a> <span class="paren5">(<span class="code"><a href="http://www.lispworks.com/reference/HyperSpec/Body/a_null.htm" class="symbol">null</a> <span class="paren6">(<span class="code">g3t db <span class="string">"c2"</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span></code></pre>

<p><a href="#x-28LMDB-3ACOMMIT-TXN-20FUNCTION-29" title="(LMDB:COMMIT-TXN FUNCTION)"><code>COMMIT-TXN</code></a>, <a href="#x-28LMDB-3AABORT-TXN-20FUNCTION-29" title="(LMDB:ABORT-TXN FUNCTION)"><code>ABORT-TXN</code></a>, and <a href="#x-28LMDB-3ARESET-TXN-20FUNCTION-29" title="(LMDB:RESET-TXN FUNCTION)"><code>RESET-TXN</code></a> all close the
<a href="#x-28LMDB-3A-40ACTIVE-TRANSACTION-20MGL-PAX-3AGLOSSARY-TERM-29" title="(LMDB:@ACTIVE-TRANSACTION MGL-PAX:GLOSSARY-TERM)">active transaction</a> (see <a href="#x-28LMDB-3AOPEN-TXN-P-20FUNCTION-29" title="(LMDB:OPEN-TXN-P FUNCTION)"><code>OPEN-TXN-P</code></a>). When the active transaction is
not open, database operations such as <a href="#x-28LMDB-3AG3T-20FUNCTION-29" title="(LMDB:G3T FUNCTION)"><code>G3T</code></a>, <a href="#x-28LMDB-3APUT-20FUNCTION-29" title="(LMDB:PUT FUNCTION)"><code>PUT</code></a>, <a href="#x-28LMDB-3ADEL-20FUNCTION-29" title="(LMDB:DEL FUNCTION)"><code>DEL</code></a> signal
<a href="#x-28LMDB-3ALMDB-BAD-TXN-ERROR-20CONDITION-29" title="(LMDB:LMDB-BAD-TXN-ERROR CONDITION)"><code>LMDB-BAD-TXN-ERROR</code></a>. Furthermore, any <a href="#x-28LMDB-3A-40LMDB-2FCURSORS-20MGL-PAX-3ASECTION-29" title="Cursors">Cursors</a> created in the
context of the transaction will no longer be valid (but see
<a href="#x-28LMDB-3ACURSOR-RENEW-20FUNCTION-29" title="(LMDB:CURSOR-RENEW FUNCTION)"><code>CURSOR-RENEW</code></a>).</p>

<p>An <a href="#x-28-23A-28-284-29-20BASE-CHAR-20-2E-20-22lmdb-22-29-20ASDF-2FSYSTEM-3ASYSTEM-29" title="(#A((4) BASE-CHAR . \&quot;lmdb\&quot;) ASDF/SYSTEM:SYSTEM)"><code>LMDB</code></a> parent transaction and its cursors must not issue operations
other than <code>COMMIT-TXN</code> and <code>ABORT-TXN</code> while there are active child
transactions. As the Lisp side does not expose transaction objects
directly, performing <a href="#x-28LMDB-3A-40LMDB-2FBASIC-OPERATIONS-20MGL-PAX-3ASECTION-29" title="Basic operations">Basic operations</a> in the parent
transaction is not possible, but it is possible with <a href="#x-28LMDB-3A-40LMDB-2FCURSORS-20MGL-PAX-3ASECTION-29" title="Cursors">Cursors</a>
as they are tied to the transaction in which they were created.</p>

<p><code>IGNORE-PARENT</code> true overrides the default nesting semantics of
<code>WITH-TXN</code> and creates a new top-level transaction, which is not a
child of the enclosing <code>WITH-TXN</code>.</p>

<ul>
<li><p>Since <code>LMDB</code> is single-writer, on nesting an <code>IGNORE-PARENT</code> write
  transaction in another write transaction, <code>LMDB-BAD-TXN-ERROR</code> is
  signalled to avoid the deadlock.</p></li>
<li><p>Nesting a read-only <code>WITH-TXN</code> with <code>IGNORE-PARENT</code> in another
  read-only <code>WITH-TXN</code> is <a href="#x-28LMDB-3ALMDB-BAD-RSLOT-ERROR-20CONDITION-29" title="(LMDB:LMDB-BAD-RSLOT-ERROR CONDITION)"><code>LMDB-BAD-RSLOT-ERROR</code></a> error with the <code>TLS</code>
  option because it would create two read-only transactions in the
  same thread.</p></li>
</ul>

<p>Nesting a read transaction in another transaction would be an
<code>LMDB-BAD-RSLOT-ERROR</code> according to the C lmdb library, but a
read-only <code>WITH-TXN</code> with <code>IGNORE-PARENT</code> <code>NIL</code> nested in another <code>WITH-TXN</code>
is turned into a noop so this edge case is papered over.</p>

<p><a id='x-28LMDB-3A-40LMDB-2FDATABASES-20MGL-PAX-3ASECTION-29'></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#x-28LMDB-3A-40LMDB-2FNESTING-TRANSACTIONS-20MGL-PAX-3ASECTION-29" title="Nesting transactions">&#8592;</a> <a href="#x-28LMDB-3A-40LMDB-MANUAL-20MGL-PAX-3ASECTION-29" title="LMDB Manual">&#8593;</a> <a href="#x-28LMDB-3A-40LMDB-2FTHE-UNNAMED-DATABASE-20MGL-PAX-3ASECTION-29" title="The unnamed database">&#8594;</a> <a href="#x-28LMDB-3A-40LMDB-2FDATABASES-20MGL-PAX-3ASECTION-29" title="Databases">&#8634;</a> <a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L1783">&#955;</a></span></span></p>

<h2><a href="#x-28LMDB-3A-40LMDB-2FDATABASES-20MGL-PAX-3ASECTION-29">8 Databases</a></h2>

<p><a id='x-28LMDB-3A-40LMDB-2FTHE-UNNAMED-DATABASE-20MGL-PAX-3ASECTION-29'></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#x-28LMDB-3A-40LMDB-2FDATABASES-20MGL-PAX-3ASECTION-29" title="Databases">&#8592;</a> <a href="#x-28LMDB-3A-40LMDB-2FDATABASES-20MGL-PAX-3ASECTION-29" title="Databases">&#8593;</a> <a href="#x-28LMDB-3A-40DUPSORT-20MGL-PAX-3ASECTION-29" title="DUPSORT">&#8594;</a> <a href="#x-28LMDB-3A-40LMDB-2FTHE-UNNAMED-DATABASE-20MGL-PAX-3ASECTION-29" title="The unnamed database">&#8634;</a> <a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L1788">&#955;</a></span></span></p>

<h3><a href="#x-28LMDB-3A-40LMDB-2FTHE-UNNAMED-DATABASE-20MGL-PAX-3ASECTION-29">8.1 The unnamed database</a></h3>

<p><a href="#x-28-23A-28-284-29-20BASE-CHAR-20-2E-20-22lmdb-22-29-20ASDF-2FSYSTEM-3ASYSTEM-29" title="(#A((4) BASE-CHAR . \&quot;lmdb\&quot;) ASDF/SYSTEM:SYSTEM)"><code>LMDB</code></a> has a default, unnamed database backed by a B+ tree. This db
can hold normal key-value pairs and named databases. The unnamed
database can be accessed by passing <code>NIL</code> as the database name to
<a href="#x-28LMDB-3AGET-DB-20FUNCTION-29" title="(LMDB:GET-DB FUNCTION)"><code>GET-DB</code></a>. There are some restrictions on the flags of the unnamed
database, see <a href="#x-28LMDB-3ALMDB-INCOMPATIBLE-ERROR-20CONDITION-29" title="(LMDB:LMDB-INCOMPATIBLE-ERROR CONDITION)"><code>LMDB-INCOMPATIBLE-ERROR</code></a>.</p>

<p><a id='x-28LMDB-3A-40DUPSORT-20MGL-PAX-3ASECTION-29'></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#x-28LMDB-3A-40LMDB-2FTHE-UNNAMED-DATABASE-20MGL-PAX-3ASECTION-29" title="The unnamed database">&#8592;</a> <a href="#x-28LMDB-3A-40LMDB-2FDATABASES-20MGL-PAX-3ASECTION-29" title="Databases">&#8593;</a> <a href="#x-28LMDB-3A-40LMDB-2FDATABASE-API-20MGL-PAX-3ASECTION-29" title="Database API">&#8594;</a> <a href="#x-28LMDB-3A-40DUPSORT-20MGL-PAX-3ASECTION-29" title="DUPSORT">&#8634;</a> <a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L1795">&#955;</a></span></span></p>

<h3><a href="#x-28LMDB-3A-40DUPSORT-20MGL-PAX-3ASECTION-29">8.2 DUPSORT</a></h3>

<p>A prominent feature of <a href="#x-28-23A-28-284-29-20BASE-CHAR-20-2E-20-22lmdb-22-29-20ASDF-2FSYSTEM-3ASYSTEM-29" title="(#A((4) BASE-CHAR . \&quot;lmdb\&quot;) ASDF/SYSTEM:SYSTEM)"><code>LMDB</code></a> is the ability to associate multiple
sorted values with keys, which is enabled by the <code>DUPSORT</code> argument of
<a href="#x-28LMDB-3AGET-DB-20FUNCTION-29" title="(LMDB:GET-DB FUNCTION)"><code>GET-DB</code></a>. Just as a named database is a B+ tree associated with a
key (its name) in the B+ tree of the unnamed database, so do these
sorted duplicates form a B+ tree under a key in a named or the
unnamed database. Among the <a href="#x-28LMDB-3A-40LMDB-2FBASIC-OPERATIONS-20MGL-PAX-3ASECTION-29" title="Basic operations">Basic operations</a>, <a href="#x-28LMDB-3APUT-20FUNCTION-29" title="(LMDB:PUT FUNCTION)"><code>PUT</code></a> and <a href="#x-28LMDB-3ADEL-20FUNCTION-29" title="(LMDB:DEL FUNCTION)"><code>DEL</code></a> are
equipped to deal with duplicate values, but <a href="#x-28LMDB-3AG3T-20FUNCTION-29" title="(LMDB:G3T FUNCTION)"><code>G3T</code></a> is too limited, and
<a href="#x-28LMDB-3A-40LMDB-2FCURSORS-20MGL-PAX-3ASECTION-29" title="Cursors">Cursors</a> are needed to make full use of <code>DUPSORT</code>.</p>

<p>When using this feature the limit on the maximum key size applies to
duplicate data, as well. See <a href="#x-28LMDB-3AENV-MAX-KEY-SIZE-20FUNCTION-29" title="(LMDB:ENV-MAX-KEY-SIZE FUNCTION)"><code>ENV-MAX-KEY-SIZE</code></a>.</p>

<p><a id='x-28LMDB-3A-40LMDB-2FDATABASE-API-20MGL-PAX-3ASECTION-29'></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#x-28LMDB-3A-40DUPSORT-20MGL-PAX-3ASECTION-29" title="DUPSORT">&#8592;</a> <a href="#x-28LMDB-3A-40LMDB-2FDATABASES-20MGL-PAX-3ASECTION-29" title="Databases">&#8593;</a> <a href="#x-28LMDB-3A-40LMDB-2FENCODINGS-20MGL-PAX-3ASECTION-29" title="Encoding and decoding data">&#8594;</a> <a href="#x-28LMDB-3A-40LMDB-2FDATABASE-API-20MGL-PAX-3ASECTION-29" title="Database API">&#8634;</a> <a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L1808">&#955;</a></span></span></p>

<h3><a href="#x-28LMDB-3A-40LMDB-2FDATABASE-API-20MGL-PAX-3ASECTION-29">8.3 Database API</a></h3>

<p><a id='x-28LMDB-3A-2ADB-CLASS-2A-20VARIABLE-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L1883">[variable]</a></span> <span class="reference-object"><a href="#x-28LMDB-3A-2ADB-CLASS-2A-20VARIABLE-29" >*DB-CLASS*</a></span></span> <span class="locative-args">DB</span></span></p>

<p>The default class that <a href="#x-28LMDB-3AGET-DB-20FUNCTION-29" title="(LMDB:GET-DB FUNCTION)"><code>GET-DB</code></a> instantiates. Must a subclass of <a href="#x-28LMDB-3ADB-20CLASS-29" title="(LMDB:DB CLASS)"><code>DB</code></a>.
This provides a way to associate application specific data with <code>DB</code>
objects.</p></li>
</ul>

<p><a id='x-28LMDB-3AGET-DB-20FUNCTION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L1888">[function]</a></span> <span class="reference-object"><a href="#x-28LMDB-3AGET-DB-20FUNCTION-29" >GET-DB</a></span></span> <span class="locative-args">NAME &amp;KEY (CLASS <a href="#x-28LMDB-3A-2ADB-CLASS-2A-20VARIABLE-29" title="(LMDB:*DB-CLASS* VARIABLE)"><code>*DB-CLASS*</code></a>) (ENV <a href="#x-28LMDB-3A-2AENV-2A-20VARIABLE-29" title="(LMDB:*ENV* VARIABLE)"><code>*ENV*</code></a>) (IF-DOES-NOT-EXIST <code>:CREATE</code>) KEY-ENCODING VALUE-ENCODING INTEGER-KEY REVERSE-KEY DUPSORT INTEGER-DUP REVERSE-DUP DUPFIXED</span></span></p>

<p>Open the database with <code>NAME</code> in the open environment <code>ENV</code>, and return
a <a href="#x-28LMDB-3ADB-20CLASS-29" title="(LMDB:DB CLASS)"><code>DB</code></a> object. If <code>NAME</code> is <code>NIL</code>, then the <a href="#x-28LMDB-3A-40LMDB-2FTHE-UNNAMED-DATABASE-20MGL-PAX-3ASECTION-29" title="The unnamed database">The unnamed database</a> is
opened.</p>

<p>If <code>GET-DB</code> is called with the same name multiple times, the returned
<code>DB</code> objects will be associated with the same database (although they
may not be EQ). The first time <code>GET-DB</code> is called with any given name
and environment, it must not be from an open transaction. This is
because <code>GET-DB</code> starts a transaction itself to comply with C lmdb's
requirements on
<a href="http://www.lmdb.tech/doc/group__mdb.html#gac08cad5b096925642ca359a6d6f0562a" >mdb_dbi_open()</a> (see
<a href="#x-28LMDB-3A-40LMDB-2FSAFETY-20MGL-PAX-3ASECTION-29" title="Safety">Safety</a>). Since dbi handles are cached within <code>ENV</code>, subsequent
calls do not involve <code>mdb_dbi_open()</code> and are thus permissible
within transactions.</p>

<p><code>CLASS</code> designates the class which will instantiated. See <a href="#x-28LMDB-3A-2ADB-CLASS-2A-20VARIABLE-29" title="(LMDB:*DB-CLASS* VARIABLE)"><code>*DB-CLASS*</code></a>.</p>

<p>If <code>IF-DOES-NOT-EXIST</code> is <code>:CREATE</code>, then a new named database is
created. If <code>IF-DOES-NOT-EXIST</code> is <code>:ERROR</code>, then an error is signalled
if the database does not exists.</p>

<p><code>KEY-ENCODING</code> and <code>VALUE-ENCODING</code> are both one of <code>NIL</code>, <code>:UINT64</code>,
<code>:OCTETS</code> or <code>:UTF-8</code>. <code>KEY-ENCODING</code> is set to <code>:UINT64</code> when <code>INTEGER-KEY</code>
is true. <code>VALUE-ENCODING</code> is set to <code>:UINT64</code> when <code>INTEGER-DUP</code> is true.
Note that changing the encoding does <em>not</em> reencode already existing
data. See <a href="#x-28LMDB-3A-40LMDB-2FENCODINGS-20MGL-PAX-3ASECTION-29" title="Encoding and decoding data">Encoding and decoding data</a> for the full semantics.</p>

<p><code>GET-DB</code> may be called more than once with the same <code>NAME</code> and <code>ENV</code>, and
the returned <code>DB</code> objects will have the same underlying C lmdb
database, but they may have different <code>KEY-ENCODING</code> and
<code>VALUE-ENCODING</code>.</p>

<p>The following flags are for database creation, they do not have any
effect in subsequent calls (except for the
<a href="#x-28LMDB-3A-40LMDB-2FTHE-UNNAMED-DATABASE-20MGL-PAX-3ASECTION-29" title="The unnamed database">The unnamed database</a>).</p>

<ul>
<li><p><code>INTEGER-KEY</code>: Keys in the database are C <code>unsigned</code> or <code>size_t</code>
  integers encoded in native byte order. Keys must all be either
  <code>unsigned</code> or <code>size_t</code>, they cannot be mixed in a single database.</p></li>
<li><p><code>REVERSE-KEY</code>: Keys are strings to be compared in reverse order,
  from the end of the strings to the beginning. By default, keys are
  treated as strings and compared from beginning to end.</p></li>
<li><p><code>DUPSORT</code>: Duplicate keys may be used in the database (or, from
  another perspective, keys may have multiple values, stored in
  sorted order). By default, keys must be unique and may have only a
  single value. Also, see <a href="#x-28LMDB-3A-40DUPSORT-20MGL-PAX-3ASECTION-29" title="DUPSORT">DUPSORT</a>.</p></li>
<li><p><code>INTEGER-DUP</code>: This option specifies that duplicate data items are
  binary integers, similarly to <code>INTEGER-KEY</code>. Only matters if
  <code>DUPSORT</code>.</p></li>
<li><p><code>REVERSE-DUP</code>: This option specifies that duplicate data items
  should be compared as strings in reverse order. Only matters if
  <code>DUPSORT</code>.</p></li>
<li><p><code>DUPFIXED</code>: This flag may only be used in combination <code>DUPSORT</code>. When
  true, data items for this database must all be the same size,
  which allows further optimizations in storage and retrieval.
  Currently, the wrapper functions that could take advantage of
  this (e.g. <a href="#x-28LMDB-3APUT-20FUNCTION-29" title="(LMDB:PUT FUNCTION)"><code>PUT</code></a>, <a href="#x-28LMDB-3ACURSOR-PUT-20FUNCTION-29" title="(LMDB:CURSOR-PUT FUNCTION)"><code>CURSOR-PUT</code></a>, <a href="#x-28LMDB-3ACURSOR-NEXT-20FUNCTION-29" title="(LMDB:CURSOR-NEXT FUNCTION)"><code>CURSOR-NEXT</code></a> and <a href="#x-28LMDB-3ACURSOR-VALUE-20FUNCTION-29" title="(LMDB:CURSOR-VALUE FUNCTION)"><code>CURSOR-VALUE</code></a>), do not.</p></li>
</ul>

<p>No function to close a database (an equivalent to
<a href="http://www.lmdb.tech/doc/group__mdb.html#ga52dd98d0c542378370cd6b712ff961b5" >mdb_dbi_close()</a>)
is provided due to subtle races and corruption it could cause when
an <code>MDB_dbi</code> (unsigned integer, similar to an fd) is assigned by a
subsequent open to another named database.</p>

<p>Wraps <a href="http://www.lmdb.tech/doc/group__mdb.html#gac08cad5b096925642ca359a6d6f0562a" >mdb_dbi_open()</a>.</p></li>
</ul>

<p><a id='x-28LMDB-3ADB-20CLASS-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L1819">[class]</a></span> <span class="reference-object"><a href="#x-28LMDB-3ADB-20CLASS-29" >DB</a></span></span></span></p>

<p>A database in an environment (class <a href="#x-28LMDB-3AENV-20CLASS-29" title="(LMDB:ENV CLASS)"><code>ENV</code></a>). Always to
be created by <a href="#x-28LMDB-3AGET-DB-20FUNCTION-29" title="(LMDB:GET-DB FUNCTION)"><code>GET-DB</code></a>.</p></li>
</ul>

<p><a id='x-28LMDB-3ADB-NAME-20-28MGL-PAX-3AREADER-20LMDB-3ADB-29-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L1822">[reader]</a></span> <span class="reference-object"><a href="#x-28LMDB-3ADB-NAME-20-28MGL-PAX-3AREADER-20LMDB-3ADB-29-29" >DB-NAME</a></span></span> <span class="locative-args">DB</span> <span class="locative-args">(:NAME)</span></span></p>

<p>The name of the database.</p></li>
</ul>

<p><a id='x-28LMDB-3ADB-KEY-ENCODING-20-28MGL-PAX-3AREADER-20LMDB-3ADB-29-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L1828">[reader]</a></span> <span class="reference-object"><a href="#x-28LMDB-3ADB-KEY-ENCODING-20-28MGL-PAX-3AREADER-20LMDB-3ADB-29-29" >DB-KEY-ENCODING</a></span></span> <span class="locative-args">DB</span> <span class="locative-args">(:KEY-ENCODING)</span></span></p>

<p>The <a href="#x-28LMDB-3AENCODING-20TYPE-29" title="(LMDB:ENCODING TYPE)"><code>ENCODING</code></a> that was passed as <code>KEY-ENCODING</code> to
<a href="#x-28LMDB-3AGET-DB-20FUNCTION-29" title="(LMDB:GET-DB FUNCTION)"><code>GET-DB</code></a>.</p></li>
</ul>

<p><a id='x-28LMDB-3ADB-VALUE-ENCODING-20-28MGL-PAX-3AREADER-20LMDB-3ADB-29-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L1834">[reader]</a></span> <span class="reference-object"><a href="#x-28LMDB-3ADB-VALUE-ENCODING-20-28MGL-PAX-3AREADER-20LMDB-3ADB-29-29" >DB-VALUE-ENCODING</a></span></span> <span class="locative-args">DB</span> <span class="locative-args">(:VALUE-ENCODING)</span></span></p>

<p>The <a href="#x-28LMDB-3AENCODING-20TYPE-29" title="(LMDB:ENCODING TYPE)"><code>ENCODING</code></a> that was passed as <code>VALUE-ENCODING</code>
to <a href="#x-28LMDB-3AGET-DB-20FUNCTION-29" title="(LMDB:GET-DB FUNCTION)"><code>GET-DB</code></a>.</p></li>
</ul>

<p><a id='x-28LMDB-3ADROP-DB-20FUNCTION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L2031">[function]</a></span> <span class="reference-object"><a href="#x-28LMDB-3ADROP-DB-20FUNCTION-29" >DROP-DB</a></span></span> <span class="locative-args">NAME PATH &amp;KEY OPEN-ENV-ARGS (DELETE <code>T</code>)</span></span></p>

<p>Empty the database with <code>NAME</code> in the environment denoted by <code>PATH</code>. If
<code>DELETE</code>, then delete the database. Since closing a database is
dangerous (see <a href="#x-28LMDB-3AGET-DB-20FUNCTION-29" title="(LMDB:GET-DB FUNCTION)"><code>GET-DB</code></a>), <code>DROP-DB</code> opens and closes the environment
itself.</p>

<p>Wraps <a href="http://www.lmdb.tech/doc/group__mdb.html#gab966fab3840fc54a6571dfb32b00f2db" >mdb_drop()</a>.</p></li>
</ul>

<p><a id='x-28LMDB-3ADB-STATISTICS-20FUNCTION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L2046">[function]</a></span> <span class="reference-object"><a href="#x-28LMDB-3ADB-STATISTICS-20FUNCTION-29" >DB-STATISTICS</a></span></span> <span class="locative-args">DB</span></span></p>

<p>Return statistics about the database.</p>

<p>Wraps <a href="http://www.lmdb.tech/doc/group__mdb.html#gae6c1069febe94299769dbdd032fadef6" >mdb_stat()</a>.</p></li>
</ul>

<p><a id='x-28LMDB-3A-40LMDB-2FENCODINGS-20MGL-PAX-3ASECTION-29'></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#x-28LMDB-3A-40LMDB-2FDATABASE-API-20MGL-PAX-3ASECTION-29" title="Database API">&#8592;</a> <a href="#x-28LMDB-3A-40LMDB-MANUAL-20MGL-PAX-3ASECTION-29" title="LMDB Manual">&#8593;</a> <a href="#x-28LMDB-3A-40LMDB-2FOVERRIDING-ENCODINGS-20MGL-PAX-3ASECTION-29" title="Overriding encodings">&#8594;</a> <a href="#x-28LMDB-3A-40LMDB-2FENCODINGS-20MGL-PAX-3ASECTION-29" title="Encoding and decoding data">&#8634;</a> <a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L2070">&#955;</a></span></span></p>

<h2><a href="#x-28LMDB-3A-40LMDB-2FENCODINGS-20MGL-PAX-3ASECTION-29">9 Encoding and decoding data</a></h2>

<p>In the C lmdb library, keys and values are opaque byte vectors
only ever inspected internally to maintain the sort order (of keys
and also duplicate values if <a href="#x-28LMDB-3A-40DUPSORT-20MGL-PAX-3ASECTION-29" title="DUPSORT">DUPSORT</a>). The client is given the
freedom and the responsibility to choose how to perform conversion
to and from byte vectors.</p>

<p><a href="#x-28-23A-28-284-29-20BASE-CHAR-20-2E-20-22lmdb-22-29-20ASDF-2FSYSTEM-3ASYSTEM-29" title="(#A((4) BASE-CHAR . \&quot;lmdb\&quot;) ASDF/SYSTEM:SYSTEM)"><code>LMDB</code></a> exposes this full flexibility while at the same time providing
reasonable defaults for the common cases. In particular, with the
<code>KEY-ENCODING</code> and <code>VALUE-ENCODING</code> arguments of <a href="#x-28LMDB-3AGET-DB-20FUNCTION-29" title="(LMDB:GET-DB FUNCTION)"><code>GET-DB</code></a>, the
data (meaning the key or value here) encoding can be declared
explicitly.</p>

<p>Even if the encoding is undeclared, it is recommended to use a
single type for keys (and duplicate values) to avoid unexpected
conflicts that could arise, for example, when the UTF-8 encoding of
a string and the <code>:UINT64</code> encoding of an integer coincide. The same
consideration doubly applies to named databases, which share the key
space with normal key-value pairs in the default database (see
<a href="#x-28LMDB-3A-40LMDB-2FTHE-UNNAMED-DATABASE-20MGL-PAX-3ASECTION-29" title="The unnamed database">The unnamed database</a>).</p>

<p>Together, <code>:UINT64</code> and <code>:UTF-8</code> cover the common cases for keys. They
trade off dynamic typing for easy sortability (using the default C
lmdb behaviour). On the other hand, when sorting is not
concern (either for keys and values), serialization may be done more
freely. For this purpose, using an encoding of <code>:OCTETS</code> or <code>NIL</code> with
<a href="https://github.com/conspack/cl-conspack" >cl-conspack</a> is
recommended because it works with complex objects, it encodes object
types, it is fast and space-efficient, has a stable specification
and an alternative implementation in C. For example:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">with-temporary-env</span></i> <span class="paren2">(<span class="code"><span class="special">*env*</span></span>)</span>
  <span class="paren2">(<span class="code"><a href="http://www.lispworks.com/reference/HyperSpec/Body/s_let_l.htm" class="symbol"><i><span class="symbol">let</span></i></a> <span class="paren3">(<span class="code"><span class="paren4">(<span class="code">db <span class="paren5">(<span class="code">get-db <span class="string">"test"</span></span>)</span></span>)</span></span>)</span>
    <span class="paren3">(<span class="code"><i><span class="symbol">with-txn</span></i> <span class="paren4">(<span class="code"><span class="keyword">:write</span> <a href="http://www.lispworks.com/reference/HyperSpec/Body/a_t.htm" class="symbol">t</a></span>)</span>
      <span class="paren4">(<span class="code">put db <span class="string">"key1"</span> <span class="paren5">(<span class="code">cpk:encode <span class="paren6">(<span class="code"><a href="http://www.lispworks.com/reference/HyperSpec/Body/a_list.htm" class="symbol">list</a> <span class="keyword">:some</span> <span class="string">"stuff"</span> 42</span>)</span></span>)</span></span>)</span>
      <span class="paren4">(<span class="code">cpk:decode <span class="paren5">(<span class="code">g3t db <span class="string">"key1"</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span>
=&gt; <span class="paren1">(<span class="code"><span class="keyword">:SOME</span> <span class="string">"stuff"</span> 42</span>)</span></span></code></pre>

<p>Note that multiple <a href="#x-28LMDB-3ADB-20CLASS-29" title="(LMDB:DB CLASS)"><code>DB</code></a> objects with different encodings can be
associated with the same C lmdb database, which declutters the code:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_defpar.htm" class="symbol"><i><span class="symbol">defvar</span></i></a> <span class="special">*cpk-encoding*</span>
  <span class="paren2">(<span class="code"><a href="http://www.lispworks.com/reference/HyperSpec/Body/a_cons.htm" class="symbol">cons</a> #'cpk:encode <span class="paren3">(<span class="code">alexandria:compose #'cpk:decode #'mdb-val-to-octets</span>)</span></span>)</span></span>)</span>

<span class="paren1">(<span class="code"><i><span class="symbol">with-temporary-env</span></i> <span class="paren2">(<span class="code"><span class="special">*env*</span></span>)</span>
  <span class="paren2">(<span class="code"><a href="http://www.lispworks.com/reference/HyperSpec/Body/s_let_l.htm" class="symbol"><i><span class="symbol">let</span></i></a> <span class="paren3">(<span class="code"><span class="paren4">(<span class="code">next-id-db <span class="paren5">(<span class="code">get-db <span class="string">"test"</span> <span class="keyword">:key-encoding</span> <span class="special">*cpk-encoding*</span>
                                   <span class="keyword">:value-encoding</span> <span class="keyword">:uint64</span></span>)</span></span>)</span>
        <span class="paren4">(<span class="code">db <span class="paren5">(<span class="code">get-db <span class="string">"test"</span> <span class="keyword">:key-encoding</span> <span class="special">*cpk-encoding*</span>
                           <span class="keyword">:value-encoding</span> <span class="special">*cpk-encoding*</span></span>)</span></span>)</span></span>)</span>
    <span class="paren3">(<span class="code"><i><span class="symbol">with-txn</span></i> <span class="paren4">(<span class="code"><span class="keyword">:write</span> <a href="http://www.lispworks.com/reference/HyperSpec/Body/a_t.htm" class="symbol">t</a></span>)</span>
      <span class="paren4">(<span class="code"><a href="http://www.lispworks.com/reference/HyperSpec/Body/s_let_l.htm" class="symbol"><i><span class="symbol">let</span></i></a> <span class="paren5">(<span class="code"><span class="paren6">(<span class="code">id <span class="paren1">(<span class="code"><a href="http://www.lispworks.com/reference/HyperSpec/Body/a_or.htm" class="symbol">or</a> <span class="paren2">(<span class="code">g3t next-id-db <span class="keyword">:next-id</span></span>)</span> 0</span>)</span></span>)</span></span>)</span>
        <span class="paren5">(<span class="code">put next-id-db <span class="keyword">:next-id</span> <span class="paren6">(<span class="code"><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_1pl_1_.htm" class="symbol">1+</a> id</span>)</span></span>)</span>
        <span class="paren5">(<span class="code">put db id <span class="paren6">(<span class="code"><a href="http://www.lispworks.com/reference/HyperSpec/Body/a_list.htm" class="symbol">list</a> <span class="keyword">:some</span> <span class="string">"stuff"</span> 42</span>)</span></span>)</span>
        <span class="paren5">(<span class="code">g3t db id</span>)</span></span>)</span></span>)</span></span>)</span></span>)</span>
=&gt; <span class="paren1">(<span class="code"><span class="keyword">:SOME</span> <span class="string">"stuff"</span> 42</span>)</span>
=&gt; T</span></code></pre>

<p><a id='x-28LMDB-3AENCODING-20TYPE-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L1850">[type]</a></span> <span class="reference-object"><a href="#x-28LMDB-3AENCODING-20TYPE-29" >ENCODING</a></span></span></span></p>

<p>The following values are supported:</p>

<ul>
<li><p><code>:UINT64:</code> Data to be encoded must be of type <code>(UNSIGNED-BYTE 64)</code>,
  which is then encoded as an 8 byte array in <em>native</em> byte order
  with <a href="#x-28LMDB-3AUINT64-TO-OCTETS-20FUNCTION-29" title="(LMDB:UINT64-TO-OCTETS FUNCTION)"><code>UINT64-TO-OCTETS</code></a>. The reverse transformation takes place when
  returning values. This is the encoding used for <code>INTEGER-KEY</code> and
  <code>INTEGER-DUP</code> <a href="#x-28LMDB-3ADB-20CLASS-29" title="(LMDB:DB CLASS)"><code>DB</code></a>s.</p></li>
<li><p><code>:OCTETS:</code> Note the plural. Data to be encoded (e.g. <code>KEY</code> argument of
  <a href="#x-28LMDB-3AG3T-20FUNCTION-29" title="(LMDB:G3T FUNCTION)"><code>G3T</code></a>) must be a 1D byte array. If its element type
  is <code>(UNSIGNED-BYTE 8)</code>, then the data can be passed to the foreign
  code more efficiently, but declaring the element type is not
  required. For example, <code>VECTOR</code>s can be used as long as the actual
  elements are of type <code>(UNSIGNED-BYTE 8)</code>. Foreign byte arrays to
  be decoded (e.g. the value returned by <code>G3T</code>) are returned as
  <a href="#x-28LMDB-3AOCTETS-20TYPE-29" title="(LMDB:OCTETS TYPE)"><code>OCTETS</code></a>.</p></li>
<li><p><code>:UTF-8:</code> Data to be encoded must be a string, which is converted to
  octets by <a href="trivial-utf-8-manual.html#x-28-23A-28-2813-29-20BASE-CHAR-20-2E-20-22trivial-utf-8-22-29-20ASDF-2FSYSTEM-3ASYSTEM-29" title="(#A((13) BASE-CHAR . \&quot;trivial-utf-8\&quot;) ASDF/SYSTEM:SYSTEM)"><code>TRIVIAL-UTF-8</code></a>. Null-terminated. Foreign byte arrays are
  decoded the same way.</p></li>
<li><p><code>NIL</code>: Data is encoded using the default encoding according to its
  Lisp type: strings as <code>:UTF-8</code>, vectors as <code>:OCTETS</code>, <code>(UNSIGNED-BYTE
  64)</code> as <code>:UINT64</code>. Decoding is always performed as <code>:OCTETS</code>.</p></li>
<li><p>A <code>CONS</code>: Data is encoded by the function in the <code>CAR</code> of the cons and
  decoded by the function in the <code>CDR</code>. For example, <code>:UINT64</code> is
  equivalent to <code>(CONS #'UINT64-TO-OCTETS #'MDB-VAL-TO-UINT64)</code>.</p></li>
</ul></li>
</ul>

<p><a id='x-28LMDB-3AWITH-MDB-VAL-SLOTS-20MGL-PAX-3AMACRO-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L2143">[macro]</a></span> <span class="reference-object"><a href="#x-28LMDB-3AWITH-MDB-VAL-SLOTS-20MGL-PAX-3AMACRO-29" >WITH-MDB-VAL-SLOTS</a></span></span> <span class="locative-args">(%BYTES SIZE MDB-VAL) &amp;BODY BODY</span></span></p>

<p>Bind <code>%BYTES</code> and <code>SIZE</code> locally to the corresponding slots of <code>MDB-VAL</code>.
<code>MDB-VAL</code> is an opaque handle for a foreign <code>MDB_val</code> struct, that
holds the pointer to a byte array and the number of bytes in the
array. This macro is needed to access the foreign data in a function
used as <a href="#x-28LMDB-3A-2AKEY-DECODER-2A-20VARIABLE-29" title="(LMDB:*KEY-DECODER* VARIABLE)"><code>*KEY-DECODER*</code></a> or <a href="#x-28LMDB-3A-2AVALUE-DECODER-2A-20VARIABLE-29" title="(LMDB:*VALUE-DECODER* VARIABLE)"><code>*VALUE-DECODER*</code></a>. <code>MDB-VAL</code> is dynamic extent,
so don't hold on to it. Also, the pointer to which <code>%BYTES</code> is bound
is valid only within the context of current top-level transaction.</p></li>
</ul>

<p><a id='x-28LMDB-3AOCTETS-20TYPE-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L2162">[type]</a></span> <span class="reference-object"><a href="#x-28LMDB-3AOCTETS-20TYPE-29" >OCTETS</a></span></span> <span class="locative-args">&amp;OPTIONAL (SIZE '*)</span></span></p>

<p>A 1D <code>SIMPLE-ARRAY</code> of <code>(UNSIGNED-BYTE 8)</code>.</p></li>
</ul>

<p><a id='x-28LMDB-3AMDB-VAL-TO-OCTETS-20FUNCTION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L2171">[function]</a></span> <span class="reference-object"><a href="#x-28LMDB-3AMDB-VAL-TO-OCTETS-20FUNCTION-29" >MDB-VAL-TO-OCTETS</a></span></span> <span class="locative-args">MDB-VAL</span></span></p>

<p>A utility function provided for writing <a href="#x-28LMDB-3A-2AKEY-DECODER-2A-20VARIABLE-29" title="(LMDB:*KEY-DECODER* VARIABLE)"><code>*KEY-DECODER*</code></a> and
<a href="#x-28LMDB-3A-2AVALUE-DECODER-2A-20VARIABLE-29" title="(LMDB:*VALUE-DECODER* VARIABLE)"><code>*VALUE-DECODER*</code></a> functions. It returns a Lisp octet vector that holds
the same bytes as <code>MDB-VAL</code>.</p></li>
</ul>

<p><a id='x-28LMDB-3AUINT64-TO-OCTETS-20FUNCTION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L2195">[function]</a></span> <span class="reference-object"><a href="#x-28LMDB-3AUINT64-TO-OCTETS-20FUNCTION-29" >UINT64-TO-OCTETS</a></span></span> <span class="locative-args">N</span></span></p>

<p>Convert an <code>(UNSIGNED-BYTE 64)</code> to <a href="#x-28LMDB-3AOCTETS-20TYPE-29" title="(LMDB:OCTETS TYPE)"><code>OCTETS</code></a> of length 8 taking the
native byte order representation of <code>N</code>. Suitable as a <a href="#x-28LMDB-3A-2AKEY-ENCODER-2A-20VARIABLE-29" title="(LMDB:*KEY-ENCODER* VARIABLE)"><code>*KEY-ENCODER*</code></a>
or <a href="#x-28LMDB-3A-2AVALUE-ENCODER-2A-20VARIABLE-29" title="(LMDB:*VALUE-ENCODER* VARIABLE)"><code>*VALUE-ENCODER*</code></a>.</p></li>
</ul>

<p><a id='x-28LMDB-3AOCTETS-TO-UINT64-20FUNCTION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L2224">[function]</a></span> <span class="reference-object"><a href="#x-28LMDB-3AOCTETS-TO-UINT64-20FUNCTION-29" >OCTETS-TO-UINT64</a></span></span> <span class="locative-args">OCTETS</span></span></p>

<p>The inverse of <a href="#x-28LMDB-3AUINT64-TO-OCTETS-20FUNCTION-29" title="(LMDB:UINT64-TO-OCTETS FUNCTION)"><code>UINT64-TO-OCTETS</code></a>. Use <a href="#x-28LMDB-3AMDB-VAL-TO-UINT64-20FUNCTION-29" title="(LMDB:MDB-VAL-TO-UINT64 FUNCTION)"><code>MDB-VAL-TO-UINT64</code></a> as a
<a href="#x-28LMDB-3A-2AKEY-DECODER-2A-20VARIABLE-29" title="(LMDB:*KEY-DECODER* VARIABLE)"><code>*KEY-DECODER*</code></a> or <a href="#x-28LMDB-3A-2AVALUE-DECODER-2A-20VARIABLE-29" title="(LMDB:*VALUE-DECODER* VARIABLE)"><code>*VALUE-DECODER*</code></a>.</p></li>
</ul>

<p><a id='x-28LMDB-3AMDB-VAL-TO-UINT64-20FUNCTION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L2238">[function]</a></span> <span class="reference-object"><a href="#x-28LMDB-3AMDB-VAL-TO-UINT64-20FUNCTION-29" >MDB-VAL-TO-UINT64</a></span></span> <span class="locative-args">MDB-VAL</span></span></p>

<p>Like <a href="#x-28LMDB-3AOCTETS-TO-UINT64-20FUNCTION-29" title="(LMDB:OCTETS-TO-UINT64 FUNCTION)"><code>OCTETS-TO-UINT64</code></a>, but suitable for <a href="#x-28LMDB-3A-2AKEY-DECODER-2A-20VARIABLE-29" title="(LMDB:*KEY-DECODER* VARIABLE)"><code>*KEY-DECODER*</code></a> or
<a href="#x-28LMDB-3A-2AVALUE-DECODER-2A-20VARIABLE-29" title="(LMDB:*VALUE-DECODER* VARIABLE)"><code>*VALUE-DECODER*</code></a> that decodes unsigned 64 bit integers in native byte
order. This function is called automatically when the encoding is
known to require it (see <a href="#x-28LMDB-3AGET-DB-20FUNCTION-29" title="(LMDB:GET-DB FUNCTION)"><code>GET-DB</code></a>'s <code>INTEGER-KEY</code>, <code>:VALUE-ENCODING</code>,
etc).</p></li>
</ul>

<p><a id='x-28LMDB-3ASTRING-TO-OCTETS-20FUNCTION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L2259">[function]</a></span> <span class="reference-object"><a href="#x-28LMDB-3ASTRING-TO-OCTETS-20FUNCTION-29" >STRING-TO-OCTETS</a></span></span> <span class="locative-args">STRING</span></span></p>

<p>Convert <code>STRING</code> to <a href="#x-28LMDB-3AOCTETS-20TYPE-29" title="(LMDB:OCTETS TYPE)"><code>OCTETS</code></a> by encoding it as UTF-8 with null
termination. Suitable as a <a href="#x-28LMDB-3A-2AKEY-ENCODER-2A-20VARIABLE-29" title="(LMDB:*KEY-ENCODER* VARIABLE)"><code>*KEY-ENCODER*</code></a> or <a href="#x-28LMDB-3A-2AVALUE-ENCODER-2A-20VARIABLE-29" title="(LMDB:*VALUE-ENCODER* VARIABLE)"><code>*VALUE-ENCODER*</code></a>.</p></li>
</ul>

<p><a id='x-28LMDB-3AOCTETS-TO-STRING-20FUNCTION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L2264">[function]</a></span> <span class="reference-object"><a href="#x-28LMDB-3AOCTETS-TO-STRING-20FUNCTION-29" >OCTETS-TO-STRING</a></span></span> <span class="locative-args">OCTETS</span></span></p>

<p>The inverse of <a href="#x-28LMDB-3ASTRING-TO-OCTETS-20FUNCTION-29" title="(LMDB:STRING-TO-OCTETS FUNCTION)"><code>STRING-TO-OCTETS</code></a>. Use <a href="#x-28LMDB-3AMDB-VAL-TO-STRING-20FUNCTION-29" title="(LMDB:MDB-VAL-TO-STRING FUNCTION)"><code>MDB-VAL-TO-STRING</code></a> as a
<a href="#x-28LMDB-3A-2AKEY-DECODER-2A-20VARIABLE-29" title="(LMDB:*KEY-DECODER* VARIABLE)"><code>*KEY-DECODER*</code></a> or <a href="#x-28LMDB-3A-2AVALUE-DECODER-2A-20VARIABLE-29" title="(LMDB:*VALUE-DECODER* VARIABLE)"><code>*VALUE-DECODER*</code></a>.</p></li>
</ul>

<p><a id='x-28LMDB-3AMDB-VAL-TO-STRING-20FUNCTION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L2269">[function]</a></span> <span class="reference-object"><a href="#x-28LMDB-3AMDB-VAL-TO-STRING-20FUNCTION-29" >MDB-VAL-TO-STRING</a></span></span> <span class="locative-args">MDB-VAL</span></span></p>

<p>Like <a href="#x-28LMDB-3AOCTETS-TO-STRING-20FUNCTION-29" title="(LMDB:OCTETS-TO-STRING FUNCTION)"><code>OCTETS-TO-STRING</code></a>, but suitable as a <a href="#x-28LMDB-3A-2AKEY-DECODER-2A-20VARIABLE-29" title="(LMDB:*KEY-DECODER* VARIABLE)"><code>*KEY-DECODER*</code></a> or
<a href="#x-28LMDB-3A-2AVALUE-DECODER-2A-20VARIABLE-29" title="(LMDB:*VALUE-DECODER* VARIABLE)"><code>*VALUE-DECODER*</code></a>.</p></li>
</ul>

<p><a id='x-28LMDB-3A-40LMDB-2FOVERRIDING-ENCODINGS-20MGL-PAX-3ASECTION-29'></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#x-28LMDB-3A-40LMDB-2FENCODINGS-20MGL-PAX-3ASECTION-29" title="Encoding and decoding data">&#8592;</a> <a href="#x-28LMDB-3A-40LMDB-2FENCODINGS-20MGL-PAX-3ASECTION-29" title="Encoding and decoding data">&#8593;</a> <a href="#x-28LMDB-3A-40LMDB-2FBASIC-OPERATIONS-20MGL-PAX-3ASECTION-29" title="Basic operations">&#8594;</a> <a href="#x-28LMDB-3A-40LMDB-2FOVERRIDING-ENCODINGS-20MGL-PAX-3ASECTION-29" title="Overriding encodings">&#8634;</a> <a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L2276">&#955;</a></span></span></p>

<h3><a href="#x-28LMDB-3A-40LMDB-2FOVERRIDING-ENCODINGS-20MGL-PAX-3ASECTION-29">9.1 Overriding encodings</a></h3>

<p>Using multiple <a href="#x-28LMDB-3ADB-20CLASS-29" title="(LMDB:DB CLASS)"><code>DB</code></a> objects with different encodings is the
recommended practice (see the example in <a href="#x-28LMDB-3A-40LMDB-2FENCODINGS-20MGL-PAX-3ASECTION-29" title="Encoding and decoding data">Encoding and decoding data</a>), but when
that is inconvenient, one can override the encodings with the
following variables.</p>

<p><a id='x-28LMDB-3A-2AKEY-ENCODER-2A-20VARIABLE-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L2286">[variable]</a></span> <span class="reference-object"><a href="#x-28LMDB-3A-2AKEY-ENCODER-2A-20VARIABLE-29" >*KEY-ENCODER*</a></span></span> <span class="locative-args">NIL</span></span></p>

<p>A function designator, <code>NIL</code> or an <a href="#x-28LMDB-3AENCODING-20TYPE-29" title="(LMDB:ENCODING TYPE)"><code>ENCODING</code></a>. If non-NIL, it overrides
the encoding method determined by <code>KEY-ENCODING</code> (see <a href="#x-28LMDB-3AGET-DB-20FUNCTION-29" title="(LMDB:GET-DB FUNCTION)"><code>GET-DB</code></a>). It is
called with a single argument, the key, when it is to be converted
to an octet vector.</p></li>
</ul>

<p><a id='x-28LMDB-3A-2AKEY-DECODER-2A-20VARIABLE-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L2292">[variable]</a></span> <span class="reference-object"><a href="#x-28LMDB-3A-2AKEY-DECODER-2A-20VARIABLE-29" >*KEY-DECODER*</a></span></span> <span class="locative-args">NIL</span></span></p>

<p>A function designator, <code>NIL</code> or an <a href="#x-28LMDB-3AENCODING-20TYPE-29" title="(LMDB:ENCODING TYPE)"><code>ENCODING</code></a>. If non-NIL, it is
called with a single <code>MDB-VAL</code> argument (see <a href="#x-28LMDB-3AWITH-MDB-VAL-SLOTS-20MGL-PAX-3AMACRO-29" title="(LMDB:WITH-MDB-VAL-SLOTS MGL-PAX:MACRO)"><code>WITH-MDB-VAL-SLOTS</code></a>), that
holds a pointer to data to be decoded and its size. This function is
called whenever a key is to be decoded and overrides the
<code>KEY-ENCODING</code> argument of <a href="#x-28LMDB-3AGET-DB-20FUNCTION-29" title="(LMDB:GET-DB FUNCTION)"><code>GET-DB</code></a>.</p>

<p>For example, if we are only interested in the length of the value
and want to avoid creating a lisp vector on the heap, we can do
this:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">with-temporary-env</span></i> <span class="paren2">(<span class="code"><span class="special">*env*</span></span>)</span>
  <span class="paren2">(<span class="code"><a href="http://www.lispworks.com/reference/HyperSpec/Body/s_let_l.htm" class="symbol"><i><span class="symbol">let</span></i></a> <span class="paren3">(<span class="code"><span class="paren4">(<span class="code">db <span class="paren5">(<span class="code">get-db <span class="string">"test"</span></span>)</span></span>)</span></span>)</span>
    <span class="paren3">(<span class="code"><i><span class="symbol">with-txn</span></i> <span class="paren4">(<span class="code"><span class="keyword">:write</span> <a href="http://www.lispworks.com/reference/HyperSpec/Body/a_t.htm" class="symbol">t</a></span>)</span>
      <span class="paren4">(<span class="code">put db <span class="string">"key1"</span> <span class="string">"abc"</span></span>)</span>
      <span class="paren4">(<span class="code"><a href="http://www.lispworks.com/reference/HyperSpec/Body/s_let_l.htm" class="symbol"><i><span class="symbol">let</span></i></a> <span class="paren5">(<span class="code"><span class="paren6">(<span class="code"><span class="special">*value-decoder*</span> <span class="paren1">(<span class="code"><a href="http://www.lispworks.com/reference/HyperSpec/Body/a_lambda.htm" class="symbol"><i><span class="symbol">lambda</span></i></a> <span class="paren2">(<span class="code">mdb-val</span>)</span>
                               <span class="paren2">(<span class="code"><i><span class="symbol">with-mdb-val-slots</span></i> <span class="paren3">(<span class="code">%bytes size mdb-val</span>)</span>
                                 <span class="paren3">(<span class="code"><a href="http://www.lispworks.com/reference/HyperSpec/Body/s_declar.htm" class="symbol">declare</a> <span class="paren4">(<span class="code"><a href="http://www.lispworks.com/reference/HyperSpec/Body/d_ignore.htm" class="symbol">ignore</a> %bytes</span>)</span></span>)</span>
                                 <span class="comment">;; Take null termination into account.
</span>                                 <span class="paren3">(<span class="code"><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_1pl_1_.htm" class="symbol">1-</a> size</span>)</span></span>)</span></span>)</span></span>)</span></span>)</span>
        <span class="paren5">(<span class="code">g3t db <span class="string">"key1"</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span>
=&gt; 3
=&gt; T</span></code></pre></li>
</ul>

<p><a id='x-28LMDB-3A-2AVALUE-ENCODER-2A-20VARIABLE-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L2319">[variable]</a></span> <span class="reference-object"><a href="#x-28LMDB-3A-2AVALUE-ENCODER-2A-20VARIABLE-29" >*VALUE-ENCODER*</a></span></span> <span class="locative-args">NIL</span></span></p>

<p>Like <a href="#x-28LMDB-3A-2AKEY-ENCODER-2A-20VARIABLE-29" title="(LMDB:*KEY-ENCODER* VARIABLE)"><code>*KEY-ENCODER*</code></a>, but for values.</p></li>
</ul>

<p><a id='x-28LMDB-3A-2AVALUE-DECODER-2A-20VARIABLE-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L2322">[variable]</a></span> <span class="reference-object"><a href="#x-28LMDB-3A-2AVALUE-DECODER-2A-20VARIABLE-29" >*VALUE-DECODER*</a></span></span> <span class="locative-args">NIL</span></span></p>

<p>Like <a href="#x-28LMDB-3A-2AKEY-DECODER-2A-20VARIABLE-29" title="(LMDB:*KEY-DECODER* VARIABLE)"><code>*KEY-DECODER*</code></a>, but for values.</p>

<p>Apart from performing actual decoding, the main purpose of
<code>*VALUE-DECODER*</code>, one can also pass the foreign data on to other
foreign functions such as <code>write()</code> directly from the decoder
function and returning a constant such as <code>T</code> to avoid consing.</p></li>
</ul>

<p><a id='x-28LMDB-3A-40LMDB-2FBASIC-OPERATIONS-20MGL-PAX-3ASECTION-29'></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#x-28LMDB-3A-40LMDB-2FOVERRIDING-ENCODINGS-20MGL-PAX-3ASECTION-29" title="Overriding encodings">&#8592;</a> <a href="#x-28LMDB-3A-40LMDB-MANUAL-20MGL-PAX-3ASECTION-29" title="LMDB Manual">&#8593;</a> <a href="#x-28LMDB-3A-40LMDB-2FCURSORS-20MGL-PAX-3ASECTION-29" title="Cursors">&#8594;</a> <a href="#x-28LMDB-3A-40LMDB-2FBASIC-OPERATIONS-20MGL-PAX-3ASECTION-29" title="Basic operations">&#8634;</a> <a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L2446">&#955;</a></span></span></p>

<h2><a href="#x-28LMDB-3A-40LMDB-2FBASIC-OPERATIONS-20MGL-PAX-3ASECTION-29">10 Basic operations</a></h2>

<p><a id='x-28LMDB-3AG3T-20FUNCTION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L2451">[function]</a></span> <span class="reference-object"><a href="#x-28LMDB-3AG3T-20FUNCTION-29" >G3T</a></span></span> <span class="locative-args">DB KEY</span></span></p>

<p>Return the value from <code>DB</code> associated with <code>KEY</code> and <code>T</code> as the second
value. If <code>KEY</code> is not found in <code>DB</code>, then <code>NIL</code> is returned. If <code>DB</code>
supports <a href="#x-28LMDB-3A-40DUPSORT-20MGL-PAX-3ASECTION-29" title="DUPSORT">DUPSORT</a>, then the first value for <code>KEY</code> will be returned.
Retrieval of other values requires the use of <a href="#x-28LMDB-3A-40LMDB-2FCURSORS-20MGL-PAX-3ASECTION-29" title="Cursors">Cursors</a>.</p>

<p>This function is called <code>G3T</code> instead of <code>GET</code> to avoid having to shadow
<code>CL:GET</code> when importing the <a href="#x-28-23A-28-284-29-20BASE-CHAR-20-2E-20-22lmdb-22-29-20ASDF-2FSYSTEM-3ASYSTEM-29" title="(#A((4) BASE-CHAR . \&quot;lmdb\&quot;) ASDF/SYSTEM:SYSTEM)"><code>LMDB</code></a> package. On the other hand, importing
the <code>LMDB+</code> package, which has <code>LMDB::GET</code> exported, requires some
shadowing.</p>

<p>The <code>LMDB+</code> package is like the <code>LMDB</code> package, but it has <code>#'LMDB:G3T</code>
fbound to <code>LMDB+:G3T</code> so it probably needs shadowing to avoid conflict
with <code>CL:GET:</code></p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_defpkg.htm" class="symbol"><i><span class="symbol">defpackage</span></i></a> lmdb/test
  <span class="paren2">(<span class="code"><span class="keyword">:shadow</span> <span class="keyword">#:get</span></span>)</span>
  <span class="paren2">(<span class="code"><span class="keyword">:use</span> <span class="keyword">#:cl</span> <span class="keyword">#:lmdb+</span></span>)</span></span>)</span></span></code></pre>

<p>Wraps <a href="http://www.lmdb.tech/doc/group__mdb.html#ga8bf10cd91d3f3a83a34d04ce6b07992d" >mdb_get()</a>.</p></li>
</ul>

<p><a id='x-28LMDB-3APUT-20FUNCTION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L2495">[function]</a></span> <span class="reference-object"><a href="#x-28LMDB-3APUT-20FUNCTION-29" >PUT</a></span></span> <span class="locative-args">DB KEY VALUE &amp;KEY (OVERWRITE <code>T</code>) (DUPDATA <code>T</code>) APPEND APPEND-DUP (KEY-EXISTS-ERROR-P <code>T</code>)</span></span></p>

<p>Add a <code>KEY</code>, <code>VALUE</code> pair to <code>DB</code> within <code>TXN</code> (which must support writes).
Returns <code>T</code> on success.</p>

<ul>
<li><p><code>OVERWRITE</code>: If <code>NIL</code>, signal <a href="#x-28LMDB-3ALMDB-KEY-EXISTS-ERROR-20CONDITION-29" title="(LMDB:LMDB-KEY-EXISTS-ERROR CONDITION)"><code>LMDB-KEY-EXISTS-ERROR</code></a> if <code>KEY</code> already
  appears in <code>DB</code>.</p></li>
<li><p><code>DUPDATA</code>: If <code>NIL</code>, signal <code>LMDB-KEY-EXISTS-ERROR</code> if the <code>KEY</code>, <code>VALUE</code>
  pair already appears in <code>DB</code>. Has no effect if <code>DB</code> doesn't have
  <code>DUPSORT</code>.</p></li>
<li><p><code>APPEND</code>: Append the <code>KEY</code>, <code>VALUE</code> pair to the end of <code>DB</code> instead of
  finding <code>KEY</code>'s location in the B+ tree by performing comparisons.
  The client effectively promises that keys are inserted in sort
  order, which allows for fast bulk loading. If the promise is
  broken, a <code>LMDB-KEY-EXISTS-ERROR</code> is signalled.</p></li>
<li><p><code>APPEND-DUP</code>: The client promises that duplicate values are inserted
  in sort order. If the promise is broken, a <code>LMDB-KEY-EXISTS-ERROR</code>
  is signalled.</p></li>
<li><p>If <code>KEY-EXISTS-ERROR-P</code> is <code>NIL</code>, then instead of signalling
  <code>LMDB-KEY-EXISTS-ERROR</code> return <code>NIL</code>.</p></li>
</ul>

<p>May signal <a href="#x-28LMDB-3ALMDB-MAP-FULL-ERROR-20CONDITION-29" title="(LMDB:LMDB-MAP-FULL-ERROR CONDITION)"><code>LMDB-MAP-FULL-ERROR</code></a>, <a href="#x-28LMDB-3ALMDB-TXN-FULL-ERROR-20CONDITION-29" title="(LMDB:LMDB-TXN-FULL-ERROR CONDITION)"><code>LMDB-TXN-FULL-ERROR</code></a>,
<a href="#x-28LMDB-3ALMDB-TXN-READ-ONLY-ERROR-20CONDITION-29" title="(LMDB:LMDB-TXN-READ-ONLY-ERROR CONDITION)"><code>LMDB-TXN-READ-ONLY-ERROR</code></a>.</p>

<p>Wraps <a href="http://www.lmdb.tech/doc/group__mdb.html#ga4fa8573d9236d54687c61827ebf8cac0" >mdb_put()</a>.</p></li>
</ul>

<p><a id='x-28LMDB-3ADEL-20FUNCTION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L2542">[function]</a></span> <span class="reference-object"><a href="#x-28LMDB-3ADEL-20FUNCTION-29" >DEL</a></span></span> <span class="locative-args">DB KEY &amp;KEY VALUE</span></span></p>

<p>Delete <code>KEY</code> from <code>DB</code>. Returns <code>T</code> if data was deleted, <code>NIL</code> otherwise.
If <code>DB</code> supports sorted duplicates (<a href="#x-28LMDB-3A-40DUPSORT-20MGL-PAX-3ASECTION-29" title="DUPSORT">DUPSORT</a>), then <code>VALUE</code> is taken
into account: if it's <code>NIL</code>, then all duplicate values for <code>KEY</code> are
deleted, if it's not <code>NIL</code>, then only the matching value. May signal
<a href="#x-28LMDB-3ALMDB-TXN-READ-ONLY-ERROR-20CONDITION-29" title="(LMDB:LMDB-TXN-READ-ONLY-ERROR CONDITION)"><code>LMDB-TXN-READ-ONLY-ERROR</code></a>.</p>

<p>Wraps <a href="http://www.lmdb.tech/doc/group__mdb.html#gab8182f9360ea69ac0afd4a4eaab1ddb0" >mdb_del()</a>.</p></li>
</ul>

<p><a id='x-28LMDB-3A-40LMDB-2FCURSORS-20MGL-PAX-3ASECTION-29'></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#x-28LMDB-3A-40LMDB-2FBASIC-OPERATIONS-20MGL-PAX-3ASECTION-29" title="Basic operations">&#8592;</a> <a href="#x-28LMDB-3A-40LMDB-MANUAL-20MGL-PAX-3ASECTION-29" title="LMDB Manual">&#8593;</a> <a href="#x-28LMDB-3A-40LMDB-2FPOSITIONING-CURSORS-20MGL-PAX-3ASECTION-29" title="Positioning cursors">&#8594;</a> <a href="#x-28LMDB-3A-40LMDB-2FCURSORS-20MGL-PAX-3ASECTION-29" title="Cursors">&#8634;</a> <a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L2569">&#955;</a></span></span></p>

<h2><a href="#x-28LMDB-3A-40LMDB-2FCURSORS-20MGL-PAX-3ASECTION-29">11 Cursors</a></h2>

<p><a id='x-28LMDB-3AWITH-CURSOR-20MGL-PAX-3AMACRO-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L2628">[macro]</a></span> <span class="reference-object"><a href="#x-28LMDB-3AWITH-CURSOR-20MGL-PAX-3AMACRO-29" >WITH-CURSOR</a></span></span> <span class="locative-args">(VAR DB) &amp;BODY BODY</span></span></p>

<p>Bind <code>VAR</code> to a fresh <a href="#x-28LMDB-3ACURSOR-20CLASS-29" title="(LMDB:CURSOR CLASS)"><code>CURSOR</code></a> on <code>DB</code>. Execute <code>BODY</code>, then close the
cursor. Within the dynamic extent of <code>BODY</code>, this will be the
<a href="#x-28LMDB-3A-40DEFAULT-CURSOR-20MGL-PAX-3AGLOSSARY-TERM-29" title="(LMDB:@DEFAULT-CURSOR MGL-PAX:GLOSSARY-TERM)">default cursor</a>. The cursor is tied to the <a href="#x-28LMDB-3A-40ACTIVE-TRANSACTION-20MGL-PAX-3AGLOSSARY-TERM-29" title="(LMDB:@ACTIVE-TRANSACTION MGL-PAX:GLOSSARY-TERM)">active transaction</a>.</p>

<p><a href="#x-28LMDB-3ALMDB-CURSOR-THREAD-ERROR-20CONDITION-29" title="(LMDB:LMDB-CURSOR-THREAD-ERROR CONDITION)"><code>LMDB-CURSOR-THREAD-ERROR</code></a> is signalled if the cursor is accessed from
threads other than the one in which it was created.</p>

<p>Wraps <a href="http://www.lmdb.tech/doc/group__mdb.html#ga9ff5d7bd42557fd5ee235dc1d62613aa" >mdb_cursor_open()</a>
and <a href="http://www.lmdb.tech/doc/group__mdb.html#gad685f5d73c052715c7bd859cc4c05188" >mdb_cursor_close()</a>.</p></li>
</ul>

<p><a id='x-28LMDB-3AWITH-IMPLICIT-CURSOR-20MGL-PAX-3AMACRO-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L2661">[macro]</a></span> <span class="reference-object"><a href="#x-28LMDB-3AWITH-IMPLICIT-CURSOR-20MGL-PAX-3AMACRO-29" >WITH-IMPLICIT-CURSOR</a></span></span> <span class="locative-args">(DB) &amp;BODY BODY</span></span></p>

<p>Like <a href="#x-28LMDB-3AWITH-CURSOR-20MGL-PAX-3AMACRO-29" title="(LMDB:WITH-CURSOR MGL-PAX:MACRO)"><code>WITH-CURSOR</code></a> but the cursor object is not accessible directly,
only through the <a href="#x-28LMDB-3A-40DEFAULT-CURSOR-20MGL-PAX-3AGLOSSARY-TERM-29" title="(LMDB:@DEFAULT-CURSOR MGL-PAX:GLOSSARY-TERM)">default cursor</a> mechanism. The cursor is
stack-allocated, which eliminates the consing of <code>WITH-CURSOR</code>. Note
that stack allocation of cursors in <code>WITH-CURSOR</code> would risk data
corruption if the cursor were accessed beyond its dynamic extent.</p>

<p>Use <code>WITH-IMPLICIT-CURSOR</code> instead of <code>WITH-CURSOR</code> if a single cursor
at a time will suffice. Conversely, use <code>WITH-CURSOR</code> if a second
cursor is needed. That is, use</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">with-implicit-cursor</span></i> <span class="paren2">(<span class="code">db</span>)</span>
  <span class="paren2">(<span class="code">cursor-set-key 1</span>)</span></span>)</span></span></code></pre>

<p>but when two cursors iterate in an interleaved manner, use
<code>WITH-CURSOR</code>:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">with-cursor</span></i> <span class="paren2">(<span class="code">c1 db</span>)</span>
  <span class="paren2">(<span class="code"><i><span class="symbol">with-cursor</span></i> <span class="paren3">(<span class="code">c2 db</span>)</span>
    <span class="paren3">(<span class="code">cursor-first c1</span>)</span>
    <span class="paren3">(<span class="code">cursor-last c2</span>)</span>
    <span class="paren3">(<span class="code"><a href="http://www.lispworks.com/reference/HyperSpec/Body/s_if.htm" class="symbol"><i><span class="symbol">if</span></i></a> <span class="paren4">(<span class="code">some-pred <span class="paren5">(<span class="code">cursor-value c1</span>)</span> <span class="paren5">(<span class="code">cursor-value c2</span>)</span></span>)</span>
        <span class="paren4">(<span class="code">cursor-next c1</span>)</span>
        <span class="paren4">(<span class="code">cursor-prev c2</span>)</span></span>)</span>
    ...</span>)</span></span>)</span></span></code></pre>

<p>Wraps <a href="http://www.lmdb.tech/doc/group__mdb.html#ga9ff5d7bd42557fd5ee235dc1d62613aa" >mdb_cursor_open()</a>
and <a href="http://www.lmdb.tech/doc/group__mdb.html#gad685f5d73c052715c7bd859cc4c05188" >mdb_cursor_close()</a>.</p></li>
</ul>

<p><a id='x-28LMDB-3ACURSOR-20CLASS-29'></a></p>

<ul>
<li><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L2580">[class]</a></span> <span class="reference-object"><a href="#x-28LMDB-3ACURSOR-20CLASS-29" >CURSOR</a></span></span> <span class="locative-args">STRUCTURE-OBJECT</span></span></li>
</ul>

<p><a id='x-28LMDB-3ACURSOR-DB-20FUNCTION-29'></a></p>

<ul>
<li><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L2580">[function]</a></span> <span class="reference-object"><a href="#x-28LMDB-3ACURSOR-DB-20FUNCTION-29" >CURSOR-DB</a></span></span> <span class="locative-args">INSTANCE</span></span></li>
</ul>

<p><a id='x-28LMDB-3A-40DEFAULT-CURSOR-20MGL-PAX-3AGLOSSARY-TERM-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L2714">[glossary-term]</a></span> <span class="reference-object"><a href="#x-28LMDB-3A-40DEFAULT-CURSOR-20MGL-PAX-3AGLOSSARY-TERM-29" >default cursor</a></span></span></span></p>

<p>All operations, described below, that take cursor arguments accept
<code>NIL</code> instead of a <a href="#x-28LMDB-3ACURSOR-20CLASS-29" title="(LMDB:CURSOR CLASS)"><code>CURSOR</code></a> object, in which case the cursor from the
immediately enclosing <a href="#x-28LMDB-3AWITH-CURSOR-20MGL-PAX-3AMACRO-29" title="(LMDB:WITH-CURSOR MGL-PAX:MACRO)"><code>WITH-CURSOR</code></a> or <a href="#x-28LMDB-3AWITH-IMPLICIT-CURSOR-20MGL-PAX-3AMACRO-29" title="(LMDB:WITH-IMPLICIT-CURSOR MGL-PAX:MACRO)"><code>WITH-IMPLICIT-CURSOR</code></a> is used.
This cursor is referred to as the <em>default cursor</em>.</p>

<p>To reduce syntactic clutter, some operations thus make cursor
arguments <code>&amp;OPTIONAL</code>. When this is undesirable - because there are
keyword arguments as well - the cursor may be a required argument as
in <a href="#x-28LMDB-3ACURSOR-PUT-20FUNCTION-29" title="(LMDB:CURSOR-PUT FUNCTION)"><code>CURSOR-PUT</code></a>. Still <code>NIL</code> can be passed explicitly.</p></li>
</ul>

<p><a id='x-28LMDB-3A-40LMDB-2FPOSITIONING-CURSORS-20MGL-PAX-3ASECTION-29'></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#x-28LMDB-3A-40LMDB-2FCURSORS-20MGL-PAX-3ASECTION-29" title="Cursors">&#8592;</a> <a href="#x-28LMDB-3A-40LMDB-2FCURSORS-20MGL-PAX-3ASECTION-29" title="Cursors">&#8593;</a> <a href="#x-28LMDB-3A-40LMDB-2FBASIC-CURSOR-OPERATIONS-20MGL-PAX-3ASECTION-29" title="Basic cursor operations">&#8594;</a> <a href="#x-28LMDB-3A-40LMDB-2FPOSITIONING-CURSORS-20MGL-PAX-3ASECTION-29" title="Positioning cursors">&#8634;</a> <a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L2725">&#955;</a></span></span></p>

<h3><a href="#x-28LMDB-3A-40LMDB-2FPOSITIONING-CURSORS-20MGL-PAX-3ASECTION-29">11.1 Positioning cursors</a></h3>

<p>The following functions <em>position</em> or <em>initialize</em> a cursor while
returning the value (<em>a</em> value with <a href="#x-28LMDB-3A-40DUPSORT-20MGL-PAX-3ASECTION-29" title="DUPSORT">DUPSORT</a>) associated with a key,
or both the key and the value. Initialization is successful if there
is the cursor points to a key-value pair, which is indicated by the
last return value being <code>T</code>.</p>

<p><a id='x-28LMDB-3ACURSOR-FIRST-20FUNCTION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L2746">[function]</a></span> <span class="reference-object"><a href="#x-28LMDB-3ACURSOR-FIRST-20FUNCTION-29" >CURSOR-FIRST</a></span></span> <span class="locative-args">&amp;OPTIONAL CURSOR</span></span></p>

<p>Move <code>CURSOR</code> to the first key of its database. Return the key, the
value and <code>T</code>, or <code>NIL</code> if the database is empty. If <a href="#x-28LMDB-3A-40DUPSORT-20MGL-PAX-3ASECTION-29" title="DUPSORT">DUPSORT</a>, position
<code>CURSOR</code> on the first value of the first key.</p>

<p>Wraps <a href="http://www.lmdb.tech/doc/group__mdb.html#ga48df35fb102536b32dfbb801a47b4cb0" >mdb_cursor_get()</a>
with <a href="http://www.lmdb.tech/doc/group__mdb.html#ga1206b2af8b95e7f6b0ef6b28708c9127" >MDB_FIRST</a>.</p></li>
</ul>

<p><a id='x-28LMDB-3ACURSOR-FIRST-DUP-20FUNCTION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L2767">[function]</a></span> <span class="reference-object"><a href="#x-28LMDB-3ACURSOR-FIRST-DUP-20FUNCTION-29" >CURSOR-FIRST-DUP</a></span></span> <span class="locative-args">&amp;OPTIONAL CURSOR</span></span></p>

<p>Move <code>CURSOR</code> to the first duplicate value of the current key. Return
the value and <code>T</code>. Return <code>NIL</code> if <code>CURSOR</code> is not positioned.</p>

<p>Wraps <a href="http://www.lmdb.tech/doc/group__mdb.html#ga48df35fb102536b32dfbb801a47b4cb0" >mdb_cursor_get()</a>
with <a href="http://www.lmdb.tech/doc/group__mdb.html#ga1206b2af8b95e7f6b0ef6b28708c9127" >MDB_FIRST_DUP</a>.</p></li>
</ul>

<p><a id='x-28LMDB-3ACURSOR-LAST-20FUNCTION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L2786">[function]</a></span> <span class="reference-object"><a href="#x-28LMDB-3ACURSOR-LAST-20FUNCTION-29" >CURSOR-LAST</a></span></span> <span class="locative-args">&amp;OPTIONAL CURSOR</span></span></p>

<p>Move <code>CURSOR</code> to the last key of its database. Return the key, the
value and <code>T</code>, or <code>NIL</code> if the database is empty. If <a href="#x-28LMDB-3A-40DUPSORT-20MGL-PAX-3ASECTION-29" title="DUPSORT">DUPSORT</a>, position
<code>CURSOR</code> on the last value of the last key.</p>

<p>Wraps <a href="http://www.lmdb.tech/doc/group__mdb.html#ga48df35fb102536b32dfbb801a47b4cb0" >mdb_cursor_get()</a>
with <a href="http://www.lmdb.tech/doc/group__mdb.html#ga1206b2af8b95e7f6b0ef6b28708c9127" >MDB_LAST</a>.</p></li>
</ul>

<p><a id='x-28LMDB-3ACURSOR-LAST-DUP-20FUNCTION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L2807">[function]</a></span> <span class="reference-object"><a href="#x-28LMDB-3ACURSOR-LAST-DUP-20FUNCTION-29" >CURSOR-LAST-DUP</a></span></span> <span class="locative-args">&amp;OPTIONAL CURSOR</span></span></p>

<p>Move <code>CURSOR</code> to the last duplicate value of the current key. Return
the value and <code>T</code>. Return <code>NIL</code> if <code>CURSOR</code> is not positioned.</p>

<p>Wraps <a href="http://www.lmdb.tech/doc/group__mdb.html#ga48df35fb102536b32dfbb801a47b4cb0" >mdb_cursor_get()</a>
with <a href="http://www.lmdb.tech/doc/group__mdb.html#ga1206b2af8b95e7f6b0ef6b28708c9127" >MDB_LAST_DUP</a>.</p></li>
</ul>

<p><a id='x-28LMDB-3ACURSOR-NEXT-20FUNCTION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L2825">[function]</a></span> <span class="reference-object"><a href="#x-28LMDB-3ACURSOR-NEXT-20FUNCTION-29" >CURSOR-NEXT</a></span></span> <span class="locative-args">&amp;OPTIONAL CURSOR</span></span></p>

<p>Move <code>CURSOR</code> to the next key-value pair of its database and return
the key, the value, and <code>T</code>. Return <code>NIL</code> if there is no next item. If
<a href="#x-28LMDB-3A-40DUPSORT-20MGL-PAX-3ASECTION-29" title="DUPSORT">DUPSORT</a>, position <code>CURSOR</code> on the next value of the current key if
exists, else the first value of next key. If <code>CURSOR</code> is
uninitialized, then <a href="#x-28LMDB-3ACURSOR-FIRST-20FUNCTION-29" title="(LMDB:CURSOR-FIRST FUNCTION)"><code>CURSOR-FIRST</code></a> is called on it first.</p>

<p>Wraps <a href="http://www.lmdb.tech/doc/group__mdb.html#ga48df35fb102536b32dfbb801a47b4cb0" >mdb_cursor_get()</a>
with <a href="http://www.lmdb.tech/doc/group__mdb.html#ga1206b2af8b95e7f6b0ef6b28708c9127" >MDB_NEXT</a>.</p></li>
</ul>

<p><a id='x-28LMDB-3ACURSOR-NEXT-NODUP-20FUNCTION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L2848">[function]</a></span> <span class="reference-object"><a href="#x-28LMDB-3ACURSOR-NEXT-NODUP-20FUNCTION-29" >CURSOR-NEXT-NODUP</a></span></span> <span class="locative-args">&amp;OPTIONAL CURSOR</span></span></p>

<p>Move <code>CURSOR</code> to the first value of next key pair of its
database (skipping over duplicate values of the current key). Return
the key, the value and <code>T</code>. Return <code>NIL</code> if there is no next item. If
<code>CURSOR</code> is uninitialized, then <a href="#x-28LMDB-3ACURSOR-FIRST-20FUNCTION-29" title="(LMDB:CURSOR-FIRST FUNCTION)"><code>CURSOR-FIRST</code></a> is called on it first.</p>

<p>Wraps <a href="http://www.lmdb.tech/doc/group__mdb.html#ga48df35fb102536b32dfbb801a47b4cb0" >mdb_cursor_get()</a>
with <a href="http://www.lmdb.tech/doc/group__mdb.html#ga1206b2af8b95e7f6b0ef6b28708c9127" >MDB_NEXT_NODUP</a>.</p></li>
</ul>

<p><a id='x-28LMDB-3ACURSOR-NEXT-DUP-20FUNCTION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L2870">[function]</a></span> <span class="reference-object"><a href="#x-28LMDB-3ACURSOR-NEXT-DUP-20FUNCTION-29" >CURSOR-NEXT-DUP</a></span></span> <span class="locative-args">&amp;OPTIONAL CURSOR</span></span></p>

<p>Move <code>CURSOR</code> to the next value of current key pair of its database.
Return the value and <code>T</code>. Return <code>NIL</code> if there is no next value. If
<code>CURSOR</code> is uninitialized, then <a href="#x-28LMDB-3ACURSOR-FIRST-20FUNCTION-29" title="(LMDB:CURSOR-FIRST FUNCTION)"><code>CURSOR-FIRST</code></a> is called on it first.</p>

<p>Wraps <a href="http://www.lmdb.tech/doc/group__mdb.html#ga48df35fb102536b32dfbb801a47b4cb0" >mdb_cursor_get()</a>
with <a href="http://www.lmdb.tech/doc/group__mdb.html#ga1206b2af8b95e7f6b0ef6b28708c9127" >MDB_NEXT_DUP</a>.</p></li>
</ul>

<p><a id='x-28LMDB-3ACURSOR-PREV-20FUNCTION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L2889">[function]</a></span> <span class="reference-object"><a href="#x-28LMDB-3ACURSOR-PREV-20FUNCTION-29" >CURSOR-PREV</a></span></span> <span class="locative-args">&amp;OPTIONAL CURSOR</span></span></p>

<p>Move <code>CURSOR</code> to the previous key-value pair of its database.
Return the key, the value and <code>T</code>. Return <code>NIL</code> if there is no previous
item. If <a href="#x-28LMDB-3A-40DUPSORT-20MGL-PAX-3ASECTION-29" title="DUPSORT">DUPSORT</a>, position <code>CURSOR</code> on the previous value of the
current key if exists, else the last value of previous key. If
<code>CURSOR</code> is uninitialized, then <a href="#x-28LMDB-3ACURSOR-LAST-20FUNCTION-29" title="(LMDB:CURSOR-LAST FUNCTION)"><code>CURSOR-LAST</code></a> is called on it first.</p>

<p>Wraps <a href="http://www.lmdb.tech/doc/group__mdb.html#ga48df35fb102536b32dfbb801a47b4cb0" >mdb_cursor_get()</a>
with <a href="http://www.lmdb.tech/doc/group__mdb.html#ga1206b2af8b95e7f6b0ef6b28708c9127" >MDB_PREV</a>.</p></li>
</ul>

<p><a id='x-28LMDB-3ACURSOR-PREV-NODUP-20FUNCTION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L2912">[function]</a></span> <span class="reference-object"><a href="#x-28LMDB-3ACURSOR-PREV-NODUP-20FUNCTION-29" >CURSOR-PREV-NODUP</a></span></span> <span class="locative-args">&amp;OPTIONAL CURSOR</span></span></p>

<p>Move <code>CURSOR</code> to the last value of previous key pair of its
database (skipping over duplicate values of the current and the
previous key). Return the key, the value, and <code>T</code>. Return <code>NIL</code> if
there is no prev item. If <code>CURSOR</code> is uninitialized, then <a href="#x-28LMDB-3ACURSOR-LAST-20FUNCTION-29" title="(LMDB:CURSOR-LAST FUNCTION)"><code>CURSOR-LAST</code></a>
is called on it first.</p>

<p>Wraps <a href="http://www.lmdb.tech/doc/group__mdb.html#ga48df35fb102536b32dfbb801a47b4cb0" >mdb_cursor_get()</a>
with <a href="http://www.lmdb.tech/doc/group__mdb.html#ga1206b2af8b95e7f6b0ef6b28708c9127" >MDB_PREV_NODUP</a>.</p></li>
</ul>

<p><a id='x-28LMDB-3ACURSOR-PREV-DUP-20FUNCTION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L2935">[function]</a></span> <span class="reference-object"><a href="#x-28LMDB-3ACURSOR-PREV-DUP-20FUNCTION-29" >CURSOR-PREV-DUP</a></span></span> <span class="locative-args">&amp;OPTIONAL CURSOR</span></span></p>

<p>Move <code>CURSOR</code> to the previous duplicate value of current key pair of
its database. Return the value and <code>T</code>. Return <code>NIL</code> if there is no prev
value. If <code>CURSOR</code> is uninitialized, then <a href="#x-28LMDB-3ACURSOR-LAST-20FUNCTION-29" title="(LMDB:CURSOR-LAST FUNCTION)"><code>CURSOR-LAST</code></a> is called on it
first.</p>

<p>Wraps <a href="http://www.lmdb.tech/doc/group__mdb.html#ga48df35fb102536b32dfbb801a47b4cb0" >mdb_cursor_get()</a>
with <a href="http://www.lmdb.tech/doc/group__mdb.html#ga1206b2af8b95e7f6b0ef6b28708c9127" >MDB_PREV_DUP</a>.</p></li>
</ul>

<p><a id='x-28LMDB-3ACURSOR-SET-KEY-20FUNCTION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L2955">[function]</a></span> <span class="reference-object"><a href="#x-28LMDB-3ACURSOR-SET-KEY-20FUNCTION-29" >CURSOR-SET-KEY</a></span></span> <span class="locative-args">KEY &amp;OPTIONAL CURSOR</span></span></p>

<p>Move <code>CURSOR</code> to <code>KEY</code> of its database. Return the corresponding value
and <code>T</code>. Return <code>NIL</code> if <code>KEY</code> was not found. If <a href="#x-28LMDB-3A-40DUPSORT-20MGL-PAX-3ASECTION-29" title="DUPSORT">DUPSORT</a>, position <code>CURSOR</code>
on the first value of <code>KEY</code>.</p>

<p>Wraps <a href="http://www.lmdb.tech/doc/group__mdb.html#ga48df35fb102536b32dfbb801a47b4cb0" >mdb_cursor_get()</a>
with <a href="http://www.lmdb.tech/doc/group__mdb.html#ga1206b2af8b95e7f6b0ef6b28708c9127" >MDB_SET_KEY</a>.</p></li>
</ul>

<p><a id='x-28LMDB-3ACURSOR-SET-KEY-DUP-20FUNCTION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L2976">[function]</a></span> <span class="reference-object"><a href="#x-28LMDB-3ACURSOR-SET-KEY-DUP-20FUNCTION-29" >CURSOR-SET-KEY-DUP</a></span></span> <span class="locative-args">KEY VALUE &amp;OPTIONAL CURSOR</span></span></p>

<p>Move <code>CURSOR</code> to the <code>KEY</code>, <code>VALUE</code> pair of its database and return <code>T</code> on
success. Return <code>NIL</code> if the pair was not found.</p>

<p>Wraps <a href="http://www.lmdb.tech/doc/group__mdb.html#ga48df35fb102536b32dfbb801a47b4cb0" >mdb_cursor_get()</a>
with <a href="http://www.lmdb.tech/doc/group__mdb.html#ga1206b2af8b95e7f6b0ef6b28708c9127" >MDB_GET_BOTH</a>.</p></li>
</ul>

<p><a id='x-28LMDB-3ACURSOR-SET-RANGE-20FUNCTION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L2994">[function]</a></span> <span class="reference-object"><a href="#x-28LMDB-3ACURSOR-SET-RANGE-20FUNCTION-29" >CURSOR-SET-RANGE</a></span></span> <span class="locative-args">KEY &amp;OPTIONAL CURSOR</span></span></p>

<p>Position <code>CURSOR</code> on the first key equal to or greater than <code>KEY</code>.
Return the found key, the value and <code>T</code>. Return <code>NIL</code> if <code>KEY</code> was not
found. If <a href="#x-28LMDB-3A-40DUPSORT-20MGL-PAX-3ASECTION-29" title="DUPSORT">DUPSORT</a>, position <code>CURSOR</code> on the first value of the found
key.</p>

<p>Wraps <a href="http://www.lmdb.tech/doc/group__mdb.html#ga48df35fb102536b32dfbb801a47b4cb0" >mdb_cursor_get()</a>
with <a href="http://www.lmdb.tech/doc/group__mdb.html#ga1206b2af8b95e7f6b0ef6b28708c9127" >MDB_SET_RANGE</a>.</p></li>
</ul>

<p><a id='x-28LMDB-3ACURSOR-SET-RANGE-DUP-20FUNCTION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L3016">[function]</a></span> <span class="reference-object"><a href="#x-28LMDB-3ACURSOR-SET-RANGE-DUP-20FUNCTION-29" >CURSOR-SET-RANGE-DUP</a></span></span> <span class="locative-args">KEY VALUE &amp;OPTIONAL CURSOR</span></span></p>

<p>Position <code>CURSOR</code> exactly at <code>KEY</code> on the first value greater than or
equal to <code>VALUE</code>. Return the value at the position and <code>T</code> on success,
or <code>NIL</code> if there is no such value associated with <code>KEY</code>.</p>

<p>Wraps <a href="http://www.lmdb.tech/doc/group__mdb.html#ga48df35fb102536b32dfbb801a47b4cb0" >mdb_cursor_get()</a>
with <a href="http://www.lmdb.tech/doc/group__mdb.html#ga1206b2af8b95e7f6b0ef6b28708c9127" >MDB_GET_BOTH_RANGE</a>.</p></li>
</ul>

<p><a id='x-28LMDB-3A-40LMDB-2FBASIC-CURSOR-OPERATIONS-20MGL-PAX-3ASECTION-29'></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#x-28LMDB-3A-40LMDB-2FPOSITIONING-CURSORS-20MGL-PAX-3ASECTION-29" title="Positioning cursors">&#8592;</a> <a href="#x-28LMDB-3A-40LMDB-2FCURSORS-20MGL-PAX-3ASECTION-29" title="Cursors">&#8593;</a> <a href="#x-28LMDB-3A-40LMDB-2FMISC-CURSOR-20MGL-PAX-3ASECTION-29" title="Miscellaneous cursor operations">&#8594;</a> <a href="#x-28LMDB-3A-40LMDB-2FBASIC-CURSOR-OPERATIONS-20MGL-PAX-3ASECTION-29" title="Basic cursor operations">&#8634;</a> <a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L3035">&#955;</a></span></span></p>

<h3><a href="#x-28LMDB-3A-40LMDB-2FBASIC-CURSOR-OPERATIONS-20MGL-PAX-3ASECTION-29">11.2 Basic cursor operations</a></h3>

<p>The following operations are similar to <a href="#x-28LMDB-3AG3T-20FUNCTION-29" title="(LMDB:G3T FUNCTION)"><code>G3T</code></a>, <a href="#x-28LMDB-3APUT-20FUNCTION-29" title="(LMDB:PUT FUNCTION)"><code>PUT</code></a>, <a href="#x-28LMDB-3ADEL-20FUNCTION-29" title="(LMDB:DEL FUNCTION)"><code>DEL</code></a> (the
<a href="#x-28LMDB-3A-40LMDB-2FBASIC-OPERATIONS-20MGL-PAX-3ASECTION-29" title="Basic operations">Basic operations</a>), but <code>G3T</code> has three variants
(<a href="#x-28LMDB-3ACURSOR-KEY-VALUE-20FUNCTION-29" title="(LMDB:CURSOR-KEY-VALUE FUNCTION)"><code>CURSOR-KEY-VALUE</code></a>, <a href="#x-28LMDB-3ACURSOR-KEY-20FUNCTION-29" title="(LMDB:CURSOR-KEY FUNCTION)"><code>CURSOR-KEY</code></a>, and <a href="#x-28LMDB-3ACURSOR-VALUE-20FUNCTION-29" title="(LMDB:CURSOR-VALUE FUNCTION)"><code>CURSOR-VALUE</code></a>). All of them
require the cursor to be positioned (see
<a href="#x-28LMDB-3A-40LMDB-2FPOSITIONING-CURSORS-20MGL-PAX-3ASECTION-29" title="Positioning cursors">Positioning cursors</a>).</p>

<p><a id='x-28LMDB-3ACURSOR-KEY-VALUE-20FUNCTION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L3047">[function]</a></span> <span class="reference-object"><a href="#x-28LMDB-3ACURSOR-KEY-VALUE-20FUNCTION-29" >CURSOR-KEY-VALUE</a></span></span> <span class="locative-args">&amp;OPTIONAL CURSOR</span></span></p>

<p>Return the key and value <code>CURSOR</code> is positioned at and <code>T</code>. Return <code>NIL</code>
if <code>CURSOR</code> is uninitialized.</p>

<p>Wraps <a href="http://www.lmdb.tech/doc/group__mdb.html#ga48df35fb102536b32dfbb801a47b4cb0" >mdb_cursor_get()</a>
with <a href="http://www.lmdb.tech/doc/group__mdb.html#ga1206b2af8b95e7f6b0ef6b28708c9127" >MDB_GET_CURRENT</a>.</p></li>
</ul>

<p><a id='x-28LMDB-3ACURSOR-KEY-20FUNCTION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L3067">[function]</a></span> <span class="reference-object"><a href="#x-28LMDB-3ACURSOR-KEY-20FUNCTION-29" >CURSOR-KEY</a></span></span> <span class="locative-args">&amp;OPTIONAL CURSOR</span></span></p>

<p>Return the key <code>CURSOR</code> is positioned at and <code>T</code>. Return <code>NIL</code> if <code>CURSOR</code>
is uninitialized.</p>

<p>Wraps <a href="http://www.lmdb.tech/doc/group__mdb.html#ga48df35fb102536b32dfbb801a47b4cb0" >mdb_cursor_get()</a>
with <a href="http://www.lmdb.tech/doc/group__mdb.html#ga1206b2af8b95e7f6b0ef6b28708c9127" >MDB_GET_CURRENT</a>.</p></li>
</ul>

<p><a id='x-28LMDB-3ACURSOR-VALUE-20FUNCTION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L3085">[function]</a></span> <span class="reference-object"><a href="#x-28LMDB-3ACURSOR-VALUE-20FUNCTION-29" >CURSOR-VALUE</a></span></span> <span class="locative-args">&amp;OPTIONAL CURSOR</span></span></p>

<p>Return the value <code>CURSOR</code> is positioned at and <code>T</code>. Return <code>NIL</code> if
<code>CURSOR</code> is uninitialized.</p>

<p>Wraps <a href="http://www.lmdb.tech/doc/group__mdb.html#ga48df35fb102536b32dfbb801a47b4cb0" >mdb_cursor_get()</a>
with <a href="http://www.lmdb.tech/doc/group__mdb.html#ga1206b2af8b95e7f6b0ef6b28708c9127" >MDB_GET_CURRENT</a>.</p></li>
</ul>

<p><a id='x-28LMDB-3ACURSOR-PUT-20FUNCTION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L3103">[function]</a></span> <span class="reference-object"><a href="#x-28LMDB-3ACURSOR-PUT-20FUNCTION-29" >CURSOR-PUT</a></span></span> <span class="locative-args">KEY VALUE CURSOR &amp;KEY CURRENT (OVERWRITE <code>T</code>) (DUPDATA <code>T</code>) APPEND APPEND-DUP</span></span></p>

<p>Like <a href="#x-28LMDB-3APUT-20FUNCTION-29" title="(LMDB:PUT FUNCTION)"><code>PUT</code></a>, store key-value pairs into <code>CURSOR</code>'s database.
<code>CURSOR</code> is positioned at the new item, or on failure usually near it.
Return <code>VALUE</code>.</p>

<ul>
<li><p><code>CURRENT</code>: Replace the item at the current cursor position. <code>KEY</code> must
  still be provided, and must match it. If using sorted
  duplicates (<a href="#x-28LMDB-3A-40DUPSORT-20MGL-PAX-3ASECTION-29" title="DUPSORT">DUPSORT</a>), <code>VALUE</code> must still sort into the same place.
  This is intended to be used when the new data is the same size as
  the old. Otherwise it will simply perform a delete of the old
  record followed by an insert.</p></li>
<li><p><code>OVERWRITE</code>: If <code>NIL</code>, signal <a href="#x-28LMDB-3ALMDB-KEY-EXISTS-ERROR-20CONDITION-29" title="(LMDB:LMDB-KEY-EXISTS-ERROR CONDITION)"><code>LMDB-KEY-EXISTS-ERROR</code></a> if <code>KEY</code> already
  appears in <a href="#x-28LMDB-3ACURSOR-DB-20FUNCTION-29" title="(LMDB:CURSOR-DB FUNCTION)"><code>CURSOR-DB</code></a>.</p></li>
<li><p><code>DUPDATA</code>: If <code>NIL</code>, signal <code>LMDB-KEY-EXISTS-ERROR</code> if the <code>KEY</code>, <code>VALUE</code>
  pair already appears in <a href="#x-28LMDB-3ADB-20CLASS-29" title="(LMDB:DB CLASS)"><code>DB</code></a>. Has no effect if <code>CURSOR-DB</code> doesn't
  have <a href="#x-28LMDB-3A-40DUPSORT-20MGL-PAX-3ASECTION-29" title="DUPSORT">DUPSORT</a>.</p></li>
<li><p><code>APPEND</code>: Append the <code>KEY</code>, <code>VALUE</code> pair to the end of <code>CURSOR-DB</code> instead
  of finding <code>KEY</code>'s location in the B+ tree by performing
  comparisons. The client effectively promises that keys are
  inserted in sort order, which allows for fast bulk loading. If the
  promise is broken, <code>LMDB-KEY-EXISTS-ERROR</code> is signalled.</p></li>
<li><p><code>APPEND-DUP</code>: The client promises that duplicate values are inserted
  in sort order. If the promise is broken, <code>LMDB-KEY-EXISTS-ERROR</code> is
  signalled.</p></li>
</ul>

<p>May signal <a href="#x-28LMDB-3ALMDB-MAP-FULL-ERROR-20CONDITION-29" title="(LMDB:LMDB-MAP-FULL-ERROR CONDITION)"><code>LMDB-MAP-FULL-ERROR</code></a>, <a href="#x-28LMDB-3ALMDB-TXN-FULL-ERROR-20CONDITION-29" title="(LMDB:LMDB-TXN-FULL-ERROR CONDITION)"><code>LMDB-TXN-FULL-ERROR</code></a>,
<a href="#x-28LMDB-3ALMDB-TXN-READ-ONLY-ERROR-20CONDITION-29" title="(LMDB:LMDB-TXN-READ-ONLY-ERROR CONDITION)"><code>LMDB-TXN-READ-ONLY-ERROR</code></a>.</p>

<p>Wraps <a href="http://www.lmdb.tech/doc/group__mdb.html#ga1f83ccb40011837ff37cc32be01ad91e" >mdb_cursor_put()</a>.</p></li>
</ul>

<p><a id='x-28LMDB-3ACURSOR-DEL-20FUNCTION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L3155">[function]</a></span> <span class="reference-object"><a href="#x-28LMDB-3ACURSOR-DEL-20FUNCTION-29" >CURSOR-DEL</a></span></span> <span class="locative-args">CURSOR &amp;KEY DELETE-DUPS</span></span></p>

<p>Delete the key-value pair <code>CURSOR</code> is positioned at. This does not
make the cursor uninitialized, so operations such as <a href="#x-28LMDB-3ACURSOR-NEXT-20FUNCTION-29" title="(LMDB:CURSOR-NEXT FUNCTION)"><code>CURSOR-NEXT</code></a> can
still be used on it. Both <code>CURSOR-NEXT</code> and <a href="#x-28LMDB-3ACURSOR-KEY-VALUE-20FUNCTION-29" title="(LMDB:CURSOR-KEY-VALUE FUNCTION)"><code>CURSOR-KEY-VALUE</code></a> will
return the same record after this operation. If <code>CURSOR</code> is not
initialized, <a href="#x-28LMDB-3ALMDB-CURSOR-UNINITIALIZED-ERROR-20CONDITION-29" title="(LMDB:LMDB-CURSOR-UNINITIALIZED-ERROR CONDITION)"><code>LMDB-CURSOR-UNINITIALIZED-ERROR</code></a> is signalled. Returns
no values.</p>

<p>If <code>DELETE-DUPS</code>, delete all duplicate values that belong to the
current key. With <code>DELETE-DUPS</code>, <a href="#x-28LMDB-3ACURSOR-DB-20FUNCTION-29" title="(LMDB:CURSOR-DB FUNCTION)"><code>CURSOR-DB</code></a> must have <a href="#x-28LMDB-3A-40DUPSORT-20MGL-PAX-3ASECTION-29" title="DUPSORT">DUPSORT</a>, else
<a href="#x-28LMDB-3ALMDB-INCOMPATIBLE-ERROR-20CONDITION-29" title="(LMDB:LMDB-INCOMPATIBLE-ERROR CONDITION)"><code>LMDB-INCOMPATIBLE-ERROR</code></a> is signalled.</p>

<p>May signal <code>LMDB-CURSOR-UNINITIALIZED-ERROR</code>,
<a href="#x-28LMDB-3ALMDB-TXN-READ-ONLY-ERROR-20CONDITION-29" title="(LMDB:LMDB-TXN-READ-ONLY-ERROR CONDITION)"><code>LMDB-TXN-READ-ONLY-ERROR</code></a>.</p>

<p>Wraps <a href="http://www.lmdb.tech/doc/group__mdb.html#ga26a52d3efcfd72e5bf6bd6960bf75f95" >mdb_cursor_del()</a>.</p></li>
</ul>

<p><a id='x-28LMDB-3A-40LMDB-2FMISC-CURSOR-20MGL-PAX-3ASECTION-29'></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#x-28LMDB-3A-40LMDB-2FBASIC-CURSOR-OPERATIONS-20MGL-PAX-3ASECTION-29" title="Basic cursor operations">&#8592;</a> <a href="#x-28LMDB-3A-40LMDB-2FCURSORS-20MGL-PAX-3ASECTION-29" title="Cursors">&#8593;</a> <a href="#x-28LMDB-3A-40LMDB-2FCONDITIONS-20MGL-PAX-3ASECTION-29" title="Conditions">&#8594;</a> <a href="#x-28LMDB-3A-40LMDB-2FMISC-CURSOR-20MGL-PAX-3ASECTION-29" title="Miscellaneous cursor operations">&#8634;</a> <a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L3186">&#955;</a></span></span></p>

<h3><a href="#x-28LMDB-3A-40LMDB-2FMISC-CURSOR-20MGL-PAX-3ASECTION-29">11.3 Miscellaneous cursor operations</a></h3>

<p><a id='x-28LMDB-3ACURSOR-RENEW-20FUNCTION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L3195">[function]</a></span> <span class="reference-object"><a href="#x-28LMDB-3ACURSOR-RENEW-20FUNCTION-29" >CURSOR-RENEW</a></span></span> <span class="locative-args">&amp;OPTIONAL CURSOR</span></span></p>

<p>Associate <code>CURSOR</code> with the <a href="#x-28LMDB-3A-40ACTIVE-TRANSACTION-20MGL-PAX-3AGLOSSARY-TERM-29" title="(LMDB:@ACTIVE-TRANSACTION MGL-PAX:GLOSSARY-TERM)">active transaction</a> (which must be
read-only) as if it had been created with that transaction to begin
with to avoid allocation overhead. <a href="#x-28LMDB-3ACURSOR-DB-20FUNCTION-29" title="(LMDB:CURSOR-DB FUNCTION)"><code>CURSOR-DB</code></a> stays the same. This
may be done whether the previous transaction is open or closed (see
<a href="#x-28LMDB-3AOPEN-TXN-P-20FUNCTION-29" title="(LMDB:OPEN-TXN-P FUNCTION)"><code>OPEN-TXN-P</code></a>). No values are returned.</p>

<p>Wraps <a href="http://www.lmdb.tech/doc/group__mdb.html#gac8b57befb68793070c85ea813df481af" >mdb_cursor_renew()</a>.</p></li>
</ul>

<p><a id='x-28LMDB-3ACURSOR-COUNT-20FUNCTION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L3215">[function]</a></span> <span class="reference-object"><a href="#x-28LMDB-3ACURSOR-COUNT-20FUNCTION-29" >CURSOR-COUNT</a></span></span> <span class="locative-args">&amp;OPTIONAL CURSOR</span></span></p>

<p>Return the number of duplicate values for the current key of
<code>CURSOR</code>. If <a href="#x-28LMDB-3ACURSOR-DB-20FUNCTION-29" title="(LMDB:CURSOR-DB FUNCTION)"><code>CURSOR-DB</code></a> doesn't have <a href="#x-28LMDB-3A-40DUPSORT-20MGL-PAX-3ASECTION-29" title="DUPSORT">DUPSORT</a>, <a href="#x-28LMDB-3ALMDB-INCOMPATIBLE-ERROR-20CONDITION-29" title="(LMDB:LMDB-INCOMPATIBLE-ERROR CONDITION)"><code>LMDB-INCOMPATIBLE-ERROR</code></a>
is signalled. If <code>CURSOR</code> is not initialized,
<a href="#x-28LMDB-3ALMDB-CURSOR-UNINITIALIZED-ERROR-20CONDITION-29" title="(LMDB:LMDB-CURSOR-UNINITIALIZED-ERROR CONDITION)"><code>LMDB-CURSOR-UNINITIALIZED-ERROR</code></a> is signalled.</p>

<p>Wraps <a href="http://www.lmdb.tech/doc/group__mdb.html#ga4041fd1e1862c6b7d5f10590b86ffbe2" >mdb_cursor_count()</a>.</p></li>
</ul>

<p><a id='x-28LMDB-3ADO-CURSOR-20MGL-PAX-3AMACRO-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L3234">[macro]</a></span> <span class="reference-object"><a href="#x-28LMDB-3ADO-CURSOR-20MGL-PAX-3AMACRO-29" >DO-CURSOR</a></span></span> <span class="locative-args">(KEY-VAR VALUE-VAR CURSOR &amp;KEY FROM-END NODUP) &amp;BODY BODY</span></span></p>

<p>Iterate over key-value pairs starting from the position of <code>CURSOR</code>.
If <code>CURSOR</code> is not positioned then no key-value pairs will be seen. If
<code>FROM-END</code>, then iterate with <a href="#x-28LMDB-3ACURSOR-PREV-20FUNCTION-29" title="(LMDB:CURSOR-PREV FUNCTION)"><code>CURSOR-PREV</code></a> instead of <a href="#x-28LMDB-3ACURSOR-NEXT-20FUNCTION-29" title="(LMDB:CURSOR-NEXT FUNCTION)"><code>CURSOR-NEXT</code></a>. If
<code>NODUP</code>, then make that <a href="#x-28LMDB-3ACURSOR-PREV-NODUP-20FUNCTION-29" title="(LMDB:CURSOR-PREV-NODUP FUNCTION)"><code>CURSOR-PREV-NODUP</code></a> and <a href="#x-28LMDB-3ACURSOR-NEXT-NODUP-20FUNCTION-29" title="(LMDB:CURSOR-NEXT-NODUP FUNCTION)"><code>CURSOR-NEXT-NODUP</code></a>.</p>

<p>If <code>CURSOR</code> is <code>NIL</code>, the <a href="#x-28LMDB-3A-40DEFAULT-CURSOR-20MGL-PAX-3AGLOSSARY-TERM-29" title="(LMDB:@DEFAULT-CURSOR MGL-PAX:GLOSSARY-TERM)">default cursor</a> is used.</p>

<p>If <code>NODUP</code> and not <code>FROM-END</code>, then the first duplicate of each key will
be seen. If <code>NODUP</code> and <code>FROM-END</code>, then the last duplicate of each key
will be seen.</p>

<p>To iterate over all key-value pairs with keys &gt;= 7:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">with-cursor</span></i> <span class="paren2">(<span class="code">cursor db</span>)</span>
  <span class="paren2">(<span class="code">cursor-set-key 7 cursor</span>)</span>
  <span class="paren2">(<span class="code">do-cursor <span class="paren3">(<span class="code">key value cursor</span>)</span>
    <span class="paren3">(<span class="code"><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_wr_pr.htm" class="symbol">print</a> <span class="paren4">(<span class="code"><a href="http://www.lispworks.com/reference/HyperSpec/Body/a_cons.htm" class="symbol">cons</a> key value</span>)</span></span>)</span></span>)</span></span>)</span></span></code></pre></li>
</ul>

<p><a id='x-28LMDB-3ADO-CURSOR-DUP-20MGL-PAX-3AMACRO-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L3270">[macro]</a></span> <span class="reference-object"><a href="#x-28LMDB-3ADO-CURSOR-DUP-20MGL-PAX-3AMACRO-29" >DO-CURSOR-DUP</a></span></span> <span class="locative-args">(VALUE-VAR CURSOR &amp;KEY FROM-END) &amp;BODY BODY</span></span></p>

<p>Iterate over duplicate values with starting from the position of
<code>CURSOR</code>. If <code>CURSOR</code> is not positioned then no values will be seen. If
<code>FROM-END</code>, then iterate with <a href="#x-28LMDB-3ACURSOR-PREV-DUP-20FUNCTION-29" title="(LMDB:CURSOR-PREV-DUP FUNCTION)"><code>CURSOR-PREV-DUP</code></a> instead of
<a href="#x-28LMDB-3ACURSOR-NEXT-DUP-20FUNCTION-29" title="(LMDB:CURSOR-NEXT-DUP FUNCTION)"><code>CURSOR-NEXT-DUP</code></a>.</p>

<p>If <code>CURSOR</code> is <code>NIL</code>, the <a href="#x-28LMDB-3A-40DEFAULT-CURSOR-20MGL-PAX-3AGLOSSARY-TERM-29" title="(LMDB:@DEFAULT-CURSOR MGL-PAX:GLOSSARY-TERM)">default cursor</a> is used.</p>

<p>To iterate over all values that not smaller than #(3 4 5),
associated with the key 7:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">with-cursor</span></i> <span class="paren2">(<span class="code">cursor db</span>)</span>
  <span class="paren2">(<span class="code">cursor-set-key-dup cursor 7 #<span class="paren3">(<span class="code">3 4 5</span>)</span></span>)</span>
  <span class="paren2">(<span class="code">do-cursor-dup <span class="paren3">(<span class="code">value cursor</span>)</span>
    <span class="paren3">(<span class="code"><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_wr_pr.htm" class="symbol">print</a> value</span>)</span></span>)</span></span>)</span></span></code></pre></li>
</ul>

<p><a id='x-28LMDB-3ADO-DB-20MGL-PAX-3AMACRO-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L3297">[macro]</a></span> <span class="reference-object"><a href="#x-28LMDB-3ADO-DB-20MGL-PAX-3AMACRO-29" >DO-DB</a></span></span> <span class="locative-args">(KEY-VAR VALUE-VAR DB &amp;KEY FROM-END NODUP) &amp;BODY BODY</span></span></p>

<p>Iterate over all keys and values in <code>DB</code>. If <code>NODUP</code>, then all but the
first (or last if <code>FROM-END</code>) value for each key are skipped. If
<code>FROM-END</code>, then iterate in reverse order.</p>

<p>To iterate over all values in <code>DB</code>:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code">do-db <span class="paren2">(<span class="code">key value db</span>)</span>
  <span class="paren2">(<span class="code"><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_wr_pr.htm" class="symbol">print</a> <span class="paren3">(<span class="code"><a href="http://www.lispworks.com/reference/HyperSpec/Body/a_cons.htm" class="symbol">cons</a> key value</span>)</span></span>)</span></span>)</span></span></code></pre>

<p>This macro establishes a <a href="#x-28LMDB-3A-40DEFAULT-CURSOR-20MGL-PAX-3AGLOSSARY-TERM-29" title="(LMDB:@DEFAULT-CURSOR MGL-PAX:GLOSSARY-TERM)">default cursor</a>.</p></li>
</ul>

<p><a id='x-28LMDB-3ADO-DB-DUP-20MGL-PAX-3AMACRO-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L3318">[macro]</a></span> <span class="reference-object"><a href="#x-28LMDB-3ADO-DB-DUP-20MGL-PAX-3AMACRO-29" >DO-DB-DUP</a></span></span> <span class="locative-args">(VALUE-VAR DB KEY &amp;KEY FROM-END) &amp;BODY BODY</span></span></p>

<p>Iterate over all values associated with <code>KEY</code> in <code>DB</code>. If <code>FROM-END</code>,
then iteration starts at the largest value.</p>

<p>To iterate over all values associated with the key 7:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code">do-db-dup <span class="paren2">(<span class="code">value db 7</span>)</span>
  <span class="paren2">(<span class="code"><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_wr_pr.htm" class="symbol">print</a> value</span>)</span></span>)</span></span></code></pre>

<p>This macro establishes a <a href="#x-28LMDB-3A-40DEFAULT-CURSOR-20MGL-PAX-3AGLOSSARY-TERM-29" title="(LMDB:@DEFAULT-CURSOR MGL-PAX:GLOSSARY-TERM)">default cursor</a>.</p></li>
</ul>

<p><a id='x-28LMDB-3ALIST-DUPS-20FUNCTION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L3338">[function]</a></span> <span class="reference-object"><a href="#x-28LMDB-3ALIST-DUPS-20FUNCTION-29" >LIST-DUPS</a></span></span> <span class="locative-args">DB KEY &amp;KEY FROM-END</span></span></p>

<p>A thin wrapper around <a href="#x-28LMDB-3ADO-DB-DUP-20MGL-PAX-3AMACRO-29" title="(LMDB:DO-DB-DUP MGL-PAX:MACRO)"><code>DO-DB-DUP</code></a>, this function returns all values
associated with <code>KEY</code> in <code>DB</code> as a list. If <code>FROM-END</code>, then the first
element of the list is the largest value.</p></li>
</ul>

<p><a id='x-28LMDB-3A-40LMDB-2FCONDITIONS-20MGL-PAX-3ASECTION-29'></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#x-28LMDB-3A-40LMDB-2FMISC-CURSOR-20MGL-PAX-3ASECTION-29" title="Miscellaneous cursor operations">&#8592;</a> <a href="#x-28LMDB-3A-40LMDB-MANUAL-20MGL-PAX-3ASECTION-29" title="LMDB Manual">&#8593;</a> <a href="#x-28LMDB-3A-40LMDB-2FERROR-CODE-CONDITIONS-20MGL-PAX-3ASECTION-29" title="Conditions for C lmdb error codes">&#8594;</a> <a href="#x-28LMDB-3A-40LMDB-2FCONDITIONS-20MGL-PAX-3ASECTION-29" title="Conditions">&#8634;</a> <a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L363">&#955;</a></span></span></p>

<h2><a href="#x-28LMDB-3A-40LMDB-2FCONDITIONS-20MGL-PAX-3ASECTION-29">12 Conditions</a></h2>

<p><a id='x-28LMDB-3ALMDB-SERIOUS-CONDITION-20CONDITION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L384">[condition]</a></span> <span class="reference-object"><a href="#x-28LMDB-3ALMDB-SERIOUS-CONDITION-20CONDITION-29" >LMDB-SERIOUS-CONDITION</a></span></span> <span class="locative-args">SERIOUS-CONDITION</span></span></p>

<p>The base class of all <a href="#x-28-23A-28-284-29-20BASE-CHAR-20-2E-20-22lmdb-22-29-20ASDF-2FSYSTEM-3ASYSTEM-29" title="(#A((4) BASE-CHAR . \&quot;lmdb\&quot;) ASDF/SYSTEM:SYSTEM)"><code>LMDB</code></a> conditions. Conditions
that are <code>LMDB-SERIOUS-CONDITION</code>s, but not <a href="#x-28LMDB-3ALMDB-ERROR-20CONDITION-29" title="(LMDB:LMDB-ERROR CONDITION)"><code>LMDB-ERROR</code></a>s are corruption
and internal errors, which are hard to recover from.</p></li>
</ul>

<p><a id='x-28LMDB-3ALMDB-ERROR-20CONDITION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L403">[condition]</a></span> <span class="reference-object"><a href="#x-28LMDB-3ALMDB-ERROR-20CONDITION-29" >LMDB-ERROR</a></span></span> <span class="locative-args">LMDB-SERIOUS-CONDITION ERROR</span></span></p>

<p>Base class for normal, recoverable <a href="#x-28-23A-28-284-29-20BASE-CHAR-20-2E-20-22lmdb-22-29-20ASDF-2FSYSTEM-3ASYSTEM-29" title="(#A((4) BASE-CHAR . \&quot;lmdb\&quot;) ASDF/SYSTEM:SYSTEM)"><code>LMDB</code></a> errors.</p></li>
</ul>

<p><a id='x-28LMDB-3A-40LMDB-2FERROR-CODE-CONDITIONS-20MGL-PAX-3ASECTION-29'></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#x-28LMDB-3A-40LMDB-2FCONDITIONS-20MGL-PAX-3ASECTION-29" title="Conditions">&#8592;</a> <a href="#x-28LMDB-3A-40LMDB-2FCONDITIONS-20MGL-PAX-3ASECTION-29" title="Conditions">&#8593;</a> <a href="#x-28LMDB-3A-40LMDB-2FADDITIONAL-CONDITIONS-20MGL-PAX-3ASECTION-29" title="Additional conditions">&#8594;</a> <a href="#x-28LMDB-3A-40LMDB-2FERROR-CODE-CONDITIONS-20MGL-PAX-3ASECTION-29" title="Conditions for C lmdb error codes">&#8634;</a> <a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L462">&#955;</a></span></span></p>

<h3><a href="#x-28LMDB-3A-40LMDB-2FERROR-CODE-CONDITIONS-20MGL-PAX-3ASECTION-29">12.1 Conditions for C lmdb error codes</a></h3>

<p>The following conditions correspond to <a href="http://www.lmdb.tech/doc/group__errors.html" >C lmdb error
codes</a>.</p>

<p><a id='x-28LMDB-3ALMDB-KEY-EXISTS-ERROR-20CONDITION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L486">[condition]</a></span> <span class="reference-object"><a href="#x-28LMDB-3ALMDB-KEY-EXISTS-ERROR-20CONDITION-29" >LMDB-KEY-EXISTS-ERROR</a></span></span> <span class="locative-args">LMDB-ERROR</span></span></p>

<p>Key-value pair already exists. Signalled by <a href="#x-28LMDB-3APUT-20FUNCTION-29" title="(LMDB:PUT FUNCTION)"><code>PUT</code></a>
and <a href="#x-28LMDB-3ACURSOR-PUT-20FUNCTION-29" title="(LMDB:CURSOR-PUT FUNCTION)"><code>CURSOR-PUT</code></a>.</p></li>
</ul>

<p><a id='x-28LMDB-3ALMDB-NOT-FOUND-ERROR-20CONDITION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L491">[condition]</a></span> <span class="reference-object"><a href="#x-28LMDB-3ALMDB-NOT-FOUND-ERROR-20CONDITION-29" >LMDB-NOT-FOUND-ERROR</a></span></span> <span class="locative-args">LMDB-ERROR</span></span></p>

<p>Key-value pair does not exist. All functions (<a href="#x-28LMDB-3AG3T-20FUNCTION-29" title="(LMDB:G3T FUNCTION)"><code>G3T</code></a>,
<a href="#x-28LMDB-3ACURSOR-NEXT-20FUNCTION-29" title="(LMDB:CURSOR-NEXT FUNCTION)"><code>CURSOR-NEXT</code></a>, ...) should return <code>NIL</code> instead of signalling this
error. If it is signalled, that's a bug.</p></li>
</ul>

<p><a id='x-28LMDB-3ALMDB-PAGE-NOT-FOUND-ERROR-20CONDITION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L497">[condition]</a></span> <span class="reference-object"><a href="#x-28LMDB-3ALMDB-PAGE-NOT-FOUND-ERROR-20CONDITION-29" >LMDB-PAGE-NOT-FOUND-ERROR</a></span></span> <span class="locative-args">LMDB-SERIOUS-CONDITION</span></span></p>

<p>Requested page not found - this usually indicates
corruption.</p></li>
</ul>

<p><a id='x-28LMDB-3ALMDB-CORRUPTED-ERROR-20CONDITION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L502">[condition]</a></span> <span class="reference-object"><a href="#x-28LMDB-3ALMDB-CORRUPTED-ERROR-20CONDITION-29" >LMDB-CORRUPTED-ERROR</a></span></span> <span class="locative-args">LMDB-SERIOUS-CONDITION</span></span></p>

<p>Located page was wrong type.</p></li>
</ul>

<p><a id='x-28LMDB-3ALMDB-PANIC-ERROR-20CONDITION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L506">[condition]</a></span> <span class="reference-object"><a href="#x-28LMDB-3ALMDB-PANIC-ERROR-20CONDITION-29" >LMDB-PANIC-ERROR</a></span></span> <span class="locative-args">LMDB-SERIOUS-CONDITION</span></span></p>

<p>Update of meta page failed or environment had fatal
error.</p></li>
</ul>

<p><a id='x-28LMDB-3ALMDB-VERSION-MISMATCH-ERROR-20CONDITION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L511">[condition]</a></span> <span class="reference-object"><a href="#x-28LMDB-3ALMDB-VERSION-MISMATCH-ERROR-20CONDITION-29" >LMDB-VERSION-MISMATCH-ERROR</a></span></span> <span class="locative-args">LMDB-ERROR</span></span></p>

<p>Environment version mismatch.</p></li>
</ul>

<p><a id='x-28LMDB-3ALMDB-INVALID-ERROR-20CONDITION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L515">[condition]</a></span> <span class="reference-object"><a href="#x-28LMDB-3ALMDB-INVALID-ERROR-20CONDITION-29" >LMDB-INVALID-ERROR</a></span></span> <span class="locative-args">LMDB-SERIOUS-CONDITION</span></span></p>

<p>File is not a valid <a href="#x-28-23A-28-284-29-20BASE-CHAR-20-2E-20-22lmdb-22-29-20ASDF-2FSYSTEM-3ASYSTEM-29" title="(#A((4) BASE-CHAR . \&quot;lmdb\&quot;) ASDF/SYSTEM:SYSTEM)"><code>LMDB</code></a> file.</p></li>
</ul>

<p><a id='x-28LMDB-3ALMDB-MAP-FULL-ERROR-20CONDITION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L519">[condition]</a></span> <span class="reference-object"><a href="#x-28LMDB-3ALMDB-MAP-FULL-ERROR-20CONDITION-29" >LMDB-MAP-FULL-ERROR</a></span></span> <span class="locative-args">LMDB-ERROR</span></span></p>

<p><a href="#x-28LMDB-3AENV-MAP-SIZE-20-28MGL-PAX-3AREADER-20LMDB-3AENV-29-29" title="(LMDB:ENV-MAP-SIZE (MGL-PAX:READER LMDB:ENV))"><code>ENV-MAP-SIZE</code></a> reached. Reopen the environment with a
larger <code>:MAP-SIZE</code>.</p></li>
</ul>

<p><a id='x-28LMDB-3ALMDB-DBS-FULL-ERROR-20CONDITION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L524">[condition]</a></span> <span class="reference-object"><a href="#x-28LMDB-3ALMDB-DBS-FULL-ERROR-20CONDITION-29" >LMDB-DBS-FULL-ERROR</a></span></span> <span class="locative-args">LMDB-ERROR</span></span></p>

<p><a href="#x-28LMDB-3AENV-MAX-DBS-20-28MGL-PAX-3AREADER-20LMDB-3AENV-29-29" title="(LMDB:ENV-MAX-DBS (MGL-PAX:READER LMDB:ENV))"><code>ENV-MAX-DBS</code></a> reached. Reopen the environment with a
higher <code>:MAX-DBS</code>.</p></li>
</ul>

<p><a id='x-28LMDB-3ALMDB-READERS-FULL-ERROR-20CONDITION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L529">[condition]</a></span> <span class="reference-object"><a href="#x-28LMDB-3ALMDB-READERS-FULL-ERROR-20CONDITION-29" >LMDB-READERS-FULL-ERROR</a></span></span> <span class="locative-args">LMDB-ERROR</span></span></p>

<p><a href="#x-28LMDB-3AENV-MAX-READERS-20-28MGL-PAX-3AREADER-20LMDB-3AENV-29-29" title="(LMDB:ENV-MAX-READERS (MGL-PAX:READER LMDB:ENV))"><code>ENV-MAX-READERS</code></a> reached. Reopen the environment
with a higher <code>:MAX-READERS</code>.</p></li>
</ul>

<p><a id='x-28LMDB-3ALMDB-TXN-FULL-ERROR-20CONDITION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L534">[condition]</a></span> <span class="reference-object"><a href="#x-28LMDB-3ALMDB-TXN-FULL-ERROR-20CONDITION-29" >LMDB-TXN-FULL-ERROR</a></span></span> <span class="locative-args">LMDB-ERROR</span></span></p>

<p><code>TXN</code> has too many dirty pages. This condition is
expected to occur only when using nested read-write transactions or
operations multiple items (currently not supported by this
wrapper).</p></li>
</ul>

<p><a id='x-28LMDB-3ALMDB-CURSOR-FULL-ERROR-20CONDITION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L541">[condition]</a></span> <span class="reference-object"><a href="#x-28LMDB-3ALMDB-CURSOR-FULL-ERROR-20CONDITION-29" >LMDB-CURSOR-FULL-ERROR</a></span></span> <span class="locative-args">LMDB-SERIOUS-CONDITION</span></span></p>

<p>Cursor stack too deep - internal error.</p></li>
</ul>

<p><a id='x-28LMDB-3ALMDB-PAGE-FULL-ERROR-20CONDITION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L545">[condition]</a></span> <span class="reference-object"><a href="#x-28LMDB-3ALMDB-PAGE-FULL-ERROR-20CONDITION-29" >LMDB-PAGE-FULL-ERROR</a></span></span> <span class="locative-args">LMDB-SERIOUS-CONDITION</span></span></p>

<p>Page has not enough space - internal error.</p></li>
</ul>

<p><a id='x-28LMDB-3ALMDB-MAP-RESIZED-ERROR-20CONDITION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L549">[condition]</a></span> <span class="reference-object"><a href="#x-28LMDB-3ALMDB-MAP-RESIZED-ERROR-20CONDITION-29" >LMDB-MAP-RESIZED-ERROR</a></span></span> <span class="locative-args">LMDB-ERROR</span></span></p>

<p>Data file contents grew beyond <a href="#x-28LMDB-3AENV-MAP-SIZE-20-28MGL-PAX-3AREADER-20LMDB-3AENV-29-29" title="(LMDB:ENV-MAP-SIZE (MGL-PAX:READER LMDB:ENV))"><code>ENV-MAP-SIZE</code></a>. This
can happen if another OS process using the same environment path set
a larger map size than this process did.</p></li>
</ul>

<p><a id='x-28LMDB-3ALMDB-INCOMPATIBLE-ERROR-20CONDITION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L555">[condition]</a></span> <span class="reference-object"><a href="#x-28LMDB-3ALMDB-INCOMPATIBLE-ERROR-20CONDITION-29" >LMDB-INCOMPATIBLE-ERROR</a></span></span> <span class="locative-args">LMDB-ERROR</span></span></p>

<p>Operation and <a href="#x-28LMDB-3ADB-20CLASS-29" title="(LMDB:DB CLASS)"><code>DB</code></a> incompatible, or <code>DB</code> type changed.
This can mean:</p>

<ul>
<li><p>The operation expects a <a href="#x-28LMDB-3A-40DUPSORT-20MGL-PAX-3ASECTION-29" title="DUPSORT">DUPSORT</a> or <code>DUPFIXED</code> database.</p></li>
<li><p>Opening a named <code>DB</code> when the unnamed <code>DB</code> has <code>DUPSORT</code> or <code>INTEGER-KEY</code>.</p></li>
<li><p>Accessing a data record as a database, or vice versa.</p></li>
<li><p>The database was dropped and recreated with different flags.</p></li>
</ul></li>
</ul>

<p><a id='x-28LMDB-3ALMDB-BAD-RSLOT-ERROR-20CONDITION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L568">[condition]</a></span> <span class="reference-object"><a href="#x-28LMDB-3ALMDB-BAD-RSLOT-ERROR-20CONDITION-29" >LMDB-BAD-RSLOT-ERROR</a></span></span> <span class="locative-args">LMDB-ERROR</span></span></p>

<p>Invalid reuse of reader locktable slot. May be
signalled by <a href="#x-28LMDB-3AWITH-TXN-20MGL-PAX-3AMACRO-29" title="(LMDB:WITH-TXN MGL-PAX:MACRO)"><code>WITH-TXN</code></a>.</p></li>
</ul>

<p><a id='x-28LMDB-3ALMDB-BAD-TXN-ERROR-20CONDITION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L573">[condition]</a></span> <span class="reference-object"><a href="#x-28LMDB-3ALMDB-BAD-TXN-ERROR-20CONDITION-29" >LMDB-BAD-TXN-ERROR</a></span></span> <span class="locative-args">LMDB-ERROR</span></span></p>

<p>Transaction must abort, has a child, or is invalid.
Signalled, for example, when a read-only transaction is nested in a
read-write transaction, or when a cursor is used whose transaction
has been closed (committed, aborted, or reset).</p></li>
</ul>

<p><a id='x-28LMDB-3ALMDB-BAD-VALSIZE-ERROR-20CONDITION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L580">[condition]</a></span> <span class="reference-object"><a href="#x-28LMDB-3ALMDB-BAD-VALSIZE-ERROR-20CONDITION-29" >LMDB-BAD-VALSIZE-ERROR</a></span></span> <span class="locative-args">LMDB-ERROR</span></span></p>

<p>Unsupported size of key/DB name/data, or wrong
<code>DUPFIXED</code>, <code>INTEGER-KEY</code> or <code>INTEGER-DUP</code>. See <a href="#x-28LMDB-3AENV-MAX-KEY-SIZE-20FUNCTION-29" title="(LMDB:ENV-MAX-KEY-SIZE FUNCTION)"><code>ENV-MAX-KEY-SIZE</code></a>.</p></li>
</ul>

<p><a id='x-28LMDB-3ALMDB-BAD-DBI-ERROR-20CONDITION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L585">[condition]</a></span> <span class="reference-object"><a href="#x-28LMDB-3ALMDB-BAD-DBI-ERROR-20CONDITION-29" >LMDB-BAD-DBI-ERROR</a></span></span> <span class="locative-args">LMDB-ERROR</span></span></p>

<p>The specified <code>DBI</code> was changed unexpectedly.</p></li>
</ul>

<p><a id='x-28LMDB-3A-40LMDB-2FADDITIONAL-CONDITIONS-20MGL-PAX-3ASECTION-29'></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#x-28LMDB-3A-40LMDB-2FERROR-CODE-CONDITIONS-20MGL-PAX-3ASECTION-29" title="Conditions for C lmdb error codes">&#8592;</a> <a href="#x-28LMDB-3A-40LMDB-2FCONDITIONS-20MGL-PAX-3ASECTION-29" title="Conditions">&#8593;</a> <a href="#x-28LMDB-3A-40LMDB-2FADDITIONAL-CONDITIONS-20MGL-PAX-3ASECTION-29" title="Additional conditions">&#8634;</a> <a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L589">&#955;</a></span></span></p>

<h3><a href="#x-28LMDB-3A-40LMDB-2FADDITIONAL-CONDITIONS-20MGL-PAX-3ASECTION-29">12.2 Additional conditions</a></h3>

<p>The following conditions do not have a dedicated C lmdb error
code.</p>

<p><a id='x-28LMDB-3ALMDB-CURSOR-UNINITIALIZED-ERROR-20CONDITION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L597">[condition]</a></span> <span class="reference-object"><a href="#x-28LMDB-3ALMDB-CURSOR-UNINITIALIZED-ERROR-20CONDITION-29" >LMDB-CURSOR-UNINITIALIZED-ERROR</a></span></span> <span class="locative-args">LMDB-ERROR</span></span></p>

<p>Cursor was not initialized. Position the cursor at
a key-value pair with a function like <a href="#x-28LMDB-3ACURSOR-FIRST-20FUNCTION-29" title="(LMDB:CURSOR-FIRST FUNCTION)"><code>CURSOR-FIRST</code></a> or
<a href="#x-28LMDB-3ACURSOR-SET-KEY-20FUNCTION-29" title="(LMDB:CURSOR-SET-KEY FUNCTION)"><code>CURSOR-SET-KEY</code></a>. Signalled when some functions return the C error
code <code>EINVAL</code>.</p></li>
</ul>

<p><a id='x-28LMDB-3ALMDB-CURSOR-THREAD-ERROR-20CONDITION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L604">[condition]</a></span> <span class="reference-object"><a href="#x-28LMDB-3ALMDB-CURSOR-THREAD-ERROR-20CONDITION-29" >LMDB-CURSOR-THREAD-ERROR</a></span></span> <span class="locative-args">LMDB-ERROR</span></span></p>

<p>Cursor was accessed from a thread other than the
one in which it was created. Since the foreign cursor object's
lifetime is tied to the dynamic extent of its <a href="#x-28LMDB-3AWITH-CURSOR-20MGL-PAX-3AMACRO-29" title="(LMDB:WITH-CURSOR MGL-PAX:MACRO)"><code>WITH-CURSOR</code></a>, this
might mean accessing garbage in foreign memory with unpredictable
consequences.</p></li>
</ul>

<p><a id='x-28LMDB-3ALMDB-TXN-READ-ONLY-ERROR-20CONDITION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L612">[condition]</a></span> <span class="reference-object"><a href="#x-28LMDB-3ALMDB-TXN-READ-ONLY-ERROR-20CONDITION-29" >LMDB-TXN-READ-ONLY-ERROR</a></span></span> <span class="locative-args">LMDB-ERROR</span></span></p>

<p>Attempt was made to write in a read-only
transaction. Signalled when some functions return the C error code
<code>EACCESS</code>.</p></li>
</ul>

<p><a id='x-28LMDB-3ALMDB-ILLEGAL-ACCESS-TO-PARENT-TXN-ERROR-20CONDITION-29'></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/melisgl/lmdb/blob/060d7e64e5e36d71735fdfe7834f147f1a874b02/src/lmdb.lisp#L618">[condition]</a></span> <span class="reference-object"><a href="#x-28LMDB-3ALMDB-ILLEGAL-ACCESS-TO-PARENT-TXN-ERROR-20CONDITION-29" >LMDB-ILLEGAL-ACCESS-TO-PARENT-TXN-ERROR</a></span></span> <span class="locative-args">LMDB-ERROR</span></span></p>

<p>A parent transaction and its cursors may not
issue any other operations than <a href="#x-28LMDB-3ACOMMIT-TXN-20FUNCTION-29" title="(LMDB:COMMIT-TXN FUNCTION)"><code>COMMIT-TXN</code></a> and <a href="#x-28LMDB-3AABORT-TXN-20FUNCTION-29" title="(LMDB:ABORT-TXN FUNCTION)"><code>ABORT-TXN</code></a> while it
has active child transactions. In <a href="#x-28-23A-28-284-29-20BASE-CHAR-20-2E-20-22lmdb-22-29-20ASDF-2FSYSTEM-3ASYSTEM-29" title="(#A((4) BASE-CHAR . \&quot;lmdb\&quot;) ASDF/SYSTEM:SYSTEM)"><code>LMDB</code></a>, <a href="#x-28LMDB-3A-40LMDB-2FBASIC-OPERATIONS-20MGL-PAX-3ASECTION-29" title="Basic operations">Basic operations</a> are
always executed in the <a href="#x-28LMDB-3A-40ACTIVE-TRANSACTION-20MGL-PAX-3AGLOSSARY-TERM-29" title="(LMDB:@ACTIVE-TRANSACTION MGL-PAX:GLOSSARY-TERM)">active transaction</a>, but <a href="#x-28LMDB-3A-40LMDB-2FCURSORS-20MGL-PAX-3ASECTION-29" title="Cursors">Cursors</a> can
refer to the parent transaction:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">with-temporary-env</span></i> <span class="paren2">(<span class="code"><span class="special">*env*</span></span>)</span>
  <span class="paren2">(<span class="code"><a href="http://www.lispworks.com/reference/HyperSpec/Body/s_let_l.htm" class="symbol"><i><span class="symbol">let</span></i></a> <span class="paren3">(<span class="code"><span class="paren4">(<span class="code">db <span class="paren5">(<span class="code">get-db <span class="string">"db"</span></span>)</span></span>)</span></span>)</span>
    <span class="paren3">(<span class="code"><i><span class="symbol">with-txn</span></i> <span class="paren4">(<span class="code"><span class="keyword">:write</span> <a href="http://www.lispworks.com/reference/HyperSpec/Body/a_t.htm" class="symbol">t</a></span>)</span>
      <span class="paren4">(<span class="code">put db #<span class="paren5">(<span class="code">1</span>)</span> #<span class="paren5">(<span class="code">1</span>)</span></span>)</span>
      <span class="paren4">(<span class="code"><i><span class="symbol">with-cursor</span></i> <span class="paren5">(<span class="code">cursor db</span>)</span>
        <span class="paren5">(<span class="code"><i><span class="symbol">with-txn</span></i> <span class="paren6">(<span class="code"><span class="keyword">:write</span> <a href="http://www.lispworks.com/reference/HyperSpec/Body/a_t.htm" class="symbol">t</a></span>)</span>
          <span class="paren6">(<span class="code">assert-error lmdb-illegal-access-to-parent-txn-error
            <span class="paren1">(<span class="code">cursor-set-key #<span class="paren2">(<span class="code">1</span>)</span> cursor</span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span></code></pre></li>
</ul>
  </div>
</div>
<script>$('#page-toc').toc({'selectors': 'h1,h2,h3,h4'});</script>
</body>
</html>
